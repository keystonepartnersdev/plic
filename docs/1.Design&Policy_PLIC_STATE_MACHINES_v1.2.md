# PLIC 상태 전이 (STATE MACHINES)

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | PLIC State Machines |
| 버전 | 1.2 |
| 작성일 | 2025-01-05 |
| 수정일 | 2025-01-06 |
| 작성자 | PLIC 개발팀 |
| 상태 | **Approved** |
| 역할 | **상태 전이 SSOT** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-05 | 초안 작성 | PLIC 개발팀 |
| 1.1 | 2025-01-05 | CTO 리뷰 반영 | PLIC 개발팀 |
| 1.2 | 2025-01-06 | **SSOT 동기화**: Deal 상태 10개로 확장 (PROCESSING, FAILED, ABANDONED 추가), PRD v1.3과 통일 | PLIC 개발팀 |

---

## 1. 개요

### 1.1 문서 목적

이 문서는 PLIC 서비스의 모든 상태(State)와 상태 전이(Transition)를 정의합니다. 개발자, QA, 운영팀이 "상태가 어떻게 바뀌는지"를 동일하게 이해하기 위한 **단일 진실 공급원(SSOT)**입니다.

### 1.2 상태 관리 대상

| 엔티티 | 테이블 | 설명 |
|--------|--------|------|
| **거래 (Deal)** | `deals` | 송금 요청의 전체 생명주기 |
| **결제 (Payment)** | `payments` | 카드 결제의 상태 |
| **송금 (Transfer)** | `transfers` | 각 송금 시도(Attempt)의 상태 |
| **송금 작업 (Transfer Job)** | `transfer_jobs` | 송금 작업 큐의 상태 |
| **회원 (User)** | `users` | 회원 계정 상태 |
| **카드 (Card)** | `cards` | 등록 카드 상태 |

### 1.3 상태 전이 원칙

| 원칙 | 설명 |
|------|------|
| **단방향 흐름** | 정상 흐름은 앞으로만 진행 (역방향 금지) |
| **명시적 전이** | 정의되지 않은 전이는 불가 |
| **낙관적 락** | 동시성 제어를 위해 version 필드 사용 |
| **타임스탬프 기록** | 주요 상태 전이 시점 기록 |
| **시도 이력 보존** | Transfer는 시도(Attempt) 단위로 기록, 재시도 시 새 row 생성 |

### 1.4 핵심 모델: Transfer vs Transfer Job

> **중요**: Transfer와 Transfer Job의 역할을 명확히 구분합니다.

```
[Transfer vs Transfer Job]

┌─────────────────────────────────────────────────────────────┐
│ Transfer Job = 송금 "작업" (오케스트레이터)                   │
│ - Deal 당 활성 Job은 1개만 존재                              │
│ - 재시도 횟수, 스케줄링, 락 관리                             │
│ - 최대 5회 시도 후 ABANDONED                                 │
└─────────────────────────────────────────────────────────────┘
        │
        │ 각 시도(Attempt)마다
        ▼
┌─────────────────────────────────────────────────────────────┐
│ Transfer = 송금 "시도" (실행 로그)                           │
│ - 시도(Attempt)마다 새 row 생성                              │
│ - 각 Transfer는 COMPLETED 또는 FAILED로 종료 (최종 상태)      │
│ - 시도 히스토리가 보존되어 대사/감사에 유리                   │
└─────────────────────────────────────────────────────────────┘

[예시: 3회 시도 후 성공]

Job #1 (deal_id: D001)
├── attempt: 1 → Transfer #T001 (FAILED)
├── attempt: 2 → Transfer #T002 (FAILED)
└── attempt: 3 → Transfer #T003 (COMPLETED) ✅
    └── Job #1 → COMPLETED
```

---

## 2. Deal (거래) 상태

### 2.1 상태 정의 ⚠️ (v1.2 SSOT 동기화)

> ⚠️ **PRD v1.3과 통일**: 10개 상태로 확장

| 상태 | 코드 | 설명 | 최종 상태 |
|------|------|------|-----------|
| **대기** | `PENDING` | 거래 생성됨, 결제 전 | ❌ |
| **처리중** | `PROCESSING` | 결제 요청 중 (PG 응답 대기) ⚠️ v1.2 추가 | ❌ |
| **결제완료** | `PAID` | 카드 결제 성공, 송금 대기 | ❌ |
| **송금중** | `TRANSFERRING` | 계좌 송금 진행 중 | ❌ |
| **완료** | `COMPLETED` | 송금 성공, 거래 완료 | ✅ |
| **취소** | `CANCELLED` | 결제 전 취소 | ✅ |
| **환불** | `REFUNDED` | 결제 후 환불 완료 | ✅ |
| **결제실패** | `FAILED` | 결제 실패 ⚠️ v1.2 추가 | ✅ |
| **송금실패** | `TRANSFER_FAILED` | 송금 실패 (재시도 중) | ❌ |
| **포기** | `ABANDONED` | 복구 불가 (수동 처리 필요) ⚠️ v1.2 추가 | ❌ |

> **v1.2 변경점**:
> - `PROCESSING`: confirm 후 PG 응답 대기 상태 (웹훅 수신 전)
> - `FAILED`: 결제 자체가 실패한 최종 상태 (Payment FAILED와 동기화)
> - `ABANDONED`: 5회 재시도 후에도 복구 불가, 운영자 수동 처리 필요

### 2.2 상태 전이 다이어그램 ⚠️ (v1.2 업데이트)

```
                        ┌─────────────────────────────────────────────────────┐
                        │                                                     │
                        │                     DEAL STATE MACHINE              │
                        │                     (v1.2 - 10 States)              │
                        └─────────────────────────────────────────────────────┘

                                         ┌───────────┐
                                         │  PENDING  │
                                         │  (대기)    │
                                         └─────┬─────┘
                                               │
                           ┌───────────────────┼───────────────────┐
                           │                   │                   │
                           │ [취소]            │ [confirm]         │
                           │                   │                   │
                           ▼                   ▼                   │
                    ┌───────────┐       ┌────────────┐             │
                    │ CANCELLED │       │ PROCESSING │             │
                    │  (취소)    │       │  (처리중)   │             │
                    └───────────┘       └──────┬─────┘             │
                                               │                    │
                              ┌────────────────┼────────────────┐   │
                              │                │                │   │
                              │ [결제 실패]     │ [결제 성공]     │   │
                              │                │                │   │
                              ▼                ▼                │   │
                       ┌───────────┐    ┌───────────┐           │   │
                       │  FAILED   │    │   PAID    │           │   │
                       │ (결제실패) │    │ (결제완료) │           │   │
                       └───────────┘    └─────┬─────┘           │   │
                                              │                 │   │
                              ┌───────────────┼───────────────┐ │   │
                              │               │               │ │   │
                              │ [환불]        │ [송금 시작]   │ │   │
                              │               │               │ │   │
                              ▼               ▼               │ │   │
                       ┌───────────┐   ┌─────────────┐        │ │   │
                       │ REFUNDED  │   │TRANSFERRING │        │ │   │
                       │  (환불)    │   │  (송금중)    │        │ │   │
                       └───────────┘   └──────┬──────┘        │ │   │
                              ▲               │               │ │   │
                              │     ┌─────────┴─────────┐     │ │   │
                              │     │                   │     │ │   │
                              │     │ [송금 실패]        │ [송금 성공]
                              │     │                   │     │ │   │
                              │     ▼                   ▼     │ │   │
                              │ ┌────────────────┐ ┌───────────┐   │
                              │ │TRANSFER_FAILED │ │ COMPLETED │   │
                              │ │  (송금실패)     │ │  (완료)   │   │
                              │ └───────┬────────┘ └───────────┘   │
                              │         │                          │
                              │         │ [재시도 - Job이 처리]     │
                              │         ▼                          │
                              │    ┌─────────────┐                 │
                              │    │TRANSFERRING │                 │
                              │    └──────┬──────┘                 │
                              │           │                        │
                              │           │ [5회 실패 - 포기]       │
                              │           ▼                        │
                              │    ┌───────────┐                   │
                              │    │ ABANDONED │                   │
                              │    │  (포기)    │                   │
                              │    └─────┬─────┘                   │
                              │          │                         │
                              │          │ [수동 처리]             │
                              │          ├────────────────────────▶│ COMPLETED
                              └──────────┴─────────────────────────┘ 또는 REFUNDED
```

### 2.3 상태 전이 규칙 ⚠️ (v1.2 업데이트)

| From | To | 트리거 | 조건 |
|------|-----|--------|------|
| `PENDING` | `PROCESSING` | confirm API 호출 | 결제 요청 시작 ⚠️ v1.2 |
| `PENDING` | `CANCELLED` | 사용자/관리자 취소 | 결제 전 |
| `PENDING` | `CANCELLED` | 만료 배치 | 5분 경과 |
| `PROCESSING` | `PAID` | 결제 성공 웹훅 | PG 상태 DONE ⚠️ v1.2 |
| `PROCESSING` | `FAILED` | 결제 실패 웹훅 | PG 상태 FAILED ⚠️ v1.2 |
| `PAID` | `TRANSFERRING` | 송금 Job 시작 | TransferJob 생성됨 |
| `PAID` | `REFUNDED` | 환불 요청 | 송금 Job 생성 전 |
| `PAID` | `CANCELLED` | 취소 요청 | 송금 Job 생성 전, 매입 전 |
| `TRANSFERRING` | `COMPLETED` | 송금 성공 | Transfer 상태가 COMPLETED |
| `TRANSFERRING` | `TRANSFER_FAILED` | 송금 실패 | Transfer 상태가 FAILED |
| `TRANSFER_FAILED` | `TRANSFERRING` | 재시도 | TransferJob이 PENDING/PROCESSING |
| `TRANSFER_FAILED` | `ABANDONED` | 재시도 포기 | 5회 초과 또는 24시간 경과 ⚠️ v1.2 |
| `TRANSFER_FAILED` | `REFUNDED` | 환불 요청 | TransferJob이 ABANDONED |
| `ABANDONED` | `COMPLETED` | 수동 송금 성공 | Admin 처리 ⚠️ v1.2 |
| `ABANDONED` | `REFUNDED` | 수동 환불 | Admin 처리 ⚠️ v1.2 |
| `COMPLETED` | `REFUNDED` | 차지백 | 카드사 차지백 승인 |

### 2.4 상태별 타임스탬프 ⚠️ (v1.2 업데이트)

| 상태 전이 | 기록 필드 |
|-----------|-----------|
| → `PROCESSING` | - (created_at 사용) |
| → `PAID` | `paid_at` |
| → `FAILED` | - (updated_at 사용) |
| → `TRANSFERRING` | `transfer_started_at` |
| → `COMPLETED` | `completed_at` |
| → `CANCELLED` | `cancelled_at` |
| → `REFUNDED` | `refunded_at` |
| → `ABANDONED` | `abandoned_at` ⚠️ v1.2 추가 |

> **v1.2 변경**: 
> - REFUNDED는 `refunded_at`에 기록 (cancelled_at 아님)
> - ABANDONED는 `abandoned_at`에 기록 (신규 필드)

---

## 3. Payment (결제) 상태

### 3.1 상태 정의

| 상태 | 코드 | 설명 | 최종 상태 |
|------|------|------|-----------|
| **대기** | `PENDING` | 결제 요청 전 | ❌ |
| **완료** | `PAID` | 결제 성공 | ❌ |
| **실패** | `FAILED` | 결제 실패 | ✅ |
| **취소** | `CANCELLED` | 결제 취소 (Void, 매입 전) | ✅ |
| **환불** | `REFUNDED` | 환불 완료 (Refund, 매입 후) | ✅ |

> **v1.0 정의**: `PAID` = 결제 완료 (PLIC 기준). 승인(Auth)/매입(Capture) 분리는 External Interface 문서에서 다룸.

### 3.2 상태 전이 다이어그램

```
                    ┌───────────┐
                    │  PENDING  │
                    │  (대기)    │
                    └─────┬─────┘
                          │
            ┌─────────────┼─────────────┐
            │             │             │
            │ [결제 실패]  │ [결제 성공]  │
            │             │             │
            ▼             ▼             │
     ┌───────────┐  ┌───────────┐       │
     │  FAILED   │  │   PAID    │       │
     │  (실패)   │  │  (완료)   │       │
     └───────────┘  └─────┬─────┘       │
                          │             │
            ┌─────────────┼─────────────┤
            │             │             │
            │ [취소]      │ [환불]      │
            │ (매입 전)   │ (매입 후)   │
            │             │             │
            ▼             ▼             │
     ┌───────────┐  ┌───────────┐       │
     │ CANCELLED │  │ REFUNDED  │       │
     │  (취소)   │  │  (환불)   │       │
     └───────────┘  └───────────┘       │
```

### 3.3 상태 전이 규칙

| From | To | 트리거 | 조건 |
|------|-----|--------|------|
| `PENDING` | `PAID` | PG 웹훅 (성공) | PG 결제 승인 성공 |
| `PENDING` | `FAILED` | PG 웹훅 (실패) | PG 결제 승인 실패 |
| `PAID` | `CANCELLED` | 취소 API | 매입 전 (Void) |
| `PAID` | `REFUNDED` | 환불 API | 매입 후 (Refund) |

### 3.4 상태별 타임스탬프

| 상태 전이 | 기록 필드 |
|-----------|-----------|
| → `PAID` | `paid_at` |
| → `CANCELLED` | `cancelled_at` |
| → `REFUNDED` | `refunded_at` |

---

## 4. Transfer (송금) 상태

### 4.1 상태 정의

> **핵심**: Transfer는 **시도(Attempt) 단위**의 로그입니다. 재시도 시 새 Transfer row가 생성됩니다.

| 상태 | 코드 | 설명 | 최종 상태 |
|------|------|------|-----------|
| **대기** | `PENDING` | 송금 API 호출 전 | ❌ |
| **처리중** | `PROCESSING` | 송금 API 호출 중 | ❌ |
| **완료** | `COMPLETED` | 송금 성공 | ✅ |
| **실패** | `FAILED` | 송금 실패 | ✅ |

### 4.2 실패 유형 (failure_type)

> **v1.1 추가**: 실패 원인에 따라 재시도 가능 여부가 달라집니다.

| failure_type | 설명 | 자동 재시도 | 예시 |
|--------------|------|-------------|------|
| `RETRYABLE` | 일시적 실패 | ✅ 가능 | 은행 점검, 네트워크 오류, 타임아웃 |
| `FATAL` | 영구적 실패 | ❌ 불가 | 계좌 오류, 예금주 불일치, 해지 계좌 |

```sql
-- Transfer 테이블 failure_type 필드
failure_type VARCHAR(20),  -- 'RETRYABLE' | 'FATAL'
failure_code VARCHAR(50),  -- 은행/송금사 에러 코드
failure_reason VARCHAR(500)
```

### 4.3 상태 전이 다이어그램

```
                    ┌───────────┐
                    │  PENDING  │
                    │  (대기)    │
                    └─────┬─────┘
                          │
                          │ [송금 시작]
                          │
                          ▼
                    ┌───────────┐
                    │PROCESSING │
                    │ (처리중)   │
                    └─────┬─────┘
                          │
            ┌─────────────┴─────────────┐
            │                           │
            │ [송금 실패]               │ [송금 성공]
            │                           │
            ▼                           ▼
     ┌───────────┐               ┌───────────┐
     │  FAILED   │               │ COMPLETED │
     │  (실패)   │               │  (완료)   │
     │           │               └───────────┘
     │ failure_  │
     │ type:     │
     │ RETRYABLE │ ──▶ Job이 새 Transfer 생성하여 재시도
     │ or FATAL  │ ──▶ Job이 ABANDONED 처리
     └───────────┘
```

### 4.4 상태 전이 규칙

| From | To | 트리거 | 조건 |
|------|-----|--------|------|
| `PENDING` | `PROCESSING` | Worker 처리 시작 | Job이 락 획득 |
| `PROCESSING` | `COMPLETED` | 송금 API 성공 | 은행 응답 성공 |
| `PROCESSING` | `FAILED` | 송금 API 실패 | 은행 응답 실패 |

> **참고**: FAILED는 해당 Transfer의 최종 상태. 재시도 시 새 Transfer가 생성됨.

### 4.5 상태별 타임스탬프

| 상태 전이 | 기록 필드 |
|-----------|-----------|
| → `PROCESSING` | `processed_at` |
| → `COMPLETED` | `completed_at` |
| → `FAILED` | `failed_at` |

---

## 5. Transfer Job (송금 작업) 상태

### 5.1 상태 정의

| 상태 | 코드 | 설명 | 환불 가능 | 최종 상태 |
|------|------|------|-----------|-----------|
| **대기** | `PENDING` | 송금 실행 대기 | ❌ | ❌ |
| **처리중** | `PROCESSING` | Worker가 처리 중 (락 보유) | ❌ | ❌ |
| **완료** | `COMPLETED` | 송금 성공 | ❌ | ✅ |
| **실패** | `FAILED` | 송금 실패, 재시도 대기 | ❌ | ❌ |
| **포기** | `ABANDONED` | 재시도 횟수 초과 또는 FATAL 오류 | ✅ | ✅ |

### 5.2 상태 전이 다이어그램

```
                                    ┌───────────┐
                                    │  PENDING  │
                                    │  (대기)    │
                                    └─────┬─────┘
                                          │
                                          │ [Worker 락 획득]
                                          │
                                          ▼
                                    ┌───────────┐
                                    │PROCESSING │◀─────────────────┐
                                    │ (처리중)   │                   │
                                    └─────┬─────┘                   │
                                          │                         │
                      ┌───────────────────┼───────────────────┐     │
                      │                   │                   │     │
                      │ [실패]            │ [성공]            │     │
                      │                   │                   │     │
                      ▼                   ▼                   │     │
               ┌───────────┐       ┌───────────┐              │     │
               │  FAILED   │       │ COMPLETED │              │     │
               │  (실패)   │       │  (완료)   │              │     │
               └─────┬─────┘       └───────────┘              │     │
                     │                                        │     │
       ┌─────────────┼─────────────┐                          │     │
       │             │             │                          │     │
       │ [재시도     │ [재시도     │                          │     │
       │  가능 &     │  불가 or    │                          │     │
       │  횟수 <5]   │  횟수 ≥5]   │                          │     │
       │             │             │                          │     │
       │             ▼             │                          │     │
       │      ┌───────────┐        │                          │     │
       │      │ ABANDONED │        │                          │     │
       │      │  (포기)   │        │                          │     │
       │      └───────────┘        │                          │     │
       │                           │                          │     │
       └───────────────────────────┴──────────────────────────┘     │
                           │                                        │
                           │ [재시도: 새 Transfer 생성]              │
                           └────────────────────────────────────────┘
```

### 5.3 상태 전이 규칙

| From | To | 트리거 | 조건 |
|------|-----|--------|------|
| `PENDING` | `PROCESSING` | Worker 락 획득 | `locked_at`, `locked_by` 설정 |
| `PROCESSING` | `COMPLETED` | 송금 성공 | Transfer 상태가 COMPLETED |
| `PROCESSING` | `FAILED` | 송금 실패 | Transfer 상태가 FAILED |
| `FAILED` | `PROCESSING` | 재시도 | `attempt < max_attempts` AND `failure_type = RETRYABLE` |
| `FAILED` | `ABANDONED` | 포기 | `attempt >= max_attempts` OR `failure_type = FATAL` |

### 5.4 PENDING 사유 코드 (pending_reason)

> **v1.1 추가**: Job이 PENDING 상태인 이유를 명확히 합니다.

| pending_reason | 설명 | 예상 대기 시간 |
|----------------|------|---------------|
| `CREATED` | 방금 생성됨 | 즉시 처리 |
| `BANK_MAINTENANCE` | 은행 점검 시간 | 점검 종료까지 |
| `CIRCUIT_BREAKER` | 서킷브레이커 발동 | 가용잔액 회복까지 |
| `RATE_LIMITED` | API 호출 한도 초과 | 1분 후 |
| `SCHEDULED_RETRY` | 재시도 스케줄 대기 | next_retry_at까지 |

### 5.5 재시도 스케줄링

| 재시도 차수 | 대기 시간 | 누적 시간 | next_retry_at 계산 |
|-------------|-----------|-----------|-------------------|
| 1차 | 즉시 | 0분 | `NOW()` |
| 2차 | 1분 후 | 1분 | `NOW() + INTERVAL '1 minute'` |
| 3차 | 5분 후 | 6분 | `NOW() + INTERVAL '5 minutes'` |
| 4차 | 15분 후 | 21분 | `NOW() + INTERVAL '15 minutes'` |
| 5차 | 30분 후 | 51분 | `NOW() + INTERVAL '30 minutes'` |
| 포기 | - | - | `ABANDONED` 전환 |

> **FATAL 실패 시**: 재시도 없이 즉시 ABANDONED 전환

### 5.6 Job ↔ Deal 상태 매핑

| Job 상태 | Deal 상태 | 환불 가능 | 설명 |
|----------|-----------|-----------|------|
| `PENDING` | `TRANSFERRING` | ❌ | 송금 대기 중 (점검시간 포함) |
| `PROCESSING` | `TRANSFERRING` | ❌ | 송금 처리 중 |
| `COMPLETED` | `COMPLETED` | ❌ | 송금 성공, 거래 완료 |
| `FAILED` | `TRANSFER_FAILED` | ❌ | 재시도 대기 중 |
| `ABANDONED` | `TRANSFER_FAILED` | ✅ | 재시도 포기, 환불 가능 |

### 5.7 좀비 프로세스 방지

> **v1.1 추가**: PROCESSING 상태에서 응답이 없는 경우 처리

```yaml
정책: PROCESSING 상태 타임아웃
조건: locked_at으로부터 30분 경과
조치:
  1. 현재 Transfer를 FAILED (RETRYABLE) 처리
  2. Job을 FAILED로 전환
  3. 다음 재시도 스케줄링
  4. 관리자 알림 발송

구현:
  - 5분 주기 배치로 타임아웃 체크
  - locked_at + 30분 < NOW() 인 PROCESSING Job 탐지
```

---

## 6. User (회원) 상태

### 6.1 상태 정의

| 상태 | 코드 | 설명 | 서비스 이용 |
|------|------|------|-------------|
| **활성** | `ACTIVE` | 정상 회원 | ✅ 전체 가능 |
| **휴면** | `DORMANT` | 1년간 미로그인 | ⚠️ 재인증 후 이용 |
| **정지** | `SUSPENDED` | 관리자 정지 | ❌ 이용 불가 |
| **탈퇴** | `WITHDRAWN` | 회원 탈퇴 | ❌ 이용 불가 |

### 6.2 상태 전이 다이어그램

```
                    ┌───────────┐
                    │  ACTIVE   │◀─────────────────────┐
                    │  (활성)   │                       │
                    └─────┬─────┘                       │
                          │                             │
        ┌─────────────────┼─────────────────┐           │
        │                 │                 │           │
        │ [1년 미로그인]   │ [관리자 정지]    │ [탈퇴]    │
        │                 │                 │           │
        ▼                 ▼                 ▼           │
 ┌───────────┐     ┌───────────┐     ┌───────────┐     │
 │  DORMANT  │     │ SUSPENDED │     │ WITHDRAWN │     │
 │  (휴면)   │     │  (정지)   │     │  (탈퇴)   │     │
 └─────┬─────┘     └─────┬─────┘     └───────────┘     │
       │                 │                              │
       │ [재인증]        │ [정지 해제]                   │
       │                 │                              │
       └─────────────────┴──────────────────────────────┘
```

### 6.3 상태 전이 규칙

| From | To | 트리거 | 조건 |
|------|-----|--------|------|
| `ACTIVE` | `DORMANT` | 휴면 배치 | 1년간 로그인 없음 |
| `ACTIVE` | `SUSPENDED` | 관리자 정지 | 차지백, 이상거래 등 |
| `ACTIVE` | `WITHDRAWN` | 회원 탈퇴 | 진행 중 거래 없음 |
| `DORMANT` | `ACTIVE` | 재인증 | 본인인증 완료 |
| `SUSPENDED` | `ACTIVE` | 관리자 해제 | 정지 사유 해소 |

---

## 7. Card (카드) 상태

### 7.1 상태 정의

| 상태 | 코드 | 설명 | 결제 가능 |
|------|------|------|-----------|
| **활성** | `ACTIVE` | 정상 사용 가능 | ✅ |
| **만료** | `EXPIRED` | 유효기간 만료 | ❌ |
| **정지** | `SUSPENDED` | 관리자 정지 | ❌ |
| **삭제** | `DELETED` | 사용자 삭제 | ❌ |

### 7.2 상태 전이 다이어그램

```
                    ┌───────────┐
                    │  ACTIVE   │
                    │  (활성)   │
                    └─────┬─────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        │ [유효기간 만료]  │ [관리자 정지]   │ [사용자 삭제]
        │                 │                 │
        ▼                 ▼                 ▼
 ┌───────────┐     ┌───────────┐     ┌───────────┐
 │  EXPIRED  │     │ SUSPENDED │     │  DELETED  │
 │  (만료)   │     │  (정지)   │     │  (삭제)   │
 └───────────┘     └───────────┘     └───────────┘
```

### 7.3 상태 전이 규칙

| From | To | 트리거 | 조건 |
|------|-----|--------|------|
| `ACTIVE` | `EXPIRED` | 만료 배치 | 유효기간 도래 |
| `ACTIVE` | `SUSPENDED` | 관리자 정지 | 이상거래 등 |
| `ACTIVE` | `DELETED` | 사용자 삭제 | 진행 중 거래 없음 |

---

## 8. 상태별 허용 액션

### 8.1 Deal 상태별 허용 액션

| 액션 | PENDING | PAID | TRANSFERRING | COMPLETED | CANCELLED | REFUNDED | TRANSFER_FAILED |
|------|---------|------|--------------|-----------|-----------|----------|-----------------|
| 결제 시작 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 취소 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 환불 요청 | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ⚠️* |
| 송금 시작 | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 수동 재송금 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ⚠️** |
| 상세 조회 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 내역 조회 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |

> ⚠️* `TRANSFER_FAILED`에서 환불은 **Job 상태가 `ABANDONED`인 경우만** 가능
> ⚠️** 수동 재송금은 **Job 상태가 `ABANDONED`이고 환불 요청이 없는 경우만** 가능

### 8.2 User 상태별 허용 액션

| 액션 | ACTIVE | DORMANT | SUSPENDED | WITHDRAWN |
|------|--------|---------|-----------|-----------|
| 거래 생성 | ✅ | ❌ | ❌ | ❌ |
| 카드 등록 | ✅ | ❌ | ❌ | ❌ |
| 카드 삭제 | ✅ | ❌ | ❌ | ❌ |
| 로그인 | ✅ | ✅ | ✅ | ❌ |
| 거래 조회 | ✅ | ✅ | ✅ | ❌ |
| 정보 수정 | ✅ | ❌ | ❌ | ❌ |
| 탈퇴 요청 | ✅ | ✅ | ❌ | ❌ |

---

## 9. 환불 가능 조건 매트릭스

### 9.1 Deal + Job 상태 조합

| Deal 상태 | Job 상태 | 환불 가능 | 사유 |
|-----------|----------|-----------|------|
| `PENDING` | - | ❌ (취소 처리) | 결제 전이므로 취소로 처리 |
| `PAID` | - | ✅ | 송금 시작 전 |
| `TRANSFERRING` | `PENDING` | ❌ | 송금 프로세스 진입 |
| `TRANSFERRING` | `PROCESSING` | ❌ | 송금 처리 중 |
| `TRANSFER_FAILED` | `FAILED` | ❌ | 재시도 대기 중 |
| `TRANSFER_FAILED` | `ABANDONED` | ✅ | 재시도 포기, 환불 가능 |
| `COMPLETED` | `COMPLETED` | ❌ | 송금 완료, 환불 불가 |
| `CANCELLED` | - | ❌ | 이미 취소됨 |
| `REFUNDED` | - | ❌ | 이미 환불됨 |

### 9.2 환불 처리 흐름

```
[환불 요청]
      │
      ▼
[Deal 상태 확인]
      │
      ├── PAID ─────────────────────────────▶ 환불 진행 ✅
      │
      ├── TRANSFER_FAILED
      │         │
      │         ▼
      │    [Job 상태 확인]
      │         │
      │         ├── ABANDONED ─────────────▶ 환불 진행 ✅
      │         │
      │         └── FAILED ────────────────▶ 환불 불가 ❌
      │                                       "재시도 대기 중"
      │
      ├── TRANSFERRING ────────────────────▶ 환불 불가 ❌
      │                                       "송금 처리 중"
      │
      ├── COMPLETED ───────────────────────▶ 환불 불가 ❌
      │                                       "송금 완료"
      │
      └── PENDING ─────────────────────────▶ 취소 처리
                                              (환불 아님)
```

---

## 10. ABANDONED 처리 정책

### 10.1 ABANDONED 전환 조건

| 조건 | 설명 |
|------|------|
| 재시도 횟수 초과 | `attempt >= max_attempts (5)` |
| FATAL 오류 | `failure_type = FATAL` (계좌 오류, 예금주 불일치 등) |

### 10.2 ABANDONED 후 처리 경로

> **v1.1 추가**: 환불과 수동 재송금이 상호 배타적으로 처리됩니다.

```
[ABANDONED 상태]
      │
      ▼
[관리자 알림 발송]
      │
      ▼
[사용자/관리자 선택] ─────────────────┐
      │                              │
      │                              │
      ▼                              ▼
┌─────────────┐              ┌─────────────┐
│ 환불 요청   │              │ 수동 재송금  │
│             │              │ 요청        │
└──────┬──────┘              └──────┬──────┘
       │                            │
       │ [refund_lock 설정]         │ [retry_lock 설정]
       │                            │
       ▼                            ▼
  재송금 차단                   환불 차단
       │                            │
       ▼                            ▼
┌─────────────┐              ┌─────────────┐
│  REFUNDED   │              │ 계좌 수정 후 │
│             │              │ 재송금 처리  │
└─────────────┘              └─────────────┘

※ 두 경로는 상호 배타적 (먼저 선택한 경로로 진행)
```

### 10.3 경합 방지 규칙

| 규칙 | 설명 |
|------|------|
| **환불 요청 시** | `refund_requested_at` 설정, 수동 재송금 API 차단 |
| **수동 재송금 요청 시** | `retry_requested_at` 설정, 환불 API 차단 |
| **선착순 처리** | 먼저 요청된 경로로 진행, 후속 요청 거부 |

```sql
-- ABANDONED 상태에서 환불/재송금 경합 방지
-- transfer_jobs 테이블에 추가
refund_requested_at TIMESTAMP,      -- 환불 요청 시점 (설정되면 재송금 차단)
retry_requested_at TIMESTAMP        -- 수동 재송금 요청 시점 (설정되면 환불 차단)
```

---

## 11. 에러 상태 복구 플로우

### 11.1 송금 실패 복구

```
[송금 실패 발생]
      │
      ▼
[failure_type 확인]
      │
      ├── RETRYABLE (일시적 오류)
      │         │
      │         ▼
      │    자동 재시도 (최대 5회)
      │         │
      │         ├── 성공 ─────▶ COMPLETED
      │         │
      │         └── 5회 실패 ──▶ ABANDONED
      │
      └── FATAL (영구적 오류)
                │
                ▼
           즉시 ABANDONED ──▶ 환불/수동재송금 안내
```

### 11.2 미결 상태 탐지 (Dangling State Detection)

> **v1.1 추가**: 비정상적으로 오래 머무는 상태 탐지

```yaml
정책: 상태 정합성 배치 (매 10분)

탐지 대상:
  - PENDING Deal이 1시간 이상 유지 → PG 상태 동기화
  - TRANSFERRING Deal이 2시간 이상 유지 → Job 상태 확인
  - PROCESSING Job이 30분 이상 유지 → 타임아웃 처리

조치:
  - PG API로 결제 상태 확인 후 동기화
  - 송금사 API로 송금 상태 확인 후 동기화
  - 불일치 발견 시 관리자 알림
```

### 11.3 대사 불일치 복구

```
[대사 불일치 발견]
      │
      ▼
[불일치 유형 확인]
      │
      ├── 결제 성공 / 송금 누락
      │         │
      │         ▼
      │    송금 Job 생성 ──▶ 자동 송금
      │
      ├── 송금 성공 / 상태 미업데이트
      │         │
      │         ▼
      │    상태 동기화 ──▶ COMPLETED로 업데이트
      │
      └── 금액 불일치
                │
                ▼
           수동 조사 필요 ──▶ 관리자 알림
```

---

## 12. 상태 전이 로깅

### 12.1 로깅 정책

모든 상태 전이는 다음 정보와 함께 로깅됩니다:

| 로깅 항목 | 설명 |
|-----------|------|
| 테이블명 | 상태가 변경된 테이블 |
| 레코드 ID | 변경된 레코드의 ID |
| 이전 상태 | 변경 전 상태 |
| 새 상태 | 변경 후 상태 |
| 트리거 | 상태 전이를 유발한 이벤트 |
| 액터 | 변경을 수행한 주체 (시스템/사용자/관리자) |
| 타임스탬프 | 변경 시각 |
| 메타데이터 | 추가 정보 (failure_type, reason 등) |

### 12.2 로그 예시

```json
{
  "table": "deals",
  "record_id": "550e8400-e29b-41d4-a716-446655440000",
  "from_status": "PAID",
  "to_status": "TRANSFERRING",
  "trigger": "TRANSFER_JOB_CREATED",
  "actor": "SYSTEM",
  "timestamp": "2025-01-05T14:30:00+09:00",
  "metadata": {
    "job_id": "660e8400-e29b-41d4-a716-446655440001"
  }
}
```

```json
{
  "table": "transfers",
  "record_id": "770e8400-e29b-41d4-a716-446655440002",
  "from_status": "PROCESSING",
  "to_status": "FAILED",
  "trigger": "BANK_API_ERROR",
  "actor": "SYSTEM",
  "timestamp": "2025-01-05T14:31:00+09:00",
  "metadata": {
    "failure_type": "RETRYABLE",
    "failure_code": "BANK_MAINTENANCE",
    "failure_reason": "은행 점검 중"
  }
}
```

---

## 부록

### A. 상태 코드 Quick Reference

```
[Deal]
PENDING → PAID → TRANSFERRING → COMPLETED
                              → TRANSFER_FAILED → (TRANSFERRING / REFUNDED)
        → CANCELLED
PAID → REFUNDED

[Payment]
PENDING → PAID → CANCELLED / REFUNDED
        → FAILED

[Transfer] (시도 단위, 재시도 시 새 row)
PENDING → PROCESSING → COMPLETED
                     → FAILED (failure_type: RETRYABLE / FATAL)

[Transfer Job]
PENDING → PROCESSING → COMPLETED
                     → FAILED → PROCESSING (재시도)
                              → ABANDONED

[User]
ACTIVE ↔ DORMANT
ACTIVE → SUSPENDED → ACTIVE
ACTIVE → WITHDRAWN

[Card]
ACTIVE → EXPIRED / SUSPENDED / DELETED
```

### B. 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-05 | 초안 작성 | PLIC 개발팀 |
| 1.1 | 2025-01-05 | CTO 리뷰 반영 (상세 아래) | PLIC 개발팀 |

#### v1.1 변경 상세

| 구분 | 변경 내용 |
|------|-----------|
| **Transfer 모델 명확화** | Transfer = 시도(Attempt) 로그, 재시도 시 새 row 생성 |
| **Deal 타임스탬프 수정** | REFUNDED → refunded_at 기록 (cancelled_at 아님) |
| **Transfer failure_type 추가** | RETRYABLE / FATAL 구분, FATAL 시 즉시 ABANDONED |
| **ABANDONED 경합 방지** | 환불/수동재송금 상호 배타 규칙 추가 |
| **Job pending_reason 추가** | PENDING 사유 코드 정의 |
| **좀비 프로세스 방지** | PROCESSING 30분 타임아웃 정책 |
| **미결 상태 탐지** | 상태 정합성 배치 정책 추가 |

### C. 참고 문서

| 문서 | 관계 |
|------|------|
| PLIC_PRD.md | 상태 정책 요약 |
| PLIC_DB_SCHEMA.md | 테이블/컬럼 정의 |
| PLIC_GLOSSARY.md | 상태 코드 용어 정의 |
| PLIC_FUNDS_FLOW.md | 상태별 자금 흐름 |
| PLIC_EXTERNAL_INTERFACE.md | PG/송금사 상태 매핑 (예정) |
