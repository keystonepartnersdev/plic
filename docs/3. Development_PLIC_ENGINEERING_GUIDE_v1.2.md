# PLIC ì—”ì§€ë‹ˆì–´ë§ ê°€ì´ë“œ (ENGINEERING GUIDE)

## ğŸ“‹ ë¬¸ì„œ ì •ë³´

| í•­ëª© | ë‚´ìš© |
|------|------|
| ë¬¸ì„œëª… | PLIC Engineering Guide |
| ë²„ì „ | 1.2 |
| ì‘ì„±ì¼ | 2025-01-06 |
| ìˆ˜ì •ì¼ | 2025-01-06 |
| ì‘ì„±ì | PLIC ê°œë°œíŒ€ |
| ìƒíƒœ | Draft |
| ì—­í•  | **ê°œë°œ ê°€ì´ë“œ SSOT** |

---

## ë³€ê²½ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ | ë³€ê²½ ë‚´ìš© | ì‘ì„±ì |
|------|------|-----------|--------|
| 1.0 | 2025-01-06 | ì´ˆì•ˆ ì‘ì„± | PLIC ê°œë°œíŒ€ |
| 1.1 | 2025-01-06 | CTO ë¦¬ë·° ë°˜ì˜: ë©±ë“±ì„± í‘œì¤€, ìƒíƒœ ë³€ê²½ ê·œì¹™, SQS/Worker í‘œì¤€, ì™¸ë¶€ ì—°ë™ ê·œì¹™, Correlation ID, IAM Role, ë§ˆì´ê·¸ë ˆì´ì…˜ ê·œì¹™ ì¶”ê°€ | PLIC ê°œë°œíŒ€ |
| 1.2 | 2025-01-06 | ì„¹ì…˜ ë²ˆí˜¸ ì¬ì •ë¦¬, ë©±ë“±ì„± ìŠ¤í‚¤ë§ˆ í‘œì¤€, ê³µí†µ ì—ëŸ¬ ì½”ë“œ í‘œ, ë¡œê·¸ ë³´ì•ˆ ì›ì¹™, Worker ì¬ë“œë¼ì´ë¸Œ ì¡°ê±´ ì¶”ê°€ | PLIC ê°œë°œíŒ€ |

---

## ëª©ì°¨

1. [ê¸°ìˆ  ìŠ¤íƒ](#1-ê¸°ìˆ -ìŠ¤íƒ)
2. [í”„ë¡œì íŠ¸ êµ¬ì¡°](#2-í”„ë¡œì íŠ¸-êµ¬ì¡°)
3. [ì½”ë”© ì»¨ë²¤ì…˜](#3-ì½”ë”©-ì»¨ë²¤ì…˜)
4. [í•€í…Œí¬ í•„ìˆ˜ ê·œì¹™](#4-í•€í…Œí¬-í•„ìˆ˜-ê·œì¹™-ï¸-v11-ì¶”ê°€) âš ï¸
5. [ê³µí†µ ì—ëŸ¬ ì½”ë“œ](#5-ê³µí†µ-ì—ëŸ¬-ì½”ë“œ-ï¸-v12-ì¶”ê°€) âš ï¸
6. [Git ë¸Œëœì¹˜ ì „ëµ](#6-git-ë¸Œëœì¹˜-ì „ëµ)
7. [í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬](#7-í™˜ê²½-ë³€ìˆ˜-ê´€ë¦¬)
8. [ë°°í¬ íŒŒì´í”„ë¼ì¸](#8-ë°°í¬-íŒŒì´í”„ë¼ì¸)
9. [í”Œë«í¼ ì •ì±…](#9-í”Œë«í¼-ì •ì±…)
10. [í…ŒìŠ¤íŠ¸ ì „ëµ](#10-í…ŒìŠ¤íŠ¸-ì „ëµ)
11. [ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§](#11-ë¡œê¹…-ë°-ëª¨ë‹ˆí„°ë§)
12. [ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸](#12-ë³´ì•ˆ-ì²´í¬ë¦¬ìŠ¤íŠ¸)
13. [ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ê·œì¹™](#13-ë°ì´í„°ë² ì´ìŠ¤-ë§ˆì´ê·¸ë ˆì´ì…˜-ê·œì¹™-ï¸-v11-ì¶”ê°€)

---

## 1. ê¸°ìˆ  ìŠ¤íƒ

### 1.1 Frontend

| ì˜ì—­ | ê¸°ìˆ  | ë²„ì „ | ë¹„ê³  |
|------|------|------|------|
| **Framework** | Next.js (App Router) | 14.x | Monorepo êµ¬ì¡° |
| **Language** | TypeScript | 5.x | Strict Mode |
| **Styling** | Tailwind CSS | 3.x | - |
| **UI Components** | shadcn/ui | - | Radix UI ê¸°ë°˜ |
| **State Management** | Zustand | 4.x | Persist ë¯¸ë“¤ì›¨ì–´ |
| **Form** | React Hook Form + Zod | - | íƒ€ì… ì•ˆì „í•œ ê²€ì¦ |
| **Icons** | Lucide React | - | - |
| **HTTP Client** | Axios | - | ì¸í„°ì…‰í„° ì„¤ì • |

### 1.2 Backend

| ì˜ì—­ | ê¸°ìˆ  | ë²„ì „ | ë¹„ê³  |
|------|------|------|------|
| **Runtime** | Node.js | 20.x LTS | - |
| **Framework** | NestJS | 10.x | - |
| **ORM** | Prisma | 5.x | PostgreSQL |
| **Validation** | class-validator | - | DTO ê²€ì¦ |
| **API Docs** | Swagger | - | OpenAPI 3.0 |

### 1.3 Database

| ì˜ì—­ | ê¸°ìˆ  | ë²„ì „ | ë¹„ê³  |
|------|------|------|------|
| **Primary DB** | PostgreSQL | 15.x | RDS |
| **Cache** | Redis | 7.x | ElastiCache |
| **Message Queue** | Amazon SQS | - | FIFO Queue |

### 1.4 Infrastructure (AWS)

| ì„œë¹„ìŠ¤ | ìš©ë„ | ë¹„ê³  |
|--------|------|------|
| **ECS Fargate** | ì»¨í…Œì´ë„ˆ ì‹¤í–‰ | ì„œë²„ë¦¬ìŠ¤ |
| **ALB** | ë¡œë“œ ë°¸ëŸ°ì„œ | HTTPS ì¢…ë‹¨ |
| **RDS** | PostgreSQL | Multi-AZ |
| **ElastiCache** | Redis í´ëŸ¬ìŠ¤í„° | - |
| **SQS** | ë©”ì‹œì§€ í | FIFO |
| **Lambda** | ë°°ì¹˜ ì‘ì—… | EventBridge ì—°ë™ |
| **S3** | ì •ì  íŒŒì¼ | CloudFront ì—°ë™ |
| **CloudFront** | CDN | - |
| **KMS** | í‚¤ ê´€ë¦¬ | ì•”í˜¸í™” í‚¤ |
| **Secrets Manager** | ë¹„ë°€ ê´€ë¦¬ | í™˜ê²½ ë³€ìˆ˜ |
| **CloudWatch** | ëª¨ë‹ˆí„°ë§ | ë¡œê·¸, ë©”íŠ¸ë¦­ |

---

## 2. í”„ë¡œì íŠ¸ êµ¬ì¡°

### 2.1 Monorepo êµ¬ì¡°

```
plic/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ customer-web/           # ê³ ê° ì›¹ì•± (Next.js)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ app/           # App Router
â”‚   â”‚   â”‚   â”œâ”€â”€ components/    # ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/         # ì»¤ìŠ¤í…€ í›…
â”‚   â”‚   â”‚   â”œâ”€â”€ stores/        # Zustand ìŠ¤í† ì–´
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/           # ìœ í‹¸ë¦¬í‹°
â”‚   â”‚   â”‚   â””â”€â”€ types/         # íƒ€ì… ì •ì˜
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ admin-web/              # ì–´ë“œë¯¼ ì›¹ì•± (Next.js)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â””â”€â”€ types/
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ api/                    # API ì„œë²„ (NestJS)
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ modules/       # ê¸°ëŠ¥ ëª¨ë“ˆ
â”‚       â”‚   â”œâ”€â”€ common/        # ê³µí†µ ëª¨ë“ˆ
â”‚       â”‚   â”œâ”€â”€ config/        # ì„¤ì •
â”‚       â”‚   â””â”€â”€ main.ts
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/                 # ê³µìœ  ì½”ë“œ
â”‚   â”‚   â”œâ”€â”€ types/             # ê³µìœ  íƒ€ì…
â”‚   â”‚   â”œâ”€â”€ constants/         # ê³µìœ  ìƒìˆ˜
â”‚   â”‚   â””â”€â”€ utils/             # ê³µìœ  ìœ í‹¸
â”‚   â”‚
â”‚   â”œâ”€â”€ ui/                     # ê³µìœ  UI ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚
â”‚   â””â”€â”€ eslint-config/          # ESLint ì„¤ì •
â”‚
â”œâ”€â”€ infrastructure/             # IaC (Terraform/CDK)
â”‚   â”œâ”€â”€ terraform/
â”‚   â””â”€â”€ scripts/
â”‚
â”œâ”€â”€ docs/                       # ë¬¸ì„œ
â”‚   â””â”€â”€ *.md
â”‚
â”œâ”€â”€ package.json               # ë£¨íŠ¸ package.json
â”œâ”€â”€ pnpm-workspace.yaml        # pnpm ì›Œí¬ìŠ¤í˜ì´ìŠ¤
â”œâ”€â”€ turbo.json                 # Turborepo ì„¤ì •
â””â”€â”€ docker-compose.yml         # ë¡œì»¬ ê°œë°œ í™˜ê²½
```

### 2.2 ëª¨ë“ˆ êµ¬ì¡° (NestJS)

```
src/modules/
â”œâ”€â”€ auth/                      # ì¸ì¦
â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ guards/
â”‚   â””â”€â”€ strategies/
â”‚
â”œâ”€â”€ users/                     # ì‚¬ìš©ì
â”‚   â”œâ”€â”€ users.controller.ts
â”‚   â”œâ”€â”€ users.service.ts
â”‚   â”œâ”€â”€ users.module.ts
â”‚   â”œâ”€â”€ dto/
â”‚   â””â”€â”€ entities/
â”‚
â”œâ”€â”€ cards/                     # ì¹´ë“œ
â”œâ”€â”€ recipients/                # ìˆ˜ì·¨ì¸
â”œâ”€â”€ deals/                     # ê±°ë˜
â”œâ”€â”€ payments/                  # ê²°ì œ
â”œâ”€â”€ transfers/                 # ì†¡ê¸ˆ
â”œâ”€â”€ admin/                     # ê´€ë¦¬ì
â””â”€â”€ webhooks/                  # ì›¹í›…
```

---

## 3. ì½”ë”© ì»¨ë²¤ì…˜

### 3.1 ëª…ëª… ê·œì¹™

| ëŒ€ìƒ | ê·œì¹™ | ì˜ˆì‹œ |
|------|------|------|
| **íŒŒì¼ (ì»´í¬ë„ŒíŠ¸)** | PascalCase | `UserProfile.tsx` |
| **íŒŒì¼ (ìœ í‹¸/í›…)** | camelCase | `useAuth.ts`, `formatDate.ts` |
| **íŒŒì¼ (ìƒìˆ˜)** | camelCase | `constants.ts` |
| **ì»´í¬ë„ŒíŠ¸** | PascalCase | `UserProfile` |
| **í•¨ìˆ˜** | camelCase | `getUserById` |
| **ë³€ìˆ˜** | camelCase | `userName` |
| **ìƒìˆ˜** | UPPER_SNAKE_CASE | `MAX_CARD_COUNT` |
| **íƒ€ì…/ì¸í„°í˜ì´ìŠ¤** | PascalCase | `User`, `DealStatus` |
| **Enum** | PascalCase | `UserGrade`, `DealStatus` |
| **CSS í´ë˜ìŠ¤** | kebab-case | `user-profile` |

### 3.2 TypeScript ê·œì¹™

```typescript
// âœ… Good: ëª…ì‹œì  íƒ€ì… ì •ì˜
interface User {
  id: string;
  name: string;
  email: string;
  grade: UserGrade;
}

// âœ… Good: í•¨ìˆ˜ ë°˜í™˜ íƒ€ì… ëª…ì‹œ
function getUserById(id: string): Promise<User | null> {
  // ...
}

// âœ… Good: Enum ì‚¬ìš©
enum UserGrade {
  BASIC = 'BASIC',
  PLATINUM = 'PLATINUM',
}

// âŒ Bad: any ì‚¬ìš© ê¸ˆì§€
function processData(data: any) { }  // ê¸ˆì§€

// âŒ Bad: íƒ€ì… ë‹¨ì–¸ ë‚¨ìš©
const user = data as User;  // ìµœì†Œí™”
```

### 3.3 React ì»´í¬ë„ŒíŠ¸ ê·œì¹™

```tsx
// âœ… Good: í•¨ìˆ˜í˜• ì»´í¬ë„ŒíŠ¸ + Props íƒ€ì…
interface UserProfileProps {
  userId: string;
  onEdit?: () => void;
}

export function UserProfile({ userId, onEdit }: UserProfileProps) {
  // í›…ì€ ìµœìƒë‹¨ì—
  const [user, setUser] = useState<User | null>(null);
  const router = useRouter();

  // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  const handleEdit = useCallback(() => {
    onEdit?.();
  }, [onEdit]);

  // ì¡°ê±´ë¶€ ë Œë”ë§
  if (!user) {
    return <Loading />;
  }

  return (
    <div className="user-profile">
      {/* ... */}
    </div>
  );
}

// âŒ Bad: í´ë˜ìŠ¤ ì»´í¬ë„ŒíŠ¸ ì‚¬ìš© ê¸ˆì§€
class UserProfile extends React.Component { }  // ê¸ˆì§€
```

### 3.4 API ì‘ë‹µ ê·œì¹™

```typescript
// ì„±ê³µ ì‘ë‹µ
interface ApiResponse<T> {
  success: true;
  data: T;
}

// ì—ëŸ¬ ì‘ë‹µ
interface ApiErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: Record<string, string[]>;
  };
}

// í˜ì´ì§€ë„¤ì´ì…˜ ì‘ë‹µ
interface PaginatedResponse<T> {
  success: true;
  data: T[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

### 3.5 ì£¼ì„ ê·œì¹™

```typescript
/**
 * ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 * 
 * @param userId - ì‚¬ìš©ì ID
 * @returns ì‚¬ìš©ì ì •ë³´ ë˜ëŠ” null
 * @throws UserNotFoundException - ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
 */
async function getUserById(userId: string): Promise<User | null> {
  // ìºì‹œì—ì„œ ë¨¼ì € ì¡°íšŒ
  const cached = await cache.get(`user:${userId}`);
  if (cached) {
    return cached;
  }

  // DB ì¡°íšŒ
  const user = await prisma.user.findUnique({
    where: { id: userId },
  });

  // ìºì‹œ ì €ì¥ (TTL: 5ë¶„)
  if (user) {
    await cache.set(`user:${userId}`, user, 300);
  }

  return user;
}
```

---

## 4. í•€í…Œí¬ í•„ìˆ˜ ê·œì¹™ âš ï¸ (v1.1 ì¶”ê°€)

> âš ï¸ **PLICì€ ëˆ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.** ì•„ë˜ ê·œì¹™ì€ ì¤‘ë³µ ê²°ì œ/ì†¡ê¸ˆ ë°©ì§€ë¥¼ ìœ„í•œ í•„ìˆ˜ ì‚¬í•­ì…ë‹ˆë‹¤.

### 4.1 ë©±ë“±ì„±(Idempotency) í‘œì¤€

> ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„, ì›¹í›… ì¤‘ë³µ, ì›Œì»¤ ì¬ì²˜ë¦¬ë¡œ ì¸í•œ ì¤‘ë³µ ê²°ì œ/ì†¡ê¸ˆì´ ê°€ì¥ í° ë¦¬ìŠ¤í¬

**ì ìš© ëŒ€ìƒ ì—”ë“œí¬ì¸íŠ¸**:
| ì—”ë“œí¬ì¸íŠ¸ | ë©±ë“±í‚¤ í˜•ì‹ | ë¹„ê³  |
|-----------|------------|------|
| `POST /deals` | `{userId}_{timestamp}_{hash}` | ê±°ë˜ ìƒì„± |
| `POST /deals/{id}/confirm` | `PLIC_D{dealId}` | ê²°ì œ í™•ì • |
| `POST /deals/{id}/cancel` | `PLIC_D{dealId}_CANCEL` | ì·¨ì†Œ |
| `POST /deals/{id}/refund` | `PLIC_D{dealId}_REFUND` | í™˜ë¶ˆ |
| `POST /admin/deals/{id}/manual-transfer` | `PLIC_D{dealId}_MANUAL` | ìˆ˜ë™ ì†¡ê¸ˆ |

**ë©±ë“±ì„± ì²˜ë¦¬ ê·œì¹™**:

```typescript
// 1. í—¤ë”ì—ì„œ ë©±ë“±í‚¤ ì¶”ì¶œ
const idempotencyKey = req.headers['idempotency-key'];
if (!idempotencyKey) {
  throw new BadRequestException('IDEMPOTENCY_KEY_REQUIRED');
}

// 2. DBì—ì„œ ê¸°ì¡´ ìš”ì²­ ì¡°íšŒ (DBê°€ SSOT)
const existing = await prisma.idempotencyKey.findUnique({
  where: { key: idempotencyKey },
});

// 3. ë™ì¼ í‚¤ ì¡´ì¬ ì‹œ
if (existing) {
  // 3a. ìš”ì²­ í•´ì‹œ ë¹„êµ
  const requestHash = computeHash(req.body);
  if (existing.requestHash !== requestHash) {
    // âš ï¸ ë™ì¼ í‚¤ + ë‹¤ë¥¸ payload â†’ 409 Conflict
    throw new ConflictException('IDEMPOTENCY_KEY_CONFLICT');
  }
  
  // 3b. ì²˜ë¦¬ ì¤‘ì¸ ê²½ìš° â†’ 409
  if (existing.status === 'PROCESSING') {
    throw new ConflictException('REQUEST_IN_PROGRESS');
  }
  
  // 3c. ì™„ë£Œëœ ê²½ìš° â†’ ê¸°ì¡´ ì‘ë‹µ ë°˜í™˜
  return existing.response;
}

// 4. ìƒˆ ìš”ì²­ ì²˜ë¦¬
await prisma.$transaction(async (tx) => {
  // 4a. ë©±ë“±í‚¤ PROCESSINGìœ¼ë¡œ ìƒì„±
  await tx.idempotencyKey.create({
    data: {
      key: idempotencyKey,
      requestHash: computeHash(req.body),
      status: 'PROCESSING',
      expiresAt: addHours(new Date(), 24),
    },
  });
  
  // 4b. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
  const result = await executeBusinessLogic(tx, req.body);
  
  // 4c. ë©±ë“±í‚¤ COMPLETEDë¡œ ì—…ë°ì´íŠ¸
  await tx.idempotencyKey.update({
    where: { key: idempotencyKey },
    data: {
      status: 'COMPLETED',
      response: result,
    },
  });
  
  return result;
});
```

**ë©±ë“±í‚¤ ì €ì¥ì†Œ ì›ì¹™**:
| ì €ì¥ì†Œ | ì—­í•  | SSOT |
|--------|------|------|
| **DB (idempotency_keys)** | ë©±ë“±ì„± íŒë‹¨ì˜ ê·¼ê±° | âœ… **SSOT** |
| **Redis** | ë¶„ì‚° ë½, Rate Limit, ìºì‹œ | âŒ ë³´ì¡° |

> âš ï¸ Redis ì¥ì•  ì‹œì—ë„ DBë¡œ ë©±ë“±ì„± ë³´ì¥ ê°€ëŠ¥í•´ì•¼ í•¨

### 4.1.1 ë©±ë“±ì„± ìŠ¤í‚¤ë§ˆ í‘œì¤€ âš ï¸ (v1.2 ì¶”ê°€)

**idempotency_keys í…Œì´ë¸” í‘œì¤€**:

```sql
CREATE TABLE idempotency_keys (
  id VARCHAR(36) PRIMARY KEY,
  key VARCHAR(255) NOT NULL UNIQUE,      -- ë©±ë“±í‚¤ (í—¤ë”ì—ì„œ ìˆ˜ì‹ )
  request_hash VARCHAR(64) NOT NULL,     -- SHA-256 í•´ì‹œ (payload ê²€ì¦)
  status VARCHAR(20) NOT NULL,           -- PROCESSING, COMPLETED, FAILED
  response JSONB,                        -- ì‘ë‹µ ìºì‹œ (í¬ê¸° ì œí•œ í•„ìˆ˜)
  error_code VARCHAR(50),                -- ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë“œ
  expires_at TIMESTAMP NOT NULL,         -- ë§Œë£Œ ì‹œê°
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  INDEX idx_key (key),
  INDEX idx_expires (expires_at)
);
```

**ìš´ì˜ ì •ì±…**:

| í•­ëª© | ì •ì±… | ë¹„ê³  |
|------|------|------|
| **TTL** | 24ì‹œê°„ | ë§Œë£Œ í›„ ë™ì¼ í‚¤ë¡œ ìƒˆ ìš”ì²­ í—ˆìš© |
| **response í¬ê¸° ì œí•œ** | 64KB | ì´ˆê³¼ ì‹œ `{cached: false}` ì €ì¥ |
| **ë§Œë£Œ í‚¤ ì •ë¦¬** | ë§¤ì¼ 04:00 ë°°ì¹˜ | 7ì¼ ì´ìƒ ì§€ë‚œ í‚¤ ì‚­ì œ |
| **ì¬ìš”ì²­ í—ˆìš©** | ë§Œë£Œ í›„ì—ë§Œ | ë§Œë£Œ ì „ ë™ì¼ í‚¤ ì¬ì‚¬ìš© ë¶ˆê°€ |

**ë§Œë£Œ í‚¤ ì •ë¦¬ ë°°ì¹˜**:

```typescript
// ë§¤ì¼ 04:00 ì‹¤í–‰
async function cleanupExpiredIdempotencyKeys() {
  const result = await prisma.idempotencyKey.deleteMany({
    where: {
      expiresAt: {
        lt: subDays(new Date(), 7),  // 7ì¼ ì´ìƒ ì§€ë‚œ í‚¤
      },
    },
  });
  
  logger.info('Expired idempotency keys cleaned', { 
    deletedCount: result.count 
  });
}
```

### 4.2 ìƒíƒœ ë³€ê²½ ê·œì¹™ (Optimistic Lock)

> AWS ECS ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë™ì‹œ í˜¸ì¶œ ì‹œ ë°ì´í„° ì •í•©ì„± ë³´ì¥

**í•„ìˆ˜ ê·œì¹™**: Command API(ìƒíƒœ ë³€ê²½)ëŠ” ë°˜ë“œì‹œ `version` ì¡°ê±´ìœ¼ë¡œ UPDATE

```typescript
// âœ… Good: version ê¸°ë°˜ ìƒíƒœ ë³€ê²½
async function updateDealStatus(
  dealId: string, 
  newStatus: DealStatus,
  currentVersion: number
): Promise<Deal> {
  const result = await prisma.deal.updateMany({
    where: {
      id: dealId,
      version: currentVersion,  // âš ï¸ ë‚™ê´€ì  ë½
    },
    data: {
      status: newStatus,
      version: { increment: 1 },
      updatedAt: new Date(),
    },
  });

  if (result.count === 0) {
    // ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ë¨¼ì € ë³€ê²½í•¨
    throw new ConflictException('VERSION_CONFLICT');
  }

  return prisma.deal.findUnique({ where: { id: dealId } });
}

// âŒ Bad: version ì—†ì´ ìƒíƒœ ë³€ê²½
await prisma.deal.update({
  where: { id: dealId },
  data: { status: newStatus },  // ë™ì‹œ í˜¸ì¶œ ì‹œ ë°ì´í„° ì†ì‹¤!
});
```

**íŠ¸ëœì­ì…˜ ê²½ê³„ ê·œì¹™**:

```
[ë‹¨ì¼ íŠ¸ëœì­ì…˜ì— í¬í•¨]
- deal ìƒíƒœ ë³€ê²½
- payment (ë‚´ë¶€ ê¸°ë¡)
- idempotency_keys

[ì™¸ë¶€ í˜¸ì¶œì€ íŠ¸ëœì­ì…˜ ì™¸ë¶€ + Jobìœ¼ë¡œ ë¶„ë¦¬]
- PG ê²°ì œ ìŠ¹ì¸/ì·¨ì†Œ
- ì†¡ê¸ˆ ìš”ì²­
- ì›¹í›… ë°œì†¡
```

```typescript
// âœ… Good: íŠ¸ëœì­ì…˜ ê²½ê³„ ë¶„ë¦¬
async function confirmDeal(dealId: string) {
  // 1. DB íŠ¸ëœì­ì…˜ (ë‚´ë¶€ ìƒíƒœë§Œ)
  const deal = await prisma.$transaction(async (tx) => {
    const deal = await tx.deal.update({
      where: { id: dealId, version: currentVersion },
      data: { status: 'CONFIRMING', version: { increment: 1 } },
    });
    
    await tx.payment.create({ data: { dealId, status: 'PENDING' } });
    
    return deal;
  });

  // 2. ì™¸ë¶€ í˜¸ì¶œ (íŠ¸ëœì­ì…˜ ì™¸ë¶€)
  try {
    const pgResult = await pgClient.approve(deal.paymentKey);
    // ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
  } catch (error) {
    // ì‹¤íŒ¨ ì‹œ ë³´ìƒ ë¡œì§ ë˜ëŠ” Job ìŠ¤ì¼€ì¤„ë§
    await scheduleRetryJob(dealId);
  }
}
```

### 4.3 SQS/Worker ì²˜ë¦¬ í‘œì¤€

> ë©”ì‹œì§€ í ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬ì˜ ë©±ë“±ì„± ë° ì•ˆì •ì„± ë³´ì¥

**ë©”ì‹œì§€ ìŠ¤í‚¤ë§ˆ**:

```typescript
interface QueueMessage {
  // ë©”ì‹œì§€ ì‹ë³„
  messageId: string;           // SQS ë©”ì‹œì§€ ID
  messageGroupId: string;      // FIFO ê·¸ë£¹ (dealId)
  
  // ë©±ë“±í‚¤ (ë¶„ë¦¬ í•„ìˆ˜!)
  externalIdempotencyKey: string;  // ì™¸ë¶€ ì „ë‹¬ìš© (deal ë‹¨ìœ„ ê³ ì •)
  jobKey: string;                   // ë‚´ë¶€ ì²˜ë¦¬ìš© (attempt í¬í•¨)
  
  // í˜ì´ë¡œë“œ
  action: 'TRANSFER' | 'REFUND';
  dealId: string;
  amount: number;
  recipientAccount: EncryptedAccount;
  
  // ë©”íƒ€ë°ì´í„°
  attemptCount: number;
  scheduledAt: string;
  correlationId: string;       // ì¶”ì ìš©
}
```

**Worker ì²˜ë¦¬ ëª¨ë¸**:

```typescript
async function processTransferMessage(message: QueueMessage) {
  const { dealId, jobKey, externalIdempotencyKey } = message;

  // 1. DBì—ì„œ Job ìƒíƒœ í™•ì¸ (ë½ + ê²€ì¦)
  const job = await prisma.$transaction(async (tx) => {
    const job = await tx.transferJob.findFirst({
      where: { 
        dealId,
        status: { in: ['PENDING', 'PROCESSING'] },
      },
      select: { id: true, status: true, version: true },
    });

    if (!job) {
      // ì´ë¯¸ ì™„ë£Œ ë˜ëŠ” ì·¨ì†Œë¨
      return null;
    }

    // ìƒíƒœë¥¼ PROCESSINGìœ¼ë¡œ ë³€ê²½ (ë‚™ê´€ì  ë½)
    await tx.transferJob.update({
      where: { id: job.id, version: job.version },
      data: { status: 'PROCESSING', version: { increment: 1 } },
    });

    return job;
  });

  if (!job) {
    // ë©”ì‹œì§€ ì‚­ì œ (ì´ë¯¸ ì²˜ë¦¬ë¨)
    return { deleteMessage: true };
  }

  // 2. ì™¸ë¶€ ì†¡ê¸ˆ API í˜¸ì¶œ
  try {
    const result = await transferClient.send({
      idempotencyKey: externalIdempotencyKey,  // âš ï¸ deal ë‹¨ìœ„ ê³ ì •
      // ...
    });

    // 3. ì„±ê³µ ì²˜ë¦¬
    await updateJobStatus(job.id, 'COMPLETED', result);
    return { deleteMessage: true };

  } catch (error) {
    // 4. ì‹¤íŒ¨ ì²˜ë¦¬
    if (isRetryable(error)) {
      // Visibility Timeout í›„ ìë™ ì¬ì‹œë„
      return { deleteMessage: false };
    } else {
      // ì˜êµ¬ ì‹¤íŒ¨ â†’ DLQ ë˜ëŠ” FAILED ìƒíƒœ
      await updateJobStatus(job.id, 'FAILED', error);
      return { deleteMessage: true };
    }
  }
}
```

**DLQ (Dead Letter Queue) ê·œì¹™**:

| í•­ëª© | ê°’ | ë¹„ê³  |
|------|-----|------|
| maxReceiveCount | 5 | 5íšŒ ì‹¤íŒ¨ ì‹œ DLQ ì´ë™ |
| DLQ ë³´ê´€ ê¸°ê°„ | 14ì¼ | ìˆ˜ë™ ì²˜ë¦¬ ì‹œê°„ í™•ë³´ |
| DLQ ì•Œë¦¼ | CloudWatch Alarm | Slack ì—°ë™ |

**DLQ ë°œìƒ ì‹œ SOP**:
1. ì•Œë¦¼ ìˆ˜ì‹  (Slack #plic-alerts)
2. CloudWatch Logsì—ì„œ ì‹¤íŒ¨ ì›ì¸ í™•ì¸
3. ì›ì¸ë³„ ì²˜ë¦¬:
   - ì¼ì‹œì  ì¥ì•  â†’ ì¬ë“œë¼ì´ë¸Œ (redrive)
   - ë°ì´í„° ì˜¤ë¥˜ â†’ ìˆ˜ë™ ìˆ˜ì • í›„ ì¬ë“œë¼ì´ë¸Œ
   - ë¹„ì¦ˆë‹ˆìŠ¤ ì˜¤ë¥˜ â†’ Adminì—ì„œ ìˆ˜ë™ ì²˜ë¦¬
4. ì²˜ë¦¬ ê²°ê³¼ í‹°ì¼“ì— ê¸°ë¡

### 4.3.1 ì¬ë“œë¼ì´ë¸Œ(Redrive) ì •ì±… âš ï¸ (v1.2 ì¶”ê°€)

> âš ï¸ ëª¨ë“  DLQ ë©”ì‹œì§€ë¥¼ ë¬´ì¡°ê±´ ì¬ë“œë¼ì´ë¸Œí•˜ë©´ ì•ˆ ë¨

**ì¬ë“œë¼ì´ë¸Œ í—ˆìš© ì¡°ê±´**:

| ì—ëŸ¬ ìœ í˜• | ì¬ë“œë¼ì´ë¸Œ | ì¡°ê±´ |
|----------|-----------|------|
| `NETWORK_TIMEOUT` | âœ… í—ˆìš© | ì›ë³¸ ì¥ì•  ë³µêµ¬ í™•ì¸ í›„ |
| `SERVICE_UNAVAILABLE` | âœ… í—ˆìš© | ì›ë³¸ ì¥ì•  ë³µêµ¬ í™•ì¸ í›„ |
| `RATE_LIMIT_EXCEEDED` | âœ… í—ˆìš© | 1ì‹œê°„ ëŒ€ê¸° í›„ |
| `INVALID_ACCOUNT` | âŒ ê¸ˆì§€ | ë°ì´í„° ìˆ˜ì • í•„ìš” |
| `INSUFFICIENT_BALANCE` | âŒ ê¸ˆì§€ | ìš´ì˜ ìê¸ˆ ì¶©ì „ í›„ Adminì—ì„œ ìˆ˜ë™ |
| `DUPLICATE_REQUEST` | âŒ ê¸ˆì§€ | ì´ë¯¸ ì²˜ë¦¬ë¨ (í™•ì¸ë§Œ) |
| `BUSINESS_RULE_VIOLATION` | âŒ ê¸ˆì§€ | ë¶„ì„ í›„ ìˆ˜ë™ ì²˜ë¦¬ |

**ì¬ë“œë¼ì´ë¸Œ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] ì›ë³¸ ì¥ì•  ì›ì¸ íŒŒì•… ì™„ë£Œ
- [ ] ì›ë³¸ ì‹œìŠ¤í…œ ì •ìƒí™” í™•ì¸
- [ ] ì¬ë“œë¼ì´ë¸Œ ëŒ€ìƒ ë©”ì‹œì§€ ìˆ˜ í™•ì¸
- [ ] ë‹´ë‹¹ì ìŠ¹ì¸ (10ê±´ ì´ˆê³¼ ì‹œ)

**Job ê²°ê³¼ ì €ì¥ ìŠ¤í‚¤ë§ˆ**:

```typescript
// transfer_jobs í…Œì´ë¸” í™•ì¥
{
  // ê¸°ì¡´ í•„ë“œ...
  
  // ê²°ê³¼ ì €ì¥ (v1.2)
  external_response: JSONB,    // ì™¸ë¶€ API ì‘ë‹µ ì›ë³¸
  error_code: VARCHAR(50),     // ì—ëŸ¬ ì½”ë“œ
  error_message: TEXT,         // ì—ëŸ¬ ë©”ì‹œì§€
  attempt_count: INT,          // ì‹œë„ íšŸìˆ˜
  last_attempt_at: TIMESTAMP,  // ë§ˆì§€ë§‰ ì‹œë„ ì‹œê°
}
```

### 4.4 ì™¸ë¶€ ì—°ë™ í˜¸ì¶œ ê·œì¹™

> ì™¸ë¶€ API í˜¸ì¶œì˜ timeout, retry, circuit breaker í‘œì¤€

**ê³µí†µ HTTP í´ë¼ì´ì–¸íŠ¸ ì„¤ì •**:

```typescript
// external-client.ts
const DEFAULT_CONFIG = {
  // Timeout (ì—°ê²° + ì½ê¸°)
  connectTimeout: 5000,   // 5ì´ˆ
  readTimeout: 60000,     // 60ì´ˆ (ê²°ì œ/ì†¡ê¸ˆ)
  
  // Retry
  maxRetries: 3,
  retryableStatuses: [408, 429, 500, 502, 503, 504],
  
  // Backoff (ì§€ìˆ˜ ë°±ì˜¤í”„ + Jitter)
  initialDelay: 1000,     // 1ì´ˆ
  maxDelay: 30000,        // 30ì´ˆ
  multiplier: 2,
  jitter: 0.2,            // Â±20%
};

// âš ï¸ ëˆ ê´€ë ¨ APIëŠ” ë¬´í•œ ì¬ì‹œë„ ê¸ˆì§€
const PAYMENT_CONFIG = {
  ...DEFAULT_CONFIG,
  maxRetries: 2,          // ìµœëŒ€ 2íšŒ
  readTimeout: 60000,     // 60ì´ˆ
};

const TRANSFER_CONFIG = {
  ...DEFAULT_CONFIG,
  maxRetries: 0,          // ì¬ì‹œë„ ê¸ˆì§€! Jobìœ¼ë¡œ ê´€ë¦¬
  readTimeout: 60000,
};
```

**Timeout ê¸°ì¤€**:

| API ìœ í˜• | Connect | Read | ë¹„ê³  |
|---------|---------|------|------|
| ê²°ì œ ìŠ¹ì¸/ì·¨ì†Œ | 5ì´ˆ | 60ì´ˆ | PG ì²˜ë¦¬ ì‹œê°„ ê³ ë ¤ |
| ì†¡ê¸ˆ ìš”ì²­ | 5ì´ˆ | 60ì´ˆ | ì€í–‰ ì—°ë™ ì‹œê°„ |
| ë³¸ì¸ì¸ì¦ | 5ì´ˆ | 30ì´ˆ | - |
| ì¡°íšŒ API | 3ì´ˆ | 10ì´ˆ | ë¹ ë¥¸ ì‘ë‹µ ê¸°ëŒ€ |

**Retry ì •ì±…**:

```typescript
// Retryable ì—ëŸ¬ íŒë‹¨
function isRetryable(error: Error): boolean {
  // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬
  if (error.code === 'ECONNRESET' || error.code === 'ETIMEDOUT') {
    return true;
  }
  
  // HTTP ìƒíƒœ ì½”ë“œ
  if (error.response) {
    const status = error.response.status;
    return [408, 429, 500, 502, 503, 504].includes(status);
  }
  
  return false;
}

// âš ï¸ íƒ€ì„ì•„ì›ƒ â‰  ì‹¤íŒ¨
// íƒ€ì„ì•„ì›ƒ ë°œìƒ ì‹œ ë°˜ë“œì‹œ ì¡°íšŒ APIë¡œ ìƒíƒœ í™•ì¸
async function handleTimeout(dealId: string) {
  // 1. PG ì¡°íšŒ API í˜¸ì¶œ
  const status = await pgClient.getPaymentStatus(dealId);
  
  // 2. ìƒíƒœì— ë”°ë¼ ì²˜ë¦¬
  if (status === 'SUCCESS') {
    // ë‚´ë¶€ ìƒíƒœ ë™ê¸°í™”
  } else if (status === 'FAILED') {
    // ì‹¤íŒ¨ ì²˜ë¦¬
  } else {
    // ì¡°íšŒë„ ì‹¤íŒ¨ â†’ PENDING ìœ ì§€, ì¬ì¡°íšŒ ìŠ¤ì¼€ì¤„ë§
    await scheduleStatusCheck(dealId);
  }
}
```

**Circuit Breaker**:

```typescript
// circuit-breaker.config.ts
const CIRCUIT_BREAKER_CONFIG = {
  // ì„ê³„ê°’
  failureThreshold: 5,        // 5íšŒ ì—°ì† ì‹¤íŒ¨
  successThreshold: 3,        // 3íšŒ ì—°ì† ì„±ê³µ ì‹œ ë³µêµ¬
  
  // íƒ€ì´ë°
  timeout: 60000,             // 60ì´ˆ í›„ Half-Open
  
  // ìƒíƒœ
  // CLOSED: ì •ìƒ ë™ì‘
  // OPEN: ëª¨ë“  ìš”ì²­ ì¦‰ì‹œ ì‹¤íŒ¨
  // HALF_OPEN: ì¼ë¶€ ìš”ì²­ë§Œ í—ˆìš©
};

// ì‚¬ìš© ì˜ˆì‹œ
const pgCircuitBreaker = new CircuitBreaker(pgClient.approve, {
  ...CIRCUIT_BREAKER_CONFIG,
  fallback: () => {
    throw new ServiceUnavailableException('PG_CIRCUIT_OPEN');
  },
});
```

### 4.5 Correlation ID (ê´€ì¸¡ì„±)

> ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ìš”ì²­ ì¶”ì ì„ ìœ„í•œ ID ì „íŒŒ ê·œì¹™

**ID ì²´ê³„**:

| ID | ìƒì„± ì‹œì  | ë²”ìœ„ | ì˜ˆì‹œ |
|----|----------|------|------|
| `requestId` | API Gateway | ë‹¨ì¼ HTTP ìš”ì²­ | `req_abc123` |
| `traceId` | ì²« ì§„ì…ì  | ì „ì²´ íŠ¸ëœì­ì…˜ | `trace_xyz789` |
| `spanId` | ê° ì„œë¹„ìŠ¤ | ì„œë¹„ìŠ¤ë³„ ì‘ì—… | `span_def456` |

**ì „íŒŒ ê·œì¹™**:

```
[API ìš”ì²­]
  â”‚
  â”œâ”€ Header: X-Request-Id, X-Trace-Id
  â”‚
  â–¼
[API Server]
  â”‚
  â”œâ”€ ë¡œê·¸: { traceId, requestId, dealId, userId }
  â”‚
  â”œâ”€ DB ì¿¼ë¦¬: /* traceId: xxx */ SELECT ...
  â”‚
  â”œâ”€ SQS ë©”ì‹œì§€: { correlationId: traceId, ... }
  â”‚
  â–¼
[Worker]
  â”‚
  â”œâ”€ ë¡œê·¸: { traceId, jobId, dealId }
  â”‚
  â”œâ”€ ì™¸ë¶€ API Header: X-Correlation-Id
  â”‚
  â–¼
[External Service]
```

**êµ¬í˜„ ì˜ˆì‹œ**:

```typescript
// middleware/correlation.ts
export function correlationMiddleware(req, res, next) {
  const traceId = req.headers['x-trace-id'] || generateTraceId();
  const requestId = req.headers['x-request-id'] || generateRequestId();
  
  // AsyncLocalStorageì— ì €ì¥ (ì „ì—­ ì ‘ê·¼)
  asyncLocalStorage.run({ traceId, requestId }, () => {
    res.setHeader('X-Request-Id', requestId);
    res.setHeader('X-Trace-Id', traceId);
    next();
  });
}

// logger.ts
export function log(level: string, message: string, context: object) {
  const { traceId, requestId } = asyncLocalStorage.getStore() || {};
  
  console.log(JSON.stringify({
    timestamp: new Date().toISOString(),
    level,
    message,
    traceId,
    requestId,
    ...context,
  }));
}

// ì™¸ë¶€ API í˜¸ì¶œ ì‹œ
const response = await axios.post(url, data, {
  headers: {
    'X-Correlation-Id': asyncLocalStorage.getStore()?.traceId,
  },
});
```

**ë¡œê·¸ í•„ìˆ˜ í•„ë“œ** (PII ì œì™¸):

```typescript
// âœ… ë°˜ë“œì‹œ í¬í•¨
{
  traceId: 'trace_xyz789',
  requestId: 'req_abc123',
  dealId: 'deal_001',           // ê±°ë˜ ì¶”ì 
  userId: 'user_123',           // ì‚¬ìš©ì ì¶”ì  (ë§ˆìŠ¤í‚¹ ë¶ˆí•„ìš”)
  action: 'PAYMENT_CONFIRM',
  duration: 1234,
}

// âŒ ì ˆëŒ€ í¬í•¨ ê¸ˆì§€
{
  cardNumber: '...',
  ci: '...',
  accountNumber: '...',
  password: '...',
}
```

---

## 5. ê³µí†µ ì—ëŸ¬ ì½”ë“œ âš ï¸ (v1.2 ì¶”ê°€)

> í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ/ìš´ì˜ì´ ê°™ì€ ì–¸ì–´ë¡œ ì†Œí†µí•˜ê¸° ìœ„í•œ í‘œì¤€ ì—ëŸ¬ ì½”ë“œ

### 5.1 HTTP ìƒíƒœ ì½”ë“œ ë§¤í•‘

| HTTP | ìš©ë„ | ì¬ì‹œë„ |
|------|------|--------|
| `200` | ì„±ê³µ | - |
| `201` | ìƒì„± ì„±ê³µ | - |
| `400` | ì˜ëª»ëœ ìš”ì²­ (í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜) | âŒ |
| `401` | ì¸ì¦ ì‹¤íŒ¨ | âŒ (ì¬ë¡œê·¸ì¸) |
| `403` | ê¶Œí•œ ì—†ìŒ | âŒ |
| `404` | ë¦¬ì†ŒìŠ¤ ì—†ìŒ | âŒ |
| `409` | ì¶©ëŒ (ë©±ë“±í‚¤, ë²„ì „) | âŒ (í™•ì¸ í•„ìš”) |
| `422` | ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ìœ„ë°˜ | âŒ |
| `429` | Rate Limit ì´ˆê³¼ | âœ… (ëŒ€ê¸° í›„) |
| `500` | ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ | âœ… |
| `502` | ê²Œì´íŠ¸ì›¨ì´ ì˜¤ë¥˜ | âœ… |
| `503` | ì„œë¹„ìŠ¤ ë¶ˆê°€ | âœ… (ëŒ€ê¸° í›„) |
| `504` | ê²Œì´íŠ¸ì›¨ì´ íƒ€ì„ì•„ì›ƒ | âœ… |

### 5.2 ë¹„ì¦ˆë‹ˆìŠ¤ ì—ëŸ¬ ì½”ë“œ í‘œì¤€

| ì½”ë“œ | HTTP | ì„¤ëª… | ì‚¬ìš©ì ë©”ì‹œì§€ |
|------|------|------|-------------|
| **ì¸ì¦/ì¸ê°€** ||||
| `AUTH_001` | 401 | í† í° ë§Œë£Œ | ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš” |
| `AUTH_002` | 401 | í† í° ë¬´íš¨ | ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš” |
| `AUTH_003` | 403 | ê¶Œí•œ ì—†ìŒ | ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤ |
| `AUTH_004` | 401 | ë³¸ì¸ì¸ì¦ í•„ìš” | ë³¸ì¸ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤ |
| **ë©±ë“±ì„±/ë™ì‹œì„±** ||||
| `IDEMPOTENCY_KEY_REQUIRED` | 400 | ë©±ë“±í‚¤ ëˆ„ë½ | (ë‚´ë¶€ ì˜¤ë¥˜) |
| `IDEMPOTENCY_KEY_CONFLICT` | 409 | ë™ì¼ í‚¤ + ë‹¤ë¥¸ payload | ìš”ì²­ì´ ì¶©ëŒí–ˆìŠµë‹ˆë‹¤ |
| `REQUEST_IN_PROGRESS` | 409 | ë™ì¼ ìš”ì²­ ì²˜ë¦¬ ì¤‘ | ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” |
| `VERSION_CONFLICT` | 409 | ë²„ì „ ë¶ˆì¼ì¹˜ (ë‚™ê´€ì  ë½) | ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” |
| **ì‚¬ìš©ì** ||||
| `USER_001` | 404 | ì‚¬ìš©ì ì—†ìŒ | ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ |
| `USER_002` | 409 | ì´ë¯¸ ê°€ì…ëœ CI | ì´ë¯¸ ê°€ì…ëœ íšŒì›ì…ë‹ˆë‹¤ |
| `USER_003` | 422 | íœ´ë©´ ìƒíƒœ | íœ´ë©´ í•´ì œê°€ í•„ìš”í•©ë‹ˆë‹¤ |
| `USER_004` | 422 | íƒˆí‡´ ëŒ€ê¸° ì¤‘ | íƒˆí‡´ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤ |
| **ì¹´ë“œ** ||||
| `CARD_001` | 404 | ì¹´ë“œ ì—†ìŒ | ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ |
| `CARD_002` | 422 | ìµœëŒ€ ì¹´ë“œ ìˆ˜ ì´ˆê³¼ | ì¹´ë“œëŠ” ìµœëŒ€ 5ì¥ê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤ |
| `CARD_003` | 422 | ì¹´ë“œ ë§Œë£Œ | ì¹´ë“œê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤ |
| `CARD_004` | 422 | ì¹´ë“œ ë¹„í™œì„±í™” | ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì¹´ë“œì…ë‹ˆë‹¤ |
| **ê±°ë˜** ||||
| `DEAL_001` | 404 | ê±°ë˜ ì—†ìŒ | ê±°ë˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ |
| `DEAL_002` | 422 | ì›” í•œë„ ì´ˆê³¼ | ì´ë²ˆ ë‹¬ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤ |
| `DEAL_003` | 422 | ê±´ë‹¹ í•œë„ ì´ˆê³¼ | 1íšŒ ìµœëŒ€ ê¸ˆì•¡ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤ |
| `DEAL_004` | 422 | ìµœì†Œ ê¸ˆì•¡ ë¯¸ë‹¬ | ìµœì†Œ ê¸ˆì•¡ì€ 10,000ì›ì…ë‹ˆë‹¤ |
| `DEAL_005` | 422 | ì˜ëª»ëœ ìƒíƒœ ì „ì´ | ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤ |
| `DEAL_006` | 422 | ì·¨ì†Œ ë¶ˆê°€ | ì·¨ì†Œí•  ìˆ˜ ì—†ëŠ” ê±°ë˜ì…ë‹ˆë‹¤ |
| **ê²°ì œ** ||||
| `PAYMENT_001` | 422 | ê²°ì œ ì‹¤íŒ¨ | ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ |
| `PAYMENT_002` | 422 | ì¹´ë“œ í•œë„ ì´ˆê³¼ | ì¹´ë“œ í•œë„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš” |
| `PAYMENT_003` | 422 | ì¹´ë“œì‚¬ ê±°ì ˆ | ì¹´ë“œì‚¬ì—ì„œ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤ |
| `PAYMENT_004` | 504 | ê²°ì œ íƒ€ì„ì•„ì›ƒ | ê²°ì œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ í™•ì¸í•´ì£¼ì„¸ìš” |
| **ì†¡ê¸ˆ** ||||
| `TRANSFER_001` | 422 | ì†¡ê¸ˆ ì‹¤íŒ¨ | ì†¡ê¸ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ |
| `TRANSFER_002` | 422 | ìœ íš¨í•˜ì§€ ì•Šì€ ê³„ì¢Œ | ê³„ì¢Œ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš” |
| `TRANSFER_003` | 422 | íœ´ë©´ ê³„ì¢Œ | íœ´ë©´ ê³„ì¢Œë¡œ ì†¡ê¸ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ |
| `TRANSFER_004` | 503 | ìš´ì˜ ìê¸ˆ ë¶€ì¡± (ì„œí‚·ë¸Œë ˆì´ì»¤) | ì¼ì‹œì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì´ìš©ì´ ë¶ˆê°€í•©ë‹ˆë‹¤ |
| **ì™¸ë¶€ ì„œë¹„ìŠ¤** ||||
| `EXTERNAL_001` | 502 | PG ì—°ë™ ì˜¤ë¥˜ | ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” |
| `EXTERNAL_002` | 502 | ì†¡ê¸ˆì‚¬ ì—°ë™ ì˜¤ë¥˜ | ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” |
| `EXTERNAL_003` | 502 | ë³¸ì¸ì¸ì¦ ì—°ë™ ì˜¤ë¥˜ | ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” |
| `PG_CIRCUIT_OPEN` | 503 | PG ì„œí‚·ë¸Œë ˆì´ì»¤ | ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” |

### 5.3 ì—ëŸ¬ ì‘ë‹µ í˜•ì‹

```typescript
// ë‹¨ì¼ ì—ëŸ¬
{
  "success": false,
  "error": {
    "code": "DEAL_002",
    "message": "ì´ë²ˆ ë‹¬ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤",
    "details": {
      "currentUsage": 4500000,
      "monthlyLimit": 5000000,
      "requestAmount": 1000000
    }
  }
}

// ìœ íš¨ì„± ê²€ì‚¬ ì—ëŸ¬ (ë‹¤ì¤‘)
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”",
    "details": {
      "amount": ["ìµœì†Œ ê¸ˆì•¡ì€ 10,000ì›ì…ë‹ˆë‹¤"],
      "recipientId": ["ìˆ˜ì·¨ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”"]
    }
  }
}
```

---

## 6. Git ë¸Œëœì¹˜ ì „ëµ

### 6.1 ë¸Œëœì¹˜ êµ¬ì¡°

```
main                    # í”„ë¡œë•ì…˜ (ë³´í˜¸ë¨)
â”œâ”€â”€ develop             # ê°œë°œ í†µí•© (ë³´í˜¸ë¨)
â”‚   â”œâ”€â”€ feature/xxx     # ê¸°ëŠ¥ ê°œë°œ
â”‚   â”œâ”€â”€ fix/xxx         # ë²„ê·¸ ìˆ˜ì •
â”‚   â””â”€â”€ refactor/xxx    # ë¦¬íŒ©í† ë§
â”‚
â”œâ”€â”€ release/x.x.x       # ë¦´ë¦¬ìŠ¤ ì¤€ë¹„
â””â”€â”€ hotfix/xxx          # ê¸´ê¸‰ ìˆ˜ì •
```

### 6.2 ë¸Œëœì¹˜ ëª…ëª…

| ìœ í˜• | í˜•ì‹ | ì˜ˆì‹œ |
|------|------|------|
| ê¸°ëŠ¥ | `feature/{ticket}-{description}` | `feature/PLIC-123-user-login` |
| ë²„ê·¸ | `fix/{ticket}-{description}` | `fix/PLIC-456-login-error` |
| ë¦¬íŒ©í† ë§ | `refactor/{description}` | `refactor/auth-module` |
| ë¦´ë¦¬ìŠ¤ | `release/{version}` | `release/1.2.0` |
| í•«í”½ìŠ¤ | `hotfix/{ticket}-{description}` | `hotfix/PLIC-789-critical-bug` |

### 6.3 ì»¤ë°‹ ë©”ì‹œì§€

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**:
- `feat`: ìƒˆë¡œìš´ ê¸°ëŠ¥
- `fix`: ë²„ê·¸ ìˆ˜ì •
- `docs`: ë¬¸ì„œ ë³€ê²½
- `style`: ì½”ë“œ í¬ë§·íŒ…
- `refactor`: ë¦¬íŒ©í† ë§
- `test`: í…ŒìŠ¤íŠ¸ ì¶”ê°€/ìˆ˜ì •
- `chore`: ë¹Œë“œ, ì„¤ì • ë³€ê²½

**ì˜ˆì‹œ**:
```
feat(auth): ì†Œì…œ ë¡œê·¸ì¸ ê¸°ëŠ¥ ì¶”ê°€

- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì—°ë™
- ë„¤ì´ë²„ ë¡œê·¸ì¸ ì—°ë™
- ì• í”Œ ë¡œê·¸ì¸ ì—°ë™

Closes #123
```

### 6.4 PR ê·œì¹™

1. **ì œëª©**: `[PLIC-123] ê¸°ëŠ¥ ì„¤ëª…`
2. **ë¦¬ë·°ì–´**: ìµœì†Œ 1ëª… í•„ìˆ˜
3. **ì²´í¬ë¦¬ìŠ¤íŠ¸**:
   - [ ] í…ŒìŠ¤íŠ¸ í†µê³¼
   - [ ] ë¦°íŠ¸ í†µê³¼
   - [ ] íƒ€ì… ì²´í¬ í†µê³¼
   - [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ)

---

## 7. í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬

### 7.1 í™˜ê²½ êµ¬ë¶„

| í™˜ê²½ | ì„¤ëª… | ë„ë©”ì¸ |
|------|------|--------|
| `local` | ë¡œì»¬ ê°œë°œ | localhost:3000 |
| `development` | ê°œë°œ ì„œë²„ | dev.plic.co.kr |
| `staging` | ìŠ¤í…Œì´ì§• | staging.plic.co.kr |
| `production` | í”„ë¡œë•ì…˜ | plic.co.kr |

### 7.2 í™˜ê²½ ë³€ìˆ˜ íŒŒì¼

```
apps/customer-web/
â”œâ”€â”€ .env.local          # ë¡œì»¬ (Git ì œì™¸)
â”œâ”€â”€ .env.development    # ê°œë°œ
â”œâ”€â”€ .env.staging        # ìŠ¤í…Œì´ì§•
â””â”€â”€ .env.production     # í”„ë¡œë•ì…˜

apps/api/
â”œâ”€â”€ .env.local          # ë¡œì»¬ (Git ì œì™¸)
â”œâ”€â”€ .env.development
â”œâ”€â”€ .env.staging
â””â”€â”€ .env.production
```

### 7.3 í™˜ê²½ ë³€ìˆ˜ ëª©ë¡

**Frontend (customer-web, admin-web)**:
```bash
# API
NEXT_PUBLIC_API_URL=https://api.plic.co.kr
NEXT_PUBLIC_WS_URL=wss://ws.plic.co.kr

# Third-party
NEXT_PUBLIC_SOFTPAYMENT_CLIENT_KEY=xxx
NEXT_PUBLIC_SENTRY_DSN=xxx

# Feature Flags
NEXT_PUBLIC_FEATURE_SPLIT_PAYMENT=false
```

**Backend (api)**:
```bash
# Database
DATABASE_URL=postgresql://user:pass@host:5432/plic

# Redis
REDIS_URL=redis://host:6379

# JWT
JWT_SECRET=xxx
JWT_EXPIRES_IN=1h
JWT_REFRESH_EXPIRES_IN=7d

# Encryption
KMS_KEY_ID=xxx

# External Services
SOFTPAYMENT_SECRET_KEY=xxx
SOFTPAYMENT_WEBHOOK_SECRET=xxx
TRANSFER_API_KEY=xxx
PASS_API_KEY=xxx

# AWS (ë¡œì»¬ ê°œë°œìš©ë§Œ)
AWS_REGION=ap-northeast-2
# âš ï¸ v1.1: Productionì—ì„œëŠ” Access Key ì‚¬ìš© ê¸ˆì§€!
# AWS_ACCESS_KEY_ID=xxx      # ë¡œì»¬/ê°œë°œë§Œ
# AWS_SECRET_ACCESS_KEY=xxx  # ë¡œì»¬/ê°œë°œë§Œ

SQS_PAYMENT_QUEUE_URL=xxx
SQS_TRANSFER_QUEUE_URL=xxx

# Monitoring
SENTRY_DSN=xxx
```

### 7.4 AWS ì¸ì¦ ì •ì±… âš ï¸ (v1.1 ì¶”ê°€)

> âš ï¸ **Productionì—ì„œëŠ” ì •ì  Access Key ì‚¬ìš© ê¸ˆì§€**

| í™˜ê²½ | ì¸ì¦ ë°©ì‹ | ë¹„ê³  |
|------|----------|------|
| **Local** | Access Key (ê°œì¸ ê³„ì •) | ê°œë°œìš© IAM User |
| **Development** | ECS Task Role | IAM Role for Tasks |
| **Staging** | ECS Task Role | IAM Role for Tasks |
| **Production** | ECS Task Role | IAM Role for Tasks |

**ECS Task Role ì„¤ì •**:

```typescript
// âœ… Good: Task Role ìë™ ì¸ì¦ (SDKê°€ ìë™ ì²˜ë¦¬)
import { SQSClient } from '@aws-sdk/client-sqs';

const sqsClient = new SQSClient({ 
  region: 'ap-northeast-2',
  // credentials ìƒëµ â†’ Task Role ìë™ ì‚¬ìš©
});

// âŒ Bad: ì •ì  í‚¤ í•˜ë“œì½”ë”©
const sqsClient = new SQSClient({
  region: 'ap-northeast-2',
  credentials: {
    accessKeyId: 'AKIA...',      // ì ˆëŒ€ ê¸ˆì§€!
    secretAccessKey: '...',
  },
});
```

**Task Roleì— í•„ìš”í•œ ê¶Œí•œ**:
- `sqs:SendMessage`, `sqs:ReceiveMessage`, `sqs:DeleteMessage`
- `secretsmanager:GetSecretValue`
- `kms:Decrypt`, `kms:Encrypt`
- `s3:GetObject`, `s3:PutObject`
- `logs:CreateLogStream`, `logs:PutLogEvents`

> âš ï¸ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” í™˜ê²½ ë³€ìˆ˜ ëŒ€ì‹  Secrets Manager ì‚¬ìš©

```typescript
// secrets.service.ts
import { SecretsManager } from '@aws-sdk/client-secrets-manager';

export class SecretsService {
  private client = new SecretsManager({ region: 'ap-northeast-2' });

  async getSecret(secretId: string): Promise<Record<string, string>> {
    const response = await this.client.getSecretValue({ SecretId: secretId });
    return JSON.parse(response.SecretString || '{}');
  }
}

// ì‚¬ìš©
const secrets = await secretsService.getSecret('plic/production/api');
const dbUrl = secrets.DATABASE_URL;
```

---

## 8. ë°°í¬ íŒŒì´í”„ë¼ì¸

### 8.1 CI/CD íë¦„

```
[Push/PR]
    â”‚
    â–¼
[GitHub Actions]
    â”‚
    â”œâ”€ Lint Check
    â”œâ”€ Type Check
    â”œâ”€ Unit Tests
    â””â”€ Build
    â”‚
    â–¼ (PR Merge to develop)
[Deploy to Development]
    â”‚
    â–¼ (Release Branch)
[Deploy to Staging]
    â”‚
    â–¼ (QA í†µê³¼)
[Deploy to Production]
```

### 8.2 GitHub Actions ì›Œí¬í”Œë¡œìš°

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm lint

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm type-check

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm test

  build:
    runs-on: ubuntu-latest
    needs: [lint, type-check, test]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm build
```

### 8.3 Docker ì„¤ì •

**apps/api/Dockerfile**:
```dockerfile
# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

# pnpm ì„¤ì¹˜
RUN corepack enable && corepack prepare pnpm@latest --activate

# ì˜ì¡´ì„± ì„¤ì¹˜
COPY pnpm-lock.yaml package.json ./
RUN pnpm install --frozen-lockfile

# ì†ŒìŠ¤ ë³µì‚¬ ë° ë¹Œë“œ
COPY . .
RUN pnpm build

# Production stage
FROM node:20-alpine AS runner

WORKDIR /app

# ë³´ì•ˆ: non-root user
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nestjs
USER nestjs

# ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=builder --chown=nestjs:nodejs /app/dist ./dist
COPY --from=builder --chown=nestjs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nestjs:nodejs /app/package.json ./

ENV NODE_ENV=production
EXPOSE 3000

CMD ["node", "dist/main.js"]
```

---

## 9. í”Œë«í¼ ì •ì±…

### 9.1 ì§€ì› í™˜ê²½

| í”Œë«í¼ | ìµœì†Œ ë²„ì „ | ë¹„ê³  |
|--------|----------|------|
| **iOS** | 14.0+ | Safari/WebKit |
| **Android** | 8.0+ (API 26) | Chrome WebView |
| **Web** | Chrome 90+, Safari 14+, Firefox 90+ | - |

### 9.2 í•˜ì´ë¸Œë¦¬ë“œ ì•± êµ¬ì¡°

```
[Capacitor]
    â”‚
    â”œâ”€ iOS (Swift)
    â”‚   â”œâ”€ WKWebView
    â”‚   â””â”€ Native Plugins
    â”‚       â”œâ”€ Push Notification
    â”‚       â”œâ”€ Biometric Auth
    â”‚       â””â”€ Secure Storage
    â”‚
    â””â”€ Android (Kotlin)
        â”œâ”€ WebView
        â””â”€ Native Plugins
            â”œâ”€ Push Notification
            â”œâ”€ Biometric Auth
            â””â”€ Secure Storage
```

### 9.3 ì•± ì—…ë°ì´íŠ¸ ì •ì±…

| ì—…ë°ì´íŠ¸ ìœ í˜• | ì¡°ê±´ | ë™ì‘ |
|-------------|------|------|
| **ê°•ì œ ì—…ë°ì´íŠ¸** | ë³´ì•ˆ íŒ¨ì¹˜, í•„ìˆ˜ ê¸°ëŠ¥ ë³€ê²½ | ì—…ë°ì´íŠ¸ ì „ ì•± ì‚¬ìš© ë¶ˆê°€ |
| **ê¶Œì¥ ì—…ë°ì´íŠ¸** | ìƒˆ ê¸°ëŠ¥, ë²„ê·¸ ìˆ˜ì • | ìŠ¤í‚µ ê°€ëŠ¥ (ìµœëŒ€ 3íšŒ) |
| **ë¬´ìŒ ì—…ë°ì´íŠ¸** | ë§ˆì´ë„ˆ ìˆ˜ì • | ì›¹ë·° ìë™ ë°˜ì˜ |

**ë²„ì „ ì²´í¬ API**:
```typescript
// GET /api/app/version
{
  "ios": {
    "minimum": "1.2.0",
    "latest": "1.3.0",
    "forceUpdate": false
  },
  "android": {
    "minimum": "1.2.0",
    "latest": "1.3.0",
    "forceUpdate": false
  }
}
```

---

## 10. í…ŒìŠ¤íŠ¸ ì „ëµ

### 10.1 í…ŒìŠ¤íŠ¸ í”¼ë¼ë¯¸ë“œ

```
        /\
       /  \
      / E2E \        (10%)
     /________\
    /          \
   / Integration \   (30%)
  /______________\
 /                \
/    Unit Tests    \ (60%)
\__________________/
```

### 10.2 í…ŒìŠ¤íŠ¸ ë„êµ¬

| ìœ í˜• | ë„êµ¬ | ëŒ€ìƒ |
|------|------|------|
| Unit | Vitest | í•¨ìˆ˜, ìœ í‹¸, ì„œë¹„ìŠ¤ |
| Integration | Vitest + Supertest | API ì—”ë“œí¬ì¸íŠ¸ |
| E2E | Playwright | ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤ |
| Component | Storybook + Testing Library | UI ì»´í¬ë„ŒíŠ¸ |

### 10.3 í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ëª©í‘œ

| ì˜ì—­ | ëª©í‘œ ì»¤ë²„ë¦¬ì§€ |
|------|-------------|
| ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ | 80% ì´ìƒ |
| API ì—”ë“œí¬ì¸íŠ¸ | 90% ì´ìƒ |
| UI ì»´í¬ë„ŒíŠ¸ | 70% ì´ìƒ |
| ì „ì²´ | 75% ì´ìƒ |

### 10.4 í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

**Unit Test**:
```typescript
// user.service.spec.ts
describe('UserService', () => {
  let service: UserService;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [UserService],
    }).compile();

    service = module.get<UserService>(UserService);
  });

  describe('calculateGrade', () => {
    it('ì›” ìˆ˜ìˆ˜ë£Œ 10ë§Œì› ì´ìƒì´ë©´ PLATINUM', () => {
      const result = service.calculateGrade(100000);
      expect(result).toBe(UserGrade.PLATINUM);
    });

    it('ì›” ìˆ˜ìˆ˜ë£Œ 10ë§Œì› ë¯¸ë§Œì´ë©´ BASIC', () => {
      const result = service.calculateGrade(50000);
      expect(result).toBe(UserGrade.BASIC);
    });
  });
});
```

**E2E Test**:
```typescript
// deal-creation.spec.ts
import { test, expect } from '@playwright/test';

test('ê±°ë˜ ìƒì„± í”Œë¡œìš°', async ({ page }) => {
  // ë¡œê·¸ì¸
  await page.goto('/login');
  await page.fill('[name="email"]', 'test@example.com');
  await page.fill('[name="password"]', 'password123');
  await page.click('button[type="submit"]');

  // ê±°ë˜ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
  await page.click('text=ìƒˆ ê±°ë˜');

  // ê¸ˆì•¡ ì…ë ¥
  await page.fill('[name="amount"]', '100000');

  // ìˆ˜ì·¨ì¸ ì„ íƒ
  await page.click('[data-testid="recipient-select"]');
  await page.click('text=í™ê¸¸ë™');

  // ì¹´ë“œ ì„ íƒ
  await page.click('[data-testid="card-select"]');
  await page.click('text=**** 1234');

  // í™•ì¸
  await page.click('button:has-text("ê²°ì œí•˜ê¸°")');

  // ê²°ê³¼ í™•ì¸
  await expect(page.locator('text=ì†¡ê¸ˆ ì™„ë£Œ')).toBeVisible();
});
```

---

## 11. ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§

### 11.1 ë¡œê¹… ë ˆë²¨

| ë ˆë²¨ | ìš©ë„ | í™˜ê²½ |
|------|------|------|
| `DEBUG` | ê°œë°œ ë””ë²„ê¹… | local, development |
| `INFO` | ì¼ë°˜ ì •ë³´ | ëª¨ë“  í™˜ê²½ |
| `WARN` | ê²½ê³  | ëª¨ë“  í™˜ê²½ |
| `ERROR` | ì—ëŸ¬ | ëª¨ë“  í™˜ê²½ |

### 11.2 ë¡œê¹… í˜•ì‹

```typescript
// êµ¬ì¡°í™”ëœ ë¡œê·¸
logger.info('User login successful', {
  userId: 'user_123',
  method: 'PASS',
  ip: '1.2.3.4',
  userAgent: 'Mozilla/5.0...',
  duration: 1234,
});

// ì¶œë ¥ (JSON)
{
  "timestamp": "2025-01-06T10:30:00.000Z",
  "level": "info",
  "message": "User login successful",
  "context": {
    "userId": "user_123",
    "method": "PASS",
    "ip": "1.2.3.4",
    "userAgent": "Mozilla/5.0...",
    "duration": 1234
  },
  "requestId": "req_abc123"
}
```

### 11.3 ë¡œê·¸ ë³´ì•ˆ ì›ì¹™ âš ï¸ (v1.2 ì¶”ê°€)

> âš ï¸ **í•€í…Œí¬ ë¡œê¹…ì˜ ê¸°ë³¸ ì›ì¹™: body ì „ì²´ ë¡œê¹… ê¸ˆì§€**

| ì›ì¹™ | ì„¤ëª… |
|------|------|
| **body ì „ì²´ ë¡œê¹… ê¸ˆì§€** | ìš”ì²­/ì‘ë‹µ bodyë¥¼ í†µì§¸ë¡œ ë¡œê¹…í•˜ì§€ ì•ŠìŒ |
| **í•„ìš” í•„ë“œë§Œ ë¡œê¹…** | ë¹„ì¦ˆë‹ˆìŠ¤ ì¶”ì ì— í•„ìš”í•œ í•„ë“œë§Œ ì„ íƒì  ë¡œê¹… |
| **ë§ˆìŠ¤í‚¹ì€ ìµœí›„ ë°©ì–´ì„ ** | ë§ˆìŠ¤í‚¹ë³´ë‹¤ "ì• ì´ˆì— ì•ˆ ì°ëŠ” ê²ƒ"ì´ ìš°ì„  |
| **ë¡œê·¸ ë ˆë²¨ ë¶„ë¦¬** | DEBUGì—ì„œë§Œ ìƒì„¸ ë¡œê¹…, PRODëŠ” ìµœì†Œí™” |

```typescript
// âŒ Bad: body ì „ì²´ ë¡œê¹…
logger.info('Request received', { body: req.body });

// âœ… Good: í•„ìš” í•„ë“œë§Œ ë¡œê¹…
logger.info('Deal created', { 
  dealId: deal.id,
  amount: deal.amount,
  userId: deal.userId,
  // cardNumber, billingKey ë“±ì€ ì• ì´ˆì— í¬í•¨í•˜ì§€ ì•ŠìŒ
});
```

### 11.4 ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹ âš ï¸ (v1.1 ë³´ê°•)

```typescript
// âŒ ì ˆëŒ€ ë¡œê¹… ê¸ˆì§€
logger.info('Card registered', { cardNumber: '1234-5678-9012-3456' });

// âœ… ë§ˆìŠ¤í‚¹ í•„ìˆ˜
logger.info('Card registered', { last4: '3456' });

// ë§ˆìŠ¤í‚¹ ëŒ€ìƒ (v1.1 ì¶”ê°€: accountHolderName)
const SENSITIVE_FIELDS = [
  'cardNumber',
  'cvv',
  'password',
  'billingKey',
  'accountNumber',
  'accountHolderName',   // v1.1 ì¶”ê°€
  'ci',
  'di',
  'refreshToken',
  'accessToken',
  'phoneNumber',         // ë¶€ë¶„ ë§ˆìŠ¤í‚¹ (010-****-1234)
];
```

**ìë™ ë§ˆìŠ¤í‚¹ ë¯¸ë“¤ì›¨ì–´** (v1.1 ê¶Œì¥):

```typescript
// interceptors/logging.interceptor.ts
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  private readonly sensitiveFields = new Set([
    'cardNumber', 'cvv', 'password', 'billingKey',
    'accountNumber', 'accountHolderName', 'ci', 'di',
    'refreshToken', 'accessToken',
  ]);

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest();
    
    // ìš”ì²­ ë¡œê¹… (ë§ˆìŠ¤í‚¹ ì ìš©)
    this.logger.log({
      method: request.method,
      url: request.url,
      body: this.maskSensitiveData(request.body),
    });

    return next.handle();
  }

  private maskSensitiveData(obj: any): any {
    if (!obj || typeof obj !== 'object') return obj;

    return Object.keys(obj).reduce((acc, key) => {
      if (this.sensitiveFields.has(key)) {
        acc[key] = '***MASKED***';
      } else if (typeof obj[key] === 'object') {
        acc[key] = this.maskSensitiveData(obj[key]);
      } else {
        acc[key] = obj[key];
      }
      return acc;
    }, {} as any);
  }
}
```

### 11.5 ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

**CloudWatch ë©”íŠ¸ë¦­**:
| ë©”íŠ¸ë¦­ | ì„ê³„ê°’ | ì•Œë¦¼ |
|--------|--------|------|
| API ì‘ë‹µì‹œê°„ (p95) | > 500ms | Warning |
| API ì‘ë‹µì‹œê°„ (p99) | > 1000ms | Critical |
| ì—ëŸ¬ìœ¨ | > 1% | Warning |
| ì—ëŸ¬ìœ¨ | > 5% | Critical |
| CPU ì‚¬ìš©ë¥  | > 70% | Warning |
| ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  | > 80% | Warning |

---

## 12. ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 12.1 ê°œë°œ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] í™˜ê²½ ë³€ìˆ˜ì— ë¯¼ê° ì •ë³´ í•˜ë“œì½”ë”© ê¸ˆì§€
- [ ] SQL Injection ë°©ì§€ (Prisma ì‚¬ìš©)
- [ ] XSS ë°©ì§€ (ì…ë ¥ê°’ ê²€ì¦, ì¶œë ¥ ì´ìŠ¤ì¼€ì´í”„)
- [ ] CSRF ë°©ì§€ (í† í° ê²€ì¦)
- [ ] Rate Limiting ì ìš©
- [ ] ë¯¼ê° ì •ë³´ ë¡œê¹… ê¸ˆì§€
- [ ] HTTPS ê°•ì œ
- [ ] ì ì ˆí•œ CORS ì„¤ì •

### 12.2 ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì¸ì¦/ì¸ê°€ ë¡œì§ ê²€í† 
- [ ] ì…ë ¥ê°’ ê²€ì¦ í™•ì¸
- [ ] ì—ëŸ¬ í•¸ë“¤ë§ ì ì ˆì„±
- [ ] ë¯¼ê° ì •ë³´ ë…¸ì¶œ ì—¬ë¶€
- [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€

### 12.3 ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ë³´ì•ˆ ìŠ¤ìº” í†µê³¼ (Snyk, SonarQube)
- [ ] ì˜ì¡´ì„± ì·¨ì•½ì  í™•ì¸
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸
- [ ] ì¸í”„ë¼ ë³´ì•ˆ ê·¸ë£¹ ê²€í† 

---

## 13. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ê·œì¹™ âš ï¸ (v1.1 ì¶”ê°€)

> âš ï¸ **í•€í…Œí¬ ì„œë¹„ìŠ¤ëŠ” ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ ì‚¬ê³ ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŒ**

### 13.1 ë§ˆì´ê·¸ë ˆì´ì…˜ ì›ì¹™

| ì›ì¹™ | ì„¤ëª… | ë¹„ê³  |
|------|------|------|
| **íŒŒê´´ì  ë³€ê²½ ê¸ˆì§€** | ì»¬ëŸ¼/í…Œì´ë¸” ì‚­ì œ ì¦‰ì‹œ ì‹¤í–‰ ê¸ˆì§€ | 2ë‹¨ê³„ ë¦´ë¦¬ì¦ˆ í•„ìˆ˜ |
| **ë¡¤ë°± ê°€ëŠ¥** | ëª¨ë“  ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ | `down` í•¨ìˆ˜ í•„ìˆ˜ |
| **ë°±í•„ ë¶„ë¦¬** | ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ìŠ¤í‚¤ë§ˆì™€ ë¶„ë¦¬ | ë³„ë„ Jobìœ¼ë¡œ ì‹¤í–‰ |
| **í”¼í¬ ì‹œê°„ íšŒí”¼** | ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ìƒˆë²½ ì‹œê°„ëŒ€ | 02:00~05:00 KST |

### 13.2 íŒŒê´´ì  ë³€ê²½ 2ë‹¨ê³„ ë¦´ë¦¬ì¦ˆ

> ì»¬ëŸ¼/í…Œì´ë¸” ì‚­ì œëŠ” ë°˜ë“œì‹œ 2ë‹¨ê³„ë¡œ ì§„í–‰

```
[Phase 1: ì†Œí”„íŠ¸ ì‚­ì œ] (v1.2.0)
â”œâ”€ ì½”ë“œì—ì„œ í•´ë‹¹ ì»¬ëŸ¼ ì‚¬ìš© ì œê±°
â”œâ”€ nullableë¡œ ë³€ê²½ (í•„ìš”ì‹œ)
â””â”€ 1ì£¼ì¼ ì´ìƒ ìš´ì˜

[Phase 2: ë¬¼ë¦¬ ì‚­ì œ] (v1.3.0)
â”œâ”€ ì»¬ëŸ¼/í…Œì´ë¸” ì‚­ì œ ë§ˆì´ê·¸ë ˆì´ì…˜
â””â”€ ë¡¤ë°± ê³„íš ìˆ˜ë¦½
```

**ì˜ˆì‹œ: ì»¬ëŸ¼ ì‚­ì œ**

```typescript
// Phase 1: v1.2.0 - ì½”ë“œì—ì„œ ì œê±° + nullable
// migration_20250106_remove_legacy_column_phase1.ts
export async function up(prisma: PrismaClient) {
  await prisma.$executeRaw`
    ALTER TABLE users 
    ALTER COLUMN legacy_field DROP NOT NULL;
  `;
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`
    ALTER TABLE users 
    ALTER COLUMN legacy_field SET NOT NULL;
  `;
}

// Phase 2: v1.3.0 - ì‹¤ì œ ì‚­ì œ (1ì£¼ì¼ ì´ìƒ í›„)
// migration_20250113_remove_legacy_column_phase2.ts
export async function up(prisma: PrismaClient) {
  await prisma.$executeRaw`
    ALTER TABLE users DROP COLUMN legacy_field;
  `;
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`
    ALTER TABLE users 
    ADD COLUMN legacy_field VARCHAR(255);
  `;
}
```

### 13.3 ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

**PR ì „**:
- [ ] `down` í•¨ìˆ˜ (ë¡¤ë°±) ì‘ì„±ë¨
- [ ] íŒŒê´´ì  ë³€ê²½ ì—†ìŒ (ìˆë‹¤ë©´ 2ë‹¨ê³„ ê³„íš)
- [ ] ì¸ë±ìŠ¤ ìƒì„±ì€ `CONCURRENTLY` ì‚¬ìš©
- [ ] ë¡œì»¬ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ

**ë°°í¬ ì „**:
- [ ] Stagingì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
- [ ] ì˜ˆìƒ ì‹¤í–‰ ì‹œê°„ í™•ì¸ (ëŒ€ìš©ëŸ‰ í…Œì´ë¸” ì£¼ì˜)
- [ ] ë¡¤ë°± ì ˆì°¨ ë¬¸ì„œí™”
- [ ] DBA ë¦¬ë·° (ëŒ€ìš©ëŸ‰ í…Œì´ë¸” ë³€ê²½ ì‹œ)

**ë°°í¬ í›„**:
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ í™•ì¸
- [ ] ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ë™ì‘ í™•ì¸
- [ ] ì¿¼ë¦¬ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (1ì‹œê°„)

### 13.4 ëŒ€ìš©ëŸ‰ í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜

> 100ë§Œ í–‰ ì´ìƒ í…Œì´ë¸”ì€ íŠ¹ë³„ ì£¼ì˜

```typescript
// âœ… Good: CONCURRENTLY ì˜µì…˜ (ë½ ìµœì†Œí™”)
export async function up(prisma: PrismaClient) {
  await prisma.$executeRaw`
    CREATE INDEX CONCURRENTLY idx_deals_created_at 
    ON deals (created_at);
  `;
}

// âŒ Bad: ì¼ë°˜ ì¸ë±ìŠ¤ ìƒì„± (í…Œì´ë¸” ë½)
export async function up(prisma: PrismaClient) {
  await prisma.$executeRaw`
    CREATE INDEX idx_deals_created_at 
    ON deals (created_at);  -- í…Œì´ë¸” ì „ì²´ ë½!
  `;
}
```

---

## ë¶€ë¡

### A. ìì£¼ ì“°ëŠ” ëª…ë ¹ì–´

```bash
# ê°œë°œ ì„œë²„ ì‹¤í–‰
pnpm dev

# ë¹Œë“œ
pnpm build

# í…ŒìŠ¤íŠ¸
pnpm test

# ë¦°íŠ¸
pnpm lint

# íƒ€ì… ì²´í¬
pnpm type-check

# DB ë§ˆì´ê·¸ë ˆì´ì…˜
pnpm db:migrate

# Prisma Studio
pnpm db:studio
```

### B. ì°¸ê³  ë¬¸ì„œ

| ë¬¸ì„œ | ì—­í•  |
|------|------|
| PLIC_PRD.md | ì •ì±… ìš”ì•½ |
| PLIC_API_SPEC.md | API ëª…ì„¸ |
| PLIC_DB_SCHEMA.md | DB ìŠ¤í‚¤ë§ˆ |
| PLIC_EXTERNAL_INTERFACE.md | ì™¸ë¶€ ì—°ë™ |
| PLIC_STATE_MACHINES.md | ìƒíƒœ ì „ì´ |
| PLIC_SECURITY.md | ë³´ì•ˆ ì •ì±… ìƒì„¸ |

### C. ì™¸ë¶€ ë¬¸ì„œ

| ë¬¸ì„œ | URL |
|------|-----|
| Next.js | https://nextjs.org/docs |
| NestJS | https://docs.nestjs.com |
| Prisma | https://www.prisma.io/docs |
| shadcn/ui | https://ui.shadcn.com |
| Zustand | https://docs.pmnd.rs/zustand |
| Tailwind CSS | https://tailwindcss.com/docs |
