# PLIC 운영 핸드북 (OPERATIONS HANDBOOK)

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | PLIC Operations Handbook |
| 버전 | 1.1 |
| 작성일 | 2025-01-06 |
| 수정일 | 2025-01-06 |
| 작성자 | PLIC 운영팀 |
| 상태 | **Approved** |
| 역할 | **일상 운영 SSOT** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-06 | 초안 작성 | PLIC 운영팀 |
| 1.1 | 2025-01-06 | **CTO 리뷰 반영**: 배치 스케줄 SSOT 링크화, SLO/SLI 추가, Correlation ID 추적 가이드, 환불 정책 표 추가 | PLIC 운영팀 |

---

## 1. 운영 개요

### 1.1 운영 조직

| 역할 | 담당 | 연락처 | 비고 |
|------|------|--------|------|
| **운영 총괄** | 운영팀장 | - | 에스컬레이션 최종 |
| **결제/송금 담당** | 운영팀 | - | 거래 이슈 1차 대응 |
| **CS 담당** | CS팀 | - | 고객 문의 |
| **개발 당직** | 개발팀 (로테이션) | - | 기술 장애 대응 |
| **DBA** | 인프라팀 | - | DB 이슈 |

### 1.2 운영 시간

| 구분 | 시간 | 비고 |
|------|------|------|
| **서비스 운영** | 24/7 | 무중단 |
| **운영팀 근무** | 09:00 ~ 18:00 (평일) | - |
| **당직 근무** | 18:00 ~ 09:00 + 주말 | 로테이션 |
| **은행 송금** | 은행별 점검시간 제외 | EXTERNAL_INTERFACE 참조 |

### 1.3 커뮤니케이션 채널

| 채널 | 용도 | 참여자 |
|------|------|--------|
| **#plic-ops** | 일상 운영 | 운영팀, 개발팀 |
| **#plic-alerts** | 자동 알림 | 전체 |
| **#plic-incidents** | 장애 대응 | 운영팀, 개발팀, 경영진 |
| **#plic-cs** | CS 에스컬레이션 | CS팀, 운영팀 |

---

## 2. 일일 운영 체크리스트

### 2.1 오전 체크 (09:00)

> 당일 운영 시작 전 필수 확인 항목

**시스템 상태**:
- [ ] 서비스 헬스체크 (API, Web 정상 응답)
- [ ] DB 연결 상태 확인
- [ ] Redis 연결 상태 확인
- [ ] SQS 큐 적체 여부 확인

**전일 처리 현황**:
- [ ] 대사 배치 결과 확인 (06:00 실행)
- [ ] 대사 불일치 건 확인 및 조치
- [ ] 송금 실패/ABANDONED 건 확인
- [ ] DLQ 메시지 확인

**운영 자금**:
- [ ] 운영 자금 잔액 확인
- [ ] 금일 예상 송금액 대비 충분 여부
- [ ] 서킷브레이커 상태 확인 (CLOSED 정상)

### 2.2 오후 체크 (14:00)

- [ ] 오전 거래량 확인
- [ ] 결제/송금 성공률 확인
- [ ] 에러율 모니터링 (1% 미만 정상)
- [ ] CS 인입 건수 확인

### 2.3 마감 체크 (18:00)

- [ ] 금일 거래 현황 리포트
- [ ] 미처리 건 인수인계
- [ ] 익일 예상 이슈 공유
- [ ] 당직자 인수인계

---

## 3. 대사 결과 확인

### 3.1 대사 배치 스케줄 ⚠️ (v1.1 SSOT 링크화)

> ⚠️ **SSOT 참조**: 배치 상세 정의는 **PLIC_BATCH_AND_JOBS.md** 참조
> 여기서는 운영 체크 포인트만 기록합니다.

| 배치 | 체크 시간 | 확인 항목 | 참조 |
|------|----------|----------|------|
| PG 대사 | 06:30 | 불일치 건수 | BATCH_AND_JOBS 섹션 2.1 |
| 송금 대사 | 07:00 | 불일치 건수 | BATCH_AND_JOBS 섹션 2.1 |
| 정산 대사 | 07:30 | 정산 금액 일치 | BATCH_AND_JOBS 섹션 2.1 |
| 등급 변경 | 매월 1일 00:30 | 변경 건수 | BATCH_AND_JOBS 섹션 2.2 |
| 만료 처리 | 매시간 | CANCELLED 건수 | BATCH_AND_JOBS 섹션 2.3 |

### 3.2 대사 결과 확인 방법

```
[Admin > 대사 관리 > 대사 결과]

1. 배치 실행 상태 확인
   - COMPLETED: 정상 완료
   - FAILED: 배치 실패 → 개발팀 에스컬레이션
   - RUNNING: 실행 중 (30분 이상 시 확인)

2. 불일치 건수 확인
   - MATCHED: 정상
   - AMOUNT_MISMATCH: 금액 불일치 (즉시 조치)
   - STATUS_MISMATCH: 상태 불일치 (4시간 내 조치)
   - GHOST_TRANSACTION: 유령 거래 (즉시 에스컬레이션)
   - TIMING_MISMATCH: 타이밍 불일치 (익일 재대사)
```

### 3.3 불일치 유형별 대응

| 유형 | SLA | 대응 |
|------|-----|------|
| **AMOUNT_MISMATCH** | 4시간 | 즉시 조사, 원인 파악 후 수동 조정 |
| **STATUS_MISMATCH** | 4시간 | 외부 시스템 조회 후 상태 동기화 |
| **GHOST_TRANSACTION** | 즉시 | 보안팀 에스컬레이션, 거래 동결 |
| **TIMING_MISMATCH** | 24시간 | 익일 자동 재대사, 지속 시 수동 확인 |
| **PLIC_ONLY** | 4시간 | PG/송금사 조회 후 상태 보정 |
| **EXTERNAL_ONLY** | 즉시 | 보안 사고 의심, 즉시 에스컬레이션 |

### 3.4 불일치 해결 절차

```
1. [Admin > 대사 관리 > 불일치 상세] 접근
2. 불일치 내역 확인 (PLIC vs 외부)
3. 원인 분석
   - PG 관리자 페이지 조회
   - 송금사 관리자 페이지 조회
4. 조치 결정
   - 상태 동기화
   - 금액 조정
   - 수동 처리
5. 조치 실행 (사유 기록 필수)
6. 결과 확인 및 문서화
```

---

## 4. 송금 실패 처리

### 4.1 송금 실패 유형

| 실패 유형 | 설명 | 대응 |
|----------|------|------|
| **INVALID_ACCOUNT** | 계좌번호 오류 | 고객에게 계좌 확인 요청 |
| **CLOSED_ACCOUNT** | 해지 계좌 | 고객에게 계좌 변경 요청 |
| **DORMANT_ACCOUNT** | 휴면 계좌 | 고객에게 휴면 해제 안내 |
| **NAME_MISMATCH** | 예금주명 불일치 | 고객에게 확인 요청 |
| **LIMIT_EXCEEDED** | 이체 한도 초과 | 은행 한도 안내 |
| **BANK_ERROR** | 은행 시스템 오류 | 자동 재시도 대기 |
| **TIMEOUT** | 타임아웃 | 상태 조회 후 처리 |

### 4.2 자동 재시도 정책

```
[재시도 스케줄]
- 1차: 즉시 (1분 후)
- 2차: 5분 후
- 3차: 30분 후
- 4차: 2시간 후
- 5차: 12시간 후

[ABANDONED 전환]
- 5회 실패 또는 24시간 경과 시
- ABANDONED 상태로 전환
- 운영팀 수동 처리 필요
```

### 4.3 ABANDONED 처리 절차

```
1. [Admin > 거래 관리 > ABANDONED 거래] 조회
2. 실패 원인 확인 (로그, 송금사 응답)
3. 원인별 처리:

   [계좌 오류인 경우]
   - 고객에게 연락 (SMS/앱푸시)
   - 올바른 계좌 확인
   - 수취인 정보 수정
   - 수동 송금 재시도

   [시스템 오류인 경우]
   - 송금사 연동 상태 확인
   - 정상화 후 수동 재시도

   [해결 불가인 경우]
   - 환불 처리 진행
   - 고객 안내
```

---

## 5. 운영 자금 관리

### 5.1 운영 자금 모니터링

| 지표 | 임계값 | 알림 |
|------|--------|------|
| 잔액 | < 50,000,000원 | Warning |
| 잔액 | < 20,000,000원 | Critical |
| 잔액 | < 10,000,000원 | 서킷브레이커 OPEN |

### 5.2 서킷브레이커 상태

| 상태 | 설명 | 영향 |
|------|------|------|
| **CLOSED** | 정상 | 모든 거래 가능 |
| **HALF_OPEN** | 제한적 운영 | 소액 거래만 허용 |
| **OPEN** | 거래 중단 | 신규 결제 차단 |

### 5.3 운영 자금 충전 절차

```
1. 자금 부족 알림 수신
2. 재무팀에 충전 요청 (긴급 시 전화)
3. 충전 완료 확인
4. 서킷브레이커 상태 확인 (자동 복구)
5. 거래 정상화 확인
```

---

## 6. CS 대응 가이드

### 6.1 주요 문의 유형

| 유형 | 빈도 | 1차 대응 |
|------|------|---------|
| 송금 지연 | 높음 | 상태 확인 후 예상 시간 안내 |
| 결제 실패 | 중간 | 실패 사유 안내, 재시도 안내 |
| 환불 요청 | 중간 | 환불 정책 안내, 처리 진행 |
| 카드 등록 실패 | 낮음 | 카드사 확인 안내 |
| 한도 문의 | 낮음 | 현재 한도 및 변경 방법 안내 |

### 6.2 송금 지연 대응

```
[상태별 응대 스크립트]

PROCESSING:
"현재 송금이 처리 중입니다. 
 통상 1~2분 내 완료되나, 은행 상황에 따라 
 최대 30분까지 소요될 수 있습니다."

TRANSFERRING (5분 이상):
"송금이 진행 중입니다. 
 은행 처리 지연으로 다소 시간이 걸리고 있습니다.
 1시간 내 완료 예정이며, 완료 시 알림 드리겠습니다."

ABANDONED:
"죄송합니다. 송금 과정에서 문제가 발생했습니다.
 담당자가 확인 후 연락 드리겠습니다. (1영업일 내)"
```

### 6.3 에스컬레이션 기준

| 상황 | 에스컬레이션 대상 | 긴급도 |
|------|-----------------|--------|
| 송금 1시간 이상 지연 | 운영팀 | 높음 |
| 동일 오류 3건 이상 | 개발팀 | 높음 |
| 차지백 발생 | 운영팀장 | 긴급 |
| 보안 의심 건 | 보안팀 | 긴급 |
| 고객 강성 항의 | 운영팀장 | 높음 |

---

## 7. 알림 대응 가이드

### 7.1 알림 유형

| 알림 | 채널 | 대응 |
|------|------|------|
| **[CRITICAL] 서킷브레이커 OPEN** | #plic-alerts | 즉시 확인, 자금 충전 |
| **[CRITICAL] 대사 불일치 - GHOST** | #plic-alerts | 즉시 에스컬레이션 |
| **[WARNING] 송금 실패율 증가** | #plic-alerts | 원인 파악, 송금사 확인 |
| **[WARNING] API 응답 지연** | #plic-alerts | 개발팀 확인 |
| **[INFO] 배치 완료** | #plic-ops | 결과 확인 |
| **[INFO] DLQ 메시지 발생** | #plic-ops | 원인 확인, 재처리 |

### 7.2 알림 대응 SLA

| 긴급도 | 초기 대응 | 해결 목표 |
|--------|----------|----------|
| **CRITICAL** | 15분 내 | 1시간 내 |
| **WARNING** | 30분 내 | 4시간 내 |
| **INFO** | 업무 시간 내 | 24시간 내 |

---

## 8. 배치 모니터링

### 8.1 주요 배치 스케줄

| 배치 | 스케줄 | 예상 소요 | 담당 |
|------|--------|----------|------|
| 등급 변경 | 매월 1일 02:00 | 30분 | 자동 |
| 휴면 전환 | 매일 03:00 | 15분 | 자동 |
| 카드 만료 알림 | 매일 09:00 | 5분 | 자동 |
| 대사 (PG) | 매일 06:00 | 20분 | 자동 |
| 대사 (송금) | 매일 06:30 | 20분 | 자동 |
| 정산 대사 | 매일 07:00 | 10분 | 자동 |
| 할인코드 만료 | 매일 00:00 | 5분 | 자동 |
| 멱등키 정리 | 매일 04:00 | 10분 | 자동 |

### 8.2 배치 실패 대응

```
1. 배치 실패 알림 수신
2. CloudWatch Logs에서 에러 확인
3. 원인 분류:
   - 일시적 오류 → 수동 재실행
   - 데이터 오류 → 데이터 수정 후 재실행
   - 시스템 오류 → 개발팀 에스컬레이션
4. 재실행 후 결과 확인
5. 실패 원인 및 조치 기록
```

---

## 9. 정기 리포트

### 9.1 일간 리포트 (매일 18:00)

| 항목 | 내용 |
|------|------|
| 거래 현황 | 건수, 금액, 성공률 |
| 송금 현황 | 성공/실패/지연 건수 |
| 대사 결과 | 불일치 건수 및 처리 현황 |
| CS 현황 | 문의 건수, 주요 이슈 |
| 운영 자금 | 잔액, 사용액 |

### 9.2 주간 리포트 (매주 월요일)

| 항목 | 내용 |
|------|------|
| 주간 거래 추이 | 일별 거래 현황 |
| 장애 현황 | 발생 건수, 원인, 조치 |
| 에러율 추이 | API/결제/송금 에러율 |
| 개선 사항 | 운영 중 발견된 이슈 |

### 9.3 월간 리포트 (매월 1일)

| 항목 | 내용 |
|------|------|
| 월간 거래 현황 | 총 거래액, 건수, 성장률 |
| 수수료 현황 | PG 수수료, PLIC 수수료 |
| 차지백 현황 | 발생 건수, 금액, 승률 |
| 등급 변경 현황 | 등급별 회원 수 변동 |
| 운영 지표 | SLA 달성률, 장애 시간 |

---

## 10. 비상 연락망

### 10.1 내부 연락망

| 상황 | 1차 | 2차 | 3차 |
|------|-----|-----|-----|
| 거래 이슈 | 운영 담당 | 운영팀장 | CTO |
| 시스템 장애 | 개발 당직 | 개발팀장 | CTO |
| 보안 사고 | 보안팀 | CTO | CEO |
| 자금 이슈 | 재무팀 | CFO | CEO |

### 10.2 외부 연락망

| 기관 | 용도 | 연락처 |
|------|------|--------|
| Softpayment | PG 장애 | 고객센터 |
| 송금사 | 송금 장애 | 기술지원 |
| AWS Support | 인프라 장애 | Support Portal |

---

## 부록

### A. SLO/SLI (Service Level Objectives/Indicators) ⚠️ (v1.1 추가)

> ⚠️ **운영 판단 기준**: 아래 지표를 벗어나면 장애로 간주

**SLI (지표)**:

| 지표 | 정의 | 측정 방법 |
|------|------|----------|
| 결제 성공률 | 결제 요청 대비 성공 비율 | `(PAID + PAID_후_취소) / (PAID + FAILED)` |
| 송금 성공률 | 송금 시도 대비 성공 비율 | `COMPLETED / (COMPLETED + TRANSFER_FAILED + ABANDONED)` |
| API 응답 시간 P95 | 95번째 백분위 응답 시간 | CloudWatch API Gateway 메트릭 |
| 대사 일치율 | 대사 대상 대비 일치 비율 | `MATCHED / TOTAL` |

**SLO (목표)**:

| 지표 | 목표 | 위반 시 |
|------|------|--------|
| 결제 성공률 | ≥ 98% | P2 장애 |
| 송금 성공률 | ≥ 99% | P2 장애 |
| API P95 (내부) | < 500ms | P3 |
| API P95 (외부 포함) | < 3s | P3 |
| 대사 일치율 | ≥ 99.9% | P2 장애 |
| DLQ 적체 | 0건 | P3 |

**RTO/RPO**:

| 항목 | 목표 | 비고 |
|------|------|------|
| **RTO** (복구 시간 목표) | 1시간 | 서비스 완전 복구 |
| **RPO** (복구 시점 목표) | 0건 (데이터 무손실) | 트랜잭션 로그 기준 |

### B. Correlation ID 기반 CS 추적 가이드 ⚠️ (v1.1 추가)

> ⚠️ **고객 문의 시** 전체 트랜잭션을 한 번에 추적하는 방법

**1단계: deal_number로 조회**
```
Admin > 거래관리 > 거래 조회 > deal_number 입력
예: PLIC_D20250106_00001
```

**2단계: Correlation ID 확보**
```
거래 상세 화면에서 "X-Request-Id" 또는 "Correlation ID" 복사
예: req_abc123xyz789
```

**3단계: CloudWatch 로그 조회**
```
CloudWatch > Log Insights > Log Group 선택:
- /ecs/plic-api
- /ecs/plic-worker

쿼리:
fields @timestamp, @message
| filter @message like /req_abc123xyz789/
| sort @timestamp asc
```

**4단계: 전체 플로우 확인**
```
추적 가능 항목:
- [결제] POST /deals/{id}/confirm 요청/응답
- [웹훅] PG 웹훅 수신/처리
- [송금] SQS 메시지 발행/처리
- [완료] 상태 변경 로그
```

### C. failure_type별 환불 정책 ⚠️ (v1.1 추가)

> ⚠️ **SSOT 참조**: PLIC_STATE_MACHINES.md 섹션 4.2

| failure_type | 설명 | 자동 환불 | 운영 방침 |
|--------------|------|----------|----------|
| `INSUFFICIENT_BALANCE` | 수취 계좌 입금 한도 초과 | ❌ | 재시도 후 ABANDONED → 수동 환불 |
| `ACCOUNT_NOT_FOUND` | 계좌번호 오류 | ✅ 즉시 | Deal FAILED, 자동 결제 취소 |
| `HOLDER_MISMATCH` | 예금주 불일치 | ✅ 즉시 | Deal FAILED, 자동 결제 취소 |
| `BANK_SYSTEM_ERROR` | 은행 시스템 오류 | ❌ | 재시도 (최대 5회) → ABANDONED |
| `TIMEOUT` | 송금 타임아웃 | ❌ | 결과 조회 후 판단 |

### D. 자주 사용하는 Admin 기능

| 메뉴 | 경로 | 용도 |
|------|------|------|
| 거래 조회 | 거래관리 > 거래 조회 | 거래 상태 확인 |
| 수동 송금 | 거래관리 > 수동 처리 | ABANDONED 재시도 |
| 환불 처리 | 거래관리 > 환불 | 환불 실행 |
| 대사 결과 | 대사관리 > 대사 결과 | 불일치 확인 |
| 회원 조회 | 회원관리 > 회원 조회 | 회원 정보 확인 |
| 회원 상태 변경 | 회원관리 > 상태 변경 | 정지/해제 |

### E. 참고 문서

| 문서 | 역할 |
|------|------|
| PLIC_OPERATION_SOP.md | 긴급 상황 대응 절차 |
| PLIC_EXTERNAL_INTERFACE.md | 외부 연동 정보 |
| PLIC_RECONCILIATION_SETTLEMENT.md | 대사/정산 상세 |
| PLIC_BATCH_AND_JOBS.md | **배치 스케줄 SSOT** |
| PLIC_STATE_MACHINES.md | **상태 전이 SSOT** |
| PLIC_SECURITY.md | 보안 정책 |
