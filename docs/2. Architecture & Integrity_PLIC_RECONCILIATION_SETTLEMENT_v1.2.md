# PLIC 대사 및 정산 명세 (RECONCILIATION & SETTLEMENT)

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | PLIC Reconciliation & Settlement Specification |
| 버전 | 1.2 |
| 작성일 | 2025-01-06 |
| 수정일 | 2025-01-06 |
| 작성자 | PLIC 개발팀 |
| 상태 | **Approved** |
| 역할 | **대사/정산 SSOT** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-06 | 초안 작성 | PLIC 개발팀 |
| 1.1 | 2025-01-06 | CTO 리뷰 반영: 멱등키 통일, 정산 금액 명확화, DB 스키마 연결, 환불 케이스 분리, Cut-off 정책, Self-Healing | PLIC 개발팀 |
| 1.2 | 2025-01-06 | **SSOT 동기화**: 매칭 키 `deal_number`로 통일, 원장 `ledger_entries` 단일화, Deal 상태 10개 반영 | PLIC 개발팀 |

---

## 1. 개요

### 1.1 문서 목적

이 문서는 PLIC 서비스의 대사(Reconciliation)와 정산(Settlement) 프로세스를 정의합니다. 재무팀과 운영팀이 "자금이 어떻게 흐르고, 어떻게 검증되는지"를 명확히 이해하기 위한 **단일 진실 공급원(SSOT)**입니다.

### 1.2 용어 정의

| 용어 | 설명 |
|------|------|
| **대사 (Reconciliation)** | 내부 데이터와 외부 데이터의 정합성을 검증하는 프로세스 |
| **정산 (Settlement)** | PG사로부터 실제 자금을 수령하는 프로세스 |
| **운영 자금** | PLIC이 선지급을 위해 보유한 자금 (수취인 계좌 송금용) |
| **선지급** | PG 정산 전 PLIC 운영 자금으로 먼저 송금하는 구조 |

### 1.3 자금 흐름 개요 ⚠️ (v1.1 금액 명확화)

```
[결제자]                    [PLIC]                    [수취인]
    │                         │                          │
    │ ① 카드 결제             │                          │
    │ (103,000원)             │                          │
    │────────────────────────▶│                          │
    │                         │                          │
    │                         │ ② 선지급 (즉시)         │
    │                         │ (100,000원)              │
    │                         │─────────────────────────▶│
    │                         │                          │
    │                         │ [운영 자금 차감]         │
    │                         │ -100,000원               │
    │                         │                          │

    ... D+2 영업일 후 ...

    │                         │                          │
    │      [PG 정산]          │                          │
    │      (100,940원 NET)    │  ⚠️ v1.1: NET 정산 명시  │
    │─────────────────────────▶│                          │
    │                         │                          │
    │                         │ [운영 자금 복구]         │
    │                         │ +100,940원               │
    │                         │                          │
    │                         │ [PLIC 마진]              │
    │                         │ = 100,940 - 100,000      │
    │                         │ = 940원                  │
```

> ⚠️ **v1.1 명확화**: 
> - **Gross 정산**: 결제 총액 (103,000원) - PG가 받는 금액
> - **Net 정산**: Gross - PG 수수료 (103,000 - 2,060 = 100,940원) - PLIC이 받는 금액
> - 다이어그램은 **Net 정산** 기준으로 표기

> 💡 **핵심**: PLIC은 PG 정산 전에 운영 자금으로 먼저 송금 (선지급 모델)

---

## 2. 대사 (Reconciliation)

### 2.1 대사 유형

| 유형 | 대상 | 주기 | 목적 |
|------|------|------|------|
| **PG 대사** | PLIC ↔ PG | 일 1회 (D+1) | 결제 데이터 정합성 |
| **송금 대사** | PLIC ↔ 송금사 | 일 1회 (D+1) | 송금 데이터 정합성 |
| **3-Way 대사** | PLIC ↔ PG ↔ 송금 | 일 1회 | 전체 거래 정합성 |
| **운영 자금 대사** | 장부 ↔ 실계좌 | 일 1회 | 운영 자금 검증 |

### 2.2 대사 흐름 ⚠️ (v1.1 매칭 키 통일, Cut-off 추가)

```
[매일 06:00 KST - 일일 대사 실행]

┌─────────────────────────────────────────────────────────────────┐
│                       1. 데이터 수집                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ⚠️ Cut-off 정책 (v1.1 추가):                                   │
│  - 대사 대상: T-1 00:00:00 ~ 23:49:59 KST                       │
│  - T-1 23:50 ~ 23:59 거래는 T+1 대사로 이월                     │
│  - 이유: 외부 기관 데이터 반영 시간차 고려                       │
│                                                                  │
│  ┌───────────┐     ┌───────────┐     ┌───────────┐             │
│  │  PLIC DB  │     │ PG 정산   │     │ 송금 정산 │             │
│  │  (전일)   │     │  파일     │     │   파일    │             │
│  └─────┬─────┘     └─────┬─────┘     └─────┬─────┘             │
│        │                 │                 │                    │
│        ▼                 ▼                 ▼                    │
│  ┌─────────────────────────────────────────────────┐           │
│  │              임시 대사 테이블                    │           │
│  │  - reconcile_plic_data_{yyyymmdd}               │           │
│  │  - reconcile_pg_data_{yyyymmdd}                 │           │
│  │  - reconcile_transfer_data_{yyyymmdd}           │           │
│  │  ⚠️ 재실행 시: TRUNCATE 후 재적재               │           │
│  └─────────────────────────────────────────────────┘           │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                       2. 매칭 및 검증                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [매칭 키] ⚠️ v1.2 SSOT 동기화 - deal_number 통일               │
│  - PG 대사: orderId = deal_number (예: PLIC_D20250106_00001)    │
│  - 송금 대사: externalIdempotencyKey = deal_number              │
│  - ⚠️ deal_id(UUID)는 내부 PK로만 사용, 외부 매칭에 사용 금지   │
│                                                                  │
│  [식별자 체계] ⚠️ v1.2 추가                                     │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ deal_id: UUID (내부 PK)                                     ││
│  │ deal_number: PLIC_DYYYYMMDD_NNNNN (외부 식별자, 대사용)     ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  [검증 항목] ⚠️ v1.2 deal_number 기준                           │
│  ┌─────────────┬─────────────┬─────────────┐                   │
│  │   PLIC DB   │     PG      │    송금     │                   │
│  ├─────────────┼─────────────┼─────────────┤                   │
│  │ deal_number │ orderId     │ extIdempKey │ ← 매칭 (v1.2)     │
│  │ total_amt   │ amount      │ -           │ ← 금액 검증       │
│  │ transfer_amt│ -           │ amount      │ ← 금액 검증       │
│  │ status      │ status      │ status      │ ← 상태 검증       │
│  └─────────────┴─────────────┴─────────────┘                   │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                       3. 불일치 분류                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [불일치 유형]                                                   │
│  │                                                               │
│  ├─ PLIC_ONLY: PLIC에만 존재 (PG/송금에 없음)                   │
│  ├─ PG_ONLY: PG에만 존재 (PLIC에 없음) ⚠️ GHOST 의심            │
│  ├─ TRANSFER_ONLY: 송금에만 존재 ⚠️ GHOST 의심                  │
│  ├─ AMOUNT_MISMATCH: 금액 불일치                                │
│  ├─ STATUS_MISMATCH: 상태 불일치                                │
│  └─ TIMING_MISMATCH: 시간 경계 불일치 (D-1 vs D)                │
│                                                                  │
│  ⚠️ GHOST_TRANSACTION (유령 거래) 탐지 시:                      │
│     → Critical Alert 발송 (보안 사고 의심)                      │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                       4. 결과 저장 및 알림                       │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2.1 타임존/영업일 정의 ⚠️ (v1.1 추가)

| 항목 | 정의 | 비고 |
|------|------|------|
| **대사 대상일** | KST 날짜 기준 | reconcile_date |
| **PG 영업일** | PG사 영업일 캘린더 | 주말/공휴일 제외 |
| **정산 주기** | D+2 PG 영업일 | PG 캘린더 기준 |
| **Cut-off 타임** | T-1 23:50 KST | 이후 거래는 이월 |

> ⚠️ **영업일 캘린더**: PG사에서 제공하는 캘린더 또는 한국 공휴일 API 사용

### 2.3 대사 데이터 스키마 ⚠️ (v1.1 DB 스키마 연결)

> ⚠️ **SSOT 참조**: 아래 테이블들은 **PLIC_DB_SCHEMA.md**에 정식 반영 필요
> - 인덱스/파티션 전략: 월 단위 파티션 권장 (reconcile_date 기준)

**reconciliation_batches** (대사 배치)
```sql
CREATE TABLE reconciliation_batches (
  id VARCHAR(36) PRIMARY KEY,
  reconcile_date DATE NOT NULL,           -- 대사 대상 날짜 (KST)
  type VARCHAR(20) NOT NULL,              -- PG, TRANSFER, THREE_WAY, FUND
  status VARCHAR(20) NOT NULL,            -- PENDING, PROCESSING, COMPLETED, FAILED
  
  -- 통계
  total_count INT DEFAULT 0,
  matched_count INT DEFAULT 0,
  mismatched_count INT DEFAULT 0,
  
  -- 금액 통계
  plic_total_amount BIGINT DEFAULT 0,
  external_total_amount BIGINT DEFAULT 0,
  amount_difference BIGINT DEFAULT 0,
  
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_date_type (reconcile_date, type)
) PARTITION BY RANGE (reconcile_date);  -- v1.1: 월 단위 파티션 권장
```

**reconciliation_items** (대사 건별 결과)
```sql
CREATE TABLE reconciliation_items (
  id VARCHAR(36) PRIMARY KEY,
  batch_id VARCHAR(36) NOT NULL,
  deal_id VARCHAR(36),
  
  -- 매칭 키 ⚠️ v1.1: External Interface 통일
  plic_key VARCHAR(100),                  -- PLIC_D{dealId}
  external_key VARCHAR(100),              -- 외부 측 식별자
  
  -- 결과
  match_status VARCHAR(20) NOT NULL,      -- MATCHED, MISMATCHED
  mismatch_type VARCHAR(30),              -- AMOUNT, STATUS, PLIC_ONLY 등
  
  -- PLIC 데이터
  plic_amount BIGINT,
  plic_status VARCHAR(20),
  plic_timestamp TIMESTAMP,
  
  -- 외부 데이터
  external_amount BIGINT,
  external_status VARCHAR(20),
  external_timestamp TIMESTAMP,
  
  -- 처리 ⚠️ v1.1: 감사 로그 연결
  resolution_status VARCHAR(20),          -- PENDING, RESOLVED, IGNORED, AUTO_HEALED
  resolution_note TEXT,
  resolved_by VARCHAR(36),                -- admin_id (audit 연결)
  resolved_at TIMESTAMP,
  audit_log_id VARCHAR(36),               -- v1.1: admin_audit_logs 연결
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (batch_id) REFERENCES reconciliation_batches(id),
  INDEX idx_batch_status (batch_id, match_status),
  INDEX idx_deal (deal_id),
  INDEX idx_resolution (resolution_status)
);
```

### 2.3.1 감사 로그 연결 ⚠️ (v1.1 추가)

> 불일치 해결 시 감사 로그 자동 생성

```sql
-- 불일치 해결 시 감사 로그
INSERT INTO admin_audit_logs (
  id, admin_id, action, target_type, target_id, 
  before_value, after_value, reason, created_at
) VALUES (
  $1, $2, 'RECONCILIATION_RESOLVE', 'reconciliation_items', $3,
  '{"status": "MISMATCHED", "mismatch_type": "AMOUNT_MISMATCH"}',
  '{"status": "RESOLVED", "resolution_note": "PG 확인 결과 반올림 차이"}',
  $4, NOW()
);

-- reconciliation_items 업데이트
UPDATE reconciliation_items
SET resolution_status = 'RESOLVED',
    resolution_note = $4,
    resolved_by = $2,
    resolved_at = NOW(),
    audit_log_id = $1
WHERE id = $3;
```

### 2.4 불일치 처리 절차 ⚠️ (v1.1 Self-Healing 추가)

| 불일치 유형 | 자동 처리 | 수동 처리 | 에스컬레이션 |
|------------|----------|----------|-------------|
| **PLIC_ONLY** | - | 외부 시스템 확인 | 24시간 내 미해결 시 |
| **PG_ONLY** | ⚠️ Critical Alert | PG 문의 | 즉시 (GHOST 의심) |
| **TRANSFER_ONLY** | ⚠️ Critical Alert | 송금사 문의 | 즉시 (GHOST 의심) |
| **AMOUNT_MISMATCH** | - | 원인 파악 | 금액 차이 1만원 초과 시 |
| **STATUS_MISMATCH** | ✅ Self-Healing 시도 | 히스토리 확인 | 자동 보정 실패 시 |
| **TIMING_MISMATCH** | ✅ D+1 자동 재확인 | - | - |

### 2.4.1 Self-Healing (자동 상태 보정) ⚠️ (v1.1 추가)

> ⚠️ **적용 대상**: STATUS_MISMATCH 중 타임아웃으로 인한 상태 미반영 건

```
[Self-Healing 로직]

조건: PLIC 상태가 외부보다 지연된 경우
- PLIC: PROCESSING, 외부 PG: DONE → 자동 보정 가능
- PLIC: TRANSFERRING, 외부 송금: COMPLETED → 자동 보정 가능

처리 흐름:
1. STATUS_MISMATCH 감지
   └─ PLIC 상태 < 외부 상태 (지연)

2. 외부 조회 API 재호출
   └─ 최신 상태 확인

3. 상태 일치 확인
   ┌─ 외부 = 성공 (DONE/COMPLETED)
   │   └─ PLIC 상태 업데이트 (Self-Heal)
   │   └─ resolution_status = 'AUTO_HEALED'
   │
   └─ 외부 ≠ 성공 또는 불일치 지속
       └─ 수동 확인으로 전환
       └─ resolution_status = 'PENDING'

4. 감사 로그 기록
   └─ action = 'RECONCILIATION_AUTO_HEAL'
```

**Self-Healing 제외 케이스**:
- 금액 불일치 (AMOUNT_MISMATCH) → 절대 자동 보정 불가
- PLIC 상태 > 외부 상태 (PLIC이 앞선 경우) → 수동 확인
- 금전 관련 상태 변경 (환불, 취소) → 수동 확인

**불일치 처리 플로우**:
```
[불일치 발견]
     │
     ▼
[자동 분류]
     │
     ├─ Self-Healing 가능 (STATUS_MISMATCH, 지연)
     │   │
     │   ▼
     │  [외부 조회 API 호출]
     │   │
     │   ├─ 성공 → 자동 보정 + 'AUTO_HEALED'
     │   └─ 실패 → 수동 전환
     │
     ├─ 자동 해결 가능 (TIMING_MISMATCH)
     │   │
     │   ▼
     │  [D+1 대사에서 재확인]
     │
     ├─ GHOST 의심 (PG_ONLY, TRANSFER_ONLY)
     │   │
     │   ▼
     │  [Critical Alert 즉시 발송]
     │
     └─ 수동 확인 필요 (나머지)
         │
         ▼
        [Slack 알림]
         │
         ▼
        [운영자 확인]
         │
         ├─ 해결 → resolution_note 기록 + audit_log
         │
         └─ 미해결 (24h)
             │
             ▼
            [에스컬레이션]
             - 재무팀 알림
             - 티켓 생성
```

### 2.5 대사 리포트

**일일 대사 리포트 (자동 생성)**:
```
═══════════════════════════════════════════════════════════════
                PLIC 일일 대사 리포트 - 2025-01-05
═══════════════════════════════════════════════════════════════

📊 대사 요약
───────────────────────────────────────────────────────────────
| 항목            | 건수      | 금액           |
|-----------------|-----------|----------------|
| 전일 총 거래    | 1,234     | 123,400,000원  |
| 대사 완료       | 1,231     | 123,100,000원  |
| 불일치          | 3         | 300,000원      |
───────────────────────────────────────────────────────────────

✅ PG 대사
- 매칭 성공: 1,232건
- 불일치: 2건
  - AMOUNT_MISMATCH: 1건 (차이: 1,000원)
  - STATUS_MISMATCH: 1건 (PLIC: PAID, PG: CANCELED)

✅ 송금 대사
- 매칭 성공: 1,200건
- 불일치: 1건
  - PLIC_ONLY: 1건 (송금 기록 누락 의심)

💰 운영 자금 대사
- 장부 잔액: 50,000,000원
- 실 잔액: 50,000,000원
- 차이: 0원 ✅

⚠️ 조치 필요 항목
1. [AMOUNT_MISMATCH] deal_001 - PG 확인 필요
2. [STATUS_MISMATCH] deal_002 - 상태 동기화 필요
3. [PLIC_ONLY] deal_003 - 송금사 확인 필요

───────────────────────────────────────────────────────────────
생성: 2025-01-06 06:30:00 KST
담당: reconcile-batch@plic.co.kr
═══════════════════════════════════════════════════════════════
```

---

## 3. 정산 (Settlement)

### 3.1 정산 주기

| 항목 | 내용 |
|------|------|
| **PG 정산 주기** | D+2 영업일 |
| **정산 방식** | 일괄 정산 (Daily) |
| **정산 계좌** | PLIC 운영 계좌 |

### 3.2 정산 흐름

```
[D일 - 거래 발생]
     │
     │ 결제: 103,000원 (원금 100,000 + 수수료 3,000)
     │ 송금: 100,000원 (운영 자금에서 선지급)
     │
     ▼
[D+1일 - 정산 데이터 확정]
     │
     │ PG: 정산 예정 데이터 제공
     │ PLIC: 대사 실행
     │
     ▼
[D+2일 - 실정산]
     │
     │ PG → PLIC 운영 계좌 입금
     │
     │ 정산 금액 계산:
     │ = 결제 금액 - PG 수수료
     │ = 103,000 - 2,060 (2%)
     │ = 100,940원
     │
     ▼
[PLIC 수익]
     │
     │ = 정산 금액 - 송금 금액
     │ = 100,940 - 100,000
     │ = 940원 (수수료 3,000 - PG수수료 2,060)
```

### 3.3 정산 상세

**정산 금액 산출**:
```
[단건 거래 정산 예시]

거래 금액: 100,000원 (송금액)
서비스 수수료: 3,000원 (3%)
결제 총액: 103,000원

PG 수수료: 2,060원 (결제 총액의 2%)
정산 금액: 100,940원 (103,000 - 2,060)

PLIC 마진: 940원 (3,000 - 2,060)
```

**일일 정산 집계**:
```sql
-- 일일 정산 예상 금액 조회
SELECT 
  DATE(created_at) as settlement_date,
  COUNT(*) as deal_count,
  SUM(total_amount) as total_payment,
  SUM(total_amount * 0.02) as pg_fee,  -- PG 수수료 2%
  SUM(total_amount - total_amount * 0.02) as net_settlement,
  SUM(transfer_amount) as total_transfer,
  SUM(total_amount - total_amount * 0.02 - transfer_amount) as gross_margin
FROM deals
WHERE status = 'COMPLETED'
  AND DATE(created_at) = '2025-01-05'
GROUP BY DATE(created_at);
```

### 3.4 정산 검증

**정산 입금 검증 프로세스**:
```
[매일 10:00 KST - 정산 입금 확인]

1. PG 정산 파일 다운로드
   - D-2 거래 정산 데이터

2. 예상 정산 금액 계산
   - PLIC DB 기준 집계

3. 실제 입금 확인
   - 운영 계좌 입금 내역 조회

4. 검증
   ┌─ 일치
   │   └─ 정산 완료 처리
   │
   └─ 불일치
       ├─ 금액 차이 < 100원: 반올림 차이로 처리
       ├─ 금액 차이 < 10,000원: 수동 확인 후 처리
       └─ 금액 차이 >= 10,000원: PG 문의 + 에스컬레이션

5. 운영 자금 복구
   - 정산 금액만큼 운영 자금 잔액 증가
```

### 3.5 정산 데이터 스키마

**settlement_batches** (정산 배치)
```sql
CREATE TABLE settlement_batches (
  id VARCHAR(36) PRIMARY KEY,
  settlement_date DATE NOT NULL,          -- 정산 대상 날짜
  pg_provider VARCHAR(20) NOT NULL,       -- SOFTPAYMENT
  status VARCHAR(20) NOT NULL,            -- PENDING, RECEIVED, VERIFIED, DISPUTED
  
  -- 예상 금액
  expected_amount BIGINT NOT NULL,
  expected_deal_count INT NOT NULL,
  
  -- 실제 금액
  actual_amount BIGINT,
  actual_deal_count INT,
  
  -- 차이
  amount_difference BIGINT,
  
  -- 타임스탬프
  expected_at DATE,                       -- 정산 예정일
  received_at TIMESTAMP,                  -- 실제 입금 시각
  verified_at TIMESTAMP,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_date (settlement_date),
  INDEX idx_status (status)
);
```

---

## 4. 운영 자금 관리

### 4.1 운영 자금 구조

```
┌─────────────────────────────────────────────────────────────┐
│                     운영 자금 계좌                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [자금 유입]                    [자금 유출]                  │
│                                                              │
│  ├─ PG 정산 입금 (+)            ├─ 수취인 송금 (-)          │
│  │  (D+2 영업일)                │  (즉시)                   │
│  │                              │                           │
│  ├─ 송금 반환 (+)               └─ 환불 시 PG 차감 (-)      │
│  │  (수취인 계좌 문제)              (자동 차감)              │
│  │                                                          │
│  └─ 자본 투입 (+)                                           │
│     (운영팀 수동)                                            │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [잔액 관리]                                                 │
│                                                              │
│  ┌────────────────┐                                         │
│  │ 현재 잔액      │                                         │
│  │ 50,000,000원   │                                         │
│  └────────────────┘                                         │
│         │                                                    │
│         ├─ WARNING (30M 이하): 알림 발송                    │
│         │                                                    │
│         └─ CRITICAL (10M 이하): 신규 거래 중단              │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 운영 자금 임계값

| 레벨 | 잔액 기준 | 조치 |
|------|----------|------|
| **NORMAL** | 30M 초과 | 정상 운영 |
| **WARNING** | 10M ~ 30M | 알림 발송, 모니터링 강화 |
| **CRITICAL** | 10M 이하 | 신규 거래 중단 (Circuit Breaker) |
| **EMERGENCY** | 5M 이하 | 긴급 자본 투입 요청 |

### 4.3 운영 자금 추적

**operational_fund_ledger** (운영 자금 원장)
```sql
CREATE TABLE operational_fund_ledger (
  id VARCHAR(36) PRIMARY KEY,
  transaction_type VARCHAR(20) NOT NULL,  -- TRANSFER_OUT, SETTLEMENT_IN, REFUND_OUT, RETURN_IN, CAPITAL_IN
  
  amount BIGINT NOT NULL,                 -- 양수: 유입, 음수: 유출
  balance_after BIGINT NOT NULL,          -- 거래 후 잔액
  
  reference_type VARCHAR(20),             -- DEAL, SETTLEMENT, MANUAL
  reference_id VARCHAR(36),
  
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_created (created_at),
  INDEX idx_type (transaction_type)
);
```

**거래 유형별 원장 기록** ⚠️ (v1.1 케이스 분리):

```
[송금 출금] - TRANSFER_OUT
- amount: -100,000
- reference_type: DEAL
- reference_id: deal_001
- description: "수취인 송금 - 홍길동"

[정산 입금] - SETTLEMENT_IN  
- amount: +100,940
- reference_type: SETTLEMENT
- reference_id: settlement_batch_001
- description: "D+2 PG 정산 (2025-01-03)"

[송금 반환 입금] - RETURN_IN
- amount: +100,000
- reference_type: DEAL
- reference_id: deal_003
- description: "송금 반환 - 휴면계좌"
```

### 4.3.1 환불/차지백 운영자금 영향 ⚠️ (v1.1 케이스 분리)

> ⚠️ **핵심**: 환불/차지백의 운영자금 영향은 **송금 완료 여부**에 따라 다름

| 케이스 | 송금 상태 | 운영자금 영향 | 처리 |
|--------|----------|--------------|------|
| **Case 1**: 송금 전 취소/환불 | 미출금 | **0원** | PG가 결제자에게 직접 환불 |
| **Case 2**: 송금 실패 후 환불 | 출금 실패 | **0원** | 운영자금 차감 없었음 |
| **Case 3**: 송금 완료 후 차지백 | 출금 완료 | **-100,000원 (손실)** | 손실 원장으로 이동 |
| **Case 4**: 송금 반환 | 출금 후 반환 | **+100,000원 (복구)** | 은행에서 자동 입금 |

**원장 기록 예시**:

```
[Case 1: 송금 전 취소] - REFUND_NO_IMPACT
- amount: 0
- reference_type: DEAL
- reference_id: deal_002
- description: "환불 - 송금 전 취소 (운영자금 영향 없음)"

[Case 3: 송금 완료 후 차지백] - CHARGEBACK_LOSS
- amount: -100,000  ← 손실 확정
- reference_type: CHARGEBACK
- reference_id: chargeback_001
- description: "차지백 손실 - 송금 완료 건"
- ⚠️ 이 금액은 정산에서 차감되거나 별도 청구됨

[Case 4: 송금 반환] - RETURN_IN
- amount: +100,000  ← 복구
- reference_type: DEAL
- reference_id: deal_003
- description: "송금 반환 - 휴면계좌"
```

**운영자금 원장 vs 손실 원장 분리**:

| 원장 유형 | 성격 | 포함 항목 |
|----------|------|----------|
| **operational_fund_ledger** | 현금 흐름 | 송금 출금, 정산 입금, 반환 입금 |
| **loss_ledger** (별도) | 손실 확정 | 차지백 손실, 회수 불가 건 |

> ⚠️ **회계 원칙**: 차지백은 발생일 기준 손실 전표로 처리 (과거 대사 기록 수정 금지)

### 4.4 Circuit Breaker

**Circuit Breaker 로직**:
```javascript
// 송금 요청 전 운영 자금 체크
async function checkOperationalFund(transferAmount: number): Promise<void> {
  const currentBalance = await getFundBalance();
  
  // CRITICAL: 10M 이하
  if (currentBalance <= 10_000_000) {
    // Circuit Breaker OPEN
    await alertOperationsTeam('CRITICAL', currentBalance);
    throw new ServiceUnavailableError({
      code: 'FUND_CRITICAL',
      message: '일시적으로 서비스를 이용할 수 없습니다.',
      retryAfter: 3600  // 1시간 후 재시도 권장
    });
  }
  
  // WARNING: 30M 이하
  if (currentBalance <= 30_000_000) {
    await alertOperationsTeam('WARNING', currentBalance);
    // 거래는 계속 허용
  }
  
  // 송금 후 잔액이 CRITICAL 이하가 되는지 체크
  if (currentBalance - transferAmount <= 10_000_000) {
    await alertOperationsTeam('APPROACHING_CRITICAL', currentBalance - transferAmount);
  }
}
```

---

## 5. 차지백 (Chargeback) 처리

### 5.1 차지백 개요

| 항목 | 내용 |
|------|------|
| **정의** | 카드 소유자가 결제를 취소/이의 제기하여 강제 환불되는 것 |
| **발생 시점** | 결제 후 최대 120일 이내 |
| **리스크** | 이미 송금 완료된 금액 회수 불가 |

### 5.2 차지백 시나리오

```
[차지백 발생 시나리오]

D일: 결제 완료 (103,000원)
     송금 완료 (100,000원 → 수취인)
     
D+30일: 카드 소유자 "결제한 적 없음" 이의 제기
        
D+35일: PG → PLIC 차지백 통보
        - 결제 강제 취소
        - 정산 금액에서 차감 또는 별도 청구
        
결과:
- PLIC 손실: 100,000원 (이미 송금됨)
- 수취인에게 회수: 법적 절차 필요
```

### 5.3 차지백 방어

**사전 방어**:
| 방어 수단 | 설명 |
|----------|------|
| **본인인증 필수** | PASS 인증으로 카드 소유자 본인 확인 |
| **3D Secure** | 카드사 인증 (추가 인증) |
| **거래 한도** | 건당/일/월 한도로 피해 규모 제한 |
| **이상 거래 탐지** | FDS로 의심 거래 차단 |

**차지백 발생 시 대응**:
```
[차지백 대응 프로세스]

1. PG 차지백 통보 수신
   └─ 웹훅 또는 정산 파일

2. 거래 정보 수집
   - 본인인증 증빙
   - 결제 동의 로그
   - IP/디바이스 정보

3. 이의 제기 검토
   ├─ 증빙 충분 → PG에 이의 제기
   └─ 증빙 부족 → 손실 처리

4. 결과 처리
   ├─ 이의 인정 → 차지백 취소, 정산 복구
   └─ 이의 기각 → 손실 확정, 회수 검토

5. 후속 조치
   - 해당 사용자 블랙리스트 검토
   - 수취인 회수 절차 검토 (고액일 경우)
```

### 5.4 차지백 데이터 스키마

**chargebacks** (차지백)
```sql
CREATE TABLE chargebacks (
  id VARCHAR(36) PRIMARY KEY,
  deal_id VARCHAR(36) NOT NULL,
  payment_id VARCHAR(36) NOT NULL,
  
  -- 차지백 정보
  pg_chargeback_id VARCHAR(100),
  reason_code VARCHAR(20),                -- 차지백 사유 코드
  reason_description TEXT,
  
  amount BIGINT NOT NULL,
  
  -- 상태
  status VARCHAR(20) NOT NULL,            -- RECEIVED, DISPUTED, WON, LOST
  
  -- 이의 제기
  dispute_submitted_at TIMESTAMP,
  dispute_evidence TEXT,                  -- 제출 증빙 요약
  dispute_result VARCHAR(20),             -- PENDING, WON, LOST
  dispute_resolved_at TIMESTAMP,
  
  -- 손실 처리
  loss_amount BIGINT,
  loss_processed_at TIMESTAMP,
  
  received_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (deal_id) REFERENCES deals(id),
  INDEX idx_status (status),
  INDEX idx_received (received_at)
);
```

---

## 6. 월간 정산 리포트

### 6.1 리포트 내용

```
═══════════════════════════════════════════════════════════════
              PLIC 월간 정산 리포트 - 2025년 1월
═══════════════════════════════════════════════════════════════

📊 거래 요약
───────────────────────────────────────────────────────────────
| 항목                | 건수      | 금액            |
|---------------------|-----------|-----------------|
| 총 거래             | 15,234    | 1,523,400,000원 |
| 완료 (COMPLETED)    | 14,980    | 1,498,000,000원 |
| 취소 (CANCELLED)    | 200       | 20,000,000원    |
| 실패 (ABANDONED)    | 54        | 5,400,000원     |
───────────────────────────────────────────────────────────────

💰 정산 요약
───────────────────────────────────────────────────────────────
| 항목                | 금액            |
|---------------------|-----------------|
| 총 결제 금액        | 1,543,940,000원 |
| PG 수수료 (2%)      | -30,878,800원   |
| 순 정산 금액        | 1,513,061,200원 |
| 총 송금 금액        | 1,498,000,000원 |
| PLIC 마진           | 15,061,200원    |
───────────────────────────────────────────────────────────────

⚠️ 리스크 요약
───────────────────────────────────────────────────────────────
| 항목                | 건수 | 금액        |
|---------------------|------|-------------|
| 차지백 발생         | 2    | 200,000원   |
| 차지백 이의 성공    | 1    | 100,000원   |
| 차지백 손실         | 1    | 100,000원   |
| 송금 반환           | 3    | 300,000원   |
───────────────────────────────────────────────────────────────

🏦 운영 자금 현황
───────────────────────────────────────────────────────────────
| 항목                | 금액            |
|---------------------|-----------------|
| 월초 잔액           | 45,000,000원    |
| 월말 잔액           | 50,000,000원    |
| 최저 잔액 (1/15)    | 25,000,000원    |
| 평균 잔액           | 42,000,000원    |
───────────────────────────────────────────────────────────────

생성: 2025-02-01 09:00:00 KST
═══════════════════════════════════════════════════════════════
```

---

## 7. 운영 체크리스트

### 7.1 일일 체크리스트

| 시간 | 항목 | 담당 |
|------|------|------|
| 06:30 | 일일 대사 결과 확인 | 운영팀 |
| 07:00 | 대사 불일치 건 처리 | 운영팀 |
| 10:00 | 정산 입금 확인 | 재무팀 |
| 10:30 | 운영 자금 잔액 확인 | 재무팀 |
| 14:00 | 차지백 접수 확인 | 운영팀 |
| 17:00 | 미처리 건 확인 및 인수인계 | 운영팀 |

### 7.2 월간 체크리스트

| 시기 | 항목 | 담당 |
|------|------|------|
| 월초 1-3일 | 전월 정산 마감 확인 | 재무팀 |
| 월초 1-5일 | 월간 정산 리포트 작성 | 재무팀 |
| 월중 15일 | 차지백 현황 리뷰 | 운영팀 |
| 월말 | 운영 자금 적정성 검토 | 재무팀 |

---

## 부록

### A. PG 정산 파일 형식

> ⚠️ 파일 포맷 상세는 **PLIC_EXTERNAL_INTERFACE.md** 참조 권장

**파일명**: `PLIC_SETTLEMENT_YYYYMMDD.csv`

| 컬럼 | 설명 | 예시 |
|------|------|------|
| orderId | PLIC 주문 ID | PLIC_D20250105_001 |
| paymentKey | PG 결제 키 | PK_abc123 |
| amount | 결제 금액 (Gross) | 103000 |
| fee | PG 수수료 | 2060 |
| netAmount | 정산 금액 (Net) | 100940 |
| status | 상태 | DONE |
| approvedAt | 승인 일시 | 2025-01-05 10:30:00 |

### B. 송금 정산 파일 형식

**파일명**: `TRANSFER_SETTLEMENT_YYYYMMDD.csv`

| 컬럼 | 설명 | 예시 |
|------|------|------|
| idempotencyKey | 멱등키 (PLIC_D 형식) | PLIC_D20250105_001 |
| externalId | 송금사 ID | EXT_TR_abc123 |
| amount | 송금 금액 | 100000 |
| fee | 송금 수수료 | 500 |
| status | 상태 | COMPLETED |
| completedAt | 완료 일시 | 2025-01-05 10:31:00 |

### C. 향후 확장: 부분 취소/부분 환불 ⚠️ (v1.1 추가)

> v1.0은 전액 결제/환불만 지원. 향후 부분 취소 도입 시 대사 규칙 변경 필요

**부분 취소 시 대사 규칙 (예정)**:
```
[현재 v1.0 - 전액 대사]
PLIC 금액 = PG 금액 = 송금 금액 → MATCHED

[향후 v1.1+ - 합산 대사]
PLIC 원 결제 금액 = SUM(PG 결제) - SUM(PG 취소)
PLIC 총 송금 금액 = SUM(송금 완료)

대사 키: deal_id 단위로 합산
금액 검증: 합산 기준 (개별 건이 아닌 deal 총액)
```

### D. 참고 문서

| 문서 | 관계 |
|------|------|
| PLIC_FUNDS_FLOW.md | 자금 흐름 상세 |
| PLIC_BATCH_AND_JOBS.md | 배치 작업 상세 |
| PLIC_EXTERNAL_INTERFACE.md | 외부 연동 API, 파일 포맷 |
| PLIC_STATE_MACHINES.md | 상태 전이 규칙 |
| PLIC_DB_SCHEMA.md | 테이블 정의 SSOT |
