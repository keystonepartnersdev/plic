# PLIC 제품 요구사항 정의서 (PRD)

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | PLIC Product Requirements Document |
| 버전 | 1.4 |
| 작성일 | 2025-01-05 |
| 수정일 | 2025-01-06 |
| 작성자 | PLIC 개발팀 |
| 상태 | **Approved** |
| 역할 | **정책 SSOT (요약)** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-05 | 초안 작성 | PLIC 개발팀 |
| 1.1 | 2025-01-05 | CTO 리뷰 반영: 자금 흐름, 리스크 관점 추가 | PLIC 개발팀 |
| 1.2 | 2025-01-05 | 2차 CTO 리뷰 반영: 상태 정책, 한도 표, 차지백 | PLIC 개발팀 |
| 1.3 | 2025-01-06 | 세부 문서 동기화: 멱등성, 타임아웃, 배치, 대사, Rate Limit, 보안 정책 | PLIC 개발팀 |
| 1.4 | 2025-01-06 | **SSOT 동기화**: Deal 상태 10개 확정, Confirm 만료 5분 통일, 서킷브레이커/은행 점검 정책 명시, deal_number 식별자 체계 | PLIC 개발팀 |

---

## 문서 역할

> ⚠️ **이 문서는 정책 요약본입니다.** 상세 내용은 각 세부 문서를 참조하세요.

| 영역 | 상세 문서 |
|------|----------|
| 상태 전이 | PLIC_STATE_MACHINES.md |
| 자금 흐름 | PLIC_FUNDS_FLOW.md |
| 외부 연동 | PLIC_EXTERNAL_INTERFACE.md |
| API 명세 | PLIC_API_SPEC.md |
| 배치/잡 | PLIC_BATCH_AND_JOBS.md |
| 대사/정산 | PLIC_RECONCILIATION_SETTLEMENT.md |

---

## 1. 제품 개요

### 1.1 서비스 정의

**PLIC**은 카드 결제를 통한 계좌 송금 서비스입니다.

> "현금이나 계좌이체로 지불해야 하는 금액을 신용카드로 결제하고, 수취인의 계좌로 원금을 송금해주는 서비스"

### 1.2 핵심 가치

| 가치 | 설명 |
|------|------|
| **편의성** | 카드 한 장으로 어디든 송금 |
| **유연성** | 카드 결제일까지 여유 확보 |
| **투명성** | 수취인에게 원금 전액 전달 |
| **안전성** | PCI-DSS SAQ-A 준수, 카드정보 비접촉 |

### 1.3 서비스 플로우

```
[결제자]                      [PLIC]                    [수취인]
    │                           │                          │
    │ 1. 거래 생성               │                          │
    │   (금액, 수취인, 카드)      │                          │
    │──────────────────────────▶│                          │
    │                           │                          │
    │ 2. 거래 확정               │                          │
    │──────────────────────────▶│                          │
    │                           │                          │
    │                           │ 3. 카드 결제 (PG)        │
    │                           │ (원금 + 수수료)          │
    │                           │                          │
    │                           │ 4. 계좌 송금 (선지급)    │
    │                           │ (원금)                   │
    │                           │─────────────────────────▶│
    │                           │                          │
    │ 5. 완료 알림               │                          │
    │◀──────────────────────────│                          │
```

### 1.4 v1.0 범위 (Scope)

**포함 (In Scope)**:
- 단건 결제 및 송금
- 본인 명의 카드 등록 (최대 5개)
- 수취인 계좌 등록 및 실명 조회
- 등급별 한도 및 수수료

**제외 (Out of Scope)**:
- ❌ 분할 결제 (Split Payment)
- ❌ 법인 카드
- ❌ 해외 카드
- ❌ 정기 결제 (Subscription)

---

## 2. 사용자 정의

### 2.1 사용자 유형

| 유형 | 설명 | 회원 여부 |
|------|------|----------|
| **결제자 (Payer)** | 카드로 결제하고 송금을 요청하는 사용자 | 회원 |
| **수취인 (Recipient)** | 계좌로 돈을 받는 사람 | 비회원 |
| **관리자 (Admin)** | 서비스 운영 및 관리 | 관리자 |

### 2.2 회원 가입 요건

| 항목 | 요건 |
|------|------|
| 본인인증 | PASS 인증 필수 |
| 연령 | 만 19세 이상 |
| 국적 | 내국인 (외국인 미지원 v1.0) |
| CI 중복 | 1인 1계정 (CI 기준) |

---

## 3. 등급 정책

### 3.1 등급 체계

| 등급 | 코드 | 수수료율 | 월 한도 | 승급 조건 |
|------|------|----------|---------|-----------|
| **베이직** | `BASIC` | 3.5% | 1,000만원 | 기본 등급 |
| **플래티넘** | `PLATINUM` | 3.0% | 3,000만원 | 월 수수료 10만원 이상 |

### 3.2 등급 변경

| 항목 | 내용 |
|------|------|
| 산정 기간 | 직전 1개월 (전월 1일 ~ 말일) |
| 변경 시점 | 매월 1일 00:00 (자동 배치) |
| 강등 유예 | 없음 (매월 재산정) |

> 상세: PLIC_BATCH_AND_JOBS.md 섹션 2.2 참조

---

## 4. 한도 정책

### 4.1 PLIC 내부 한도

| 한도 유형 | BASIC | PLATINUM | 비고 |
|-----------|-------|----------|------|
| 1회 최소 | 10,000원 | 10,000원 | - |
| 1회 최대 | 5,000,000원 | 10,000,000원 | - |
| 1일 최대 | 10,000,000원 | 30,000,000원 | - |
| 월간 최대 | 10,000,000원 | 30,000,000원 | 매월 1일 리셋 |

### 4.2 외부 한도

| 구분 | 한도 | 비고 |
|------|------|------|
| PG사 1회 한도 | 가맹점 계약 | PLIC 통제 불가 |
| 카드사 한도 | 카드별 상이 | 결제자 카드 이용한도 |
| 은행 송금 한도 | 은행 정책 | 수취 계좌 입금 한도 |

> ⚠️ 외부 한도에 의해 내부 한도 이내라도 거래가 실패할 수 있습니다.

---

## 5. 수수료 정책

### 5.1 수수료 계산

```
수수료 = 송금 원금 × 수수료율 (절사)
총 결제액 = 송금 원금 + 수수료

예시 (BASIC):
송금 원금: 1,000,000원
수수료: 1,000,000 × 3.5% = 35,000원
총 결제액: 1,035,000원
```

### 5.2 수수료 원칙

| 원칙 | 설명 |
|------|------|
| 결제자 부담 | 수수료는 결제자가 전액 부담 |
| 원금 전액 송금 | 수취인은 송금 원금 전액 수령 |
| 최소 수수료 | **100원** (계산 결과가 100원 미만이어도) |
| VAT 포함 | 표시 수수료는 VAT 포함 금액 |

---

## 6. 거래 상태 정책 ⚠️ (v1.4 SSOT 동기화)

### 6.1 Deal 상태 (10개)

| 상태 | 설명 | 사용자 노출 |
|------|------|------------|
| PENDING | 거래 생성됨, 확정 대기 | "결제 대기 중" |
| PROCESSING | 확정됨, 결제 진행 중 | "처리 중" |
| PAID | 결제 완료, 송금 대기 | "송금 준비 중" |
| TRANSFERRING | 송금 진행 중 | "송금 중" |
| COMPLETED | 송금 완료 | "송금 완료" |
| CANCELLED | 취소됨 | "취소됨" |
| REFUNDED | 환불 완료 | "환불 완료" |
| FAILED | 결제 실패 | "결제 실패" |
| TRANSFER_FAILED | 송금 실패 (재시도 중) | "송금 처리 중" |
| ABANDONED | 송금 실패 (복구 불가) | "송금 실패" |

### 6.2 Confirm 만료 정책 ⚠️ (v1.4 통일)

| 항목 | 정책 |
|------|------|
| PENDING 유효 시간 | **5분** |
| 만료 시 | 자동 CANCELLED (배치 처리, 1분 주기) |
| 재생성 | 만료 후 동일 내용으로 재생성 가능 |

### 6.3 취소 가능 시점

| 상태 | 취소 가능 | 비고 |
|------|----------|------|
| PENDING | ✅ 가능 | 수수료 없음 |
| PROCESSING | ✅ 가능 | 결제 전이면 수수료 없음 |
| PAID | ⚠️ 조건부 | 송금 시작 전까지만 |
| TRANSFERRING | ❌ 불가 | 송금 진행 중 |
| COMPLETED | ❌ 불가 | 완료 후 취소 불가 |

> 상세: PLIC_STATE_MACHINES.md 참조

---

## 7. 환불 정책

### 7.1 환불 사유별 처리

| 사유 | 환불 대상 | 수수료 환불 |
|------|----------|------------|
| 사용자 취소 (결제 전) | 없음 | - |
| 사용자 취소 (결제 후, 송금 전) | 결제 금액 전액 | ✅ 환불 |
| 결제 실패 | 없음 | - |
| 송금 실패 (FATAL) | 결제 금액 전액 | ✅ 환불 |
| 송금 반환 | 결제 금액 전액 | ✅ 환불 |

### 7.2 환불 소요 시간

| 결제 수단 | 환불 소요 시간 |
|----------|---------------|
| 신용카드 | 3~7 영업일 |
| 체크카드 | 3~7 영업일 |

---

## 8. 자금 흐름 정책 ⚠️ (v1.1 추가)

### 8.1 선지급 모델

```
[결제자 결제]                     [수취인 수령]
103,000원 ──────────────────────▶ 100,000원
    │                                 ▲
    │ PG 승인                         │ PLIC 선지급
    ▼                                 │ (운영 자금)
┌─────────┐                     ┌─────────┐
│   PG    │                     │  PLIC   │
│  정산   │ ──── D+2 영업일 ────▶│ 운영계좌 │
│ 100,940원│     (정산 입금)     │         │
└─────────┘                     └─────────┘
```

### 8.2 운영 자금 및 서킷브레이커 정책 ⚠️ (v1.4 상세화)

| 레벨 | 잔액 기준 | 조치 |
|------|----------|------|
| NORMAL | > 50M | 정상 운영 |
| WARNING | 20M ~ 50M | 알림 발송, 자금 충전 요청 |
| CRITICAL | 10M ~ 20M | 대량 거래 제한 (100만원 이상) |
| OPEN | ≤ 10M | **신규 결제 전면 중단** |

**서킷브레이커 상태**:

| 상태 | 설명 | 영향 |
|------|------|------|
| CLOSED | 정상 | 모든 거래 가능 |
| HALF_OPEN | 제한적 운영 | 소액 거래만 허용 |
| OPEN | 거래 중단 | 신규 결제 차단, 진행 중 송금만 처리 |

**복구 조건**:
- 잔액 30M 이상 → CLOSED 자동 전환

### 8.3 은행 점검 시간 정책 ⚠️ (v1.4 추가)

| 항목 | 정책 |
|------|------|
| 공통 점검 시간 | 23:30 ~ 00:30 KST |
| 결제 | 점검 시간 중에도 **가능** |
| 송금 | 점검 종료 후 **순차 처리** |
| 사용자 안내 | "은행 점검으로 송금이 지연될 수 있습니다" 팝업 |

> 상세: PLIC_FUNDS_FLOW.md, PLIC_RECONCILIATION_SETTLEMENT.md 참조

---

## 9. 대사 및 정산 정책 ⚠️ (v1.3 추가)

### 9.1 대사 (Reconciliation)

| 항목 | 내용 |
|------|------|
| 주기 | 매일 06:00 KST |
| 유형 | 3-Way 대사 (PLIC ↔ PG ↔ 송금사) |
| 불일치 처리 | 자동 분류 + 수동 확인 |

### 9.2 정산 (Settlement)

| 항목 | 내용 |
|------|------|
| PG 정산 주기 | D+2 영업일 |
| 정산 금액 | 결제 금액 - PG 수수료 (2%) |

> 상세: PLIC_RECONCILIATION_SETTLEMENT.md 참조

---

## 10. 차지백 정책 ⚠️ (v1.1 추가)

### 10.1 차지백 리스크

| 항목 | 내용 |
|------|------|
| 정의 | 카드 소유자가 결제 이의 제기로 강제 환불 |
| 발생 가능 기간 | 결제 후 최대 120일 |
| 리스크 | 이미 송금 완료된 금액 회수 불가 |

### 10.2 방어 수단

| 수단 | 설명 |
|------|------|
| 본인인증 | PASS 인증 필수 |
| 3D Secure | 카드사 추가 인증 |
| 거래 한도 | 건당/일/월 한도로 피해 제한 |
| FDS | 이상 거래 탐지 |

> 상세: PLIC_RECONCILIATION_SETTLEMENT.md 섹션 5 참조

---

## 11. API 정책 ⚠️ (v1.3 추가)

### 11.1 멱등성 (Idempotency)

| 항목 | 내용 |
|------|------|
| 적용 대상 | 거래 생성, 확정, 취소, 환불 |
| 헤더 | `Idempotency-Key: {uuid}` |
| TTL | 24시간 |
| 동일 키 + 다른 payload | 409 Conflict |

### 11.2 낙관적 락 (Optimistic Lock)

| 항목 | 내용 |
|------|------|
| 적용 대상 | Deal, Payment, Transfer 상태 변경 |
| 헤더 | `If-Match: {version}` |
| 버전 불일치 | 409 VERSION_CONFLICT |

### 11.3 Rate Limiting ⚠️ (v1.3 추가)

| 엔드포인트 | 제한 | 기준 |
|-----------|------|------|
| 인증 API | 10회/분 | IP |
| 일반 API | 100회/분 | userId |
| 거래 생성 | 30회/분 | userId |

> 상세: PLIC_API_SPEC.md 참조

---

## 12. 타임아웃 정책 ⚠️ (v1.3 추가)

### 12.1 외부 API 타임아웃

| API | 연결 | 읽기 | 비고 |
|-----|------|------|------|
| 결제 승인 | 5초 | 60초 | - |
| 결제 취소 | 5초 | 60초 | - |
| 송금 요청 | 5초 | 60초 | - |

### 12.2 타임아웃 처리 원칙

> ⚠️ **핵심**: 타임아웃 ≠ 실패. 반드시 **조회 API로 상태 확인 후** 판단

| 상황 | 처리 |
|------|------|
| 결제 타임아웃 | PG 조회 API로 상태 확인 |
| 송금 타임아웃 | 송금사 조회 API로 상태 확인 |
| 조회도 실패 | PENDING 유지, 재조회 스케줄링 |

> 상세: PLIC_EXTERNAL_INTERFACE.md 섹션 7.2 참조

---

## 13. 배치 작업 정책 ⚠️ (v1.3 추가)

### 13.1 주요 배치

| 배치 | 스케줄 | 역할 |
|------|--------|------|
| grade-update | 매월 1일 00:00 | 등급 변경 |
| daily-reconcile | 매일 06:00 | 일일 대사 |
| transfer-retry | 매일 09:00, 14:00 | 송금 재처리 |
| stale-deal-cleanup | 매시간 | 만료 거래 정리 |
| privacy-cleanup | 매일 04:00 | 개인정보 파기 |

### 13.2 멱등성 SSOT ⚠️ (v1.3 추가)

| 항목 | 내용 |
|------|------|
| 멱등성 최종 진실 | **DB** (idempotency_keys 테이블) |
| Redis 역할 | 분산 락, 캐시, Rate Limit (멱등의 근거 아님) |
| 송금 멱등키 | deal 단위 고정 (재시도에도 동일) |

> 상세: PLIC_BATCH_AND_JOBS.md 참조

---

## 14. 보안 정책

### 14.1 카드 정보 처리

| 항목 | 정책 |
|------|------|
| 카드 번호 | PLIC 서버 미접촉 (PG SDK 토큰화) |
| billingKey | KMS 암호화 저장 |
| CVV/CVC | 절대 저장 금지 |
| PCI-DSS | SAQ-A 준수 |

### 14.2 개인정보 처리

| 항목 | 정책 |
|------|------|
| CI | SHA-256 해시 저장 (원문은 KMS 암호화) |
| 계좌번호 | KMS 암호화 저장, 응답 시 마스킹 |
| 로그 마스킹 | 민감 필드 절대 평문 로깅 금지 |

### 14.3 암호화 정책 ⚠️ (v1.3 추가)

| 구분 | 방식 | 대상 |
|------|------|------|
| 전송 | TLS 1.2+ | 모든 통신 |
| 저장 | KMS AES-256 | CI, 계좌번호, billingKey |
| 로그 | 마스킹 | 민감정보 전체 |

> 상세: PLIC_EXTERNAL_INTERFACE.md 섹션 1.3.1 참조

### 14.4 CI/DI 보관 정책 ⚠️ (v1.3 추가)

| 항목 | 정책 |
|------|------|
| CI 저장 | SHA-256 해시 (중복가입 검증) |
| 탈퇴 후 보관 | CI 해시만 5년 보관 (재가입 차단) |
| 재가입 정책 | 탈퇴 후 30일 이내 불가 |

---

## 15. 비기능 요구사항

### 15.1 가용성

| 항목 | 목표 |
|------|------|
| 서비스 가용성 | 99.9% |
| 계획 점검 | 월 1회, 사전 공지 |

### 15.2 성능

| 항목 | 목표 |
|------|------|
| API 응답 시간 | p95 < 500ms (외부 API 제외) |
| 동시 접속자 | 1,000명 |

### 15.3 데이터 보관

| 데이터 | 보관 기간 | 근거 |
|--------|----------|------|
| 거래 기록 | 5년 | 전자금융거래법 |
| 감사 로그 | 5년 | 전자금융거래법 |
| 로그인 기록 | 3개월 | 통신비밀보호법 |

---

## 16. 성공 지표 (KPI)

| 지표 | 목표 | 측정 주기 |
|------|------|----------|
| 거래 완료율 | > 98% | 일간 |
| 송금 성공률 | > 99% | 일간 |
| 평균 송금 소요 시간 | < 30초 | 일간 |
| 대사 일치율 | > 99.9% | 일간 |
| 차지백 발생률 | < 0.1% | 월간 |

---

## 부록

### A. 용어 정의

> PLIC_GLOSSARY.md 참조

### B. 문서 참조

| 문서 | 역할 |
|------|------|
| PLIC_GLOSSARY.md | 용어 SSOT |
| PLIC_STATE_MACHINES.md | 상태 전이 SSOT |
| PLIC_FUNDS_FLOW.md | 자금 흐름 SSOT |
| PLIC_EXTERNAL_INTERFACE.md | 외부 연동 SSOT |
| PLIC_API_SPEC.md | 내부 API SSOT |
| PLIC_BATCH_AND_JOBS.md | 배치/잡 SSOT |
| PLIC_RECONCILIATION_SETTLEMENT.md | 대사/정산 SSOT |
| PLIC_DB_SCHEMA.md | DB 스키마 |
