# PLIC 실서비스 전환 인프라 로드맵

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 버전 | 1.2 |
| 작성일 | 2025-12-23 |
| 수정일 | 2026-01-06 |
| 서비스명 | PLIC (카드결제 → 계좌이체 대행 서비스) |
| 플랫폼 | 하이브리드 웹앱 (iOS/Android/Web) |
| PG사 | 소프트먼트 (Softpayment) |

---

## 1. 서비스 개요

### 1.1 PLIC 서비스 정의

**"카드결제 → 계좌이체 대행 서비스"**

> 현금/계좌이체로 내야 하는 돈을 카드로 결제하면, 받을 사람에게 PLIC이 계좌이체로 송금해주는 서비스

```
[결제자]                    [PLIC]                    [수취인]
카드로 결제 ──────────────▶ 결제 수신 ──────────────▶ 계좌로 송금받음
(돈 내는 사람)              (중개/대행)               (돈 받는 사람)
```

### 1.2 사용 예시

| 상황 | 기존 방식 | PLIC 이용 |
|------|-----------|-----------|
| 월세 납부 | 계좌이체 | 카드결제 → 집주인 계좌로 송금 |
| 중고차 계약금 | 현금/이체 | 카드결제 → 판매자 계좌로 송금 |
| 학원비/교육비 | 계좌이체 | 카드결제 → 학원 계좌로 송금 |
| 개인 간 송금 | 계좌이체 | 카드결제 → 상대방 계좌로 송금 |

### 1.3 서비스 요약

| 항목 | 내용 |
|------|------|
| **서비스 유형** | 카드결제 → 계좌이체 대행 (페이먼츠) |
| **플랫폼** | 하이브리드 웹앱 (iOS/Android + Web) |
| **사용자 규모** | 전국 단위 (수만~수십만 MAU 대응) |
| **가용성 목표** | 99.9% 이상 |
| **트랜잭션** | 결제 무결성, ACID 보장 |
| **트래픽** | 피크 타임 대응, Auto Scaling |
| **PG사** | 소프트먼트 (Softpayment) |

### 1.4 사용자 정의

| 사용자 | 역할 | PLIC에서 하는 일 |
|--------|------|------------------|
| **결제자** | 돈을 내는 사람 (PLIC 회원) | 회원가입, 카드 등록, 거래 생성, 결제 |
| **수취인** | 돈을 받는 사람 (비회원) | 없음 (계좌 정보만 입력됨) |
| **관리자** | PLIC 운영자 | 회원/거래/정산 관리, 송금 처리 |

### 1.5 핵심 서비스 흐름

```
[결제자]                      [PLIC]                     [수취인]
    │                           │                           │
    │  1. 거래 생성              │                           │
    │  (금액, 수취인 계좌 입력)   │                           │
    │──────────────────────────▶│                           │
    │                           │                           │
    │  2. 카드 결제              │                           │
    │  (원금 + 수수료)           │                           │
    │──────────────────────────▶│                           │
    │                           │                           │
    │                           │  3. 소프트먼트 결제 처리   │
    │                           │◀────────────────────────▶│
    │                           │                           │
    │                           │  4. 수취인 계좌로 송금     │
    │                           │  (원금 전액)              │
    │                           │──────────────────────────▶│
    │                           │                           │
    │  5. 완료 알림              │                           │
    │◀──────────────────────────│                           │
```

**※ 수수료는 결제자가 부담, 수취인은 원금 전액 수령**

### 1.6 수익 모델

```
송금 금액: 1,000,000원 (수취인이 받을 금액)

[결제자]
    │
    ├── 카드 결제: 1,000,000원 + 수수료 30,000원 = 1,030,000원
    │
    ▼
[PLIC]
    │
    ├── 수수료 수익: 30,000원 (3% 가정)
    │   ├── PG 수수료 (소프트먼트): ~25,000원
    │   └── PLIC 마진: ~5,000원
    │
    ▼
[수취인]
    │
    └── 계좌 송금: 1,000,000원 (원금 그대로)
```

**※ 수수료는 결제자가 추가 부담, 수취인은 원금 전액 수령**

### 1.7 결제자 혜택

| 혜택 | 설명 |
|------|------|
| 카드 포인트/마일리지 | 결제 시 카드사 혜택 적립 |
| 카드 할부 | 큰 금액도 할부로 분산 |
| 현금 불필요 | 계좌 잔액 없이도 송금 가능 |
| 결제 내역 관리 | 카드 명세서로 관리 |

---

## 2. 보안 및 규제

### 2.1 PLIC이 하는 일 vs 하지 않는 일

| 구분 | PLIC이 하는 일 | PLIC이 하지 않는 일 |
|------|---------------|-------------------|
| 결제 | 소프트먼트 API 호출 | 직접 카드사 통신 ❌ |
| 카드 정보 | billingKey만 저장 | 카드번호 원본 저장 ❌ |
| 송금 | 수취인 계좌로 이체 요청 | 직접 은행 통신 ❌ |
| 인증 | SMS 인증 (외부 서비스) | 공인인증서 ❌ |

### 2.2 보안 수준 정의

**PG사 가맹점 수준 (PCI-DSS SAQ-A)**

```
은행/카드사        ← PCI-DSS Level 1 (최고 수준)
   ↓
소프트먼트 (PG사)  ← PCI-DSS Level 1
   ↓
✅ PLIC (가맹점)    ← PCI-DSS SAQ-A 수준 (간소화)
   ↓
결제자
```

### 2.3 보안 요구사항 체크리스트

| 항목 | 필요 여부 | 이유 |
|------|-----------|------|
| HTTPS 필수 | ✅ 필수 | 기본 |
| billingKey 암호화 | ✅ 필수 | PG사 요구사항 |
| 계좌번호 암호화 | ✅ 필수 | 개인정보보호법 |
| WAF | ✅ 권장 | SQL Injection, XSS 방지 |
| Shield Advanced | ❌ 불필요 | 과도한 비용 |
| GuardDuty | ⚠️ 선택 | 있으면 좋음 |
| CloudTrail | ✅ 필수 | 감사 로그 |
| Multi-AZ DB | ✅ 필수 | 결제 데이터 보호 |
| 전용 HSM | ❌ 불필요 | KMS로 충분 |

---

## 3. 핵심 데이터 모델

### 3.1 데이터 모델 개요

| 영역 | 모델 | 설명 |
|------|------|------|
| 사용자 | User | 결제자 (PLIC 회원) |
| 거래 | Deal | 결제 건 (금액, 수취인 정보) |
| 결제 | Payment | 카드 결제 내역 |
| 카드 | Card | 등록된 카드 (billingKey) |
| 송금 | Transfer | 수취인 송금 내역 |
| 수취인 계좌 | BankAccount | 수취인 계좌 정보 |
| 즐겨찾기 계좌 | FavoriteAccount | 자주 쓰는 수취인 계좌 |
| 멤버십 | Membership | 등급별 수수료율 |
| 관리자 | AdminUser | 관리자 계정 |

### 3.2 거래 상태 흐름 (Deal Status)

```
[PENDING] 거래 생성됨 (결제자가 금액, 수취인 계좌 입력)
    │
    ▼
[PAID] 결제 완료 (카드 결제 성공)
    │
    ▼
[TRANSFERRING] 송금 중 (수취인 계좌로 이체 진행)
    │
    ├──(송금 성공)──▶ [COMPLETED] 완료
    │
    └──(송금 실패)──▶ [TRANSFER_FAILED] 송금 실패 → 재시도 또는 환불

[CANCELLED] 취소됨 (결제 전 취소 가능)
[REFUNDED] 환불됨 (결제 후 취소 시)
```

**※ 기존 코드의 CONFIRMED 상태 제거** (판매자 확인 불필요)

### 3.3 결제 상태 (Payment Status)

```
PENDING   → 결제 대기
PAID      → 결제 완료
FAILED    → 결제 실패
CANCELLED → 결제 취소
REFUNDED  → 환불됨
```

### 3.4 송금 상태 (Transfer Status)

```
PENDING    → 송금 대기
PROCESSING → 송금 처리 중
COMPLETED  → 송금 완료
FAILED     → 송금 실패
```

### 3.5 분할결제 (보류 - 추후 개발)

```
⚠️ 분할결제 기능은 v1.0에서 제외, 추후 개발 예정

[보류 사유]
- 법적 검토 필요 (자금 체류 기간에 따른 선불전자지급수단 해당 여부)
- v1.0은 일반결제(1회 결제 → 즉시 송금)에 집중

[추후 개발 시 고려사항]
- 송금 트리거 모드 파라미터화 (ALL_COMPLETE / PER_SLICE)
- 법률 검토 결과에 따라 "회차별 즉시 송금" 방식 검토
```

### 3.6 핵심 용어 정의

| 용어 | 정의 | 비고 |
|------|------|------|
| **결제자 (Payer)** | 카드로 결제하는 사람 | PLIC 회원 |
| **수취인 (Recipient)** | 계좌로 돈 받는 사람 | 비회원, 계좌정보만 입력 |
| **거래 (Deal)** | 결제자가 생성한 결제 건 | 금액 + 수취인 계좌 |
| **결제 (Payment)** | 결제자 카드 → PLIC | 수수료 포함 |
| **송금 (Transfer)** | PLIC → 수취인 계좌 | 원금만 (수수료 제외) |
| **서비스 수수료** | 결제자가 부담하는 수수료 | 원금에 추가 |

### 3.7 금액 구조

```
[결제자 입장]
총 결제액 = 송금 원금 + 서비스 수수료
예: 1,030,000원 = 1,000,000원 + 30,000원 (3%)

[수취인 입장]
송금 수령액 = 송금 원금 (수수료 없음)
예: 1,000,000원
```

---

## 4. PG사 연동 (소프트먼트)

### 4.1 소프트먼트 API 개요

| 항목 | 내용 |
|------|------|
| PG사 | 소프트먼트 (Softpayment) |
| Base URL | https://api.softpayment.co.kr/v1 |
| 인증 방식 | API Key (Header) |
| 지원 기능 | 빌링키 발급, 빌링키 결제, 결제 취소, 웹훅 |

### 4.2 소프트먼트 API 엔드포인트

**⚠️ 중요: 카드정보 토큰화 (PCI-DSS SAQ-A 준수)**

PLIC 서버는 카드번호/CVC를 직접 받지 않습니다. 소프트먼트의 클라이언트 SDK를 통해 토큰화됩니다.

```
[카드 등록 흐름 - 토큰화 방식]

결제자 브라우저/앱          소프트먼트 SDK          PLIC 서버
       │                        │                    │
       │  카드정보 입력          │                    │
       │  (카드번호, CVC)       │                    │
       │───────────────────────▶│                    │
       │                        │                    │
       │                        │  토큰화 처리        │
       │                        │  (PG 서버에서 암호화)│
       │                        │                    │
       │     billingKey 반환    │                    │
       │◀───────────────────────│                    │
       │                        │                    │
       │  billingKey만 전송     │                    │
       │────────────────────────┼───────────────────▶│
       │                        │                    │
       │                        │      billingKey    │
       │                        │      암호화 후 저장 │

※ 카드번호, CVC는 PLIC 서버를 절대 거치지 않음
※ PLIC 서버가 받는 것: billingKey, 마스킹된 카드번호(앞6뒤4), 카드사명
※ SAQ-A 준수: 카드 데이터 비접촉
```

```
Base URL: https://api.softpayment.co.kr/v1

┌─────────────────────────────────────────────────────────┐
│                    빌링키 결제                           │
├─────────────────────────────────────────────────────────┤
│ POST /billing/payment                                   │
│                                                         │
│ Request:                                                │
│ {                                                       │
│   "billingKey": "빌링키 (SDK에서 발급받은 것)",           │
│   "amount": 결제금액,                                    │
│   "orderId": "주문번호 (PLIC 거래번호)",                 │
│   "orderName": "거래명"                                  │
│ }                                                       │
│                                                         │
│ Response:                                               │
│ {                                                       │
│   "paymentKey": "결제 고유 키",                          │
│   "status": "DONE | FAILED",                            │
│   "approvedAt": "승인일시",                              │
│   "amount": 결제금액                                     │
│ }                                                       │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    결제 취소                             │
├─────────────────────────────────────────────────────────┤
│ POST /payments/{paymentKey}/cancel                      │
│                                                         │
│ Request:                                                │
│ {                                                       │
│   "cancelReason": "취소 사유",                           │
│   "cancelAmount": 취소금액 (부분취소 시)                 │
│ }                                                       │
│                                                         │
│ Response:                                               │
│ {                                                       │
│   "paymentKey": "결제 고유 키",                          │
│   "status": "CANCELED | PARTIAL_CANCELED",              │
│   "canceledAt": "취소일시",                              │
│   "cancelAmount": 취소금액                               │
│ }                                                       │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    웹훅 수신 (PLIC 구현)                  │
├─────────────────────────────────────────────────────────┤
│ POST /v1/webhooks/softpayment                             │
│                                                         │
│ - 서명 검증(HMAC), 리플레이 방지, 멱등 처리(pg_webhook_events) │
│ - 상세 Payload/헤더/에러 매핑은 External Interface SSOT 참조 │
│                                                         │
│ 참조: 1.Design&Policy_PLIC_EXTERNAL_INTERFACE_v1.2.md     │
└─────────────────────────────────────────────────────────┘
```

### 4.3 PLIC ↔ 소프트먼트 연동 흐름

```
[카드 등록 흐름]

결제자           PLIC 서버         소프트먼트
  │                │                  │
  │ 카드정보 입력   │                  │
  │───────────────▶│                  │
  │                │ POST /billing/   │
  │                │ card/register    │
  │                │─────────────────▶│
  │                │                  │
  │                │   billingKey     │
  │                │◀─────────────────│
  │                │                  │
  │                │ billingKey 암호화 │
  │                │ DB 저장          │
  │   등록 완료     │                  │
  │◀───────────────│                  │


[결제 → 송금 흐름]

결제자           PLIC 서버         소프트먼트        수취인 은행
  │                │                  │                 │
  │  거래 생성      │                  │                 │
  │  (금액, 수취인  │                  │                 │
  │   계좌 입력)   │                  │                 │
  │───────────────▶│                  │                 │
  │                │                  │                 │
  │  결제 요청      │                  │                 │
  │───────────────▶│                  │                 │
  │                │ POST /billing/   │                 │
  │                │ payment          │                 │
  │                │─────────────────▶│                 │
  │                │                  │                 │
  │                │  결제 승인        │                 │
  │                │◀─────────────────│                 │
  │                │                  │                 │
  │                │        계좌이체 요청               │
  │                │─────────────────────────────────▶ │
  │                │                  │                 │
  │                │        송금 완료                   │
  │                │◀─────────────────────────────────│
  │                │                  │                 │
  │  완료 알림      │                  │                 │
  │◀───────────────│                  │                 │
```

### 4.4 소프트먼트 연동 시 주의사항

| 항목 | 내용 |
|------|------|
| API Key 보안 | AWS Secrets Manager에 저장, 코드에 하드코딩 금지 |
| billingKey 암호화 | KMS로 암호화 후 DB 저장 |
| 웹훅 검증 | 서명 검증으로 위변조 방지 |
| 타임아웃 | 결제 API 호출 시 30초 타임아웃 설정 |
| 재시도 | 네트워크 오류 시 최대 3회 재시도 (지수 백오프) |
| 멱등성 | orderId 기반 중복 결제 방지 |

---

## 5. AWS 인프라 아키텍처

### 5.1 아키텍처 다이어그램

```
┌────────────────────────────────────────────────────────────────────┐
│                     AWS Cloud (Seoul Region)                        │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                      Edge Layer                              │  │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐              │  │
│  │  │ Route 53 │───▶│CloudFront│───▶│   WAF    │              │  │
│  │  │  (DNS)   │    │  (CDN)   │    │ (Basic)  │              │  │
│  │  └──────────┘    └──────────┘    └──────────┘              │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                │                                   │
│                                ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                  VPC (10.0.0.0/16)                           │  │
│  │                                                               │  │
│  │   Public Subnet                    Public Subnet              │  │
│  │  ┌────────────────┐              ┌────────────────┐          │  │
│  │  │    AZ-2a       │              │    AZ-2c       │          │  │
│  │  │  ┌──────────┐  │              │  ┌──────────┐  │          │  │
│  │  │  │   ALB    │◀─┼──────────────┼─▶│   ALB    │  │          │  │
│  │  │  └──────────┘  │              │  └──────────┘  │          │  │
│  │  │  ┌──────────┐  │              │  ┌──────────┐  │          │  │
│  │  │  │   NAT    │  │              │  │   NAT    │  │          │  │
│  │  │  └──────────┘  │              │  └──────────┘  │          │  │
│  │  └────────────────┘              └────────────────┘          │  │
│  │                                                               │  │
│  │   Private Subnet (App)             Private Subnet (App)       │  │
│  │  ┌────────────────┐              ┌────────────────┐          │  │
│  │  │  ┌──────────┐  │   Auto      │  ┌──────────┐  │          │  │
│  │  │  │   ECS    │  │  Scaling    │  │   ECS    │  │          │  │
│  │  │  │ Fargate  │◀─┼─────────────┼─▶│ Fargate  │  │          │  │
│  │  │  │(Next.js+ │  │  Min:2      │  │(Next.js+ │  │          │  │
│  │  │  │ NestJS)  │  │  Max:10     │  │ NestJS)  │  │          │  │
│  │  │  └──────────┘  │              │  └──────────┘  │          │  │
│  │  └────────────────┘              └────────────────┘          │  │
│  │                                                               │  │
│  │   Private Subnet (Data)            Private Subnet (Data)      │  │
│  │  ┌────────────────┐              ┌────────────────┐          │  │
│  │  │  ┌──────────┐  │   동기식    │  ┌──────────┐  │          │  │
│  │  │  │   RDS    │  │   복제     │  │   RDS    │  │          │  │
│  │  │  │PostgreSQL│══╪════════════╪══│PostgreSQL│  │          │  │
│  │  │  │(Primary) │  │            │  │(Standby) │  │          │  │
│  │  │  │db.t3.med │  │            │  │자동전환  │  │          │  │
│  │  │  └──────────┘  │            │  └──────────┘  │          │  │
│  │  │  ┌──────────┐  │            │                │          │  │
│  │  │  │  Redis   │  │            │                │          │  │
│  │  │  │(Session/ │  │            │                │          │  │
│  │  │  │ Cache)   │  │            │                │          │  │
│  │  │  └──────────┘  │            │                │          │  │
│  │  └────────────────┘            └────────────────┘          │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    Support Services                          │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │  │
│  │  │Secrets  │ │   KMS   │ │   S3    │ │CloudWatch│           │  │
│  │  │Manager  │ │(암호화) │ │(Assets) │ │(로그/알람)│           │  │
│  │  │-PG API  │ │-billing │ │         │ │          │           │  │
│  │  │ Key     │ │ Key암호 │ │         │ │          │           │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                       │  │
│  │  │  SQS    │ │   SNS   │ │CloudTrail│                       │  │
│  │  │(비동기) │ │(알림)   │ │(감사)   │                       │  │
│  │  └─────────┘ └─────────┘ └─────────┘                       │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    Batch & Scheduler                         │  │
│  │  ┌─────────────┐         ┌─────────────┐                    │  │
│  │  │ EventBridge │────────▶│   Lambda    │                    │  │
│  │  │ (스케줄러)   │         │ (배치작업)  │                    │  │
│  │  │ - 매월 1일   │         │ - 등급변경  │                    │  │
│  │  │ - 매일 송금  │         │ - 월간초기화│                    │  │
│  │  │ - 분할결제   │         │ - 분할결제  │                    │  │
│  │  └─────────────┘         └─────────────┘                    │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    Email & Notification                      │  │
│  │  ┌─────────────┐                                            │  │
│  │  │     SES     │  송금완료, 결제알림 등                       │  │
│  │  │  (이메일)   │                                            │  │
│  │  └─────────────┘                                            │  │
│  └─────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────┘

외부 연동:
┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  소프트먼트  │  │  송금 API   │  │   알리고    │  │  Firebase   │
│ (PG 결제)   │  │ (계좌이체)  │  │ (SMS 인증)  │  │ (Push/FCM)  │
└─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘
```

### 5.2 네트워크 구성

| 구성요소 | CIDR / 설정 | 용도 |
|----------|-------------|------|
| VPC | 10.0.0.0/16 | 메인 VPC |
| Public Subnet AZ-a | 10.0.1.0/24 | ALB, NAT Gateway |
| Public Subnet AZ-c | 10.0.2.0/24 | ALB, NAT Gateway |
| Private Subnet (App) AZ-a | 10.0.10.0/24 | ECS Fargate |
| Private Subnet (App) AZ-c | 10.0.20.0/24 | ECS Fargate |
| Private Subnet (Data) AZ-a | 10.0.100.0/24 | RDS, Redis |
| Private Subnet (Data) AZ-c | 10.0.200.0/24 | RDS Standby |

### 5.3 주요 AWS 서비스

| 서비스 | 사양 | 역할 |
|--------|------|------|
| ECS Fargate | 1 vCPU, 2GB × 2~10 | Next.js + NestJS 컨테이너 |
| RDS PostgreSQL | db.t3.medium, Multi-AZ | 메인 데이터베이스 |
| ElastiCache Redis | cache.t3.micro | 세션, 캐시 |
| ALB | 1개 | 로드밸런싱, HTTPS 종료 |
| CloudFront | - | CDN, 정적 자산 |
| WAF | Basic Rules | 웹 방화벽 |
| S3 | - | 정적 파일, 백업, 로그 보관 |
| Secrets Manager | - | 소프트먼트 API Key, DB 비밀번호 |
| KMS | - | billingKey, 계좌번호 암호화 키 |
| CloudWatch | - | 로그, 메트릭, 알람 |
| CloudTrail | - | 감사 로그 |
| EventBridge | - | 배치 스케줄러 |
| Lambda | - | 배치 작업 실행 |
| SES | - | 이메일 발송 |

### 5.4 송금 아키텍처 (이벤트 기반)

**⚠️ 중요: SQS와 DB큐의 역할 분리**

```
┌─────────────────────────────────────────────────────────────────────┐
│                     송금 이벤트 아키텍처                              │
│                                                                     │
│  [역할 분리]                                                        │
│  - DB (transfer_jobs): 진실의 원천 (Source of Truth)               │
│    → 상태/재시도/락/감사 모두 DB에서 관리                            │
│  - SQS: 워커 깨우는 신호 역할만 (유실되어도 DB 폴링으로 복구)         │
│                                                                     │
│  [소프트먼트]                                                        │
│       │                                                             │
│       │ 웹훅 (결제 완료)                                             │
│       ▼                                                             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │   Webhook   │────▶│pg_webhook_  │────▶│transfer_jobs│           │
│  │  Receiver   │     │  events     │     │  (DB 큐)    │           │
│  │  (NestJS)   │     │ (멱등성)    │     │ =진실의원천 │           │
│  └─────────────┘     └─────────────┘     └─────────────┘           │
│                                                │                    │
│                                   ┌────────────┴────────────┐      │
│                                   ▼                         ▼      │
│                            ┌───────────┐             ┌───────────┐ │
│                            │    SQS    │             │  Transfer │ │
│                            │  (신호용) │────────────▶│   Worker  │ │
│                            │           │             │(ECS)│ │
│                            └───────────┘             └───────────┘ │
│                                                            │       │
│                                          ┌─────────────────┼───┐   │
│                                          ▼                 ▼   ▼   │
│                                   ┌───────────┐     ┌───────────┐ │
│                                   │ transfers │     │  송금 API  │ │
│                                   │  (결과)   │     │           │ │
│                                   └───────────┘     └───────────┘ │
│                                                                     │
│  [정확히 한 번 송금 보장]                                            │
│  - transfer_jobs: deal_id 당 1개만 (UNIQUE 제약)                    │
│  - INSERT ... ON CONFLICT DO NOTHING 패턴                          │
│  - 워커: FOR UPDATE SKIP LOCKED로 중복 처리 방지                    │
│                                                                     │
│  [백업 배치 - 하루 2회]                                              │
│  - DB 폴링으로 누락/실패 건 재처리                                   │
│  - 정합성 검증 (Reconciliation)                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.5 배치 작업 설계 (수정)

| 작업명 | 스케줄 | 역할 |
|--------|--------|------|
| grade-update | 매월 1일 00:00 | 사용자 등급 자동 변경 |
| monthly-reset | 매월 1일 00:30 | 월간 통계 이력 저장 및 초기화 |
| transfer-retry | 매일 09:00, 14:00 | 실패/누락 건 재처리 (DB 폴링) |
| transfer-reconcile | 매일 23:00 | 정합성 검증 (PG vs DB vs 송금) |
| log-archive | 매주 일요일 | 로그 S3 → Glacier 이동 |
| stale-lock-cleanup | 매시간 | 만료된 transfer_jobs 락 해제 |

**※ 분할결제 배치(split-payment)는 v1.0에서 제외**

### 5.6 FDS (이상거래탐지) 기본 룰

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Redis 기반 FDS 룰                               │
│                                                                     │
│  [Rate Limiting]                                                    │
│  - 동일 사용자: 1일 송금 5회 제한                                    │
│  - 동일 사용자: 1일 송금 총액 500만원 제한                           │
│  - 동일 카드: 1시간 결제 3회 제한                                    │
│                                                                     │
│  [Pattern Detection]                                                │
│  - 동일 수취 계좌로 다수 카드 결제 시 Block                          │
│  - 동일 기기에서 다수 계좌로 송금 시 Alert                           │
│  - 신규 가입 후 24시간 내 고액 결제 시 Alert                         │
│                                                                     │
│  [Redis Key 설계]                                                   │
│  - fds:user:{uid}:daily:count     → 일일 송금 횟수                  │
│  - fds:user:{uid}:daily:amount    → 일일 송금 금액                  │
│  - fds:card:{cardId}:hourly:count → 시간당 결제 횟수                │
│  - fds:account:{hash}:cards       → 수취 계좌별 결제 카드 Set       │
│                                                                     │
│  [TTL]                                                              │
│  - daily 키: 24시간                                                 │
│  - hourly 키: 1시간                                                 │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.7 백업 및 로그 보관 정책

| 항목 | 보관 기간 | 저장소 |
|------|-----------|--------|
| RDS 자동 백업 | 7일 | RDS |
| RDS 스냅샷 | 30일 | S3 |
| 애플리케이션 로그 | 90일 | CloudWatch → S3 |
| 결제/송금 로그 | 5년 | S3 → Glacier |
| CloudTrail | 1년 | S3 |

---

## 6. 하이브리드 앱 아키텍처

### 6.1 앱 구조

```
┌─────────────────────────────────────────────────────────┐
│                    Mobile Apps                           │
│  ┌─────────────────┐       ┌─────────────────┐         │
│  │   iOS App       │       │  Android App    │         │
│  │  ┌───────────┐  │       │  ┌───────────┐  │         │
│  │  │ WKWebView │  │       │  │ WebView   │  │         │
│  │  └─────┬─────┘  │       │  └─────┬─────┘  │         │
│  │        │        │       │        │        │         │
│  │  ┌─────┴─────┐  │       │  ┌─────┴─────┐  │         │
│  │  │  Native   │  │       │  │  Native   │  │         │
│  │  │  Bridge   │  │       │  │  Bridge   │  │         │
│  │  │ - Push    │  │       │  │ - Push    │  │         │
│  │  │ - 생체인증│  │       │  │ - 생체인증│  │         │
│  │  └───────────┘  │       │  └───────────┘  │         │
│  └─────────────────┘       └─────────────────┘         │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              Next.js (하이브리드 웹앱)                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │  모바일 최적화 UI (375px 기준)                    │   │
│  │  - 반응형 레이아웃                               │   │
│  │  - PWA 지원                                     │   │
│  │  - Native Bridge 연동                           │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 6.2 하이브리드 앱 기술 스택

| 옵션 | 장점 | 단점 | 권장 |
|------|------|------|------|
| **Capacitor** | Next.js 호환, 쉬운 설정 | 네이티브 성능 한계 | ✅ 권장 |

### 6.3 Native Bridge 기능

| 기능 | iOS | Android | 용도 |
|------|-----|---------|------|
| Push Notification | APNs | FCM | 결제/송금 완료 알림 |
| Biometric Auth | Face ID / Touch ID | Fingerprint | 간편 로그인, 결제 인증 |
| Deep Link | Universal Links | App Links | 외부 링크 앱 실행 |

---

## 7. 비용 산정

### 7.1 월간 예상 비용 (운영 환경)

| 서비스 | 사양 | 월 비용 (USD) |
|--------|------|---------------|
| ECS Fargate | 1 vCPU, 2GB × 2~10개 | ~$80 |
| RDS PostgreSQL | db.t3.medium, Multi-AZ | ~$130 |
| ElastiCache Redis | cache.t3.micro | ~$15 |
| ALB | 1개 | ~$20 |
| NAT Gateway | 2개 | ~$70 |
| CloudFront | 100GB | ~$10 |
| WAF | Basic Rules | ~$10 |
| S3 + 로그 보관 | - | ~$20 |
| EventBridge + Lambda | 배치 작업 | ~$5 |
| SES | 이메일 | ~$10 |
| 기타 | Secrets Manager, KMS 등 | ~$10 |
| **합계** | | **~$380/월** |

### 7.2 비용 옵션별 비교

| 구성 | 월 비용 | 비고 |
|------|---------|------|
| 운영 환경 (Multi-AZ) | ~$380 | 권장 |
| 초기 환경 (Single-AZ) | ~$220 | 트래픽 적을 때 |
| 개발 환경 | ~$120 | 테스트용 |

### 7.3 외부 서비스 비용

| 서비스 | 단가 | 예상 월 비용 |
|--------|------|--------------|
| 소프트먼트 (PG) | 결제금액의 수수료% | 거래량에 따라 |
| 송금 API | 건당 수수료 | 거래량에 따라 |
| 알리고 SMS | 건당 8.4원 | ~50,000원 (5,000건) |
| Firebase (Push) | 무료 티어 | $0 |

---

## 8. 개발 로드맵

### 8.1 전체 일정 (14주)

| Phase | 기간 | 작업 내용 | 산출물 |
|-------|------|-----------|--------|
| **Phase 1** | 2주 | 인프라 설계 + DB 스키마 | 설계 문서, ERD, DDL |
| **Phase 2** | 1.5주 | AWS 인프라 구축 | Terraform, 인프라 |
| **Phase 3** | 4주 | 백엔드 API 개발 | NestJS API 서버 |
| **Phase 4** | 2주 | 소프트먼트 + SMS + 송금 + FDS | 결제/인증/송금/보안 |
| **Phase 5** | 1.5주 | 프론트엔드 API 연동 | Next.js 수정 |
| **Phase 6** | 1주 | 하이브리드 앱 래핑 | iOS/Android 앱 |
| **Phase 7** | 2주 | 테스트 + 앱 심사 + 배포 | 운영 환경 |
| **총** | **14주** | | |

### 8.2 Phase 1: 인프라 설계 + DB 스키마 (2주)

**작업 내용:**
- AWS 아키텍처 상세 설계
- PostgreSQL 스키마 설계 (v2.0 기준)
- ERD 작성
- 송금 이벤트 아키텍처 설계
- Terraform 초기 구조

**핵심 스키마 (v2.0 - CTO 리뷰 반영):**

| 구분 | 테이블 | 설명 |
|------|--------|------|
| Core | deals, payments, payment_slices, transfers | 거래/결제/송금 |
| Transaction | pg_webhook_events, idempotency_keys, transfer_jobs | 멱등성/큐 |
| Audit | admin_audit_logs, ledger_entries | 감사/원장 |
| Statistics | user_monthly_stats | 월간 통계 이력 |

**공통 컬럼 (모든 테이블):**
- `version`: Optimistic Lock
- `deleted_at`: Soft Delete
- `*_hash`: 암호화 필드 검색용

**산출물:**
- `PLIC_DB_SCHEMA.md` (v2.0)
- `PLIC_ERD.png`
- `PLIC_TRANSFER_ARCHITECTURE.md`
- `terraform/` 디렉토리 구조

### 8.3 Phase 2: AWS 인프라 구축 (1.5주)

**Week 1:**
- VPC, Subnet, Route Table 생성
- Security Group, NACL 설정
- NAT Gateway, Internet Gateway

**Week 1.5:**
- RDS PostgreSQL (Multi-AZ)
- ElastiCache Redis
- ECS Cluster & Task Definition
- ALB 설정
- EventBridge + Lambda 설정
- SES 설정

### 8.4 Phase 3: 백엔드 API 개발 (4주)

**기술 스택:**

| 항목 | 선택 | 이유 |
|------|------|------|
| Framework | NestJS | TypeScript, 구조화, 검증 |
| ORM | Prisma | 타입 안전, 마이그레이션 |
| 인증 | JWT + Redis | 무상태, 토큰 관리 |
| 문서화 | Swagger | 자동 API 문서 |
| 큐 | SQS + Worker | 송금 이벤트 처리 |

**주차별 작업:**

**Week 1-2: 핵심 API + 멱등성**
- 인증 API (회원가입, 로그인, SMS)
- 사용자 API
- 거래 API (Deal CRUD)
- 멱등성 미들웨어 (idempotency_keys)
- 웹훅 수신기 (pg_webhook_events)

**Week 3: 결제 + 송금**
- 카드 API (토큰화 연동)
- 결제 API (Payment)  # Split Payment는 v2.0 Backlog
- 송금 워커 (transfer_jobs → transfers)
- 송금 API 연동

**Week 4: 관리자 + 감사**
- 관리자 API
- 감사 로그 (admin_audit_logs)
- 원장 기록 (ledger_entries)
- 정합성 검증 API (Reconciliation)

**API 엔드포인트 (전체):**

```
/v1
├── /auth            # 인증/인가
├── /users           # 사용자 관리
├── /cards           # 카드 관리 (billingKey 저장)
├── /recipients      # 수취인 계좌 검증/저장
├── /deals           # 거래 생성/조회/확정(confirm)/취소
├── /payments        # 결제 상세 조회 (PG 추적)
├── /transfers       # 송금 상세 조회 (송금 추적)
├── /admin           # 운영/관리자
└── /webhooks        # PG 웹훅 수신
```

> 상세 엔드포인트/요청·응답/에러코드는 **`1.Design&Policy_PLIC_API_SPEC_v1.1.md`**를 SSOT로 참조합니다.


### 8.5 Phase 4: 소프트먼트 + SMS + 송금 + FDS (2주)

**Week 1: 결제/송금 연동**

**소프트먼트 연동:**

| 기능 | API | PLIC 기능 |
|------|-----|-----------|
| 빌링키 발급 | 클라이언트 SDK (토큰화) | 카드 등록 |
| 빌링키 결제 | POST /billing/payment | 거래 결제 |
| 결제 취소 | POST /payments/{key}/cancel | 환불 처리 |
| 웹훅 수신 | PLIC: POST /webhook/softpayment | 상태 동기화 → 송금 트리거 |

**송금 API 연동:**

| 기능 | 설명 |
|------|------|
| 계좌 유효성 검증 | 수취인 계좌 실명 확인 |
| 계좌 이체 | 결제 완료 → 즉시 송금 (이벤트 기반) |
| 송금 상태 조회 | 송금 진행 상태 확인 |

**Week 2: SMS + FDS**

**SMS 인증 (알리고):**

| 항목 | 내용 |
|------|------|
| 서비스 | 알리고 |
| 비용 | 건당 8.4원 |
| 기능 | 인증코드 발송, 유효시간 3분 |

**FDS 기본 룰 구현:**
- Redis Rate Limiter 구현
- 이상 패턴 탐지 룰 구현
- Alert/Block 처리 로직

### 8.6 Phase 5: 프론트엔드 API 연동 (1.5주)

**변경 사항:**
```
├── Mock 데이터 → API 호출로 교체
├── localStorage → API 응답 + React Query 캐싱
├── Zustand 스토어 → API 연동 버전으로 수정
└── 인증 토큰 관리 추가 (interceptor)
```

### 8.7 Phase 6: 하이브리드 앱 래핑 (1주)

**Capacitor 설정:**
```bash
npm install @capacitor/core @capacitor/cli
npx cap init PLIC com.plic.app
npx cap add ios
npx cap add android
```

**Native 기능 연동:**
- Push Notification (FCM)
- 생체 인증
- Deep Link

### 8.8 Phase 7: 테스트 + 앱 심사 + 배포 (2주)

**Week 1: 테스트**

| 테스트 유형 | 도구 | 범위 |
|-------------|------|------|
| 단위 테스트 | Jest | 비즈니스 로직 |
| 통합 테스트 | Supertest | API 엔드포인트 |
| E2E 테스트 | Playwright | 주요 사용자 시나리오 |
| 부하 테스트 | k6 | 동시 접속 100명 |

**결제/송금 특화 테스트:**
- 소프트먼트 테스트 모드 결제
- 송금 실패 → 재시도 시나리오
- 웹훅 중복 수신 처리
- 부분 취소/환불

**Week 2: 앱 심사 + 배포**

**앱스토어 심사 대응:**
- 금융 서비스 소명 자료 준비
- "카드깡 아님" 설명 문서
- 서비스 이용약관, 개인정보처리방침
- 테스트 계정 제공

**배포:**
- CI/CD 파이프라인 (GitHub Actions)
- 스테이징 환경 검증
- 프로덕션 배포
- 모니터링 알람 설정 7: 테스트 + 배포 (1.5주)

**테스트:**
- 통합 테스트
- 소프트먼트 테스트 모드 결제
- 송금 테스트
- 분할결제 시나리오 테스트
- 부하 테스트 (k6)

**배포:**
- CI/CD 파이프라인 (GitHub Actions)
- 스테이징 → 프로덕션

---

## 9. 리스크 관리

### 9.1 주요 리스크

| 리스크 | 영향도 | 발생 가능성 | 대응 방안 |
|--------|--------|-------------|-----------|
| 소프트먼트 연동 지연 | 높음 | 중 | 테스트 모드 먼저 개발 |
| 송금 API 연동 지연 | 높음 | 중 | 대체 서비스 검토 |
| 앱스토어 심사 지연 | 중 | 중 | 2주 여유 확보 |
| 결제/송금 오류 | 높음 | 중 | 롤백/환불 로직 철저 설계 |

※ **분할결제(Split Payment)**는 v1.0 범위에서 제외되어, 리스크/일정은 v2.0 Backlog로 관리합니다.

### 9.2 롤백 계획

| 상황 | 롤백 방안 |
|------|-----------|
| 결제 실패 | 트랜잭션 롤백, 사용자 알림 |
| 송금 실패 | 재시도 큐, 관리자 알림, 수동 처리 |
| 배포 실패 | ECS 이전 태스크로 롤백 |
| DB 마이그레이션 실패 | RDS 스냅샷 복원 |

---

## 10. 관련 SSOT 문서

인프라 구현/운영 시 아래 문서를 **단일 진실(SSOT)**로 참조합니다.  
(인프라 로드맵에는 상세 규격(JSON/필드/에러코드)을 **복제하지 않고 링크로 유지**합니다.)

- **PRD**: `1.Design&Policy_PLIC_PRD_v1.3.md`
- **API (내부)**: `1.Design&Policy_PLIC_API_SPEC_v1.1.md`
- **External Interface (PG/송금/PASS/SMS)**: `1.Design&Policy_PLIC_EXTERNAL_INTERFACE_v1.2.md`
- **Funds Flow (자금 흐름)**: `1.Design&Policy_PLIC_FUNDS_FLOW_v1.1.md`
- **State Machines (상태 전이)**: `1.Design&Policy_PLIC_STATE_MACHINES_v1.1.md`
- **DB Schema**: `0. Overview_plic-db-schema.md`
- **Batch & Jobs**: `2. Architecture & Integrity_PLIC_BATCH_AND_JOBS_v1.1.md`
- **Reconciliation & Settlement**: `2. Architecture & Integrity_PLIC_RECONCILIATION_SETTLEMENT_v1.1.md`
- **Engineering Guide**: `PLIC_ENGINEERING_GUIDE_v1.1.md`

---

## 부록

### A. 기술 스택 요약

| 레이어 | 기술 |
|--------|------|
| Frontend | Next.js 14, TypeScript, Tailwind CSS |
| Backend | NestJS, Prisma, PostgreSQL |
| Cache | Redis (ElastiCache) |
| Infra | AWS (ECS, RDS, ALB, CloudFront) |
| Mobile | Capacitor (iOS/Android) |
| PG사 | **소프트먼트 (Softpayment)** |
| 송금 | 송금 API (TBD) |
| CI/CD | GitHub Actions |
| Monitoring | CloudWatch, Sentry |

### B. 용어 정의

| 용어 | 정의 |
|------|------|
| 결제자 | PLIC 회원, 카드로 결제하는 사람 |
| 수취인 | 계좌로 돈을 받는 사람 (비회원) |
| 거래 | 결제자가 생성한 결제 건 |
| 결제 | 결제자 카드에서 PLIC으로 돈이 들어오는 것 |
| 송금 | PLIC에서 수취인 계좌로 돈이 나가는 것 |
| 분할결제 | 큰 금액을 여러 번에 나눠 결제 |

### C. 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|-----------|
| 1.0 | 2025-12-23 | 초안 작성 |
| 1.1 | 2025-12-23 | CTO 리뷰 반영: 이벤트 기반 송금, FDS 고려, 앱 심사 기간 확장 |
| 1.2 | 2026-01-06 | SSOT 정합성 반영: `/v1` 통일, Split Payment v2 Backlog, Settlement→Transfer 용어 정리, External Interface 링크화, Worker=ECS 고정 |
