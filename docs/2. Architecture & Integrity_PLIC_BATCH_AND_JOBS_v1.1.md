# PLIC 배치 및 잡 명세 (BATCH AND JOBS)

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | PLIC Batch and Jobs Specification |
| 버전 | 1.1 |
| 작성일 | 2025-01-06 |
| 수정일 | 2025-01-06 |
| 작성자 | PLIC 개발팀 |
| 상태 | Draft |
| 역할 | **배치/잡 SSOT** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-06 | 초안 작성 | PLIC 개발팀 |
| 1.1 | 2025-01-06 | CTO 리뷰 반영: 멱등성 DB SSOT, 멱등키 분리, transfer_jobs 유니크 제약, 상태명 정합성, Cron 검증, Circuit Breaker 재개 정책, 배치 추가 | PLIC 개발팀 |

---

## 1. 개요

### 1.1 문서 목적

이 문서는 PLIC 서비스에서 실행되는 모든 배치 작업과 비동기 잡을 정의합니다. 운영팀과 개발팀이 "언제, 무엇이, 왜 실행되는지"를 명확히 이해하기 위한 **단일 진실 공급원(SSOT)**입니다.

### 1.2 작업 분류

| 분류 | 설명 | 트리거 | 예시 |
|------|------|--------|------|
| **Scheduled Batch** | 정해진 시간에 실행 | Cron/EventBridge | 등급 변경, 대사 |
| **Event-Driven Job** | 이벤트 발생 시 실행 | SQS/SNS | 송금 처리, 알림 발송 |
| **Manual Job** | 관리자 수동 실행 | Admin API | 수동 대사, 재처리 |

### 1.3 인프라 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                        AWS Infrastructure                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [Scheduled Batch]                                              │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │ EventBridge │────▶│   Lambda    │────▶│   RDS/     │       │
│  │  Scheduler  │     │  Function   │     │   Redis    │       │
│  └─────────────┘     └─────────────┘     └─────────────┘       │
│                                                                  │
│  [Event-Driven Job]                                             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │     SQS     │────▶│   Worker    │────▶│  External  │       │
│  │    Queue    │     │  (Lambda/   │     │    API     │       │
│  │             │     │   ECS)      │     │ (PG/Bank)  │       │
│  └─────────────┘     └─────────────┘     └─────────────┘       │
│                                                                  │
│  [Monitoring]                                                   │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │ CloudWatch  │────▶│    SNS     │────▶│   Slack    │       │
│  │   Alarms    │     │   Topic    │     │   Alert    │       │
│  └─────────────┘     └─────────────┘     └─────────────┘       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. Scheduled Batch (정기 배치)

### 2.1 배치 작업 목록 ⚠️ (v1.1 보강)

| 작업명 | 스케줄 (KST) | 역할 | 우선순위 |
|--------|-------------|------|----------|
| `grade-update` | 매월 1일 00:00 | 사용자 등급 자동 변경 | P1 |
| `monthly-reset` | 매월 1일 00:30 | 월간 통계 이력 저장 및 초기화 | P1 |
| `daily-reconcile` | 매일 06:00 | 일일 대사 (PG vs DB vs 송금) | P0 |
| `transfer-retry` | 매일 09:00, 14:00 | 실패 송금 재처리 (백업) | P0 |
| `stale-deal-cleanup` | 매시간 정각 | 만료 거래 정리 (PENDING 5분 초과) | P1 |
| `stale-transaction-cleanup` | 매일 03:00 | 24h+ 미완료 거래 정리 (v1.1 추가) | P1 |
| `dormant-check` | 매일 02:00 | 휴면 계정 전환 검사 | P2 |
| `privacy-cleanup` | 매일 04:00 | 탈퇴 사용자 개인정보 파기 (v1.1 추가) | P2 |
| `log-archive` | 매주 일요일 03:00 | 로그 S3 → Glacier 이동 | P3 |
| `transfer-return-check` | 매일 06:30 | 송금 사후 반환 확인 | P0 |

> ⚠️ **상태명 정합성**: 모든 상태명은 PLIC_STATE_MACHINES.md에 정의된 상태만 사용

---

### 2.2 grade-update (등급 변경)

**스케줄**: 매월 1일 00:00 KST

**목적**: 전월 거래 실적 기준으로 사용자 등급 자동 조정

**로직**:
```
[등급 변경 로직]

1. 전월 거래 통계 집계
   - 거래 건수 (COMPLETED 상태만)
   - 거래 금액 합계

2. 등급 기준 비교
   | 등급 | 월 거래 건수 | 월 거래 금액 |
   |------|-------------|--------------|
   | BASIC | - | - |
   | SILVER | 5건 이상 | 50만원 이상 |
   | GOLD | 15건 이상 | 200만원 이상 |
   | VIP | 30건 이상 | 500만원 이상 |

3. 등급 변경 적용
   - 승급: 즉시 적용
   - 강등: 2개월 연속 미달 시 적용 (유예 기간)

4. 변경 이력 저장
   - user_grade_histories 테이블에 기록

5. 알림 발송
   - 등급 변경 시 푸시/SMS 발송
```

**의존성**: `monthly-reset` 이전에 실행 필수

**실패 처리**:
- 개별 사용자 실패 시 스킵 후 계속 진행
- 전체 실패 시 알림 후 수동 재실행

**예상 소요 시간**: 사용자 10만명 기준 약 10분

---

### 2.3 monthly-reset (월간 초기화)

**스케줄**: 매월 1일 00:30 KST

**목적**: 월간 한도 및 통계 초기화

**로직**:
```
[월간 초기화 로직]

1. 월간 통계 이력 저장
   - user_monthly_stats 테이블에 전월 데이터 아카이빙

2. 한도 카운터 초기화
   - users.monthly_used_amount = 0
   - users.monthly_deal_count = 0

3. 통계 테이블 갱신
   - 사용자별 월간 누적 초기화
```

**의존성**: `grade-update` 완료 후 실행

---

### 2.4 daily-reconcile (일일 대사)

**스케줄**: 매일 06:00 KST

**목적**: PG 정산 데이터, 송금 데이터, 내부 DB 간 정합성 검증

**로직**:
```
[일일 대사 로직]

1. 대사 대상 추출
   - 전일 00:00 ~ 23:59:59 사이 생성된 거래
   - 상태: COMPLETED, CANCELLED, ABANDONED, REFUNDED

2. PG 데이터 수신
   - PG 정산 파일 다운로드 (SFTP/API)
   - 파싱 및 임시 테이블 저장

3. 송금 데이터 수신
   - 송금사 정산 파일 다운로드
   - 파싱 및 임시 테이블 저장

4. 3-Way 대사
   ┌─────────────┐
   │   PLIC DB   │
   │  (deals,    │
   │  payments,  │
   │  transfers) │
   └──────┬──────┘
          │
    ┌─────┴─────┐
    ▼           ▼
┌───────┐   ┌───────┐
│  PG   │   │ 송금  │
│ 정산  │   │ 정산  │
└───────┘   └───────┘

   검증 항목:
   - 건수 일치
   - 금액 일치 (원 단위)
   - 상태 일치

5. 불일치 건 처리
   | 불일치 유형 | 처리 |
   |------------|------|
   | PLIC에만 존재 | 수동 확인 필요 |
   | PG에만 존재 | 누락 거래 복구 검토 |
   | 금액 불일치 | 우선 수동 확인 |
   | 상태 불일치 | 상태 동기화 검토 |

6. 대사 결과 저장
   - reconciliation_results 테이블
   - 불일치 건은 reconciliation_mismatches 테이블

7. 알림 발송
   - 불일치 발생 시 Slack 알림
   - 일일 대사 리포트 발송
```

**상세 내용**: PLIC_RECONCILIATION_SETTLEMENT.md 참조

**실패 처리**:
- 파일 수신 실패 시 30분 간격 3회 재시도
- 3회 실패 시 알림 후 수동 처리

---

### 2.5 transfer-retry (송금 재처리) ⚠️ (v1.1 유니크 제약 추가)

**스케줄**: 매일 09:00, 14:00 KST

**목적**: 실시간 처리 실패한 송금 건 백업 재처리

**로직**:
```
[송금 재처리 로직]

1. 재처리 대상 추출
   - Transfer 상태: FAILED (failure_type = RETRYABLE)
   - 마지막 시도: 1시간 이상 경과
   - 시도 횟수: 5회 미만

2. 은행 점검 시간 확인
   - 수취 은행별 점검 시간 체크
   - 점검 중이면 해당 건 스킵

3. Job 생성 ⚠️ (v1.1: deal당 1개 제약)
   - transfer_jobs 테이블에 job 생성
   - INSERT ... ON CONFLICT (deal_id, status='PENDING') DO NOTHING
   - 이미 활성 job 존재 시 next_retry_at만 갱신

4. SQS 메시지 발행
   - 새로 생성된 job만 발행
   - externalIdempotencyKey는 deal 단위 고정 유지

5. 결과 처리
   - 성공: Transfer → COMPLETED
   - 실패 (RETRYABLE): 다음 배치에서 재시도
   - 실패 (FATAL): Transfer → FAILED, Deal → ABANDONED

6. 최대 시도 초과 시
   - 5회 초과: MANUAL_REVIEW 플래그 설정
   - 관리자 알림 발송
```

### 2.5.1 transfer_jobs 유니크 제약 ⚠️ (v1.1 추가)

> ⚠️ **핵심**: deal당 동시에 1개의 활성 job만 존재 (중복 송금 방지)

**DB 제약**:
```sql
-- deal당 활성 job 1개 제약
CREATE UNIQUE INDEX idx_transfer_jobs_deal_active 
ON transfer_jobs (deal_id) 
WHERE status IN ('PENDING', 'PROCESSING');
```

**Job 생성 패턴**:
```sql
-- Upsert 패턴: 존재하면 retry_at만 갱신
INSERT INTO transfer_jobs (id, deal_id, transfer_id, status, attempt, next_retry_at)
VALUES ($1, $2, $3, 'PENDING', $4, $5)
ON CONFLICT (deal_id) WHERE status IN ('PENDING', 'PROCESSING')
DO UPDATE SET next_retry_at = $5, updated_at = NOW();
```

**주의사항**:
- 멱등키는 deal 단위로 고정 (중복 송금 방지)
- 은행 점검 시간대 자동 스킵

---

### 2.6 stale-deal-cleanup (만료 거래 정리) ⚠️ (v1.1 상태명 수정)

**스케줄**: 매시간 정각

**목적**: 확정되지 않은 PENDING 거래 자동 만료 처리

**로직**:
```
[만료 거래 정리 로직]

1. 만료 대상 추출
   - Deal 상태: PENDING
   - 생성 시각: 현재 - 5분 이상

2. 상태 전이
   - Deal: PENDING → CANCELLED
   - cancel_reason: 'TIMEOUT_EXPIRED'

3. 리소스 해제
   - 사용자 한도 복구 (예약된 금액 해제)

4. 통계 업데이트
   - 만료 건수 집계
```

> ⚠️ **상태명 정합성**: EXPIRED 상태 대신 CANCELLED + reason_code 사용 (STATE_MACHINES 준수)

---

### 2.7 dormant-check (휴면 계정 검사)

**스케줄**: 매일 02:00 KST

**목적**: 장기 미이용 계정 휴면 전환

**로직**:
```
[휴면 계정 검사 로직]

1. 휴면 대상 추출
   - 마지막 로그인: 1년 이상 경과
   - 마지막 거래: 1년 이상 경과
   - 현재 상태: ACTIVE

2. 사전 알림 (휴면 전환 30일 전)
   - 이메일/SMS 발송
   - 휴면 예정 안내

3. 휴면 전환
   - User 상태: ACTIVE → DORMANT
   - 빌링키 비활성화 (선택)

4. 휴면 해제 조건
   - 로그인 시 자동 해제
   - 본인인증 재수행 필요
```

---

### 2.8 transfer-return-check (송금 반환 확인)

**스케줄**: 매일 06:30 KST

**목적**: 전일 완료 송금 중 사후 반환 건 확인

**로직**:
```
[송금 반환 확인 로직]

1. 확인 대상 추출
   - Transfer 상태: COMPLETED
   - 완료 시각: 24~48시간 전

2. 송금사 API 조회
   - 각 건별 최종 상태 확인

3. 반환 건 처리
   - Transfer: COMPLETED → FAILED (failure_type: RETURNED)
   - Deal: COMPLETED → ABANDONED
   - cancel_reason: 'TRANSFER_RETURNED'
   - 환불 프로세스 시작

4. 리포트 생성
   - 반환 건수/금액 집계
   - 관리자 알림
```

> ⚠️ **상태명**: RETURNED 대신 FAILED + failure_type='RETURNED' 사용 (STATE_MACHINES 준수)
> 상세 내용: PLIC_EXTERNAL_INTERFACE.md 섹션 3.7.1 참조

---

### 2.9 stale-transaction-cleanup (미완료 거래 정리) ⚠️ (v1.1 추가)

**스케줄**: 매일 03:00 KST

**목적**: 24시간 이상 미완료 상태인 거래 정리

**로직**:
```
[미완료 거래 정리 로직]

1. 정리 대상 추출
   - Deal 상태: PROCESSING, PAID, TRANSFERRING
   - 상태 진입 시각: 24시간 이상 경과
   - 제외: 이미 MANUAL_REVIEW 플래그 설정된 건

2. 상태 동기화 시도
   - PG 조회 API로 결제 상태 확인
   - 송금사 조회 API로 송금 상태 확인

3. 동기화 결과 처리
   ┌─ 외부 성공 확인
   │   - 내부 상태 업데이트
   │   - 정상 완료 처리
   │
   ├─ 외부 실패 확인
   │   - Deal → ABANDONED
   │   - 환불 프로세스 시작 (결제 완료 시)
   │
   └─ 상태 불명확
       - MANUAL_REVIEW 플래그 설정
       - 관리자 알림

4. 리포트 생성
   - 정리 건수/유형별 집계
```

---

### 2.10 privacy-cleanup (개인정보 파기) ⚠️ (v1.1 추가)

**스케줄**: 매일 04:00 KST

**목적**: 탈퇴 사용자 개인정보 법적 보유기간 경과 후 파기 (K-ISMS 준수)

**로직**:
```
[개인정보 파기 로직]

1. 파기 대상 추출
   - User 상태: WITHDRAWN
   - 탈퇴 시각: 법적 보유기간 경과
     - 전자금융거래법: 5년 (거래기록)
     - 개인정보보호법: 탈퇴 후 즉시 (불필요 정보)

2. 파기 유형별 처리

   [즉시 파기 (탈퇴 시점)]
   - 마케팅 동의 정보
   - 푸시 토큰
   - 기기 정보

   [5년 보관 후 파기]
   - CI (해시만 보관, 원문 파기)
   - 거래 기록 (마스킹 처리)
   - 카드 정보 (billingKey 폐기)

   [영구 보관 (익명화)]
   - 통계 데이터 (개인 식별 불가 형태)

3. 파기 처리
   - 민감 필드: NULL 또는 '탈퇴회원' 대체
   - billingKey: PG 폐기 API 호출
   - 로그: 파기 이력 기록 (audit_logs)

4. 리포트 생성
   - 파기 건수 집계
   - 법적 준수 증빙용 로그
```

**보관 기간 참조**:
| 정보 유형 | 보관 기간 | 근거 법령 |
|----------|----------|----------|
| 거래 기록 | 5년 | 전자금융거래법 |
| 본인확인 정보 | 5년 | 정보통신망법 |
| 로그인 기록 | 3개월 | 통신비밀보호법 |
| 소비자 불만 | 3년 | 전자상거래법 |

---

## 3. Event-Driven Job (이벤트 기반 잡)

### 3.1 잡 목록

| 잡 이름 | 트리거 | 역할 | SQS 큐 |
|--------|--------|------|--------|
| `payment-process` | Deal 확정 | 결제 승인 처리 | `plic-payment-queue` |
| `transfer-process` | Payment 완료 | 송금 처리 | `plic-transfer-queue` |
| `refund-process` | 취소/ABANDONED | 환불 처리 | `plic-refund-queue` |
| `notification-send` | 상태 변경 | 알림 발송 | `plic-notification-queue` |
| `webhook-process` | 외부 웹훅 | 웹훅 이벤트 처리 | `plic-webhook-queue` |

---

### 3.2 payment-process (결제 처리)

**트리거**: Deal 상태가 PENDING → PROCESSING으로 전이 시

**SQS 메시지 형식**:
```json
{
  "jobType": "PAYMENT_PROCESS",
  "dealId": "deal_001",
  "paymentId": "payment_001",
  "idempotencyKey": "PLIC_D20250106_001",
  "requestedAt": "2025-01-06T10:31:00+09:00",
  "attempt": 1
}
```

**처리 로직**:
```
[결제 처리 로직]

1. 멱등성 체크 ⚠️ (v1.1 수정: DB가 SSOT)
   - DB idempotency_keys 테이블에서 확인
   - 이미 처리 완료면 저장된 응답 반환
   - Redis는 분산락 용도로만 사용 (멱등의 근거 아님)

2. 분산 락 획득
   - Redis로 Deal에 대한 분산 락 획득
   - 타임아웃: 60초
   - 락 실패 시 재시도 또는 스킵

3. PG API 호출
   - 빌링키 결제 승인 요청
   - 타임아웃: 60초

4. 결과 처리
   ┌─ 성공 (DONE)
   │   - Payment: PROCESSING → PAID
   │   - Deal: PROCESSING → PAID
   │   - idempotency_keys에 결과 저장
   │   - Transfer Job 발행
   │
   ├─ 실패 (FATAL 에러)
   │   - Payment: PROCESSING → FAILED
   │   - Deal: PROCESSING → FAILED
   │
   └─ 실패 (RETRYABLE 에러)
       - 재시도 스케줄링 (최대 3회)
       - 3회 초과 시 FAILED

5. 타임아웃 처리
   - PG 조회 API로 상태 확인
   - 조회 결과에 따라 처리

6. 락 해제
```

> ⚠️ **멱등성 SSOT**: Redis 장애/TTL 만료 시에도 DB가 최종 진실. Redis는 락/캐시/Rate Limit 용도만

**재시도 정책**:
| 시도 | 대기 시간 | 비고 |
|------|----------|------|
| 1회 | 즉시 | - |
| 2회 | 30초 | - |
| 3회 | 60초 | 마지막 |

**DLQ (Dead Letter Queue)**: `plic-payment-dlq`
- 3회 실패 시 DLQ로 이동
- 관리자 알림 발송

---

### 3.3 transfer-process (송금 처리) ⚠️ (v1.1 멱등키 분리)

**트리거**: Payment 상태가 PAID로 전이 시

**SQS 메시지 형식** ⚠️ (v1.1 수정):
```json
{
  "jobType": "TRANSFER_PROCESS",
  "dealId": "deal_001",
  "transferId": "transfer_001",
  "jobKey": "transfer_job_001_attempt_1",
  "externalIdempotencyKey": "PLIC_D20250106_001",
  "requestedAt": "2025-01-06T10:31:05+09:00",
  "attempt": 1
}
```

> ⚠️ **멱등키 분리 원칙**:
> - `externalIdempotencyKey`: 외부 송금사에 전달 (deal 단위 고정, 재시도에도 동일)
> - `jobKey`: 내부 처리용 (attempt 포함 가능, 외부 전달 금지)

**처리 로직**:
```
[송금 처리 로직]

1. 멱등성 체크 ⚠️ (v1.1: DB SSOT)
   - DB transfer_jobs에서 externalIdempotencyKey로 확인
   - 이미 COMPLETED면 저장된 결과 반환

2. 운영 자금 체크
   - 잔액이 송금액 이상인지 확인
   - 부족 시 Circuit Breaker 발동

3. 은행 점검 시간 체크
   - 수취 은행 점검 중이면 재스케줄링

4. 송금 API 호출
   - 멱등키: externalIdempotencyKey (deal 단위 고정)
   - 타임아웃: 60초

5. 결과 처리
   ┌─ 성공 (COMPLETED)
   │   - Transfer: PROCESSING → COMPLETED
   │   - Deal: TRANSFERRING → COMPLETED
   │   - 운영 자금 차감
   │
   ├─ 처리 중 (PROCESSING)
   │   - 폴링 스케줄 진입
   │   - 최대 2시간
   │
   ├─ 실패 (FATAL)
   │   - Transfer: FAILED (failure_type 기록)
   │   - Deal: TRANSFERRING → ABANDONED
   │   - 환불 Job 발행
   │
   └─ 실패 (RETRYABLE)
       - 재시도 스케줄링 (최대 5회)
       - 5회 초과 시 ABANDONED

6. 타임아웃 처리
   - 송금 조회 API로 상태 확인
   - PROCESSING이면 폴링 스케줄 진입
```

**재시도 정책** (Exponential Backoff):
| 시도 | 대기 시간 | 비고 |
|------|----------|------|
| 1회 | 즉시 | - |
| 2회 | 1분 | - |
| 3회 | 5분 | - |
| 4회 | 30분 | - |
| 5회 | 2시간 | 마지막 |

### 3.3.1 Circuit Breaker 정책 ⚠️ (v1.1 추가)

**발동 조건**:
| 레벨 | 운영 자금 잔액 | 동작 |
|------|---------------|------|
| NORMAL | > 30M | 정상 운영 |
| WARNING | 10M ~ 30M | 알림 발송, 모니터링 강화 |
| CRITICAL | ≤ 10M | **Circuit Breaker OPEN** - 신규 송금 중단 |

**Circuit Breaker OPEN 시 처리**:
```
[Circuit Breaker 발동 시]

1. 신규 송금 요청 차단
   - 503 Service Unavailable 응답
   - "일시적으로 서비스 이용 불가" 메시지

2. 처리 중 거래 상태
   - Deal: PAID 상태 유지 (송금 대기)
   - Transfer: PENDING 상태로 대기열에 보관
   - 사용자 알림: "송금이 지연되고 있습니다"

3. 관리자 알림
   - Slack + SMS + PagerDuty 동시 발송
   - 긴급 자본 투입 요청

4. 재개 조건 ⚠️ (자동/수동)
   ┌─ 자동 재개
   │   - 잔액 > 30M 회복 시
   │   - 10분마다 잔액 체크
   │
   └─ 수동 재개 (권장)
       - 관리자가 Admin API로 재개
       - POST /admin/circuit-breaker/close
       - 재개 사유 로깅 필수

5. 재개 후 처리
   - 대기 중이던 Transfer 순차 처리
   - 오래된 건부터 (FIFO)
```

**DLQ**: `plic-transfer-dlq`

---

### 3.4 refund-process (환불 처리)

**트리거**: 
- 사용자 취소 요청
- 송금 실패로 인한 ABANDONED 전이

**SQS 메시지 형식**:
```json
{
  "jobType": "REFUND_PROCESS",
  "dealId": "deal_001",
  "paymentId": "payment_001",
  "refundAmount": 103000,
  "reason": "TRANSFER_FAILED",
  "requestedAt": "2025-01-06T10:35:00+09:00"
}
```

**처리 로직**:
```
[환불 처리 로직]

1. 환불 가능 여부 확인
   - Payment 상태: PAID
   - Deal 상태: CANCELLED 또는 ABANDONED

2. PG 환불 API 호출
   - 전액 취소
   - 타임아웃: 60초

3. 결과 처리
   ┌─ 성공
   │   - Payment: PAID → REFUNDED
   │   - 사용자 한도 복구
   │   - 알림 발송
   │
   └─ 실패
       - 재시도 스케줄링
       - 3회 초과 시 수동 처리 전환

4. 운영 자금 처리
   - ABANDONED 환불 시 운영 자금 복구
   (송금 실패로 실제 출금 없었으므로)
```

---

### 3.5 notification-send (알림 발송)

**트리거**: 주요 상태 변경 이벤트

**SQS 메시지 형식**:
```json
{
  "jobType": "NOTIFICATION_SEND",
  "userId": "user_001",
  "type": "TRANSFER_COMPLETED",
  "channels": ["PUSH", "SMS"],
  "data": {
    "dealId": "deal_001",
    "amount": 100000,
    "recipientName": "홍길동"
  }
}
```

**알림 유형**:
| 이벤트 | 채널 | 내용 |
|--------|------|------|
| 결제 완료 | PUSH | 결제가 완료되었습니다. 송금을 진행합니다. |
| 송금 완료 | PUSH, SMS | {금액}원이 {수취인}님께 송금되었습니다. |
| 송금 실패 | PUSH, SMS | 송금에 실패했습니다. 환불이 진행됩니다. |
| 환불 완료 | PUSH | {금액}원 환불이 완료되었습니다. |
| 등급 변경 | PUSH | {등급}으로 변경되었습니다. |

---

### 3.6 webhook-process (웹훅 처리)

**트리거**: 외부 시스템(PG, 송금사)에서 웹훅 수신 시

**SQS 메시지 형식**:
```json
{
  "jobType": "WEBHOOK_PROCESS",
  "provider": "SOFTPAYMENT",
  "eventType": "PAYMENT.DONE",
  "eventKey": "evt_abc123",
  "payload": { ... },
  "receivedAt": "2025-01-06T10:31:05+09:00"
}
```

**처리 로직**:
```
[웹훅 처리 로직]

1. 중복 체크
   - pg_webhook_events에서 eventKey 확인
   - 이미 처리된 이벤트면 스킵

2. 페이로드 검증
   - 서명 검증 (이미 API 레벨에서 완료)
   - 필수 필드 확인

3. 이벤트 타입별 처리
   | eventType | 처리 |
   |-----------|------|
   | PAYMENT.DONE | Payment → PAID, Transfer Job 발행 |
   | PAYMENT.CANCELED | Payment → CANCELLED |
   | PAYMENT.FAILED | Payment → FAILED |
   | TRANSFER.COMPLETED | Transfer → COMPLETED |
   | TRANSFER.RETURNED | Transfer → RETURNED, 환불 처리 |

4. 이벤트 저장
   - pg_webhook_events 테이블에 기록
```

---

## 4. SQS 큐 설정 ⚠️ (v1.1 보강)

### 4.1 큐 목록

| 큐 이름 | 목적 | Visibility Timeout | Message Retention | 비고 |
|--------|------|-------------------|-------------------|------|
| `plic-payment-queue` | 결제 처리 | 120초 | 4일 | v1.1: 90→120초 |
| `plic-transfer-queue` | 송금 처리 | 180초 | 7일 | v1.1: 120→180초 |
| `plic-refund-queue` | 환불 처리 | 120초 | 4일 | v1.1: 90→120초 |
| `plic-notification-queue` | 알림 발송 | 30초 | 1일 | - |
| `plic-webhook-queue` | 웹훅 처리 | 60초 | 4일 | - |

> ⚠️ **Visibility Timeout 산정 기준**: 
> - 외부 API 타임아웃 (60초) + DB 처리 (10초) + 여유 (50초) = 120초
> - 송금은 폴링 가능성 고려하여 180초

### 4.2 DLQ 설정

| DLQ 이름 | 원본 큐 | Max Receive Count | 알림 |
|---------|--------|-------------------|------|
| `plic-payment-dlq` | payment-queue | 3 | Slack + SMS |
| `plic-transfer-dlq` | transfer-queue | 5 | Slack + SMS |
| `plic-refund-dlq` | refund-queue | 3 | Slack + SMS |
| `plic-notification-dlq` | notification-queue | 3 | Slack |
| `plic-webhook-dlq` | webhook-queue | 3 | Slack |

### 4.3 처리 워커

| 워커 | 실행 환경 | Concurrency | Auto Scaling |
|------|----------|-------------|--------------|
| PaymentWorker | Lambda | 10 | 큐 깊이 기반 |
| TransferWorker | Lambda | 5 | 큐 깊이 기반 |
| RefundWorker | Lambda | 5 | 큐 깊이 기반 |
| NotificationWorker | Lambda | 20 | 큐 깊이 기반 |
| WebhookWorker | Lambda | 10 | 큐 깊이 기반 |

---

## 5. 모니터링 및 알림

### 5.1 CloudWatch 메트릭

| 메트릭 | 대상 | 임계값 | 알림 |
|--------|------|--------|------|
| `BatchExecutionTime` | 모든 배치 | 예상 시간 2배 초과 | Warning |
| `BatchFailureCount` | 모든 배치 | 1 이상 | Critical |
| `QueueDepth` | 모든 SQS 큐 | 1000 이상 | Warning |
| `DLQDepth` | 모든 DLQ | 1 이상 | Critical |
| `ProcessingLatency` | 이벤트 잡 | 5분 초과 | Warning |

### 5.2 알림 채널

| 심각도 | 채널 | 대상 |
|--------|------|------|
| Critical | Slack + SMS + PagerDuty | 운영팀 전체 |
| Warning | Slack | 운영팀 채널 |
| Info | Slack | 운영팀 채널 |

### 5.3 일일 리포트

**발송 시간**: 매일 07:00 KST

**리포트 내용**:
```
[PLIC 일일 배치 리포트 - 2025-01-06]

📊 배치 실행 현황
- grade-update: ✅ 완료 (00:05:32)
- monthly-reset: ⏭️ 스킵 (해당 없음)
- daily-reconcile: ✅ 완료 (00:15:43)
- transfer-retry: ✅ 완료 (처리: 5건, 성공: 4건, 실패: 1건)

📈 이벤트 잡 현황
- 결제 처리: 1,234건 (성공률: 99.2%)
- 송금 처리: 1,200건 (성공률: 98.5%)
- 환불 처리: 34건 (성공률: 100%)
- 알림 발송: 3,500건

⚠️ 주의 사항
- DLQ: transfer-dlq에 2건 적재
- 대사 불일치: 3건 (수동 확인 필요)

🔗 상세: https://admin.plic.co.kr/reports/daily/2025-01-06
```

---

## 6. 운영 가이드

### 6.1 수동 실행

**배치 수동 실행**:
```bash
# AWS CLI
aws lambda invoke \
  --function-name plic-batch-grade-update \
  --payload '{"manual": true, "requestedBy": "admin@plic.co.kr"}' \
  response.json

# Admin API
POST /admin/batch/execute
{
  "batchName": "grade-update",
  "reason": "수동 실행 - 등급 재계산 필요"
}
```

**SQS 메시지 수동 발행**:
```bash
# 특정 거래 송금 재처리
POST /admin/jobs/transfer-retry
{
  "dealId": "deal_001",
  "reason": "수동 재처리 요청"
}
```

### 6.2 DLQ 처리

**DLQ 메시지 확인**:
```bash
# AWS CLI
aws sqs receive-message \
  --queue-url https://sqs.ap-northeast-2.amazonaws.com/xxx/plic-transfer-dlq \
  --max-number-of-messages 10
```

**DLQ 재처리**:
```bash
# Admin API
POST /admin/dlq/reprocess
{
  "queueName": "plic-transfer-dlq",
  "messageIds": ["msg_001", "msg_002"]
}
```

**DLQ 삭제 (문제 해결 후)**:
```bash
POST /admin/dlq/purge
{
  "queueName": "plic-transfer-dlq",
  "reason": "이슈 해결 완료 - JIRA-123"
}
```

### 6.3 배치 일시 중지

**긴급 중지**:
```bash
# EventBridge 규칙 비활성화
aws events disable-rule --name plic-batch-transfer-retry

# Admin API
POST /admin/batch/pause
{
  "batchName": "transfer-retry",
  "reason": "송금사 장애로 인한 일시 중지",
  "resumeAt": "2025-01-06T12:00:00+09:00"
}
```

---

## 7. 장애 대응

### 7.1 배치 실패 시

```
[배치 실패 대응 플로우]

1. 알림 수신
   - Slack/SMS로 실패 알림

2. 원인 파악
   - CloudWatch Logs 확인
   - 에러 메시지 분석

3. 영향 범위 확인
   - 전체 실패 vs 부분 실패
   - 영향받은 데이터 수

4. 조치
   ┌─ 일시적 오류 (네트워크, 타임아웃)
   │   → 수동 재실행
   │
   ├─ 데이터 오류
   │   → 데이터 수정 후 재실행
   │
   └─ 로직 오류
       → 핫픽스 배포 후 재실행

5. 후속 조치
   - 원인 분석 리포트 작성
   - 재발 방지책 수립
```

### 7.2 큐 적체 시

```
[큐 적체 대응 플로우]

1. 알림 수신
   - Queue Depth > 1000 알림

2. 원인 파악
   - 워커 상태 확인
   - 외부 API 상태 확인
   - 처리 속도 확인

3. 조치
   ┌─ 워커 문제
   │   → 워커 재시작/스케일 업
   │
   ├─ 외부 API 장애
   │   → 해당 큐 일시 중지
   │   → 외부 시스템 복구 대기
   │
   └─ 급증한 트래픽
       → 워커 스케일 아웃
       → 필요시 Rate Limit 강화

4. 모니터링
   - Queue Depth 정상화 확인
   - 처리 지연 시간 확인
```

---

## 부록

### A. Cron 표현식 참조 ⚠️ (v1.1 검증/단순화)

> ⚠️ **원칙**: UTC 기준 검증된 표현만 사용. 월간 작업은 월초 기준으로 단순화

| 스케줄 | Cron (UTC) | KST 실행 시각 | 비고 |
|--------|-----------|--------------|------|
| 매일 02:00 KST | `0 17 * * ? *` | 02:00 | UTC 전일 17:00 |
| 매일 03:00 KST | `0 18 * * ? *` | 03:00 | - |
| 매일 04:00 KST | `0 19 * * ? *` | 04:00 | - |
| 매일 06:00 KST | `0 21 * * ? *` | 06:00 | 대사 배치 |
| 매일 06:30 KST | `30 21 * * ? *` | 06:30 | 반환 확인 |
| 매일 09:00 KST | `0 0 * * ? *` | 09:00 | 송금 재처리 |
| 매일 14:00 KST | `0 5 * * ? *` | 14:00 | 송금 재처리 |
| 매시간 정각 | `0 * * * ? *` | 매시간 | - |
| 매월 1일 00:00 KST | `0 15 1 * ? *` | 00:00 | ⚠️ UTC 전월말 15:00 아님! |
| 매월 1일 00:30 KST | `30 15 1 * ? *` | 00:30 | - |
| 매주 일요일 03:00 KST | `0 18 ? * SUN *` | 03:00 | 로그 아카이브 |

> ⚠️ **월간 배치 주의**: 
> - `0 15 1 * ? *`는 "매월 1일 UTC 15:00" = KST 매월 2일 00:00
> - KST 1일 00:00 실행하려면 `0 15 L * ? *` (전월 말일)이지만, EventBridge 'L' 지원 불안정
> - **권장**: EventBridge Scheduler timezone 기능 사용 또는 1일 00:00 대신 1일 09:00 KST로 변경

### B. 환경 변수

| 변수 | 설명 | 예시 |
|------|------|------|
| `BATCH_ENABLED` | 배치 활성화 여부 | `true` |
| `SQS_PAYMENT_QUEUE_URL` | 결제 큐 URL | `https://sqs...` |
| `WORKER_CONCURRENCY` | 워커 동시 처리 수 | `10` |
| `RETRY_MAX_ATTEMPTS` | 최대 재시도 횟수 | `5` |
| `DLQ_ALERT_THRESHOLD` | DLQ 알림 임계값 | `1` |

### C. 참고 문서

| 문서 | 관계 |
|------|------|
| PLIC_STATE_MACHINES.md | 상태 전이 규칙 |
| PLIC_EXTERNAL_INTERFACE.md | 외부 API 연동 |
| PLIC_RECONCILIATION_SETTLEMENT.md | 대사/정산 상세 |
| PLIC_OPERATIONS_HANDBOOK.md | 운영 절차 |
