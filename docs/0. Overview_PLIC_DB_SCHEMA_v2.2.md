# PLIC ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

## ğŸ“‹ ë¬¸ì„œ ì •ë³´

| í•­ëª© | ë‚´ìš© |
|------|------|
| ë²„ì „ | 2.2 |
| ì‘ì„±ì¼ | 2025-12-23 |
| ìˆ˜ì •ì¼ | 2025-01-06 |
| ë°ì´í„°ë² ì´ìŠ¤ | PostgreSQL 15+ |
| ë¬¸ìì…‹ | UTF-8 |
| íƒ€ì„ì¡´ | Asia/Seoul (KST) |

---

## ë³€ê²½ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ | ë³€ê²½ ë‚´ìš© | ì‘ì„±ì |
|------|------|-----------|--------|
| 2.1 | 2025-12-23 | ì´ˆì•ˆ ì‘ì„± | PLIC ê°œë°œíŒ€ |
| 2.2 | 2025-01-06 | **SSOT ë™ê¸°í™”**: deals.status 10ê°œë¡œ í™•ì¥, ledger entry_type í™•ì¥, abandoned_at í•„ë“œ ì¶”ê°€ | PLIC ê°œë°œíŒ€ |

---

## 1. ìŠ¤í‚¤ë§ˆ ê°œìš”

### 1.1 í…Œì´ë¸” ëª©ë¡

| êµ¬ë¶„ | í…Œì´ë¸”ëª… | ì„¤ëª… |
|------|----------|------|
| **Core** | users | ê²°ì œì (PLIC íšŒì›) |
| | cards | ë“±ë¡ ì¹´ë“œ (billingKey) |
| | deals | ê±°ë˜ |
| | payments | ê²°ì œ ë‚´ì—­ |
| | transfers | ì†¡ê¸ˆ ë‚´ì—­ |
| **Transaction** | pg_webhook_events | PG ì›¹í›… ì´ë²¤íŠ¸ (ë©±ë“±ì„±) |
| | idempotency_keys | API ë©±ë“±ì„± í‚¤ |
| | transfer_jobs | ì†¡ê¸ˆ ì‘ì—… í (ì§„ì‹¤ì˜ ì›ì²œ, SQSëŠ” ì‹ í˜¸ ì—­í• ) |
| **Audit** | admin_audit_logs | ê´€ë¦¬ì ê°ì‚¬ ë¡œê·¸ |
| | ledger_entries | ì›ì¥ (íšŒê³„) |
| **Statistics** | user_monthly_stats | ì›”ê°„ í†µê³„ ì´ë ¥ |
| **User** | favorite_accounts | ì¦ê²¨ì°¾ê¸° ê³„ì¢Œ |
| | memberships | ë©¤ë²„ì‹­ ë“±ê¸‰ ì„¤ì • |
| | discount_codes | í• ì¸ ì½”ë“œ |
| **Admin** | admin_users | ê´€ë¦¬ì ê³„ì • |
| **Content** | notices | ê³µì§€ì‚¬í•­ |
| | faqs | FAQ |
| | banners | ë°°ë„ˆ |

**â€» payment_slices (ë¶„í• ê²°ì œ) í…Œì´ë¸”ì€ v1.0ì—ì„œ ì œì™¸, ì¶”í›„ ê°œë°œ ì˜ˆì •**

### 1.2 ERD ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      users      â”‚       â”‚      deals      â”‚       â”‚    transfers    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ uid (PK)        â”‚â—€â”€â”€â”   â”‚ id (PK)         â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ id (PK)         â”‚
â”‚ phone           â”‚   â”‚   â”‚ payer_uid (FK)  â”‚       â”‚ deal_id (FK)    â”‚
â”‚ name            â”‚   â””â”€â”€â”€â”‚ recipient_*     â”‚       â”‚ status          â”‚
â”‚ grade           â”‚       â”‚ amount          â”‚       â”‚ version         â”‚
â”‚ version         â”‚       â”‚ status          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ deleted_at      â”‚       â”‚ version         â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ deleted_at      â”‚              â”‚
        â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
        â”‚                        â”‚                         â”‚
        â–¼                        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      cards      â”‚       â”‚    payments     â”‚       â”‚  transfer_jobs  â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)         â”‚â—€â”€â”€â”€â”€â”€â”€â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚
â”‚ user_uid (FK)   â”‚       â”‚ deal_id (FK)    â”‚       â”‚ deal_id (FK,UQ) â”‚
â”‚ billing_key     â”‚       â”‚ card_id (FK)    â”‚       â”‚ status          â”‚
â”‚ version         â”‚       â”‚ version         â”‚       â”‚ locked_at       â”‚
â”‚ deleted_at      â”‚       â”‚ deleted_at      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚pg_webhook_eventsâ”‚       â”‚idempotency_keys â”‚       â”‚ admin_audit_logsâ”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚
â”‚ event_id (UQ)   â”‚       â”‚ key (UQ)        â”‚       â”‚ admin_id (FK)   â”‚
â”‚ provider        â”‚       â”‚ response        â”‚       â”‚ action_type     â”‚
â”‚ deal_id         â”‚       â”‚ expires_at      â”‚       â”‚ before/after    â”‚
â”‚ payment_id      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ processed_at    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â€» payment_slices í…Œì´ë¸”ì€ v1.0ì—ì„œ ì œì™¸ (ë¶„í• ê²°ì œ ë³´ë¥˜)
â€» transfer_jobs.deal_idëŠ” ì¡°ê±´ë¶€ ìœ ë‹ˆí¬ (í™œì„± ìƒíƒœì—ì„œë§Œ)
```

### 1.3 ê³µí†µ ì»¬ëŸ¼ ê·œì¹™

ëª¨ë“  í…Œì´ë¸”ì— ì ìš©ë˜ëŠ” ê³µí†µ ì»¬ëŸ¼:

```sql
-- ê³µí†µ ì»¬ëŸ¼ (ëª¨ë“  í…Œì´ë¸”)
created_at TIMESTAMP DEFAULT NOW(),
updated_at TIMESTAMP DEFAULT NOW(),
deleted_at TIMESTAMP,                    -- Soft Delete
version BIGINT DEFAULT 0                 -- Optimistic Lock
```

---

## 2. Core í…Œì´ë¸”

### 2.1 users (ê²°ì œì)

```sql
CREATE TABLE users (
    -- ê¸°ë³¸ ì‹ë³„ì
    uid UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ì¸ì¦ ì •ë³´
    phone VARCHAR(20) UNIQUE NOT NULL,
    
    -- ê°œì¸ ì •ë³´
    name VARCHAR(50) NOT NULL,
    
    -- ë“±ê¸‰ ì •ë³´
    grade VARCHAR(20) DEFAULT 'BASIC',
    membership_id UUID REFERENCES memberships(id),
    
    -- ì•Œë¦¼ ì„¤ì •
    notification_push BOOLEAN DEFAULT TRUE,
    notification_sms BOOLEAN DEFAULT TRUE,
    notification_email BOOLEAN DEFAULT FALSE,
    
    -- ìƒíƒœ
    status VARCHAR(20) DEFAULT 'ACTIVE',
    
    -- ê³µí†µ ì»¬ëŸ¼
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0,
    
    -- ì¶”ê°€ íƒ€ì„ìŠ¤íƒ¬í”„
    last_login_at TIMESTAMP,
    grade_changed_at TIMESTAMP,
    
    CONSTRAINT users_phone_format CHECK (phone ~ '^\d{10,11}$')
);

CREATE INDEX idx_users_phone ON users(phone) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_grade ON users(grade) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_status ON users(status) WHERE deleted_at IS NULL;
```

### 2.2 cards (ë“±ë¡ ì¹´ë“œ)

```sql
CREATE TABLE cards (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ì†Œìœ ì
    user_uid UUID REFERENCES users(uid) ON DELETE CASCADE NOT NULL,
    
    -- ì¹´ë“œ ì •ë³´ (PGì‚¬ SDK í† í°í™” ë°©ì‹ìœ¼ë¡œ ë°œê¸‰)
    billing_key VARCHAR(500) NOT NULL,              -- KMS ì•”í˜¸í™”
    
    -- ì¹´ë“œ í‘œì‹œ ì •ë³´
    card_company VARCHAR(50) NOT NULL,
    card_number_masked VARCHAR(20) NOT NULL,        -- ì•6ë’¤4
    card_type VARCHAR(20),
    
    -- ì„¤ì •
    is_default BOOLEAN DEFAULT FALSE,
    card_alias VARCHAR(50),
    
    -- ìƒíƒœ
    status VARCHAR(20) DEFAULT 'ACTIVE',
    
    -- ê³µí†µ ì»¬ëŸ¼
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0,
    
    last_used_at TIMESTAMP
);

CREATE INDEX idx_cards_user_uid ON cards(user_uid) WHERE deleted_at IS NULL;
CREATE UNIQUE INDEX idx_cards_default_unique ON cards(user_uid) 
    WHERE is_default = TRUE AND status = 'ACTIVE' AND deleted_at IS NULL;
```

### 2.3 deals (ê±°ë˜)

```sql
CREATE TABLE deals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    deal_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- ê²°ì œì
    payer_uid UUID REFERENCES users(uid) NOT NULL,
    
    -- ìˆ˜ì·¨ì¸ ê³„ì¢Œ ì •ë³´ (ì•”í˜¸í™”)
    recipient_bank_code VARCHAR(10) NOT NULL,
    recipient_account_number VARCHAR(200) NOT NULL,     -- KMS ì•”í˜¸í™”
    recipient_account_hash VARCHAR(64) NOT NULL,        -- ê²€ìƒ‰/ìœ ë‹ˆí¬ìš© HMAC
    recipient_account_holder VARCHAR(50) NOT NULL,
    recipient_memo VARCHAR(100),
    
    -- ê¸ˆì•¡ ì •ë³´ (ì›ê¸ˆ ì „ì•¡ ì†¡ê¸ˆ ì›ì¹™)
    amount BIGINT NOT NULL,                             -- ì†¡ê¸ˆ ì›ê¸ˆ (ìˆ˜ì·¨ì¸ì—ê²Œ ì „ì•¡ ì „ë‹¬)
    service_fee BIGINT NOT NULL,                        -- ì„œë¹„ìŠ¤ ìˆ˜ìˆ˜ë£Œ (ê²°ì œì ë¶€ë‹´)
    total_payment BIGINT NOT NULL,                      -- ì´ ê²°ì œì•¡ (amount + service_fee)
    
    -- ìˆ˜ìˆ˜ë£Œ ì •ë³´
    fee_rate DECIMAL(5,4) NOT NULL,
    discount_code_id UUID REFERENCES discount_codes(id),
    discount_amount BIGINT DEFAULT 0,
    
    -- ìƒíƒœ âš ï¸ (v2.2 SSOT ë™ê¸°í™” - 10ê°œ ìƒíƒœ)
    status VARCHAR(20) DEFAULT 'PENDING',
    /*
      PENDING: ê±°ë˜ ìƒì„±ë¨ (ê²°ì œ ì „)
      PROCESSING: ê²°ì œ ìš”ì²­ ì¤‘ (PG ì‘ë‹µ ëŒ€ê¸°) âš ï¸ v2.2 ì¶”ê°€
      PAID: ê²°ì œ ì™„ë£Œ, ì†¡ê¸ˆ ëŒ€ê¸°
      TRANSFERRING: ì†¡ê¸ˆ ì§„í–‰ ì¤‘
      COMPLETED: ê±°ë˜ ì™„ë£Œ
      CANCELLED: ì·¨ì†Œë¨ (ê²°ì œ ì „)
      REFUNDED: í™˜ë¶ˆ ì™„ë£Œ
      FAILED: ê²°ì œ ì‹¤íŒ¨ âš ï¸ v2.2 ì¶”ê°€
      TRANSFER_FAILED: ì†¡ê¸ˆ ì‹¤íŒ¨ (ì¬ì‹œë„ ì¤‘)
      ABANDONED: ë³µêµ¬ ë¶ˆê°€ (ìˆ˜ë™ ì²˜ë¦¬ í•„ìš”) âš ï¸ v2.2 ì¶”ê°€
    */
    
    description VARCHAR(200),
    
    -- ê³µí†µ ì»¬ëŸ¼
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0,
    
    -- ìƒíƒœë³„ íƒ€ì„ìŠ¤íƒ¬í”„ âš ï¸ (v2.2 abandoned_at ì¶”ê°€)
    paid_at TIMESTAMP,
    transfer_started_at TIMESTAMP,
    completed_at TIMESTAMP,
    cancelled_at TIMESTAMP,
    refunded_at TIMESTAMP,
    abandoned_at TIMESTAMP                      -- v2.2 ì¶”ê°€
);

-- v1.0: ë¶„í• ê²°ì œ ê´€ë ¨ í•„ë“œ ì œê±° (is_split_payment, split_count, split_paid_count)

CREATE INDEX idx_deals_deal_number ON deals(deal_number);
CREATE INDEX idx_deals_payer_uid ON deals(payer_uid) WHERE deleted_at IS NULL;
CREATE INDEX idx_deals_status ON deals(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_deals_created_at ON deals(created_at DESC);
CREATE INDEX idx_deals_recipient_hash ON deals(recipient_account_hash);
```

### 2.4 payments (ê²°ì œ)

```sql
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    payment_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- ì—°ê´€ ì •ë³´
    deal_id UUID REFERENCES deals(id) NOT NULL,
    user_uid UUID REFERENCES users(uid) NOT NULL,
    card_id UUID REFERENCES cards(id),
    
    -- ê²°ì œ ê¸ˆì•¡
    amount BIGINT NOT NULL,                         -- ì´ ê²°ì œì•¡
    
    -- PGì‚¬ ì •ë³´
    pg_payment_key VARCHAR(200),                    -- ì†Œí”„íŠ¸í˜ì´ë¨¼íŠ¸ paymentKey
    pg_order_id VARCHAR(100),                       -- ì†Œí”„íŠ¸í˜ì´ë¨¼íŠ¸ orderId
    pg_response JSONB,                              -- PG ì‘ë‹µ ì›ë³¸ ì €ì¥
    
    -- ê²°ì œ ìƒíƒœ
    status VARCHAR(20) DEFAULT 'PENDING',
    /*
      PENDING: ê²°ì œ ëŒ€ê¸°
      PAID: ê²°ì œ ì™„ë£Œ
      FAILED: ê²°ì œ ì‹¤íŒ¨
      CANCELLED: ì·¨ì†Œë¨
      REFUNDED: í™˜ë¶ˆë¨
    */
    
    failure_reason VARCHAR(500),
    cancel_reason VARCHAR(500),
    
    -- ê³µí†µ ì»¬ëŸ¼
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0,
    
    paid_at TIMESTAMP,
    cancelled_at TIMESTAMP,
    refunded_at TIMESTAMP
);

-- v1.0: ë¶„í• ê²°ì œ ê´€ë ¨ í•„ë“œ ì œê±° (is_split, split_count, total_amount, paid_amount)

CREATE INDEX idx_payments_deal_id ON payments(deal_id);
CREATE INDEX idx_payments_user_uid ON payments(user_uid);
CREATE INDEX idx_payments_status ON payments(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_payments_pg_key ON payments(pg_payment_key);
CREATE UNIQUE INDEX idx_payments_pg_key_unique ON payments(pg_payment_key) WHERE pg_payment_key IS NOT NULL;
```

### 2.5 payment_slices - ë³´ë¥˜ (ì¶”í›„ ê°œë°œ)

```sql
/*
 * âš ï¸ ë¶„í• ê²°ì œ í…Œì´ë¸”ì€ v1.0ì—ì„œ ì œì™¸
 * 
 * [ë³´ë¥˜ ì‚¬ìœ ]
 * - ë²•ì  ê²€í†  í•„ìš” (ìê¸ˆ ì²´ë¥˜ ê¸°ê°„ì— ë”°ë¥¸ ì„ ë¶ˆì „ìì§€ê¸‰ìˆ˜ë‹¨ í•´ë‹¹ ì—¬ë¶€)
 * - v1.0ì€ ì¼ë°˜ê²°ì œ(1íšŒ ê²°ì œ â†’ ì¦‰ì‹œ ì†¡ê¸ˆ)ì— ì§‘ì¤‘
 * 
 * [ì¶”í›„ ê°œë°œ ì‹œ ê³ ë ¤ì‚¬í•­]
 * - ì†¡ê¸ˆ íŠ¸ë¦¬ê±° ëª¨ë“œ íŒŒë¼ë¯¸í„°í™”: SPLIT_TRANSFER_MODE
 *   - ALL_COMPLETE: ì „ì²´ ë¶„í• ê²°ì œ ì™„ë£Œ í›„ ì†¡ê¸ˆ (í˜„ì¬ ì„¤ê³„)
 *   - PER_SLICE: íšŒì°¨ë³„ ì¦‰ì‹œ ì†¡ê¸ˆ (ë²•ë¥  ê²€í†  ê²°ê³¼ì— ë”°ë¼)
 * - EventBridge â†’ Lambdaë¡œ due slice íŠ¸ë¦¬ê±°
 */
```

### 2.6 transfers (ì†¡ê¸ˆ)

```sql
CREATE TABLE transfers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    transfer_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- ì—°ê´€ ì •ë³´
    deal_id UUID REFERENCES deals(id) NOT NULL,
    
    -- ì†¡ê¸ˆ ê¸ˆì•¡ (ì›ê¸ˆ ì „ì•¡)
    amount BIGINT NOT NULL,
    
    -- ìˆ˜ì·¨ì¸ ê³„ì¢Œ (Snapshot)
    recipient_bank_code VARCHAR(10) NOT NULL,
    recipient_account_number VARCHAR(200) NOT NULL,
    recipient_account_hash VARCHAR(64) NOT NULL,
    recipient_account_holder VARCHAR(50) NOT NULL,
    transfer_memo VARCHAR(100),
    
    -- ìƒíƒœ
    status VARCHAR(20) DEFAULT 'PENDING',
    /*
      PENDING: ì†¡ê¸ˆ ëŒ€ê¸°
      PROCESSING: ì†¡ê¸ˆ ì²˜ë¦¬ ì¤‘
      COMPLETED: ì†¡ê¸ˆ ì™„ë£Œ
      FAILED: ì†¡ê¸ˆ ì‹¤íŒ¨
    */
    
    -- ì™¸ë¶€ API ì •ë³´
    transfer_ref_id VARCHAR(200),
    transfer_idempotency_key VARCHAR(100) UNIQUE,
    transfer_response JSONB,
    
    failure_reason VARCHAR(500),
    retry_count INT DEFAULT 0,
    
    -- ê³µí†µ ì»¬ëŸ¼
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0,
    
    processed_at TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE UNIQUE INDEX idx_transfers_deal_unique ON transfers(deal_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_transfers_status ON transfers(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_transfers_recipient_hash ON transfers(recipient_account_hash);
CREATE INDEX idx_transfers_idempotency ON transfers(transfer_idempotency_key);
```

---

## 3. Transaction í…Œì´ë¸” (ë©±ë“±ì„±/í)

### 3.1 pg_webhook_events (PG ì›¹í›… ì´ë²¤íŠ¸)

```sql
CREATE TABLE pg_webhook_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ì´ë²¤íŠ¸ ì‹ë³„
    provider VARCHAR(50) NOT NULL,                  -- 'softpayment'
    event_id VARCHAR(200) NOT NULL,                 -- paymentKey + status ì¡°í•©
    event_type VARCHAR(50) NOT NULL,                -- PAYMENT_DONE, PAYMENT_FAILED ë“±
    
    -- ì—°ê²° ì •ë³´ (ì¡°íšŒ ìµœì í™”ìš© - P1 ë°˜ì˜)
    deal_id UUID REFERENCES deals(id),
    payment_id UUID REFERENCES payments(id),
    pg_payment_key VARCHAR(200),
    
    -- ì›ë³¸ ë°ì´í„°
    payload JSONB NOT NULL,
    
    -- ì²˜ë¦¬ ìƒíƒœ
    process_status VARCHAR(20) DEFAULT 'PENDING',   -- PENDING, PROCESSED, FAILED
    process_error VARCHAR(500),
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    received_at TIMESTAMP DEFAULT NOW(),
    processed_at TIMESTAMP,
    
    CONSTRAINT pg_webhook_events_unique UNIQUE (provider, event_id)
);

CREATE INDEX idx_pg_webhook_status ON pg_webhook_events(process_status) 
    WHERE process_status = 'PENDING';
CREATE INDEX idx_pg_webhook_received ON pg_webhook_events(received_at DESC);
CREATE INDEX idx_pg_webhook_deal ON pg_webhook_events(deal_id);
CREATE INDEX idx_pg_webhook_payment ON pg_webhook_events(payment_id);
CREATE INDEX idx_pg_webhook_pg_key ON pg_webhook_events(pg_payment_key);
```

### 3.2 idempotency_keys (API ë©±ë“±ì„±)

```sql
CREATE TABLE idempotency_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- í‚¤ ì •ë³´
    idempotency_key VARCHAR(100) UNIQUE NOT NULL,
    user_uid UUID REFERENCES users(uid),
    
    -- ìš”ì²­/ì‘ë‹µ
    request_path VARCHAR(200) NOT NULL,
    request_hash VARCHAR(64),                       -- ìš”ì²­ ë³¸ë¬¸ í•´ì‹œ
    response_status INT,
    response_body JSONB,
    
    -- ë§Œë£Œ
    expires_at TIMESTAMP NOT NULL,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_idempotency_key ON idempotency_keys(idempotency_key);
CREATE INDEX idx_idempotency_expires ON idempotency_keys(expires_at);
```

### 3.3 transfer_jobs (ì†¡ê¸ˆ ì‘ì—… í - ì§„ì‹¤ì˜ ì›ì²œ)

```sql
/*
 * [ì•„í‚¤í…ì²˜ ëª…í™•í™” - P0 ë°˜ì˜]
 * 
 * transfer_jobs (DB) = ì§„ì‹¤ì˜ ì›ì²œ (Source of Truth)
 * - ëª¨ë“  ì†¡ê¸ˆ ì‘ì—…ì˜ ìƒíƒœì™€ ì´ë ¥ ë³´ê´€
 * - ì¥ì•  ë³µêµ¬, ì¬ì‹œë„, ê°ì‚¬ ì¶”ì ì˜ ê¸°ì¤€
 * 
 * SQS = ì‹ í˜¸ ì—­í•  (Signal)
 * - ì›Œì»¤ì—ê²Œ "ì²˜ë¦¬í•  ì‘ì—… ìˆìŒ" ì•Œë¦¼
 * - ë©”ì‹œì§€ ìœ ì‹¤ë˜ì–´ë„ DB í´ë§ìœ¼ë¡œ ë³µêµ¬ ê°€ëŠ¥
 */

CREATE TABLE transfer_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ì—°ê´€ ì •ë³´
    deal_id UUID REFERENCES deals(id) NOT NULL,
    transfer_id UUID REFERENCES transfers(id),
    
    -- ì‘ì—… ìƒíƒœ
    status VARCHAR(20) DEFAULT 'PENDING',
    /*
      PENDING: ëŒ€ê¸°
      PROCESSING: ì²˜ë¦¬ ì¤‘ (locked)
      COMPLETED: ì™„ë£Œ
      FAILED: ì‹¤íŒ¨ (ì¬ì‹œë„ ëŒ€ê¸°)
      ABANDONED: í¬ê¸° (ìˆ˜ë™ ì²˜ë¦¬ í•„ìš”)
    */
    
    -- ì¬ì‹œë„ ì •ë³´
    attempt INT DEFAULT 0,
    max_attempts INT DEFAULT 5,
    next_retry_at TIMESTAMP,
    last_error VARCHAR(500),
    
    -- ë½ ì •ë³´ (FOR UPDATE SKIP LOCKED ìš©)
    locked_at TIMESTAMP,
    locked_by VARCHAR(100),                         -- ì›Œì»¤ ID
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);

-- ì¤‘ë³µ ë°©ì§€: dealë‹¹ í™œì„± jobì€ 1ê°œë§Œ (P0 - Critical)
CREATE UNIQUE INDEX idx_transfer_jobs_deal_unique 
    ON transfer_jobs(deal_id) 
    WHERE status IN ('PENDING', 'PROCESSING', 'FAILED');

CREATE INDEX idx_transfer_jobs_status ON transfer_jobs(status, next_retry_at) 
    WHERE status IN ('PENDING', 'FAILED');
CREATE INDEX idx_transfer_jobs_locked ON transfer_jobs(locked_at) 
    WHERE status = 'PROCESSING';

/*
 * [ì‚¬ìš© íŒ¨í„´]
 * 
 * 1. Job ìƒì„± (ì¤‘ë³µ ë°©ì§€)
 * INSERT INTO transfer_jobs (deal_id, status)
 * VALUES (?, 'PENDING')
 * ON CONFLICT DO NOTHING;
 * 
 * 2. ì›Œì»¤ê°€ ì‘ì—… ê°€ì ¸ì˜¤ê¸° (ë½)
 * UPDATE transfer_jobs
 * SET status = 'PROCESSING', locked_at = NOW(), locked_by = 'worker-1'
 * WHERE id = (
 *     SELECT id FROM transfer_jobs
 *     WHERE status IN ('PENDING', 'FAILED')
 *       AND (next_retry_at IS NULL OR next_retry_at <= NOW())
 *     ORDER BY created_at
 *     LIMIT 1
 *     FOR UPDATE SKIP LOCKED
 * )
 * RETURNING *;
 */
```

---

## 4. Audit í…Œì´ë¸”

### 4.1 admin_audit_logs (ê´€ë¦¬ì ê°ì‚¬ ë¡œê·¸)

```sql
CREATE TABLE admin_audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ë¦¬ì ì •ë³´
    admin_id UUID REFERENCES admin_users(id) NOT NULL,
    admin_login_id VARCHAR(50) NOT NULL,
    
    -- ì•¡ì…˜ ì •ë³´
    action_type VARCHAR(50) NOT NULL,
    /*
      USER_UPDATE, USER_SUSPEND, USER_DELETE,
      DEAL_CANCEL, DEAL_REFUND,
      TRANSFER_RETRY, TRANSFER_MANUAL,
      GRADE_CHANGE, DISCOUNT_CREATE ë“±
    */
    
    -- ëŒ€ìƒ ì •ë³´
    target_table VARCHAR(50) NOT NULL,
    target_id UUID NOT NULL,
    
    -- ë³€ê²½ ë‚´ìš©
    before_data JSONB,
    after_data JSONB,
    description VARCHAR(500),
    
    -- ì ‘ì† ì •ë³´
    ip_address VARCHAR(50),
    user_agent VARCHAR(500),
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_audit_admin ON admin_audit_logs(admin_id);
CREATE INDEX idx_audit_target ON admin_audit_logs(target_table, target_id);
CREATE INDEX idx_audit_action ON admin_audit_logs(action_type);
CREATE INDEX idx_audit_created ON admin_audit_logs(created_at DESC);
```

### 4.2 ledger_entries (ì›ì¥) âš ï¸ (v2.2 entry_type í™•ì¥)

```sql
CREATE TABLE ledger_entries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê±°ë˜ ì°¸ì¡°
    deal_id UUID REFERENCES deals(id),
    payment_id UUID REFERENCES payments(id),
    transfer_id UUID REFERENCES transfers(id),
    
    -- ì›ì¥ ìœ í˜• âš ï¸ (v2.2 SSOT ë™ê¸°í™” - ìš´ì˜ìê¸ˆ ì¤‘ì‹¬)
    entry_type VARCHAR(50) NOT NULL,
    /*
      === ìš´ì˜ìê¸ˆ ìœ ì… (ì–‘ìˆ˜) ===
      CAPITAL_IN: ìë³¸ê¸ˆ ìœ ì… (ì´ˆê¸° ìê¸ˆ, ì¶”ê°€ íˆ¬ì…)
      SETTLEMENT_IN: PG ì •ì‚°ê¸ˆ ìˆ˜ì‹  (D+2 ì •ì‚°)
      RETURN_IN: ì†¡ê¸ˆ ë°˜í™˜ ì…ê¸ˆ (ì‹¤íŒ¨ í›„ ë°˜í™˜)
      
      === ìš´ì˜ìê¸ˆ ìœ ì¶œ (ìŒìˆ˜) ===
      TRANSFER_OUT: ê³ ê° ì†¡ê¸ˆ ì¶œê¸ˆ (ì›ê¸ˆ ì „ì•¡)
      REFUND_OUT: í™˜ë¶ˆ ì¶œê¸ˆ (ê²°ì œ ì·¨ì†Œ/í™˜ë¶ˆ)
      FEE_OUT: PG/ì†¡ê¸ˆ ìˆ˜ìˆ˜ë£Œ (ë¹„ìš© ì²˜ë¦¬)
      CHARGEBACK_OUT: ì°¨ì§€ë°± ì†ì‹¤
      
      === ë ˆê±°ì‹œ (í•˜ìœ„ í˜¸í™˜) ===
      CARD_CAPTURE: ì¹´ë“œ ê²°ì œ ìˆ˜ì‹  (v2.1 ë ˆê±°ì‹œ)
      FEE_REVENUE: ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ (v2.1 ë ˆê±°ì‹œ)
      TRANSFER_PAYOUT: ì†¡ê¸ˆ ì§€ì¶œ (v2.1 ë ˆê±°ì‹œ â†’ TRANSFER_OUT)
      REFUND_FEE_REVERSAL: ìˆ˜ìˆ˜ë£Œ í™˜ì… (v2.1 ë ˆê±°ì‹œ)
    */
    
    -- ê¸ˆì•¡ (ì–‘ìˆ˜: ìˆ˜ì…, ìŒìˆ˜: ì§€ì¶œ)
    amount BIGINT NOT NULL,
    
    -- ì”ì•¡ (ëˆ„ì )
    balance_after BIGINT NOT NULL,
    
    -- ì°¸ì¡° ì •ë³´
    reference_type VARCHAR(50),
    reference_id VARCHAR(100),
    description VARCHAR(200),
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_ledger_deal ON ledger_entries(deal_id);
CREATE INDEX idx_ledger_type ON ledger_entries(entry_type);
CREATE INDEX idx_ledger_created ON ledger_entries(created_at DESC);
```

---

## 5. Statistics í…Œì´ë¸”

### 5.1 user_monthly_stats (ì›”ê°„ í†µê³„ ì´ë ¥)

```sql
CREATE TABLE user_monthly_stats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ì‚¬ìš©ì
    user_uid UUID REFERENCES users(uid) NOT NULL,
    
    -- ê¸°ê°„
    year_month VARCHAR(7) NOT NULL,                 -- '2025-12'
    
    -- í†µê³„
    payment_count INT DEFAULT 0,
    payment_amount BIGINT DEFAULT 0,
    fee_amount BIGINT DEFAULT 0,
    
    -- ë“±ê¸‰ ì •ë³´
    grade_at_month VARCHAR(20),
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    CONSTRAINT user_monthly_stats_unique UNIQUE (user_uid, year_month)
);

CREATE INDEX idx_monthly_stats_user ON user_monthly_stats(user_uid);
CREATE INDEX idx_monthly_stats_month ON user_monthly_stats(year_month);
```

---

## 6. User í…Œì´ë¸”

### 6.1 favorite_accounts (ì¦ê²¨ì°¾ê¸° ê³„ì¢Œ)

```sql
CREATE TABLE favorite_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ì†Œìœ ì
    user_uid UUID REFERENCES users(uid) ON DELETE CASCADE NOT NULL,
    
    -- ê³„ì¢Œ ì •ë³´
    bank_code VARCHAR(10) NOT NULL,
    account_number VARCHAR(200) NOT NULL,           -- KMS ì•”í˜¸í™”
    account_number_hash VARCHAR(64) NOT NULL,       -- ê²€ìƒ‰/ìœ ë‹ˆí¬ìš©
    account_holder VARCHAR(50) NOT NULL,
    
    -- ë³„ì¹­
    alias VARCHAR(50),
    
    -- ì‚¬ìš© í†µê³„
    use_count INT DEFAULT 0,
    
    -- ê³µí†µ ì»¬ëŸ¼
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0,
    
    last_used_at TIMESTAMP
);

CREATE INDEX idx_favorite_user ON favorite_accounts(user_uid) WHERE deleted_at IS NULL;
CREATE UNIQUE INDEX idx_favorite_unique ON favorite_accounts(user_uid, bank_code, account_number_hash) 
    WHERE deleted_at IS NULL;
```

### 6.2 memberships (ë©¤ë²„ì‹­ ë“±ê¸‰)

```sql
CREATE TABLE memberships (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    grade VARCHAR(20) UNIQUE NOT NULL,
    grade_name VARCHAR(50) NOT NULL,
    grade_order INT NOT NULL,
    
    fee_rate DECIMAL(5,4) NOT NULL,
    
    monthly_fee_min BIGINT DEFAULT 0,
    monthly_amount_min BIGINT DEFAULT 0,
    
    benefits TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0
);

-- ì´ˆê¸° ë°ì´í„°
INSERT INTO memberships (grade, grade_name, grade_order, fee_rate, monthly_fee_min) VALUES
('BASIC', 'ë² ì´ì§', 1, 0.0350, 0),
('PLATINUM', 'í”Œë˜í‹°ë„˜', 2, 0.0300, 100000);
```

### 6.3 discount_codes (í• ì¸ ì½”ë“œ)

```sql
CREATE TABLE discount_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    code VARCHAR(50) UNIQUE NOT NULL,
    description VARCHAR(200),
    
    discount_type VARCHAR(20) NOT NULL,             -- RATE, FIXED
    discount_value DECIMAL(10,4) NOT NULL,
    
    min_amount BIGINT DEFAULT 0,
    max_discount BIGINT,
    
    total_limit INT,
    per_user_limit INT DEFAULT 1,
    used_count INT DEFAULT 0,
    
    valid_from TIMESTAMP NOT NULL,
    valid_until TIMESTAMP NOT NULL,
    
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0
);

CREATE INDEX idx_discount_code ON discount_codes(code) WHERE deleted_at IS NULL;
CREATE INDEX idx_discount_valid ON discount_codes(valid_from, valid_until) 
    WHERE is_active = TRUE AND deleted_at IS NULL;
```

---

## 7. Admin í…Œì´ë¸”

### 7.1 admin_users (ê´€ë¦¬ì)

```sql
CREATE TABLE admin_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    login_id VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(200) NOT NULL,
    
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(20),
    
    role VARCHAR(20) DEFAULT 'ADMIN',               -- SUPER_ADMIN, ADMIN, VIEWER
    permissions JSONB,
    
    status VARCHAR(20) DEFAULT 'ACTIVE',
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0,
    
    last_login_at TIMESTAMP
);

CREATE INDEX idx_admin_login ON admin_users(login_id) WHERE deleted_at IS NULL;
```

---

## 8. Content í…Œì´ë¸”

### 8.1 notices (ê³µì§€ì‚¬í•­)

```sql
CREATE TABLE notices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(50) DEFAULT 'GENERAL',
    
    is_pinned BOOLEAN DEFAULT FALSE,
    is_published BOOLEAN DEFAULT FALSE,
    view_count INT DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0,
    
    published_at TIMESTAMP
);

CREATE INDEX idx_notices_published ON notices(is_published, published_at DESC) 
    WHERE deleted_at IS NULL;
```

### 8.2 faqs (FAQ)

```sql
CREATE TABLE faqs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    question VARCHAR(500) NOT NULL,
    answer TEXT NOT NULL,
    category VARCHAR(50) DEFAULT 'GENERAL',
    sort_order INT DEFAULT 0,
    
    is_published BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0
);

CREATE INDEX idx_faqs_published ON faqs(is_published, sort_order) WHERE deleted_at IS NULL;
```

### 8.3 banners (ë°°ë„ˆ)

```sql
CREATE TABLE banners (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    title VARCHAR(200) NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    link_url VARCHAR(500),
    position VARCHAR(50) DEFAULT 'MAIN',
    sort_order INT DEFAULT 0,
    
    start_date TIMESTAMP,
    end_date TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    click_count INT DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    version BIGINT DEFAULT 0
);

CREATE INDEX idx_banners_active ON banners(position, sort_order) 
    WHERE is_active = TRUE AND deleted_at IS NULL;
```

---

## 9. ìƒíƒœ ì •ì˜

### 9.1 Deal ìƒíƒœ

| ìƒíƒœ | ì„¤ëª… | ë‹¤ìŒ ìƒíƒœ |
|------|------|-----------|
| PENDING | ê±°ë˜ ìƒì„±ë¨ | PAID, CANCELLED |
| PAID | ê²°ì œ ì™„ë£Œ | TRANSFERRING, REFUNDED |
| TRANSFERRING | ì†¡ê¸ˆ ì§„í–‰ ì¤‘ | COMPLETED, TRANSFER_FAILED |
| COMPLETED | ê±°ë˜ ì™„ë£Œ | - |
| CANCELLED | ì·¨ì†Œ (ê²°ì œ ì „) | - |
| REFUNDED | í™˜ë¶ˆë¨ | - |
| TRANSFER_FAILED | ì†¡ê¸ˆ ì‹¤íŒ¨ | TRANSFERRING |

### 9.2 Payment ìƒíƒœ

| ìƒíƒœ | ì„¤ëª… |
|------|------|
| PENDING | ê²°ì œ ëŒ€ê¸° |
| PAID | ê²°ì œ ì™„ë£Œ |
| FAILED | ê²°ì œ ì‹¤íŒ¨ |
| CANCELLED | ì·¨ì†Œë¨ |
| REFUNDED | í™˜ë¶ˆë¨ |

### 9.3 Transfer ìƒíƒœ

| ìƒíƒœ | ì„¤ëª… |
|------|------|
| PENDING | ì†¡ê¸ˆ ëŒ€ê¸° |
| PROCESSING | ì†¡ê¸ˆ ì²˜ë¦¬ ì¤‘ |
| COMPLETED | ì†¡ê¸ˆ ì™„ë£Œ |
| FAILED | ì†¡ê¸ˆ ì‹¤íŒ¨ |

### 9.4 TransferJob ìƒíƒœ

| ìƒíƒœ | ì„¤ëª… |
|------|------|
| PENDING | ëŒ€ê¸° |
| PROCESSING | ì²˜ë¦¬ ì¤‘ (locked) |
| COMPLETED | ì™„ë£Œ |
| FAILED | ì‹¤íŒ¨ (ì¬ì‹œë„ ëŒ€ê¸°) |
| ABANDONED | í¬ê¸° (ìˆ˜ë™ ì²˜ë¦¬) |

**â€» PaymentSlice ìƒíƒœëŠ” v1.0ì—ì„œ ì œì™¸ (ë¶„í• ê²°ì œ ë³´ë¥˜)**

---

## 10. ì•”í˜¸í™” ì •ì±…

### 10.1 ì•”í˜¸í™” ëŒ€ìƒ

| í…Œì´ë¸” | í•„ë“œ | ë°©ì‹ |
|--------|------|------|
| cards | billing_key | AES-256 (KMS) |
| deals | recipient_account_number | AES-256 (KMS) |
| transfers | recipient_account_number | AES-256 (KMS) |
| favorite_accounts | account_number | AES-256 (KMS) |
| admin_users | password_hash | bcrypt |

### 10.2 ê²€ìƒ‰ìš© Hash í•„ë“œ

| í…Œì´ë¸” | Hash í•„ë“œ | ìš©ë„ |
|--------|-----------|------|
| deals | recipient_account_hash | ë™ì¼ ê³„ì¢Œ ê²€ìƒ‰, FDS |
| transfers | recipient_account_hash | ë™ì¼ ê³„ì¢Œ ê²€ìƒ‰ |
| favorite_accounts | account_number_hash | ì¤‘ë³µ ë°©ì§€, ê²€ìƒ‰ |

### 10.3 KMS í‚¤

```
AWS KMS Key Alias:
- plic/billing-key    : billingKey ì•”í˜¸í™”
- plic/account-number : ê³„ì¢Œë²ˆí˜¸ ì•”í˜¸í™”
- plic/account-hmac   : ê³„ì¢Œë²ˆí˜¸ HMACìš©
```

---

## 11. ë™ì‹œì„± ì œì–´

### 11.1 Optimistic Lock ì‚¬ìš©ë²•

```sql
-- ì—…ë°ì´íŠ¸ ì‹œ
UPDATE deals 
SET status = 'PAID', version = version + 1, updated_at = NOW()
WHERE id = ? AND version = ?;

-- ì˜í–¥ë°›ì€ í–‰ì´ 0ì´ë©´ ì¶©ëŒ ë°œìƒ â†’ ì¬ì‹œë„ ë˜ëŠ” ì—ëŸ¬
```

### 11.2 Transfer Job ë½

```sql
-- ì›Œì»¤ê°€ ì‘ì—… ê°€ì ¸ì˜¤ê¸°
UPDATE transfer_jobs
SET status = 'PROCESSING', locked_at = NOW(), locked_by = 'worker-1'
WHERE id = (
    SELECT id FROM transfer_jobs
    WHERE status IN ('PENDING', 'FAILED')
      AND (next_retry_at IS NULL OR next_retry_at <= NOW())
    ORDER BY created_at
    LIMIT 1
    FOR UPDATE SKIP LOCKED
)
RETURNING *;
```

---

## ë¶€ë¡

### A. ì€í–‰ ì½”ë“œ

| ì½”ë“œ | ì€í–‰ëª… |
|------|--------|
| 004 | KBêµ­ë¯¼ì€í–‰ |
| 011 | NHë†í˜‘ì€í–‰ |
| 020 | ìš°ë¦¬ì€í–‰ |
| 081 | í•˜ë‚˜ì€í–‰ |
| 088 | ì‹ í•œì€í–‰ |
| 089 | ì¼€ì´ë±…í¬ |
| 090 | ì¹´ì¹´ì˜¤ë±…í¬ |
| 092 | í† ìŠ¤ë±…í¬ |

### B. ë³€ê²½ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ | ë³€ê²½ ë‚´ìš© |
|------|------|-----------|
| 1.0 | 2025-12-23 | ì´ˆì•ˆ ì‘ì„± |
| 2.0 | 2025-12-23 | CTO ë¦¬ë·° ë°˜ì˜: ë™ì‹œì„± ì œì–´, ê°ì‚¬ë¡œê·¸, Soft Delete, ë©±ë“±ì„±, ì†¡ê¸ˆí, Hash ì»¬ëŸ¼, Split ëª¨ë¸ ëª…í™•í™” |
| 2.1 | 2025-12-23 | 2ì°¨ CTO ë¦¬í¬íŠ¸ ë°˜ì˜ (ì•„ë˜ ìƒì„¸) |

### C. v2.1 ë³€ê²½ ìƒì„¸ (2ì°¨ CTO ë¦¬í¬íŠ¸ ë°˜ì˜)

#### P0 (Critical) ë°˜ì˜ ì‚¬í•­

| # | í•­ëª© | ë³€ê²½ ë‚´ìš© |
|---|------|-----------|
| 1 | ìˆ˜ìˆ˜ë£Œ ì°¨ê° ë¬¸êµ¬ | "ì›ê¸ˆ ì „ì•¡ ì†¡ê¸ˆ" ì›ì¹™ ëª…ì‹œ (deals, transfers, ledger_entries ì£¼ì„) |
| 2 | ì¹´ë“œ í† í°í™” | cards í…Œì´ë¸”ì— "SDK í† í°í™” ë°©ì‹" ì£¼ì„ ì¶”ê°€ |
| 3 | SQS vs DB ì—­í•  | transfer_jobsì— "DB=ì§„ì‹¤, SQS=ì‹ í˜¸" ì•„í‚¤í…ì²˜ ì£¼ì„ ì¶”ê°€ |
| 4 | transfer_jobs ì¤‘ë³µ ë°©ì§€ | `idx_transfer_jobs_deal_unique` ì¡°ê±´ë¶€ ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ ì¶”ê°€ |

#### P1 (High) ë°˜ì˜ ì‚¬í•­

| # | í•­ëª© | ë³€ê²½ ë‚´ìš© |
|---|------|-----------|
| 5 | pg_webhook_events ìµœì í™” | `deal_id`, `payment_id`, `pg_payment_key` ì»¬ëŸ¼ ìŠ¹ê²© + ì¸ë±ìŠ¤ |
| 6 | Split ìŠ¤ì¼€ì¤„ëŸ¬ ì±…ì„ | payment_slices ë³´ë¥˜ ì„¹ì…˜ì— "EventBridge â†’ Lambda" ëª…ì‹œ |
| 7 | ë¶„í• ê²°ì œ ë²•ì  ë¦¬ìŠ¤í¬ | payment_slices ì „ì²´ ë³´ë¥˜, `SPLIT_TRANSFER_MODE` íŒŒë¼ë¯¸í„°í™” ì–¸ê¸‰ |

#### ë°˜ì˜í•˜ì§€ ì•Šì€ ì‚¬í•­

| í•­ëª© | ì‚¬ìœ  |
|------|------|
| TIMESTAMPTZ ì „í™˜ | êµ­ë‚´ ì „ìš© ì„œë¹„ìŠ¤, KST ê³ ì • |
| NAT 1ê°œë¡œ ì¶•ì†Œ | ì•ˆì •ì„± ìš°ì„  (CTO ì§€ì§€) |
| VPC Endpoint | ëŸ°ì¹­ í›„ ìµœì í™” |
| í…Œì´ë¸” íŒŒí‹°ì…”ë‹ | íŠ¸ë˜í”½ í™•ì¸ í›„ |
