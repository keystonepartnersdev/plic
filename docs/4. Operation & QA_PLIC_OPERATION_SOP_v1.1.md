# PLIC 운영 SOP (OPERATION SOP)

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | PLIC Operation SOP |
| 버전 | 1.1 |
| 작성일 | 2025-01-06 |
| 수정일 | 2025-01-06 |
| 작성자 | PLIC 운영팀 |
| 상태 | **Approved** |
| 역할 | **긴급 상황 대응 SSOT** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-06 | 초안 작성 | PLIC 운영팀 |
| 1.1 | 2025-01-06 | **CTO 리뷰 반영**: AWS 리소스 확인 위치 명시, 서킷브레이커 복구 절차, DLQ 처리 매뉴얼, 은행 점검 대응, 커뮤니케이션 템플릿 추가 | PLIC 운영팀 |

---

## 1. SOP 개요

### 1.1 목적

본 문서는 PLIC 서비스 운영 중 발생할 수 있는 긴급 상황에 대한 표준 대응 절차를 정의합니다.

### 1.2 적용 범위

- 시스템 장애 대응
- 차지백 대응
- 운영 자금 부족 대응
- 대사 불일치 복구
- 보안 사고 대응

### 1.3 긴급도 분류

| 등급 | 정의 | 대응 시간 | 예시 |
|------|------|----------|------|
| **P1 (Critical)** | 서비스 전면 중단 | 15분 내 | 전체 시스템 다운, 결제 불가 |
| **P2 (High)** | 주요 기능 장애 | 30분 내 | 송금 전체 실패, 대사 불일치 |
| **P3 (Medium)** | 부분 기능 장애 | 2시간 내 | 특정 은행 송금 실패 |
| **P4 (Low)** | 경미한 이슈 | 24시간 내 | UI 오류, 알림 지연 |

---

## 2. 시스템 장애 대응 SOP

### 2.1 장애 감지

**자동 감지**:
- CloudWatch Alarm
- Health Check 실패
- 에러율 급증 알림

**수동 감지**:
- CS 문의 급증
- 모니터링 대시보드 이상

### 2.2 장애 대응 플로우

```
[장애 감지]
    │
    ▼
[1단계: 초기 대응] (15분 이내)
    │ - 장애 범위 파악
    │ - 담당자 소집
    │ - 상황 공유 (#plic-incidents)
    │
    ▼
[2단계: 원인 분석] (30분 이내)
    │ - 로그 분석
    │ - 메트릭 확인
    │ - 최근 변경 사항 확인
    │
    ▼
[3단계: 긴급 조치]
    │ - 롤백 (배포 관련 시)
    │ - 서버 재시작
    │ - 트래픽 차단/우회
    │
    ▼
[4단계: 복구 확인]
    │ - 서비스 정상화 확인
    │ - 모니터링 강화
    │
    ▼
[5단계: 사후 처리]
    - 장애 보고서 작성
    - 재발 방지 대책 수립
```

### 2.3 장애 유형별 대응 ⚠️ (v1.1 AWS 리소스 확인 위치 명시)

#### 2.3.1 API 서버 장애

```
[증상] API 응답 없음 또는 5xx 에러 급증

[AWS 확인 위치] ⚠️ v1.1 추가
- ECS Console: 클러스터 > plic-prod > 서비스 > plic-api > Tasks
- CloudWatch: Log Groups > /ecs/plic-api > Log Insights
- ALB: EC2 > 로드밸런서 > plic-alb > 대상 그룹 > Health

[CloudWatch Log Insights 쿼리]
fields @timestamp, @message
| filter @message like /ERROR|FATAL|Exception/
| sort @timestamp desc
| limit 100

[확인 사항]
1. ECS Task 상태 확인
2. ALB Target Health 확인
3. CPU/Memory 사용률 확인
4. DB 연결 상태 확인

[조치]
- Task 수 증가 (Auto Scaling)
- 문제 Task 재시작
- 최근 배포 롤백 (필요 시)

[명령어]
aws ecs update-service --cluster plic-prod \
  --service plic-api --force-new-deployment
```

#### 2.3.2 데이터베이스 장애

```
[증상] DB 연결 실패 또는 쿼리 타임아웃

[AWS 확인 위치] ⚠️ v1.1 추가
- RDS Console: 데이터베이스 > plic-prod-db > 모니터링
- CloudWatch: RDS 메트릭 (CPUUtilization, DatabaseConnections)
- Performance Insights: RDS > 성능 개선 도우미

[확인 사항]
1. RDS 인스턴스 상태
2. 연결 수 (max_connections)
3. 슬로우 쿼리 로그
4. 디스크 사용량

[조치]
- 연결 풀 초기화
- 슬로우 쿼리 킬
- Read Replica 전환 (필요 시)
- RDS 인스턴스 재시작 (최후 수단)

[명령어]
-- 현재 연결 확인
SELECT count(*) FROM pg_stat_activity;

-- 슬로우 쿼리 킬
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE state = 'active' 
AND query_start < now() - interval '5 minutes';
```

#### 2.3.3 Redis 장애

```
[증상] 세션 오류, 캐시 미작동

[AWS 확인 위치] ⚠️ v1.1 추가
- ElastiCache Console: Redis 클러스터 > plic-redis > 노드
- CloudWatch: ElastiCache 메트릭 (CurrConnections, BytesUsedForCache)

[확인 사항]
1. ElastiCache 노드 상태
2. 메모리 사용률
3. 연결 수

[조치]
- 노드 재시작
- 메모리 정리 (FLUSHDB - 주의)
- 클러스터 페일오버

[영향]
- 멱등성: DB에서 처리 (Redis 없어도 동작)
- 세션: 재로그인 필요
- 캐시: 일시적 성능 저하
```

#### 2.3.4 SQS 장애

```
[증상] 메시지 적체, 송금 지연

[AWS 확인 위치] ⚠️ v1.1 추가
- SQS Console: 대기열 > plic-transfer-queue
- DLQ: 대기열 > plic-transfer-dlq
- CloudWatch: SQS 메트릭 (ApproximateNumberOfMessages, NumberOfMessagesReceived)

[확인 사항]
1. 큐 메시지 수
2. Worker 상태
3. DLQ 메시지 수

[조치]
- Worker 수 증가
- 메시지 처리 속도 확인
- DLQ 메시지 재처리

[모니터링]
- ApproximateNumberOfMessages > 1000: Warning
- ApproximateNumberOfMessages > 5000: Critical
```

### 2.4 에스컬레이션 경로

| 시간 | 조치 |
|------|------|
| 0분 | 당직자 초기 대응 |
| 15분 | 개발팀장 보고 |
| 30분 | CTO 보고 |
| 1시간 | CEO 보고 (P1의 경우) |
| 복구 후 | 장애 보고서 작성 |

---

## 3. 차지백 대응 SOP

### 3.1 차지백 개요

> 차지백: 카드 소지자가 카드사에 거래 취소를 요청하는 것

**주요 사유**:
- 부정 사용 (도난/분실 카드)
- 서비스 미제공
- 금액 오류
- 중복 결제

### 3.2 차지백 대응 SLA

| 단계 | 기한 | 담당 |
|------|------|------|
| 차지백 접수 | D+0 | 자동 |
| 내부 조사 | D+2 | 운영팀 |
| 증빙 제출 | D+5 | 운영팀 |
| 카드사 심사 | D+30~45 | 카드사 |
| 결과 통보 | D+45~60 | 카드사 |

### 3.3 차지백 대응 플로우

```
[차지백 접수] (PG 웹훅)
    │
    ▼
[1단계: 접수 확인] (D+0)
    │ - 거래 내역 확인
    │ - 고객 정보 확인
    │ - 차지백 사유 확인
    │
    ▼
[2단계: 내부 조사] (D+1~2)
    │ - 결제 로그 확인
    │ - 송금 완료 여부 확인
    │ - 고객 연락 시도
    │
    ▼
[3단계: 증빙 수집] (D+2~4)
    │ - 결제 승인 내역
    │ - 본인인증 기록
    │ - 송금 완료 증빙
    │ - 고객 동의 기록
    │
    ▼
[4단계: 증빙 제출] (D+5 이내)
    │ - PG사 양식에 맞춰 제출
    │ - 제출 기록 보관
    │
    ▼
[5단계: 결과 대응]
    ├─ [승소] → 차지백 취소
    └─ [패소] → 손실 처리, 계정 조치
```

### 3.4 증빙 항목 체크리스트

- [ ] 결제 승인 내역 (거래일시, 금액, 카드정보)
- [ ] 본인인증 기록 (PASS 인증 결과)
- [ ] 서비스 이용 내역 (거래 생성, 송금 요청)
- [ ] 송금 완료 증빙 (송금 결과, 은행 확인)
- [ ] 고객 동의 기록 (이용약관 동의)
- [ ] IP 및 디바이스 정보
- [ ] 고객 연락 기록 (해당 시)

### 3.5 차지백 후속 조치

**패소 시 계정 조치 기준**:

| 차지백 횟수 | 조치 |
|------------|------|
| 1회 | 경고 알림 |
| 2회 | 한도 제한 (50%) |
| 3회 | 신규 결제 차단 |
| 4회 이상 | 계정 영구 정지 |

**부정 사용 의심 시**:

```
1. 즉시 계정 정지 (SUSPENDED)
2. 보안팀 보고
3. 연관 계정 조사
4. 법적 조치 검토
```

---

## 4. 운영 자금 부족 대응 SOP

### 4.1 운영 자금 임계값

| 잔액 | 상태 | 알림 | 조치 |
|------|------|------|------|
| > 50,000,000원 | 정상 | - | - |
| ≤ 50,000,000원 | 주의 | Warning | 재무팀 알림 |
| ≤ 20,000,000원 | 경고 | Critical | 즉시 충전 요청 |
| ≤ 10,000,000원 | 위험 | OPEN | 서킷브레이커 작동 |

### 4.2 서킷브레이커 대응 ⚠️ (v1.1 기술적 복구 절차 추가)

```
[HALF_OPEN 상태] (잔액 20,000,000원 이하)
    │
    ├─ 조치:
    │   - 대량 거래 제한 (100만원 이상)
    │   - 재무팀 긴급 충전 요청
    │   - 예상 소진 시간 계산
    │
    ▼
[OPEN 상태] (잔액 10,000,000원 이하)
    │
    ├─ 영향:
    │   - 신규 결제 차단
    │   - 진행 중 송금만 처리
    │   - 사용자에게 점검 안내
    │
    ├─ 조치:
    │   - 재무팀 비상 충전
    │   - 경영진 보고
    │   - 복구 예상 시간 공지
    │
    ▼
[CLOSED 복구] (잔액 30,000,000원 이상)
    │
    └─ 조치:
        - 서비스 정상화 확인
        - 대기 거래 처리
        - 정상화 공지
```

**기술적 복구 매뉴얼** ⚠️ (v1.1 추가):

```
[1단계: 잔액 확인]
# DB 쿼리
SELECT balance_after 
FROM ledger_entries 
ORDER BY created_at DESC 
LIMIT 1;

# 또는 Admin API
GET /admin/fund/balance

[2단계: 자금 충전 후 시스템 업데이트]
# 자금 입금 후 ledger_entries 기록
INSERT INTO ledger_entries (
  entry_type, amount, balance_after, description
) VALUES (
  'CAPITAL_IN', 50000000, {현재잔액+50000000}, '긴급 자금 충전'
);

[3단계: 서킷브레이커 상태 확인]
# Redis 캐시 확인
redis-cli GET plic:circuit_breaker:transfer

# 강제 CLOSED 전환 (Admin 권한 필요)
redis-cli SET plic:circuit_breaker:transfer "CLOSED"

[4단계: 서비스 정상화 검증]
# 테스트 거래 생성 시도
# 에러 로그 모니터링
# 메트릭 대시보드 확인
```

### 4.3 긴급 자금 충전 절차

```
1. 운영팀 → 재무팀 긴급 충전 요청
   - 채널: #plic-finance (또는 전화)
   - 내용: 현재 잔액, 필요 금액, 예상 소진 시간

2. 재무팀 → 충전 실행
   - 법인 계좌에서 운영 계좌로 이체
   - 금액: 최소 5천만원 이상 권장

3. 운영팀 → 충전 확인
   - 잔액 증가 확인
   - 서킷브레이커 상태 확인

4. 서비스 정상화
   - CLOSED 상태 전환 확인
   - 대기 거래 처리 모니터링
```

---

## 5. 대사 불일치 복구 SOP

### 5.1 불일치 유형별 SOP

#### 5.1.1 AMOUNT_MISMATCH (금액 불일치)

```
[원인] PLIC 기록 금액 ≠ 외부 시스템 금액

[조사]
1. PLIC DB에서 거래 원본 조회
2. PG 관리자에서 실제 결제 금액 확인
3. 부분 취소 여부 확인

[처리]
- PLIC 금액이 잘못된 경우: 내부 데이터 보정
- 외부 금액이 잘못된 경우: PG사에 문의

[기록]
- reconciliation_items.resolution_notes에 조치 내용 기록
- 감사 로그 생성
```

#### 5.1.2 STATUS_MISMATCH (상태 불일치)

```
[원인] PLIC 상태 ≠ 외부 시스템 상태

[조사]
1. PLIC 상태 전이 로그 확인
2. 외부 API 조회로 현재 상태 확인
3. 웹훅 수신 로그 확인

[처리]
- 외부가 최신인 경우: PLIC 상태 동기화 (Self-Heal)
- 웹훅 누락인 경우: 수동 상태 업데이트

[주의]
- 금전 관련 상태는 자동 보정 금지
- 환불/취소는 반드시 수동 확인
```

#### 5.1.3 GHOST_TRANSACTION (유령 거래)

```
[원인] 한쪽에만 존재하는 거래

[PLIC_ONLY] (PLIC에만 있음)
1. 외부 시스템에서 직접 조회
2. 웹훅 누락 확인
3. 상태가 "성공"이면 외부에 문의
4. 상태가 "실패"면 내부 정리

[EXTERNAL_ONLY] (외부에만 있음) ⚠️ 보안 사고 의심
1. 즉시 보안팀 에스컬레이션
2. 해당 거래 동결
3. 로그 전수 조사
4. 부정 거래 여부 확인
```

#### 5.1.4 TIMING_MISMATCH (타이밍 불일치)

```
[원인] Cut-off 시간 전후 거래

[처리]
1. 익일 자동 재대사 대기
2. 2일 연속 불일치 시 수동 확인
3. 외부 시스템 반영 시간 확인

[예방]
- Cut-off 전 10분(23:50) 거래는 익일 대사로 이월
```

### 5.2 불일치 해결 권한

| 작업 | 담당자 | 승인 |
|------|--------|------|
| 상태 동기화 | 운영 담당 | 불필요 |
| 금액 1만원 미만 조정 | 운영 담당 | 불필요 |
| 금액 1만원 이상 조정 | 운영 담당 | 운영팀장 |
| 거래 삭제/생성 | 운영팀장 | CTO |

---

## 6. 보안 사고 대응 SOP

### 6.1 보안 사고 유형

| 유형 | 예시 | 긴급도 |
|------|------|--------|
| **데이터 유출** | DB 접근 이상, 로그 유출 | P1 |
| **부정 거래** | 도용 카드, 허위 계정 | P2 |
| **시스템 침입** | 비인가 접근, 악성코드 | P1 |
| **DDoS** | 트래픽 폭주 | P2 |

### 6.2 보안 사고 대응 플로우

```
[사고 감지]
    │
    ▼
[1단계: 초기 대응] (즉시)
    │ - 보안팀 긴급 연락
    │ - 피해 범위 파악
    │ - 증거 보전 (로그 백업)
    │
    ▼
[2단계: 격리] (15분 내)
    │ - 침해 시스템 격리
    │ - 의심 계정 정지
    │ - 필요 시 서비스 중단
    │
    ▼
[3단계: 분석] (1시간 내)
    │ - 침입 경로 분석
    │ - 피해 범위 확정
    │ - 원인 파악
    │
    ▼
[4단계: 복구]
    │ - 취약점 패치
    │ - 시스템 복구
    │ - 서비스 재개
    │
    ▼
[5단계: 사후 처리]
    - 사고 보고서 작성
    - 관계 기관 신고 (필요 시)
    - 고객 통지 (개인정보 유출 시)
    - 재발 방지 대책
```

### 6.3 데이터 유출 대응

```
[개인정보 유출 확인 시]

1. 즉시 조치
   - 유출 경로 차단
   - 증거 보전

2. 보고 (24시간 내)
   - 경영진 보고
   - 개인정보보호위원회 신고 (1,000명 이상)
   - 한국인터넷진흥원(KISA) 신고

3. 고객 통지 (72시간 내)
   - 유출 항목
   - 유출 시점
   - 대응 조치
   - 피해 최소화 방법
   - 문의처

4. 사후 조치
   - 피해 보상 검토
   - 보안 강화 조치
   - 재발 방지 대책
```

### 6.4 부정 거래 대응

```
[부정 거래 의심 시]

1. 즉시 조치
   - 해당 거래 동결
   - 관련 계정 정지

2. 조사
   - 거래 패턴 분석
   - IP/디바이스 확인
   - 연관 계정 조사

3. 처리
   - 부정 확인 시: 거래 취소, 계정 영구 정지
   - 오탐 확인 시: 계정 복구, 고객 사과

4. 기록
   - 부정 거래 DB 등록
   - 패턴 룰 업데이트
```

---

## 7. 커뮤니케이션 템플릿

### 7.1 장애 공지 템플릿

**서비스 점검 안내**:
```
[PLIC 서비스 점검 안내]

안녕하세요, PLIC입니다.

현재 시스템 점검으로 인해 일시적으로 서비스 이용이 제한됩니다.

■ 점검 시간: YYYY-MM-DD HH:MM ~ HH:MM (예정)
■ 영향 범위: [결제/송금/전체]
■ 점검 사유: [간단한 사유]

빠른 복구를 위해 최선을 다하겠습니다.
이용에 불편을 드려 죄송합니다.

PLIC 드림
```

**장애 복구 안내**:
```
[PLIC 서비스 정상화 안내]

안녕하세요, PLIC입니다.

시스템 점검이 완료되어 정상 서비스가 재개되었습니다.

■ 복구 시간: YYYY-MM-DD HH:MM
■ 점검 기간 중 미처리 건은 순차적으로 처리됩니다.

불편을 드려 죄송합니다.
감사합니다.

PLIC 드림
```

### 7.2 내부 보고 템플릿

**장애 보고서**:
```
# 장애 보고서

## 개요
- 발생 일시: YYYY-MM-DD HH:MM
- 복구 일시: YYYY-MM-DD HH:MM
- 장애 시간: X시간 X분
- 긴급도: P1/P2/P3/P4
- 영향 범위: [설명]

## 타임라인
- HH:MM - 장애 감지
- HH:MM - 초기 대응 시작
- HH:MM - 원인 파악
- HH:MM - 조치 완료
- HH:MM - 서비스 정상화

## 원인 분석
[상세 원인]

## 조치 내용
[수행한 조치]

## 영향도
- 영향 받은 사용자 수: X명
- 영향 받은 거래 수: X건
- 금전적 영향: X원

## 재발 방지 대책
1. [단기 대책]
2. [장기 대책]

## 담당자
- 초기 대응: [이름]
- 복구: [이름]
- 보고서 작성: [이름]
```

---

## 부록

### A. DLQ (Dead Letter Queue) 처리 매뉴얼 ⚠️ (v1.1 추가)

> ⚠️ **DLQ**: 5회 이상 실패하여 일반 큐에서 이동된 메시지

**확인 위치**:
- SQS Console: 대기열 > `plic-transfer-dlq`
- CloudWatch: `ApproximateNumberOfMessagesVisible` 메트릭

**DLQ 처리 절차**:
```
[1단계: 메시지 확인]
# AWS CLI로 DLQ 메시지 조회
aws sqs receive-message \
  --queue-url https://sqs.ap-northeast-2.amazonaws.com/xxx/plic-transfer-dlq \
  --max-number-of-messages 10

[2단계: 실패 사유 분석]
# 메시지 body에서 deal_id 추출 후 DB 조회
SELECT * FROM transfer_jobs WHERE deal_id = '{deal_id}';
SELECT * FROM transfers WHERE deal_id = '{deal_id}' ORDER BY attempt DESC;

# 실패 사유 확인
- INSUFFICIENT_BALANCE: 수취 계좌 입금 한도 초과
- ACCOUNT_NOT_FOUND: 계좌번호 오류
- BANK_SYSTEM_ERROR: 은행 시스템 오류 (재시도 가능)

[3단계: 조치 결정]
┌─ 재시도 가능 (BANK_SYSTEM_ERROR 등)
│   └─ Re-drive 실행
│
└─ 재시도 불가 (ACCOUNT_NOT_FOUND 등)
    └─ Deal 상태 ABANDONED 처리 → 환불 진행
```

**Re-drive 실행** (SUPER_ADMIN 권한 필요):
```
# AWS Console: SQS > DLQ 선택 > "DLQ 재드라이브" 버튼
# 또는 CLI
aws sqs start-message-move-task \
  --source-arn arn:aws:sqs:ap-northeast-2:xxx:plic-transfer-dlq \
  --destination-arn arn:aws:sqs:ap-northeast-2:xxx:plic-transfer-queue
```

### B. 은행 점검 시간 대응 ⚠️ (v1.1 추가)

**점검 시간**: 23:30 ~ 00:30 KST (공통)

**점검 전 체크리스트** (23:00):
- [ ] 점검 시간 내 송금 예정 건 확인
- [ ] 사용자 안내 팝업 활성화 확인
- [ ] 모니터링 강화

**점검 중 처리**:
```
[결제]: 정상 진행
[송금]: PAID 상태 유지 (송금 대기)
[안내]: "은행 점검으로 송금이 지연될 수 있습니다"
```

**점검 종료 후 체크리스트** (00:35):
- [ ] 대기 송금 건 자동 처리 시작 확인
- [ ] 송금 성공률 모니터링
- [ ] 실패 건 DLQ 확인
- [ ] 00:45까지 정상 처리 미완료 시 알림

**모니터링 쿼리**:
```sql
-- 점검 시간 내 생성, 아직 송금 미완료 건
SELECT COUNT(*) 
FROM deals 
WHERE status IN ('PAID', 'TRANSFERRING')
AND paid_at BETWEEN '2025-01-06 23:30:00' AND '2025-01-07 00:30:00';
```

### C. 커뮤니케이션 템플릿 ⚠️ (v1.1 추가)

**CS 안내 - 송금 지연**:
```
[PLIC 송금 지연 안내]

안녕하세요, {고객명}님.

송금 처리가 일시적으로 지연되고 있습니다.

■ 거래번호: {deal_number}
■ 지연 사유: {은행 점검 / 일시적 오류}
■ 예상 완료: {시간}

정상 처리되면 알림을 보내드리겠습니다.
추가 문의 사항은 고객센터로 연락 부탁드립니다.

감사합니다.
```

**CS 안내 - 예금주 불일치**:
```
[PLIC 송금 실패 안내]

안녕하세요, {고객명}님.

입력하신 계좌정보 확인이 필요합니다.

■ 거래번호: {deal_number}
■ 실패 사유: 예금주명 불일치
■ 입력 예금주: {입력값}

정확한 예금주명 확인 후 새로운 거래를 진행해 주세요.
결제 금액은 자동 환불 처리됩니다. (3~7 영업일)

감사합니다.
```

### D. 주요 연락처

| 역할 | 연락처 | 비고 |
|------|--------|------|
| 운영팀장 | - | - |
| 개발팀장 | - | - |
| CTO | - | - |
| 보안팀 | - | - |
| 재무팀 | - | - |

### E. 참고 문서

| 문서 | 역할 |
|------|------|
| PLIC_OPERATIONS_HANDBOOK.md | 일상 운영 가이드 |
| PLIC_SECURITY.md | 보안 정책 상세 |
| PLIC_RECONCILIATION_SETTLEMENT.md | 대사/정산 상세 |
| PLIC_ENGINEERING_GUIDE.md | 기술 가이드 |
| PLIC_BATCH_AND_JOBS.md | 배치 스케줄 SSOT |
| PLIC_STATE_MACHINES.md | 상태 전이 SSOT |
