# PLIC QA 시나리오 (QA SCENARIO)

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | PLIC QA Scenario |
| 버전 | 1.1 |
| 작성일 | 2025-01-06 |
| 수정일 | 2025-01-06 |
| 작성자 | PLIC QA팀 |
| 상태 | **Approved** |
| 역할 | **QA 테스트 SSOT** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-06 | 초안 작성 | PLIC QA팀 |
| 1.1 | 2025-01-06 | **CTO 리뷰 반영**: 멱등성/동시성 TC, 대사 불일치 TC, 인프라 장애 복구 TC, Rate Limit TC 추가 | PLIC QA팀 |

---

## 1. 테스트 개요

### 1.1 테스트 환경

| 환경 | URL | 용도 |
|------|-----|------|
| Development | dev.plic.co.kr | 개발 테스트 |
| Staging | staging.plic.co.kr | QA 테스트 |
| Production | plic.co.kr | 프로덕션 |

### 1.2 테스트 계정

| 유형 | ID | 비고 |
|------|-----|------|
| 일반 회원 | test_basic@plic.co.kr | BASIC 등급 |
| 플래티넘 회원 | test_platinum@plic.co.kr | PLATINUM 등급 |
| 관리자 | admin@plic.co.kr | 전체 권한 |

### 1.3 테스트 데이터

| 항목 | 테스트 값 | 비고 |
|------|----------|------|
| 테스트 카드 | PG 제공 테스트 카드 | Softpayment 참조 |
| 테스트 계좌 | 테스트 은행 계좌 | 송금사 참조 |
| 테스트 금액 | 10,000 ~ 100,000원 | - |

---

## 2. 회원 시나리오

### 2.1 회원 가입

#### TC-USER-001: 정상 회원 가입
```
[전제조건]
- 미가입 상태

[테스트 단계]
1. 앱 실행 → 회원가입 선택
2. 약관 동의 (전체 동의)
3. 본인인증 (PASS) 진행
4. 본인인증 완료
5. 비밀번호 설정 (6자리)
6. 가입 완료

[예상 결과]
- 회원 상태: ACTIVE
- 회원 등급: BASIC
- 월 한도: 500만원
- 홈 화면으로 이동

[검증 항목]
□ users 테이블에 레코드 생성 확인
□ CI 해시 저장 확인
□ 기본 등급/한도 적용 확인
□ 가입 완료 알림 수신 확인
```

#### TC-USER-002: 중복 CI 가입 시도
```
[전제조건]
- 동일 CI로 이미 가입된 회원 존재

[테스트 단계]
1. 앱 실행 → 회원가입 선택
2. 약관 동의
3. 본인인증 (동일인)

[예상 결과]
- 에러: "이미 가입된 회원입니다"
- 로그인 화면으로 안내

[검증 항목]
□ 에러 코드: USER_002
□ 중복 가입 차단 확인
```

#### TC-USER-003: 탈퇴 후 재가입 (90일 이내)
```
[전제조건]
- 탈퇴 후 90일 미경과 회원

[테스트 단계]
1. 동일 CI로 본인인증 진행

[예상 결과]
- 에러: "탈퇴 후 90일간 재가입 불가"
- 남은 기간 안내

[검증 항목]
□ 재가입 차단 확인
□ 정확한 남은 기간 표시
```

### 2.2 로그인/로그아웃

#### TC-USER-010: 정상 로그인
```
[테스트 단계]
1. 앱 실행
2. 로그인 선택
3. 본인인증 진행
4. 비밀번호 입력

[예상 결과]
- 로그인 성공
- 홈 화면 표시
- Access Token 발급

[검증 항목]
□ 토큰 발급 확인
□ 최종 로그인 시간 업데이트
```

#### TC-USER-011: 비밀번호 5회 오류
```
[테스트 단계]
1. 로그인 시도
2. 비밀번호 5회 틀림

[예상 결과]
- 계정 잠금 (30분)
- "비밀번호 5회 오류로 계정이 잠겼습니다"

[검증 항목]
□ 계정 잠금 상태 확인
□ 30분 후 자동 해제 확인
```

### 2.3 회원 탈퇴

#### TC-USER-020: 정상 탈퇴
```
[전제조건]
- 진행 중인 거래 없음
- 잔여 포인트 없음

[테스트 단계]
1. 내 정보 → 회원 탈퇴
2. 탈퇴 사유 선택
3. 비밀번호 입력
4. 탈퇴 확인

[예상 결과]
- 회원 상태: WITHDRAWN
- deleted_at 설정
- 로그아웃 처리

[검증 항목]
□ 상태 변경 확인
□ 개인정보 마스킹 확인 (30일 후)
□ 탈퇴 완료 알림
```

#### TC-USER-021: 진행 중 거래 있는 상태에서 탈퇴 시도
```
[전제조건]
- PROCESSING 상태 거래 존재

[테스트 단계]
1. 탈퇴 시도

[예상 결과]
- 에러: "진행 중인 거래가 있어 탈퇴할 수 없습니다"
- 거래 완료 후 재시도 안내

[검증 항목]
□ 탈퇴 차단 확인
□ 진행 중 거래 목록 표시
```

---

## 3. 카드 시나리오

### 3.1 카드 등록

#### TC-CARD-001: 정상 카드 등록
```
[전제조건]
- 등록된 카드 4장 이하

[테스트 단계]
1. 카드 관리 → 카드 추가
2. 카드 정보 입력
   - 카드번호: 테스트 카드
   - 유효기간: MM/YY
   - 생년월일: YYMMDD
   - 비밀번호 앞2자리
3. 등록 요청

[예상 결과]
- 카드 등록 성공
- billingKey 발급
- 카드 목록에 표시

[검증 항목]
□ billingKey 암호화 저장 확인
□ 카드 마스킹 표시 (앞6뒤4)
□ PG 카드 등록 API 호출 확인
```

#### TC-CARD-002: 5번째 카드 등록 시도
```
[전제조건]
- 이미 5장 등록됨

[테스트 단계]
1. 카드 추가 시도

[예상 결과]
- 에러: "카드는 최대 5장까지 등록 가능합니다"
- 기존 카드 삭제 안내

[검증 항목]
□ 에러 코드: CARD_002
□ 등록 차단 확인
```

### 3.2 카드 삭제

#### TC-CARD-010: 대표 카드 삭제
```
[전제조건]
- 카드 2장 이상 등록
- 대표 카드 삭제 시도

[테스트 단계]
1. 대표 카드 삭제

[예상 결과]
- 삭제 성공
- 다음 카드가 대표 카드로 자동 지정

[검증 항목]
□ 대표 카드 자동 변경 확인
□ billingKey 삭제 확인
```

#### TC-CARD-011: 마지막 카드 삭제
```
[전제조건]
- 카드 1장만 등록

[테스트 단계]
1. 카드 삭제 시도

[예상 결과]
- 삭제 성공
- 대표 카드 없음 상태

[검증 항목]
□ 거래 생성 시 카드 등록 유도 확인
```

---

## 4. 거래 시나리오

### 4.1 거래 생성

#### TC-DEAL-001: 정상 거래 생성 (한도 내)
```
[전제조건]
- ACTIVE 회원
- 등록된 카드 있음
- 등록된 수취인 있음
- 월 한도 잔여 있음

[테스트 단계]
1. 홈 → 새 거래
2. 금액 입력: 100,000원
3. 수취인 선택
4. 카드 선택
5. 거래 생성

[예상 결과]
- 거래 상태: CREATED
- 확인 화면 표시
- 수수료 계산 표시 (3,000원)
- 총 결제 금액: 103,000원

[검증 항목]
□ deals 테이블 레코드 생성
□ 수수료 계산 정확성
□ 한도 차감 예정 표시
```

#### TC-DEAL-002: 월 한도 초과 거래 시도
```
[전제조건]
- 월 한도 잔여: 100,000원
- 시도 금액: 200,000원

[테스트 단계]
1. 200,000원 거래 생성 시도

[예상 결과]
- 에러: "이번 달 한도를 초과했습니다"
- 현재 한도 잔여 표시

[검증 항목]
□ 에러 코드: DEAL_002
□ 거래 생성 차단
```

#### TC-DEAL-003: 건당 한도 초과 (BASIC)
```
[전제조건]
- BASIC 등급 (건당 100만원)
- 시도 금액: 1,500,000원

[테스트 단계]
1. 1,500,000원 거래 생성 시도

[예상 결과]
- 에러: "1회 최대 금액을 초과했습니다"
- 등급별 한도 안내

[검증 항목]
□ 에러 코드: DEAL_003
□ 등급 업그레이드 안내 표시
```

#### TC-DEAL-004: 최소 금액 미만
```
[테스트 단계]
1. 5,000원 거래 생성 시도

[예상 결과]
- 에러: "최소 금액은 10,000원입니다"

[검증 항목]
□ 에러 코드: DEAL_004
```

### 4.2 결제 확정 (Confirm)

#### TC-DEAL-010: 정상 결제 확정
```
[전제조건]
- CREATED 상태 거래

[테스트 단계]
1. 거래 확인 화면
2. 결제하기 버튼 클릭
3. 비밀번호 입력
4. 결제 진행

[예상 결과]
- Deal 상태: CREATED → PROCESSING → PAID
- Payment 상태: PAID
- Transfer 상태: PROCESSING

[검증 항목]
□ PG 결제 API 호출 확인
□ 결제 승인 번호 저장
□ 송금 Job 생성 확인
□ 결제 완료 알림
```

#### TC-DEAL-011: 결제 실패 (카드 한도 초과)
```
[전제조건]
- CREATED 상태 거래
- 카드 한도 부족 상황

[테스트 단계]
1. 결제 확정 시도

[예상 결과]
- Deal 상태: CREATED 유지
- Payment 상태: FAILED
- 에러: "카드 한도를 확인해주세요"

[검증 항목]
□ 에러 코드: PAYMENT_002
□ 거래 재시도 가능 확인
□ 다른 카드 선택 안내
```

### 4.3 송금 처리

#### TC-DEAL-020: 정상 송금 완료
```
[전제조건]
- Payment PAID 상태
- Transfer PROCESSING 상태

[테스트 단계]
1. 송금 처리 대기 (자동)

[예상 결과]
- Transfer 상태: COMPLETED
- Deal 상태: COMPLETED
- 송금 완료 알림

[검증 항목]
□ 송금 API 호출 확인
□ 송금 결과 저장
□ 완료 알림 발송
```

#### TC-DEAL-021: 송금 실패 - 계좌 오류
```
[전제조건]
- 잘못된 계좌 정보

[테스트 단계]
1. 송금 시도 (자동)

[예상 결과]
- Transfer 상태: FAILED
- Deal 상태: TRANSFER_FAILED
- 자동 재시도 스케줄링

[검증 항목]
□ 에러 코드 저장
□ 재시도 Job 생성
□ 고객 알림 발송
```

---

## 5. 환불 시나리오

### 5.1 송금 전 환불

#### TC-REFUND-001: 송금 전 전액 환불
```
[전제조건]
- PAID 상태 (송금 전)

[테스트 단계]
1. 거래 상세 → 취소 요청
2. 취소 사유 입력
3. 취소 확인

[예상 결과]
- Deal 상태: CANCELLED
- Payment: 전액 환불 처리
- Transfer: 취소

[검증 항목]
□ PG 취소 API 호출
□ 한도 복구 확인
□ 운영 자금 영향 없음 (0원)
```

### 5.2 송금 후 환불

#### TC-REFUND-010: 송금 완료 후 환불 요청 (24시간 이내)
```
[전제조건]
- COMPLETED 상태
- 완료 후 24시간 이내

[테스트 단계]
1. 환불 요청

[예상 결과]
- 에러: "이미 송금이 완료된 거래입니다"
- CS 문의 안내

[검증 항목]
□ 자동 환불 불가 확인
□ CS 안내 표시
```

---

## 6. 할인코드 시나리오

### 6.1 할인코드 적용

#### TC-DISCOUNT-001: 유효한 할인코드 적용
```
[전제조건]
- 유효한 할인코드 존재
- 적용 조건 충족 (최소 금액 등)

[테스트 단계]
1. 거래 생성 화면
2. 할인코드 입력
3. 적용 버튼

[예상 결과]
- 할인 적용됨
- 수수료에서 할인 차감
- 최종 결제 금액 업데이트

[검증 항목]
□ 할인 금액 정확성
□ 할인코드 사용 기록
□ 수수료 0원 이하 방지
```

#### TC-DISCOUNT-002: 만료된 할인코드
```
[테스트 단계]
1. 만료된 할인코드 입력

[예상 결과]
- 에러: "만료된 할인코드입니다"

[검증 항목]
□ 적용 차단 확인
```

#### TC-DISCOUNT-003: 이미 사용한 할인코드
```
[전제조건]
- 1회용 할인코드
- 이미 사용됨

[테스트 단계]
1. 동일 할인코드 재사용 시도

[예상 결과]
- 에러: "이미 사용된 할인코드입니다"

[검증 항목]
□ 중복 사용 차단
```

---

## 7. 특수 상황 시나리오

### 7.1 은행 점검시간 거래

#### TC-SPECIAL-001: 점검시간 내 거래
```
[전제조건]
- 수취 은행 점검시간 (예: 23:30~00:30)

[테스트 단계]
1. 점검시간 내 거래 생성 및 결제

[예상 결과]
- 결제 정상 진행
- 송금 대기 (PENDING_SCHEDULED)
- 점검 종료 후 자동 송금
- "은행 점검으로 송금이 지연됩니다" 안내

[검증 항목]
□ 송금 스케줄링 확인
□ 고객 안내 메시지
□ 점검 후 자동 처리
```

### 7.2 서킷브레이커 시나리오

#### TC-SPECIAL-010: 서킷브레이커 OPEN 상태에서 결제
```
[전제조건]
- 서킷브레이커 OPEN

[테스트 단계]
1. 거래 생성 시도

[예상 결과]
- 에러: "일시적으로 서비스 이용이 불가합니다"
- 에러 코드: TRANSFER_004

[검증 항목]
□ 신규 거래 차단 확인
□ 적절한 안내 메시지
```

### 7.3 멱등성 테스트

#### TC-SPECIAL-020: 결제 요청 중복 호출
```
[전제조건]
- CREATED 상태 거래

[테스트 단계]
1. 결제 확정 API 동시 2회 호출 (동일 멱등키)

[예상 결과]
- 첫 번째 요청: 정상 처리
- 두 번째 요청: 기존 응답 반환 (200 OK)
- 중복 결제 없음

[검증 항목]
□ 중복 결제 방지
□ 동일 응답 반환
□ idempotency_keys 레코드 확인
```

#### TC-SPECIAL-021: 동일 멱등키 + 다른 Payload
```
[테스트 단계]
1. 결제 요청 (멱등키: KEY-001, 금액: 100,000원)
2. 결제 요청 (멱등키: KEY-001, 금액: 200,000원)

[예상 결과]
- 첫 번째 요청: 정상 처리
- 두 번째 요청: 409 Conflict
- 에러: IDEMPOTENCY_KEY_CONFLICT

[검증 항목]
□ 충돌 감지 확인
□ 409 응답 확인
```

---

## 8. 어드민 시나리오

### 8.1 회원 관리

#### TC-ADMIN-001: 회원 상태 변경 (정지)
```
[테스트 단계]
1. Admin > 회원 관리 > 회원 검색
2. 대상 회원 선택
3. 상태 변경: ACTIVE → SUSPENDED
4. 사유 입력

[예상 결과]
- 회원 상태 변경
- 감사 로그 생성
- 해당 회원 로그인/거래 불가

[검증 항목]
□ 상태 변경 확인
□ audit_logs 기록 확인
□ 사유 저장 확인
```

### 8.2 수동 송금 처리

#### TC-ADMIN-010: ABANDONED 거래 수동 재시도
```
[전제조건]
- ABANDONED 상태 거래

[테스트 단계]
1. Admin > 거래 관리 > ABANDONED 조회
2. 대상 거래 선택
3. 수동 송금 재시도
4. 사유 입력

[예상 결과]
- 송금 재시도 실행
- 감사 로그 생성

[검증 항목]
□ 송금 Job 생성
□ 상태 변경 확인
□ 감사 로그 기록
```

### 8.3 대사 불일치 처리

#### TC-ADMIN-020: 상태 불일치 수동 보정
```
[전제조건]
- STATUS_MISMATCH 불일치 건

[테스트 단계]
1. Admin > 대사 관리 > 불일치 조회
2. 불일치 건 선택
3. 상태 동기화 실행
4. 사유 입력

[예상 결과]
- PLIC 상태 업데이트
- 불일치 해결 처리
- 감사 로그 생성

[검증 항목]
□ 상태 보정 확인
□ resolution_status = RESOLVED
□ 감사 로그 기록
```

---

## 9. 성능 테스트 시나리오

### 9.1 부하 테스트

#### TC-PERF-001: 동시 결제 처리
```
[테스트 조건]
- 동시 사용자: 100명
- 초당 요청: 50 TPS
- 지속 시간: 10분

[예상 결과]
- 응답시간 (p95): < 500ms
- 에러율: < 1%
- 중복 결제: 0건

[검증 항목]
□ 응답시간 지표
□ 에러율
□ 데이터 정합성
```

### 9.2 스트레스 테스트

#### TC-PERF-010: 대량 송금 처리
```
[테스트 조건]
- 동시 송금 요청: 1,000건
- SQS 처리 확인

[예상 결과]
- 모든 송금 순차 처리
- 중복 송금: 0건
- 누락: 0건

[검증 항목]
□ 처리 완료율 100%
□ 중복 방지 확인
□ SQS 적체 없음
```

---

## 10. Edge Case 시나리오 ⚠️ (v1.1 추가)

> ⚠️ **금융 사고 방지를 위한 핵심 Edge Case 테스트**

### 10.1 동시성/레이스 컨디션

#### TC-EDGE-001: Optimistic Lock 동작 검증
```
[전제조건]
- PAID 상태 거래

[테스트 단계]
1. API 1: 송금 시작 요청 (version=1)
2. API 2: 취소 요청 (version=1) - 동시 호출

[예상 결과]
- 먼저 도착한 요청만 성공
- 두 번째 요청: 409 VERSION_CONFLICT
- DB version 증가 확인

[검증 항목]
□ 동시 상태 변경 방지
□ 적절한 에러 응답
□ 데이터 무결성 유지
```

#### TC-EDGE-002: 동시 송금 요청 방지
```
[전제조건]
- PAID 상태 거래

[테스트 단계]
1. 송금 시작 API 동시 3회 호출

[예상 결과]
- 1건만 transfer_jobs 생성
- 나머지: 409 DUPLICATE_TRANSFER_JOB
- Transfer 1건만 생성

[검증 항목]
□ transfer_jobs UNIQUE 제약 확인
□ 중복 송금 방지
```

### 10.2 멱등성 심층 검증

#### TC-EDGE-010: 타임아웃 후 재시도 (결제)
```
[테스트 단계]
1. 결제 확정 API 호출 (멱등키: KEY-001)
2. 응답 대기 중 클라이언트 타임아웃 (실제로 서버 처리 완료)
3. 동일 멱등키로 재시도

[예상 결과]
- 재시도 응답: 200 OK (기존 결과 반환)
- 중복 결제 없음
- Payment 1건

[검증 항목]
□ 멱등성 응답 반환
□ payments 테이블 1건
□ PG 결제도 1건
```

#### TC-EDGE-011: 웹훅 중복 수신
```
[테스트 단계]
1. 동일 웹훅 3회 연속 전송 (PG 재시도 시뮬레이션)

[예상 결과]
- 첫 번째: 정상 처리
- 두 번째/세 번째: 200 OK (처리 스킵)
- 상태 변경 1회만

[검증 항목]
□ pg_webhook_events 중복 체크
□ Deal 상태 변경 1회
```

### 10.3 대사 불일치 재현

#### TC-EDGE-020: PG 성공 + PLIC 미반영 (STATUS_MISMATCH)
```
[전제조건]
- 웹훅 수신 실패 시뮬레이션

[테스트 단계]
1. 결제 요청 (PG 성공)
2. 웹훅 수신 차단 (네트워크 장애 시뮬레이션)
3. PLIC Deal 상태: PROCESSING 유지
4. 대사 배치 실행

[예상 결과]
- 불일치 감지: STATUS_MISMATCH
- Self-Healing 시도: PG 조회 → DONE 확인 → PAID 업데이트
- resolution_status: AUTO_HEALED

[검증 항목]
□ 불일치 감지 로직
□ Self-Healing 동작
□ 감사 로그 기록
```

#### TC-EDGE-021: PLIC 성공 + 송금사 실패 (AMOUNT_MISMATCH)
```
[테스트 단계]
1. 송금 요청 (100,000원)
2. 송금사 Mock: 50,000원만 성공 응답 (비정상)

[예상 결과]
- AMOUNT_MISMATCH 불일치 생성
- 자동 처리 불가 (Critical Alert)
- 수동 확인 필요

[검증 항목]
□ 금액 불일치 감지
□ 자동 보정 차단
□ Critical 알림 발송
```

#### TC-EDGE-022: GHOST_TRANSACTION 감지
```
[테스트 단계]
1. 대사 데이터에 PLIC에 없는 PG 거래 삽입

[예상 결과]
- PG_ONLY 불일치 감지
- GHOST_TRANSACTION 의심
- Critical Alert 즉시 발송

[검증 항목]
□ GHOST 의심 로직
□ 보안 알림 발송
□ 대사 중단 (수동 확인)
```

### 10.4 인프라 장애 복구

#### TC-EDGE-030: 송금 중 ECS 컨테이너 강제 종료
```
[테스트 단계]
1. 송금 API 호출 직후
2. ECS Task 강제 종료 (Chaos Engineering)
3. 새 컨테이너 기동

[예상 결과]
- transfer_jobs 레코드 유지 (DB)
- SQS 메시지 재처리 (visibility timeout 후)
- 송금 재시도 성공

[검증 항목]
□ 작업 유실 없음
□ 재시도 정상 동작
□ 최종 일관성 유지
```

#### TC-EDGE-031: Redis 장애 시 결제 처리
```
[테스트 단계]
1. Redis 연결 차단
2. 결제 확정 요청

[예상 결과]
- 결제 처리 가능 (DB fallback)
- Rate Limit 일시 비활성화 경고
- 로그 기록

[검증 항목]
□ Redis 장애 시 서비스 지속
□ 분산 락 fallback 동작
```

### 10.5 Rate Limit / WAF

#### TC-EDGE-040: Rate Limit 초과
```
[테스트 단계]
1. 동일 사용자로 거래 생성 API 연속 50회 호출 (1분 내)

[예상 결과]
- 30회까지: 200 OK
- 31회 이후: 429 Too Many Requests
- Retry-After 헤더 포함

[검증 항목]
□ Rate Limit 정확성 (30회/분)
□ 429 응답
□ Retry-After 헤더
```

#### TC-EDGE-041: WAF Bad Bot 차단
```
[테스트 단계]
1. 악성 User-Agent로 API 호출

[예상 결과]
- 403 Forbidden
- WAF 차단 로그

[검증 항목]
□ Bad Bot 차단
□ 정상 요청 허용
```

---

## 부록

### A. 테스트 데이터 준비 SQL

```sql
-- 테스트 회원 생성
INSERT INTO users (id, name, phone, ci_hash, grade, status, ...)
VALUES ('test_user_001', '테스트유저', '01012345678', 'hash...', 'BASIC', 'ACTIVE', ...);

-- 테스트 카드 생성
INSERT INTO cards (id, user_id, card_type, last4, ...)
VALUES ('test_card_001', 'test_user_001', 'CREDIT', '1234', ...);

-- 테스트 수취인 생성
INSERT INTO recipients (id, user_id, bank_code, account_number_enc, ...)
VALUES ('test_recipient_001', 'test_user_001', '004', 'encrypted...', ...);
```

### B. 테스트 결과 템플릿

| TC ID | 시나리오명 | 결과 | 비고 |
|-------|----------|------|------|
| TC-USER-001 | 정상 회원 가입 | PASS/FAIL | - |
| ... | ... | ... | ... |

### C. 참고 문서

| 문서 | 역할 |
|------|------|
| PLIC_PRD.md | 정책 요약 |
| PLIC_STATE_MACHINES.md | 상태 전이 |
| PLIC_API_SPEC.md | API 명세 |
| PLIC_ENGINEERING_GUIDE.md | 에러 코드 |
