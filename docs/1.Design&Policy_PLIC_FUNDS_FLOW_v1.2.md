# PLIC 자금 흐름 (FUNDS FLOW)

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | PLIC Funds Flow |
| 버전 | 1.2 |
| 작성일 | 2025-01-05 |
| 수정일 | 2025-01-06 |
| 작성자 | PLIC 개발팀 |
| 상태 | **Approved** |
| 역할 | **자금 흐름 SSOT** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-05 | 초안 작성 | PLIC 개발팀 |
| 1.1 | 2025-01-05 | CTO 리뷰 반영 | PLIC 개발팀 |
| 1.2 | 2025-01-06 | **SSOT 동기화**: v1.0 범위 명시, 운영자금 중심 원장 확정, 미수금/예수금은 개념 설명으로 유지 | PLIC 개발팀 |

---

## 1. 개요

### 1.1 문서 목적

이 문서는 PLIC 서비스의 자금 흐름을 상세히 정의합니다. 개발자, 기획자, 재무 담당자가 "돈이 어떻게 흐르는지"를 동일하게 이해하기 위한 **단일 진실 공급원(SSOT)**입니다.

### 1.2 핵심 원칙

| 원칙 | 설명 |
|------|------|
| **선지급 구조** | PLIC이 PG 정산 전 수취인에게 먼저 송금 |
| **원금 전액 송금** | 수취인은 송금 원금 100%를 수령 (수수료 차감 없음) |
| **결제자 수수료 부담** | 서비스 수수료는 결제자가 전액 부담 |
| **운영자금 자체 조달** | 자금 공백은 PLIC 운영자금으로 커버 |

### 1.3 회계 원칙

> **중요**: 이 문서에서는 **현금(Cash)**과 **미수금(Receivable)**을 명확히 구분합니다.

| 구분 | 정의 | 예시 |
|------|------|------|
| **현금 (Cash)** | PLIC 법인계좌에 실제 입금된 금액 | 정산금 입금 |
| **미수금 (Receivable)** | PG사로부터 받을 예정인 금액 (아직 입금 안 됨) | 결제 완료 ~ 정산 전 |
| **예수금 (Payable)** | 수취인에게 송금해야 할 금액 (부채) | 결제 완료 ~ 송금 전 |

### 1.3.1 v1.0 원장 범위 ⚠️ (v1.2 SSOT 동기화)

> ⚠️ **v1.0 구현 범위**: 운영자금(현금) 추적에 집중

| 항목 | v1.0 | v1.1+ |
|------|------|-------|
| **운영자금 잔액 추적** | ✅ 구현 | - |
| **입출금 기록** (ledger_entries) | ✅ 구현 | - |
| **미수금 회계** | ⚠️ 개념 설명만 | 구현 예정 |
| **예수금 회계** | ⚠️ 개념 설명만 | 구현 예정 |
| **복식부기** | ❌ 미구현 | 구현 예정 |

**v1.0 entry_type (운영자금 중심)**:

| entry_type | 설명 | 잔액 영향 |
|------------|------|----------|
| `CAPITAL_IN` | 자본금 유입 | + |
| `SETTLEMENT_IN` | PG 정산금 수신 | + |
| `TRANSFER_OUT` | 고객 송금 출금 | - |
| `REFUND_OUT` | 환불 출금 | - |
| `RETURN_IN` | 송금 반환 입금 | + |
| `FEE_OUT` | PG/송금 수수료 | - |
| `CHARGEBACK_OUT` | 차지백 손실 | - |

> **참조**: PLIC_DB_SCHEMA.md v2.2, PLIC_RECONCILIATION_SETTLEMENT.md v1.2

```
[현금 vs 미수금]

결제 완료 ─────────────────────────▶ 정산 입금
    │                                    │
    │  PG 미수금 발생                     │  현금 입금
    │  (아직 현금 아님!)                  │  (이제 현금!)
    │                                    │
    ▼                                    ▼
┌─────────────┐                    ┌─────────────┐
│ PG_RECEIVABLE│      D+3~D+7      │   CASH_IN   │
│  +1,035,000  │  ───────────────▶ │ +1,009,125  │
└─────────────┘                    └─────────────┘
                                   (차액정산 기준)
```

### 1.4 이해관계자별 자금 흐름

```
[결제자]                    [PLIC]                    [수취인]
    │                          │                          │
    │  ┌─────────────────┐     │                          │
    │  │ 원금 + 수수료    │     │                          │
    │  │ (총 결제액)      │     │                          │
    │  └────────┬────────┘     │                          │
    │           │              │                          │
    │           ▼              │                          │
    │     [카드 결제]          │                          │
    │           │              │                          │
    │           ▼              │                          │
    │      ┌────────┐          │                          │
    │      │  PG사   │──정산──▶│                          │
    │      └────────┘   (D+N)  │                          │
    │                          │                          │
    │                          │  ┌─────────────────┐     │
    │                          │  │ 원금 100%       │     │
    │                          │  │ (수수료 없음)    │     │
    │                          │  └────────┬────────┘     │
    │                          │           │              │
    │                          │           ▼              │
    │                          │      [계좌 송금]         │
    │                          │       (즉시)             │
    │                          │           │              │
    │                          │           └─────────────▶│
```

---

## 2. 정상 거래 자금 흐름

### 2.1 거래별 자금 흐름 상세

```
[예시: 100만원 송금, BASIC 등급 (수수료율 3.5%)]

D+0 (결제 시점)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                     
결제자 카드 ──────────────────────────▶ PG사 (소프트페이먼트)
           │                           
           │  카드 승인: 1,035,000원    
           │  (원금 100만 + 수수료 3.5만)
           │                           
           └──────────────────────────────────────────────────

⚠️ 이 시점에서 PLIC에 현금이 들어온 것이 아님!
   PG 미수금(Receivable)이 발생한 것임.


D+0 (송금 시점) - 결제 직후 즉시
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

PLIC 법인계좌 ─────────────────────────▶ 수취인 계좌
              │
              │  송금: 1,000,000원
              │  (원금 전액, 선지급 = 현금 유출!)
              │
              └──────────────────────────────────────────────

⚠️ 이 시점에서 PLIC 법인계좌에서 실제 현금 100만원이 빠져나감.
   PG 정산은 아직 안 들어왔으므로 "자금 공백" 발생.


D+3 ~ D+5 (정산 시점) - 차액정산 기준
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

PG사 ──────────────────────────────────▶ PLIC 법인계좌
      │
      │  정산: 1,009,125원 (Net)
      │  = 총 결제액 1,035,000 - PG수수료 25,875 (2.5%)
      │
      └──────────────────────────────────────────────────────

✅ 이 시점에서 PLIC 법인계좌에 실제 현금이 입금됨.
   미수금 → 현금 전환 완료.
```

### 2.2 자금 흐름 타임라인

```
시간 ──────────────────────────────────────────────────────────▶

D+0                                    D+3 ~ D+5
 │                                        │
 │  ┌─────────────────────────┐           │  ┌─────────────────────────┐
 │  │ [결제자 → PG]           │           │  │ [PG → PLIC]             │
 │  │ 카드 승인 1,035,000원    │           │  │ 정산 1,009,125원 (Net)  │
 │  │ → PG 미수금 발생         │           │  │ → 현금 입금             │
 │  └─────────────────────────┘           │  └─────────────────────────┘
 │                                        │
 │  ┌─────────────────────────┐           │
 │  │ [PLIC → 수취인]          │           │
 │  │ 송금 1,000,000원 (선지급) │           │
 │  │ → 현금 유출!             │           │
 │  └─────────────────────────┘           │
 │                                        │
 │◀─────── 자금 공백 기간 ────────────────▶│
 │  현금 100만원 선지급 상태               │
 │  (PG 미수금은 현금이 아님!)             │
```

### 2.3 회계 처리 (Ledger Entries)

> **핵심**: 미수금(Receivable)과 현금(Cash)을 분리하여 기록합니다.

하나의 정상 거래에서 발생하는 원장 기록:

| 시점 | entry_type | amount | 계정 성격 | 설명 |
|------|------------|--------|-----------|------|
| 결제 완료 | `PG_RECEIVABLE` | +1,035,000 | 자산(미수금) | PG로부터 받을 금액 |
| 결제 완료 | `PRINCIPAL_PAYABLE` | +1,000,000 | 부채(예수금) | 수취인에게 줄 금액 |
| 결제 완료 | `FEE_REVENUE` | +35,000 | 수익 | 서비스 수수료 (VAT 포함) |
| 송금 완료 | `CASH_OUT` | -1,000,000 | 현금 유출 | 수취인 송금 |
| 송금 완료 | `PRINCIPAL_PAYABLE` | -1,000,000 | 부채 감소 | 예수금 상환 |
| 송금 완료 | `TRANSFER_FEE` | -500 | 비용 | 송금 수수료 |
| 정산 입금 | `CASH_IN` | +1,009,125 | 현금 유입 | PG 정산금 입금 |
| 정산 입금 | `PG_RECEIVABLE` | -1,035,000 | 미수금 감소 | 미수금 정리 |
| 정산 입금 | `PG_FEE_EXPENSE` | -25,875 | 비용 | PG 수수료 (차액정산) |

```
[Ledger 흐름 - 정상 거래]

D+0 결제 완료 시:
┌─────────────────────────────────────────────────────────┐
│ PG_RECEIVABLE (미수금):     +1,035,000 (아직 현금 아님!) │
│ PRINCIPAL_PAYABLE (예수금): +1,000,000 (수취인 줄 돈)    │
│ FEE_REVENUE (수익):           +35,000 (수수료)          │
└─────────────────────────────────────────────────────────┘

D+0 송금 완료 시:
┌─────────────────────────────────────────────────────────┐
│ CASH_OUT (현금 유출):      -1,000,000 (실제 현금 빠짐!) │
│ PRINCIPAL_PAYABLE:         -1,000,000 (예수금 상환)     │
│ TRANSFER_FEE (비용):           -500 (송금 수수료)       │
└─────────────────────────────────────────────────────────┘

D+3~D+5 정산 입금 시:
┌─────────────────────────────────────────────────────────┐
│ CASH_IN (현금 유입):       +1,009,125 (실제 현금 입금!) │
│ PG_RECEIVABLE:             -1,035,000 (미수금 정리)     │
│ PG_FEE_EXPENSE (비용):       -25,875 (PG 수수료)        │
└─────────────────────────────────────────────────────────┘

────────────────────────────────────────────────────────────
[최종 손익]
수익: FEE_REVENUE           +35,000
비용: TRANSFER_FEE             -500
비용: PG_FEE_EXPENSE        -25,875
────────────────────────────────────────────────────────────
순이익:                      +8,625
```

---

## 3. 정산 구조

### 3.1 PG 정산 주기

| 정산 유형 | 주기 | 설명 |
|-----------|------|------|
| **일반 정산** | D+3 ~ D+5 | 영업일 기준 |
| **주말/공휴일** | 다음 영업일 | 주말 거래는 월요일 정산 |
| **대량 거래** | D+5 ~ D+7 | 검토 필요 시 지연 가능 |

> **D+N**: 거래일(D) 기준 N영업일 후

### 3.2 정산 방식

> **PLIC은 차액정산(Net Settlement) 방식을 사용합니다.**

#### 3.2.1 차액정산 (Net Settlement) - 기본값

```
PG사 → PLIC

정산금 = 결제 총액 - PG 수수료
       = 1,035,000 - 25,875 (2.5%)
       = 1,009,125원

※ PG 수수료가 이미 차감된 금액이 입금됨
※ PLIC 법인계좌에서 별도로 PG 수수료가 출금되지 않음
```

#### 3.2.2 회계 처리 (차액정산)

| 시점 | 처리 |
|------|------|
| 결제 완료 | PG_RECEIVABLE +1,035,000 (총액 미수금) |
| 정산 입금 | CASH_IN +1,009,125 (실제 입금액) |
| 정산 입금 | PG_RECEIVABLE -1,035,000 (미수금 정리) |
| 정산 입금 | PG_FEE_EXPENSE +25,875 (PG 수수료 비용 인식) |

> **핵심**: PG 수수료는 "돈이 나가는 것"이 아니라 "들어올 돈이 깎이는 것"

### 3.3 정산 리포트 (Settlement Report)

PG사에서 제공하는 정산 데이터:

| 필드 | 설명 | 예시 |
|------|------|------|
| settlement_date | 정산일 | 2025-01-05 |
| transaction_date | 거래일 | 2025-01-02 |
| pg_payment_key | PG 거래번호 | pay_abc123 |
| merchant_id | 가맹점 번호 | PLIC001 |
| gross_amount | 총 결제 금액 | 1,035,000 |
| pg_fee | PG 수수료 | 25,875 |
| net_amount | 정산 금액 | 1,009,125 |

### 3.4 대사 매칭 키

| 대사 유형 | 매칭 키 | 비교 대상 |
|-----------|---------|-----------|
| 결제 대사 | `pg_payment_key` | PLIC payments ↔ PG 결제 원장 |
| 정산 대사 | `pg_payment_key` | PLIC 기대 정산액 ↔ PG Settlement Report |
| 송금 대사 | `transfer_ref_id` | PLIC transfers ↔ 송금사 이체 원장 |

---

## 4. 운영자금 관리

### 4.1 선지급 구조의 이해

```
[선지급 구조]

PLIC은 결제 완료 즉시 수취인에게 송금합니다.
하지만 PG 정산은 D+3~D+5에 발생합니다.

이 "자금 공백 기간"을 메우기 위해
PLIC 법인계좌에 충분한 운영자금(현금)이 필요합니다.

┌─────────────────────────────────────────────────────┐
│                                                     │
│   D+0      D+1      D+2      D+3      D+4      D+5 │
│    │        │        │        │        │        │  │
│    ▼        │        │        │        ▼        │  │
│  송금       │        │        │      정산       │  │
│  -100만     │        │        │      +100.9만   │  │
│  (현금↓)    │        │        │      (현금↑)    │  │
│             │        │        │                 │  │
│  ◀──────── 자금 공백 (4일) ────────▶             │
│                                                     │
│  이 기간 동안 PLIC 현금 100만원이 묶임              │
│  ※ PG 미수금 103.5만원은 현금이 아님!              │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 4.2 가용잔액 정의

> **서킷브레이커 및 리스크 관리의 기준이 되는 핵심 정의입니다.**

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   가용잔액 = 출금 가능 은행잔액                              │
│            - 예약된 송금액 (TRANSFERRING 상태)               │
│            - 보류액 (Holding)                                │
│                                                             │
│   ※ PG 미수금(정산 예정)은 가용잔액에 포함하지 않음          │
│   ※ 정산 입금이 확인된 후에만 가용잔액에 반영               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**예시**:
```
PLIC 법인계좌 잔액:       50,000,000원
- 예약된 송금 (10건):    -15,000,000원
- 보류액:                 -2,000,000원
────────────────────────────────────
가용잔액:                 33,000,000원

※ PG 미수금 80,000,000원은 제외 (아직 입금 안 됨)
```

### 4.3 운영자금 산정 공식

```
필요 운영자금 = 일평균 송금액 × 평균 정산 기간 × 안전 계수

예시:
- 일평균 송금액: 1억원
- 평균 정산 기간: 4일
- 안전 계수: 1.5 (여유분)

필요 운영자금 = 1억 × 4 × 1.5 = 6억원
```

### 4.4 운영자금 시나리오별 산정

| 시나리오 | 일 거래량 | 정산 주기 | 필요 운영자금 |
|----------|-----------|-----------|---------------|
| **초기** | 1,000만원/일 | D+4 | 6,000만원 |
| **성장기** | 5,000만원/일 | D+4 | 3억원 |
| **안정기** | 1억원/일 | D+4 | 6억원 |
| **성수기** | 2억원/일 | D+5 | 15억원 |

> **안전 계수 1.5 적용**: 거래량 급증, 정산 지연 등 예외 상황 대비

---

## 5. 서킷브레이커 (Circuit Breaker)

### 5.1 개요

운영자금(가용잔액) 고갈 시 자동으로 서비스를 보호하는 안전 장치입니다.

```
[서킷브레이커 상태 전이]

        정상 운영
            │
            │ 가용잔액 < 3일분
            ▼
        ┌───────┐
        │ 경고  │ ─────▶ 관리자 알림
        └───┬───┘
            │ 가용잔액 < 2일분
            ▼
        ┌───────┐
        │ 주의  │ ─────▶ 한도 50% 하향
        └───┬───┘
            │ 가용잔액 < 1일분
            ▼
        ┌───────┐
        │ 위험  │ ─────▶ 신규 거래 차단
        └───┬───┘
            │ 가용잔액 > 3일분
            ▼
        정상 운영 (복구)
```

### 5.2 트리거 조건

| 단계 | 조건 | 상태 | 조치 |
|------|------|------|------|
| **정상** | 가용잔액 ≥ 일평균 × 3일 | `NORMAL` | 정상 운영 |
| **경고** | 일평균 × 2일 ≤ 가용잔액 < 일평균 × 3일 | `WARNING` | 관리자 알림 |
| **주의** | 일평균 × 1일 ≤ 가용잔액 < 일평균 × 2일 | `CAUTION` | 한도 50% 하향 |
| **위험** | 가용잔액 < 일평균 × 1일 | `CRITICAL` | 신규 거래 차단 |

### 5.3 상세 동작

#### 5.3.1 경고 (WARNING)

```yaml
조건: 가용잔액 < 일평균송금액 × 3일
조치:
  - Slack 알림 발송 (#plic-alerts)
  - SMS 알림 (운영 담당자)
  - 이메일 알림 (재무팀)
사용자 영향: 없음
```

#### 5.3.2 주의 (CAUTION)

```yaml
조건: 가용잔액 < 일평균송금액 × 2일
조치:
  - 모든 사용자 1회/1일 한도 50% 하향
  - 관리자 긴급 알림
  - 대시보드 경고 표시
사용자 영향: 한도 축소
UX 메시지: "일시적으로 거래 한도가 조정되었습니다"
```

#### 5.3.3 위험 (CRITICAL)

```yaml
조건: 가용잔액 < 일평균송금액 × 1일
조치:
  - 신규 거래 생성 완전 차단
  - 기존 진행 중 거래는 정상 처리
  - 경영진 긴급 보고
  - 법인계좌 긴급 충전 필요
사용자 영향: 서비스 이용 불가
UX 메시지: "일시적으로 서비스 이용이 제한됩니다"
```

### 5.4 복구 조건

```yaml
복구 조건: 가용잔액 > 일평균송금액 × 3일

복구 절차:
  1. 시스템 자동 감지 (5분 주기 체크)
  2. 서킷브레이커 상태 → NORMAL
  3. 한도 원복
  4. 서비스 재개
  5. 관리자 알림 (복구 완료)
```

### 5.5 가용잔액 및 일평균 송금액 산정 SQL

```sql
-- 가용잔액 계산
SELECT 
    bank_balance                                    -- 은행 잔액
    - COALESCE(reserved_transfers, 0)               -- 예약된 송금
    - COALESCE(holding_amount, 0)                   -- 보류액
    AS available_balance
FROM (
    SELECT 
        (SELECT balance FROM bank_accounts WHERE account_type = 'OPERATING') as bank_balance,
        (SELECT SUM(amount) FROM transfers WHERE status = 'PENDING') as reserved_transfers,
        (SELECT SUM(amount) FROM holdings WHERE status = 'ACTIVE') as holding_amount
) calc;

-- 일평균 송금액 계산 (최근 7일)
SELECT AVG(daily_amount) as avg_daily_amount
FROM (
    SELECT DATE(created_at) as date, 
           SUM(amount) as daily_amount
    FROM deals
    WHERE status IN ('COMPLETED', 'TRANSFERRING')
      AND created_at >= NOW() - INTERVAL '7 days'
    GROUP BY DATE(created_at)
) daily;
```

---

## 6. 환불 자금 흐름

### 6.1 환불 가능 조건

| Deal 상태 | Job 상태 | 환불 가능 | 자금 흐름 |
|-----------|----------|-----------|-----------|
| `PAID` | - | ✅ | PG 취소 → 미수금 상계 |
| `TRANSFERRING` | `PENDING` | ❌ | 송금 대기 중 |
| `TRANSFERRING` | `PROCESSING` | ❌ | 송금 진행 중 |
| `TRANSFER_FAILED` | `FAILED` | ❌ | 재시도 대기 중 |
| `TRANSFER_FAILED` | `ABANDONED` | ✅ | PG 취소 → 미수금 상계 |
| `COMPLETED` | `COMPLETED` | ❌ | 송금 완료됨 |

### 6.2 환불 자금 흐름 (PAID 상태)

```
[PAID 상태에서 환불 - 송금 전]

상황: 결제 완료, 아직 송금 실행 전

PG사에 취소 요청 ─────────────────────▶ 카드사 환불 처리
                                               │
                                               ▼
                                        결제자 카드 환급
                                        (3~7 영업일)

※ PLIC 법인계좌에서 현금이 나가지 않음
※ PG 미수금이 취소(상계)되는 것
```

### 6.3 환불 회계 처리 (Ledger Entries)

> **핵심**: 환불은 현금 유출이 아니라 **미수금 상계** 처리

| 시점 | entry_type | amount | 설명 |
|------|------------|--------|------|
| 결제 완료 시 (기존) | `PG_RECEIVABLE` | +1,035,000 | 미수금 발생 |
| 결제 완료 시 (기존) | `FEE_REVENUE` | +35,000 | 수익 인식 |
| 환불 처리 | `PG_RECEIVABLE_REVERSAL` | -1,035,000 | 미수금 상계 (취소) |
| 환불 처리 | `FEE_REVENUE_REVERSAL` | -35,000 | 수익 환입 |

```
[환불 시 Ledger 흐름]

환불 처리 시:
┌─────────────────────────────────────────────────────────┐
│ PG_RECEIVABLE_REVERSAL:    -1,035,000 (미수금 상계)     │
│ FEE_REVENUE_REVERSAL:        -35,000 (수익 환입)        │
│                                                         │
│ ※ CASH_OUT이 아님! 현금이 나가는 게 아님!              │
│ ※ 아직 입금 안 된 미수금이 취소되는 것                  │
└─────────────────────────────────────────────────────────┘
```

### 6.4 정산 후 환불 처리

> 이미 정산이 완료된 거래에 대해 환불이 발생하면?

```
[정산 완료 후 환불 - 미래 정산에서 차감]

상황: D+0 결제, D+3 정산 완료, D+10 환불 요청

처리:
1. PG사에 환불 요청
2. PG사가 다음 정산에서 환불 금액 차감
3. 또는 별도 청구서 발행

회계 처리:
├── REFUND_PAYABLE:  +1,035,000 (환불 지급 의무)
├── FEE_REVENUE_REVERSAL: -35,000 (수익 환입)
│
│ 다음 정산 시:
├── CASH_IN: +정산금 (환불액 차감된 금액)
└── REFUND_PAYABLE: -1,035,000 (의무 이행)
```

---

## 7. 차지백 자금 흐름

### 7.1 차지백 시나리오

```
[차지백 발생 시나리오]

D+0: 결제 완료
     └── PG 미수금: +1,035,000원
     └── PLIC: 송금 실행 (현금 100만원 유출!)
     
D+0: 송금 완료
     └── 수취인 계좌: +1,000,000원
     
D+3: 정산 완료
     └── PLIC 현금: +1,009,125원
     
D+30: 차지백 발생 ⚠️
     └── 결제자가 카드사에 "결제한 적 없다" 이의 제기
     
D+35: 차지백 확정
     └── 카드사 → PG사: 대금 강제 회수
     └── PG사 → PLIC: 청구 (미래 정산 차감 또는 별도 청구)
     
결과:
├── 수취인: +1,000,000원 (이미 수령, 회수 어려움)
├── PLIC: 손실 발생
└── 결제자: 카드 대금 환급
```

### 7.2 차지백 청구 금액

```
차지백 청구 금액 = 원금 + 수수료 ± 조정액 + 차지백 수수료

일반적인 경우:
= 1,000,000 + 35,000 + 차지백 수수료 (약 5,000~25,000원)
= 약 1,040,000 ~ 1,060,000원

※ 차지백 수수료는 PG사/카드사 정책에 따라 상이
※ 조정액은 부분 차지백 등 특수 케이스
```

### 7.3 차지백 자금 흐름 다이어그램

```
[정상 흐름]
결제자 ──1,035,000──▶ PG사 ──정산──▶ PLIC ──1,000,000──▶ 수취인
                                        │
                                        │
[차지백 발생 시]                          │
                                        │
카드사 ◀──이의제기── 결제자               │
   │                                    │
   │  차지백 승인                         │
   ▼                                    │
PG사 ◀──대금회수── 카드사                 │
   │                                    │
   │  PLIC에 청구                        │
   ▼                                    │
PLIC ◀──(원금+수수료+CB fee) 청구         │
   │                                    │
   │  ⚠️ 손실 발생                       │
   │  (이미 송금 완료)                    │
   ▼                                    ▼
손실: 약 104~106만원           수취인: 회수 불가
```

### 7.4 차지백 회계 처리

| 시점 | entry_type | amount | 설명 |
|------|------------|--------|------|
| 차지백 확정 | `CHARGEBACK_LOSS` | -1,000,000 | 원금 손실 |
| 차지백 확정 | `CHARGEBACK_FEE_LOSS` | -35,000 | 수수료 손실 |
| 차지백 확정 | `CHARGEBACK_PENALTY` | -15,000 | 차지백 수수료 (예시) |
| 차지백 확정 | `FEE_REVENUE_REVERSAL` | -35,000 | 수익 환입 |

```
[차지백 시 Ledger 흐름]

차지백 확정 시:
┌─────────────────────────────────────────────────────────┐
│ CHARGEBACK_LOSS:         -1,000,000 (원금 손실)         │
│ CHARGEBACK_FEE_LOSS:       -35,000 (수수료 손실)        │
│ CHARGEBACK_PENALTY:        -15,000 (차지백 수수료)      │
│ FEE_REVENUE_REVERSAL:      -35,000 (수익 환입)          │
│                                                         │
│ ※ 이미 송금 완료된 상태이므로 전액 손실                   │
│ ※ 수취인으로부터 회수는 별도 채권 추심 절차               │
└─────────────────────────────────────────────────────────┘
```

### 7.5 차지백 리스크 완화

| 방안 | 설명 | 효과 |
|------|------|------|
| **1회 한도 제한** | BASIC 500만원, PLATINUM 1,000만원 | 단건 손실 규모 제한 |
| **FDS** | 이상 거래 탐지 및 추가 인증 | 사전 차단 |
| **블랙리스트** | 차지백 이력자 재가입 차단 | 재발 방지 |
| **본인인증** | CI 기반 본인확인 | 부인 방지 증빙 |
| **증빙 보관** | 결제/인증/송금 로그 보관 | 차지백 방어 |

---

## 8. 대사 (Reconciliation)

### 8.1 대사 개요

```
[대사 = 돈 맞추기]

대사는 내부 데이터와 외부 데이터를 비교하여
불일치를 찾아내고 수정하는 작업입니다.

┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ PLIC DB     │     │ PG사 원장   │     │ 송금사 원장 │
│ (deals,     │ ◀─▶ │ (결제 내역) │ ◀─▶ │ (이체 내역) │
│  payments,  │     │             │     │             │
│  transfers) │     │             │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                    ┌──────▼──────┐
                    │   대사 배치   │
                    │  (매일 09:00) │
                    └──────┬──────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
              ▼            ▼            ▼
         일치 ✅      불일치 ⚠️     누락 ❌
```

### 8.2 대사 대상 및 매칭 키

| 대사 유형 | 비교 대상 | 매칭 키 | 비교 항목 |
|-----------|-----------|---------|-----------|
| **결제 대사** | PLIC payments ↔ PG 결제 원장 | `pg_payment_key` | 건수, 금액, 상태 |
| **정산 대사** | PLIC 기대 정산액 ↔ PG Settlement | `pg_payment_key` | 정산 금액 |
| **송금 대사** | PLIC transfers ↔ 송금사 이체 원장 | `transfer_ref_id` | 건수, 금액, 상태 |

### 8.3 대사 프로세스

```
[대사 배치 프로세스 - 매일 09:00]

1. 데이터 수집
   ├── PLIC DB에서 전일 거래 추출
   ├── PG사 API로 전일 결제 내역 조회
   └── 송금사 API로 전일 이체 내역 조회

2. 비교 수행
   ├── 매칭 키 기준 매칭
   ├── 금액 일치 확인
   └── 상태 일치 확인

3. 결과 분류
   ├── 일치: 정상 처리
   ├── 불일치: Alert 발생
   └── 누락: Alert 발생

4. 후처리
   ├── 불일치 리포트 생성
   ├── 관리자 알림 발송
   └── 자동 복구 시도 (가능한 경우)
```

### 8.4 불일치 유형 및 대응

| 불일치 유형 | 설명 | 대응 |
|-------------|------|------|
| **결제 성공 / 송금 누락** | PG는 성공인데 송금이 안 됨 | 즉시 송금 재시도 |
| **송금 성공 / 상태 미업데이트** | 송금은 됐는데 DB 상태가 안 바뀜 | 상태 업데이트 |
| **금액 불일치** | 결제/송금 금액이 다름 | 수동 조사 필요 |
| **PG에만 존재** | PLIC에 없는 결제 건 | 데이터 복구 필요 |
| **PLIC에만 존재** | PG에 없는 결제 건 | 가짜 거래 조사 |
| **정산 금액 차이** | 기대 정산액 ≠ 실제 정산액 | PG 수수료율 검증 |

### 8.5 대사 SLA

| 항목 | SLA |
|------|-----|
| 대사 완료 시간 | 09:00 ~ 10:00 (1시간 이내) |
| 불일치 발견 시 원인 파악 | 4시간 이내 |
| 불일치 복구 완료 | 24시간 이내 |
| 자동 복구 불가 시 | 관리자 수동 처리 + 감사 로그 |

---

## 9. 수익 구조

### 9.1 거래별 수익 계산

```
[100만원 송금, BASIC 등급 기준]

매출
├── 서비스 수수료 (FEE_REVENUE):    +35,000원 (3.5%)
│
원가
├── PG 수수료 (PG_FEE_EXPENSE):    -25,875원 (2.5%, 총 결제액 기준)
├── 송금 수수료 (TRANSFER_FEE):       -500원 (건당 고정, 가정)
│
────────────────────────────────────────
순이익:                              +8,625원
순이익률:                            약 0.86% (원금 대비)
```

### 9.2 수수료 구조 비교

| 항목 | BASIC (3.5%) | PLATINUM (3.0%) |
|------|--------------|-----------------|
| 송금 원금 | 1,000,000 | 1,000,000 |
| 서비스 수수료 | 35,000 | 30,000 |
| PG 수수료 (2.5%) | -25,875 | -25,750 |
| 송금 수수료 | -500 | -500 |
| **순이익** | **8,625** | **3,750** |
| **순이익률** | **0.86%** | **0.38%** |

> **참고**: PG 수수료율은 계약에 따라 다를 수 있음

---

## 10. Ledger Entry Types 정의

### 10.1 Entry Type 전체 목록

| entry_type | 방향 | 계정 성격 | 설명 | 발생 시점 |
|------------|------|-----------|------|-----------|
| **수입/자산** |||||
| `PG_RECEIVABLE` | + | 미수금 | PG로부터 받을 금액 | 결제 완료 |
| `CASH_IN` | + | 현금 | 법인계좌 현금 유입 | 정산 입금 |
| **지출/부채** |||||
| `PRINCIPAL_PAYABLE` | +/- | 예수금 | 수취인에게 줄 금액 | 결제/송금 완료 |
| `CASH_OUT` | - | 현금 | 법인계좌 현금 유출 | 송금 완료 |
| **수익** |||||
| `FEE_REVENUE` | + | 수익 | 서비스 수수료 | 결제 완료 |
| `FEE_REVENUE_REVERSAL` | - | 수익 취소 | 환불/차지백 시 수익 환입 | 환불/차지백 |
| **비용** |||||
| `PG_FEE_EXPENSE` | - | 비용 | PG 수수료 | 정산 입금 |
| `TRANSFER_FEE` | - | 비용 | 송금 수수료 | 송금 완료 |
| **상계/조정** |||||
| `PG_RECEIVABLE_REVERSAL` | - | 미수금 감소 | 환불 시 미수금 상계 | 환불 처리 |
| **손실** |||||
| `CHARGEBACK_LOSS` | - | 손실 | 차지백 원금 손실 | 차지백 확정 |
| `CHARGEBACK_FEE_LOSS` | - | 손실 | 차지백 수수료 손실 | 차지백 확정 |
| `CHARGEBACK_PENALTY` | - | 손실 | 차지백 패널티 | 차지백 확정 |

### 10.2 거래 시나리오별 Ledger

#### 10.2.1 정상 완료

```
Deal #123 (100만원 송금, 수수료 3.5만원, 차액정산)

시점        entry_type           amount      설명
───────────────────────────────────────────────────────────
D+0 결제    PG_RECEIVABLE       +1,035,000   미수금 발생
D+0 결제    PRINCIPAL_PAYABLE   +1,000,000   예수금 발생
D+0 결제    FEE_REVENUE           +35,000   수익 인식
D+0 송금    CASH_OUT            -1,000,000   현금 유출 (선지급)
D+0 송금    PRINCIPAL_PAYABLE   -1,000,000   예수금 상환
D+0 송금    TRANSFER_FEE            -500   송금 수수료
D+4 정산    CASH_IN             +1,009,125   현금 입금
D+4 정산    PG_RECEIVABLE       -1,035,000   미수금 정리
D+4 정산    PG_FEE_EXPENSE        -25,875   PG 수수료 비용
───────────────────────────────────────────────────────────
                                순이익:       +8,625
```

#### 10.2.2 환불 처리 (PAID 상태, 정산 전)

```
Deal #124 (100만원 송금 요청 → PAID 상태에서 환불)

시점        entry_type                amount      설명
───────────────────────────────────────────────────────────
결제완료    PG_RECEIVABLE            +1,035,000   미수금 발생
결제완료    PRINCIPAL_PAYABLE        +1,000,000   예수금 발생
결제완료    FEE_REVENUE                +35,000   수익 인식
환불처리    PG_RECEIVABLE_REVERSAL   -1,035,000   미수금 상계
환불처리    PRINCIPAL_PAYABLE        -1,000,000   예수금 취소
환불처리    FEE_REVENUE_REVERSAL       -35,000   수익 환입
───────────────────────────────────────────────────────────
                                    순잔액변동:        0
                                    ※ 현금 이동 없음
```

#### 10.2.3 차지백 손실 (송금 완료 후)

```
Deal #125 (100만원 송금 완료 → 차지백 발생)

시점        entry_type           amount      설명
───────────────────────────────────────────────────────────
D+0 결제    PG_RECEIVABLE       +1,035,000   미수금 발생
D+0 결제    PRINCIPAL_PAYABLE   +1,000,000   예수금 발생
D+0 결제    FEE_REVENUE           +35,000   수익 인식
D+0 송금    CASH_OUT            -1,000,000   현금 유출
D+0 송금    PRINCIPAL_PAYABLE   -1,000,000   예수금 상환
D+0 송금    TRANSFER_FEE            -500   송금 수수료
D+4 정산    CASH_IN             +1,009,125   현금 입금
D+4 정산    PG_RECEIVABLE       -1,035,000   미수금 정리
D+4 정산    PG_FEE_EXPENSE        -25,875   PG 수수료
D+30 차지백 CHARGEBACK_LOSS     -1,000,000   원금 손실
D+30 차지백 CHARGEBACK_FEE_LOSS   -35,000   수수료 손실
D+30 차지백 CHARGEBACK_PENALTY    -15,000   차지백 패널티
D+30 차지백 FEE_REVENUE_REVERSAL  -35,000   수익 환입
───────────────────────────────────────────────────────────
                                순손실:   -1,041,375
```

---

## 11. 분할결제 자금 흐름 (v2.0 예정)

> ⚠️ **v1.0에서는 분할결제를 지원하지 않습니다.**
> 법적 검토 완료 후 v2.0에서 도입 예정입니다.

### 11.1 분할결제 자금 흐름 개요

```
[분할결제 시 자금 흐름 - 향후 설계]

정책: 전체 회차 완료 후 송금 (ALL_COMPLETE 모드)

회차1 결제 ─────▶ PG 미수금 발생 (1/3)
                    │
회차2 결제 ─────▶ PG 미수금 누적 (2/3)
                    │
회차3 결제 ─────▶ PG 미수금 누적 (3/3)
                    │
                    ▼
              전체 완료 ────▶ 송금 실행
                    │
                    ▼
              각 회차별 정산 (D+3~D+5)

※ 자금 공백이 단건보다 줄어드는 효과
※ 중간 회차 실패 시 환불/정산 상계 정책 별도 정의 필요
```

### 11.2 v2.0에서 추가될 내용

| 항목 | 설명 |
|------|------|
| 회차별 Ledger Entry | 각 Slice별 PG_RECEIVABLE 발생 |
| 중간 실패 시 환불 | 결제된 회차만 환불 or 전체 취소 정책 |
| 정산 상계 | 회차별 정산 vs 합산 정산 |
| 자금 공백 산정 | 마지막 회차 결제 ~ 송금 사이로 변경 |

---

## 부록

### A. 용어 정의

| 용어 | 정의 |
|------|------|
| 선지급 | PG 정산 전 PLIC이 먼저 수취인에게 송금하는 구조 |
| 자금 공백 | 선지급부터 정산 수령까지의 기간 |
| 가용잔액 | 실제 출금 가능한 현금 (미수금 제외) |
| 미수금 | PG로부터 받을 예정이나 아직 입금되지 않은 금액 |
| 예수금 | 수취인에게 송금해야 할 금액 (부채) |
| 차액정산 | 결제 금액에서 PG 수수료를 차감한 금액으로 정산 |
| 대사 | 내부 데이터와 외부 원장을 비교 검증하는 작업 |
| 서킷브레이커 | 가용잔액 고갈 시 자동 거래 차단 장치 |

### B. 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-05 | 초안 작성 | PLIC 개발팀 |
| 1.1 | 2025-01-05 | CTO 리뷰 반영 (상세 아래) | PLIC 개발팀 |

#### v1.1 변경 상세

| 구분 | 변경 내용 |
|------|-----------|
| **Ledger 이중계산 수정** | CARD_CAPTURE → PG_RECEIVABLE + PRINCIPAL_PAYABLE + FEE_REVENUE 분리 |
| **현금/미수금 분리** | 회계 원칙 섹션 추가, 현금 vs 미수금 명확화 |
| **가용잔액 정의** | 서킷브레이커 기준인 가용잔액 수학적 정의 추가 |
| **정산 방식 통일** | 차액정산(Net)을 기본값으로 확정 |
| **환불 원장 수정** | REFUND_OUT → PG_RECEIVABLE_REVERSAL (미수금 상계) |
| **차지백 청구 범위** | 원금 + 수수료 + 차지백 패널티 범용 공식 적용 |
| **대사 매칭 키** | pg_payment_key, transfer_ref_id 구체화 |
| **Entry Type 재설계** | 10개 → 13개로 확장, 계정 성격 명시 |
| **분할결제 섹션** | v2.0 예정 내용으로 플레이스홀더 추가 |

### C. 참고 문서

| 문서 | 관계 |
|------|------|
| PLIC_PRD.md | 자금 흐름 정책 요약 |
| PLIC_DB_SCHEMA.md | ledger_entries 테이블 정의 |
| PLIC_GLOSSARY.md | 용어 정의 |
| PLIC_STATE_MACHINES.md | 상태별 자금 흐름 연계 |
| PLIC_RECONCILIATION_SETTLEMENT.md | 정산/대사 상세 (예정) |
