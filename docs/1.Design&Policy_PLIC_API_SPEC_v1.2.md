# PLIC API 명세 (API SPECIFICATION)

## 📋 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | PLIC API Specification |
| 버전 | 1.2 |
| 작성일 | 2025-01-06 |
| 수정일 | 2025-01-06 |
| 작성자 | PLIC 개발팀 |
| 상태 | **Approved** |
| 역할 | **PLIC 내부 API SSOT** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-06 | 초안 작성 | PLIC 개발팀 |
| 1.1 | 2025-01-06 | CTO 리뷰 반영: Base URL 통일, Idempotency-Key, version/ETag, /payments·/transfers 엔드포인트, Refresh Token 보안, 폴링 규약, Rate Limit 기준 | PLIC 개발팀 |
| 1.2 | 2025-01-06 | **SSOT 동기화**: VIP→PLATINUM 용어 통일, deal_number 응답 포함 확인 | PLIC 개발팀 |

---

## 1. 개요

### 1.1 문서 목적

이 문서는 PLIC 서비스의 내부 API를 정의합니다. 프론트엔드 개발자, 백엔드 개발자, QA 담당자가 API 동작을 명확히 이해하기 위한 **단일 진실 공급원(SSOT)**입니다.

### 1.2 API 구조 ⚠️ (v1.1 통일)

> ⚠️ **Base URL과 경로 prefix 통일**: 로컬/운영 환경 모두 동일한 경로 사용

```
Base URL: https://api.plic.co.kr/v1

/v1
├── /auth            # 인증/인가
├── /users           # 사용자 관리
├── /cards           # 카드 관리
├── /recipients      # 수취인 관리
├── /deals           # 거래(송금) 관리
├── /payments        # 결제 상세 (v1.1 추가)
├── /transfers       # 송금 상세 (v1.1 추가)
├── /admin           # 관리자 전용
└── /webhooks        # 외부 웹훅 수신
```

**환경별 Base URL**

| 환경 | Base URL | 비고 |
|------|----------|------|
| 로컬 | `http://localhost:3000/v1` | Next.js 프록시 불필요 |
| 개발 | `https://api-dev.plic.co.kr/v1` | - |
| 스테이징 | `https://api-stg.plic.co.kr/v1` | - |
| 운영 | `https://api.plic.co.kr/v1` | - |

> ⚠️ **주의**: `/api` prefix는 사용하지 않음. 모든 환경에서 `/v1`로 통일

### 1.3 공통 규칙

| 항목 | 규칙 |
|------|------|
| Base URL | `https://api.plic.co.kr/v1` |
| 인증 | Bearer Token (JWT) |
| 데이터 형식 | JSON |
| 날짜 형식 | ISO 8601 (`2025-01-06T10:30:00+09:00`) |
| 페이지네이션 | Cursor 기반 |
| 버전 관리 | URL Path (`/v1/...`) |

### 1.4 공통 헤더 ⚠️ (v1.1 보강)

**Request Headers**
```
Authorization: Bearer {access_token}
Content-Type: application/json
Accept: application/json
X-Request-Id: {uuid}           # 요청 추적용 (모든 요청)
X-Device-Id: {device_id}       # 기기 식별
X-App-Version: 1.0.0           # 앱 버전
Idempotency-Key: {uuid}        # 멱등성 키 (v1.1 추가, 상태 변경 요청)
If-Match: {version}            # 낙관적 락 (v1.1 추가, 상태 변경 요청)
```

**Response Headers**
```
Content-Type: application/json
X-Request-Id: {uuid}           # 요청과 동일
ETag: {version}                # 리소스 버전 (v1.1 추가)
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 99
X-RateLimit-Reset: 1704520200
Retry-After: 30                # 429 응답 시 (v1.1 추가)
```

### 1.4.1 Idempotency-Key 정책 ⚠️ (v1.1 추가)

> ⚠️ **필수**: 금전 거래 관련 상태 변경 요청에는 반드시 Idempotency-Key 포함

**적용 대상 엔드포인트**

| 엔드포인트 | 필수 여부 | 비고 |
|-----------|----------|------|
| `POST /deals` | **필수** | 거래 생성 |
| `POST /deals/{id}/confirm` | **필수** | 결제/송금 트리거 |
| `POST /deals/{id}/cancel` | **필수** | 거래 취소 |
| `POST /cards` | 권장 | 카드 등록 |
| `POST /recipients` | 권장 | 수취인 등록 |
| `POST /admin/deals/{id}/refund` | **필수** | 수동 환불 |

**처리 규칙**

```javascript
// 서버 처리 로직
async function handleIdempotentRequest(key, payload) {
  const existing = await redis.get(`idempotency:${key}`);
  
  if (existing) {
    const cached = JSON.parse(existing);
    
    // 동일 키 + 동일 payload → 저장된 응답 반환
    if (cached.payloadHash === hash(payload)) {
      return { status: cached.status, body: cached.response };
    }
    
    // 동일 키 + 다른 payload → 409 Conflict
    throw new ConflictError('IDEMPOTENCY_KEY_CONFLICT');
  }
  
  // 새 요청 처리
  const response = await processRequest(payload);
  
  // Redis에 24시간 TTL로 저장
  await redis.setex(`idempotency:${key}`, 86400, JSON.stringify({
    payloadHash: hash(payload),
    status: response.status,
    response: response.body
  }));
  
  return response;
}
```

| 상황 | 응답 |
|------|------|
| 키 없음 | 정상 처리 |
| 동일 키 + 동일 payload | 저장된 응답 반환 (멱등성) |
| 동일 키 + 다른 payload | 409 Conflict |
| 키 만료 (24h 후) | 새 요청으로 처리 |

### 1.4.2 낙관적 락 (version/ETag) 정책 ⚠️ (v1.1 추가)

> ⚠️ **필수**: 상태 변경 요청 시 version 검증으로 동시성 충돌 방지

**적용 대상**

| 리소스 | version 필드 | 비고 |
|--------|-------------|------|
| Deal | `version` | 상태 변경 시 필수 |
| Payment | `version` | 상태 변경 시 필수 |
| Transfer | `version` | 상태 변경 시 필수 |
| Card | - | 선택적 |
| Recipient | - | 선택적 |

**사용 방법**

```
1. GET /deals/{id} → 응답에 version: 3, ETag: "3" 포함
2. POST /deals/{id}/confirm
   - Header: If-Match: "3"
   - 또는 Body: { "version": 3 }
3. 서버: 현재 version과 비교
   - 일치 → 처리 후 version++ 
   - 불일치 → 409 DEAL_VERSION_CONFLICT
```

**에러 응답**

```json
{
  "success": false,
  "error": {
    "code": "DEAL_VERSION_CONFLICT",
    "message": "다른 요청에 의해 상태가 변경되었습니다. 새로고침 후 다시 시도해주세요.",
    "currentVersion": 4
  }
}
```

### 1.5 공통 응답 형식

**성공 응답**
```json
{
  "success": true,
  "data": { ... },
  "meta": {
    "requestId": "req_abc123",
    "timestamp": "2025-01-06T10:30:00+09:00"
  }
}
```

**에러 응답**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "입력값이 올바르지 않습니다.",
    "details": [
      { "field": "amount", "message": "최소 1,000원 이상이어야 합니다." }
    ]
  },
  "meta": {
    "requestId": "req_abc123",
    "timestamp": "2025-01-06T10:30:00+09:00"
  }
}
```

### 1.6 HTTP 상태 코드

| 코드 | 의미 | 사용 상황 |
|------|------|----------|
| 200 | OK | 성공 |
| 201 | Created | 리소스 생성 성공 |
| 204 | No Content | 삭제 성공 |
| 400 | Bad Request | 요청 형식 오류 |
| 401 | Unauthorized | 인증 필요/실패 |
| 403 | Forbidden | 권한 없음 |
| 404 | Not Found | 리소스 없음 |
| 409 | Conflict | 상태 충돌 / 버전 충돌 / 멱등키 충돌 |
| 422 | Unprocessable Entity | 비즈니스 규칙 위반 |
| 429 | Too Many Requests | Rate Limit 초과 |
| 500 | Internal Server Error | 서버 오류 |

### 1.6.1 민감정보 처리 정책 ⚠️ (v1.1 추가)

> ⚠️ **원칙**: 민감정보는 응답/로그에 평문으로 노출되지 않음

**API 응답 마스킹**

| 필드 | 마스킹 방식 | 예시 |
|------|-----------|------|
| 계좌번호 | 앞3자리 + 마스킹 + 뒤4자리 | `110***6789` |
| 카드번호 | last4만 노출 | `****1234` |
| 휴대폰 | 뒤4자리만 | `***5678` |
| 예금주명 | 가운데 마스킹 | `김*동` |
| CI/DI | **절대 응답 불가** | - |
| billingKey | **절대 응답 불가** | - |

**로깅 금지 필드**

```javascript
// 로그 필터링 대상
const SENSITIVE_FIELDS = [
  'billingKey',
  'accountNumber',  // 마스킹 전 원문
  'cardNumber',
  'ci', 'di',
  'refreshToken',
  'password'
];

// 로그 출력 전 필터링
function sanitizeLog(data) {
  return omit(data, SENSITIVE_FIELDS);
}
```

**수취인 조회(verify) 특별 규칙**

> `/recipients/verify`는 평문 계좌번호를 받지만, 응답과 로그에는 마스킹 적용

```json
// Request (평문 허용 - 검증용)
{ "accountNumber": "1101234567890" }

// Response (마스킹 필수)
{ "accountNumber": "110***7890", "holderName": "김*동" }

// 로그 (마스킹 필수)
{ "accountNumber": "110***7890", ... }
```

### 1.7 에러 코드 체계

| 접두어 | 도메인 | 예시 |
|--------|--------|------|
| AUTH_ | 인증/인가 | AUTH_TOKEN_EXPIRED |
| USER_ | 사용자 | USER_NOT_FOUND |
| CARD_ | 카드 | CARD_LIMIT_EXCEEDED |
| RECIPIENT_ | 수취인 | RECIPIENT_ACCOUNT_INVALID |
| DEAL_ | 거래 | DEAL_ALREADY_CANCELLED |
| TRANSFER_ | 송금 | TRANSFER_BANK_ERROR |
| PAYMENT_ | 결제 | PAYMENT_DECLINED |
| SYSTEM_ | 시스템 | SYSTEM_MAINTENANCE |

---

## 2. 인증 API (/auth)

### 2.1 본인인증 요청

**POST** `/auth/verify/request`

휴대폰 본인확인(PASS) 인증 URL을 요청합니다.

**Request Body**
```json
{
  "purpose": "SIGNUP",
  "returnUrl": "plic://auth/callback",
  "cancelUrl": "plic://auth/cancel"
}
```

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| purpose | string | Y | 인증 목적 (SIGNUP, CARD_ADD) |
| returnUrl | string | Y | 인증 완료 후 리다이렉트 URL |
| cancelUrl | string | Y | 인증 취소 시 리다이렉트 URL |

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "requestId": "auth_req_abc123",
    "authUrl": "https://pass.provider/auth?token=xyz",
    "expiresAt": "2025-01-06T10:35:00+09:00"
  }
}
```

---

### 2.2 본인인증 결과 확인 및 회원가입

**POST** `/auth/verify/complete`

본인인증 완료 후 회원가입을 처리합니다.

**Request Body**
```json
{
  "requestId": "auth_req_abc123",
  "agreedTerms": ["SERVICE", "PRIVACY", "MARKETING"],
  "marketingAgreed": true
}
```

**Response (201 Created)**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user_001",
      "name": "홍길동",
      "phone": "01012345678",
      "status": "ACTIVE",
      "tier": "BASIC",
      "createdAt": "2025-01-06T10:30:00+09:00"
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIs...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
      "expiresIn": 3600
    }
  }
}
```

---

### 2.3 토큰 갱신 ⚠️ (v1.1 보안 강화)

**POST** `/auth/token/refresh`

Access Token을 갱신합니다.

**Option A: Body 전달 (모바일 앱)**

> ⚠️ 모바일 앱은 Secure Storage(iOS Keychain, Android Keystore)에 저장 필수

**Request Body**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
}
```

**Option B: HttpOnly Cookie (웹) - 권장**

> ⚠️ 웹 환경에서는 XSS 방지를 위해 HttpOnly Secure Cookie 사용 권장

```
Cookie: refresh_token=eyJhbGciOiJIUzI1NiIs...; HttpOnly; Secure; SameSite=Strict
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresIn": 3600
  }
}
```

> ⚠️ **Refresh Token Rotation**: 매 갱신 시 새로운 refreshToken 발급 (이전 토큰 무효화)

**보안 정책**

| 정책 | 설명 |
|------|------|
| **Rotation** | 매 갱신 시 새 refreshToken 발급, 이전 토큰 즉시 무효화 |
| **TTL** | accessToken: 1시간, refreshToken: 14일 |
| **Revoke** | 로그아웃 시 refreshToken 서버에서 무효화 |
| **단일 사용** | 동일 refreshToken 재사용 시 모든 토큰 무효화 (탈취 감지) |

**Error Responses**

| HTTP | 에러 코드 | 설명 |
|------|-----------|------|
| 401 | AUTH_REFRESH_TOKEN_EXPIRED | 리프레시 토큰 만료 |
| 401 | AUTH_REFRESH_TOKEN_INVALID | 유효하지 않은 리프레시 토큰 |
| 401 | AUTH_REFRESH_TOKEN_REUSED | 이미 사용된 토큰 (탈취 의심) |

---

### 2.4 로그아웃

**POST** `/auth/logout`

현재 세션을 종료합니다.

**Response (204 No Content)**

---

## 3. 사용자 API (/users)

### 3.1 내 정보 조회

**GET** `/users/me`

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "user_001",
    "name": "홍길동",
    "phone": "01012345678",
    "status": "ACTIVE",
    "tier": "BASIC",
    "limits": {
      "daily": {
        "max": 500000,
        "used": 100000,
        "remaining": 400000
      },
      "monthly": {
        "max": 3000000,
        "used": 500000,
        "remaining": 2500000
      }
    },
    "stats": {
      "totalTransfers": 15,
      "totalAmount": 1500000
    },
    "createdAt": "2025-01-01T10:00:00+09:00"
  }
}
```

---

### 3.2 내 정보 수정

**PATCH** `/users/me`

**Request Body**
```json
{
  "marketingAgreed": false
}
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "user_001",
    "marketingAgreed": false,
    "updatedAt": "2025-01-06T10:30:00+09:00"
  }
}
```

---

### 3.3 회원 탈퇴

**POST** `/users/me/withdraw`

**Request Body**
```json
{
  "reason": "SERVICE_UNSATISFIED",
  "feedback": "수수료가 너무 높아요"
}
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "withdrawnAt": "2025-01-06T10:30:00+09:00",
    "message": "탈퇴가 완료되었습니다. 30일 이내 재가입이 가능합니다."
  }
}
```

**Error Responses**

| HTTP | 에러 코드 | 설명 |
|------|-----------|------|
| 409 | USER_HAS_PENDING_DEALS | 진행 중인 거래가 있음 |

---

## 4. 카드 API (/cards)

### 4.1 카드 목록 조회

**GET** `/cards`

**Query Parameters**

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| status | string | N | ACTIVE, INACTIVE, ALL (기본: ACTIVE) |

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "cards": [
      {
        "id": "card_001",
        "cardCompany": "SHINHAN",
        "cardCompanyName": "신한카드",
        "last4": "1234",
        "cardType": "CREDIT",
        "isDefault": true,
        "status": "ACTIVE",
        "createdAt": "2025-01-01T10:00:00+09:00"
      }
    ],
    "count": 1
  }
}
```

---

### 4.2 카드 등록 ⚠️ (v1.1 보안 강화)

**POST** `/cards`

> ⚠️ 빌링키는 클라이언트 SDK에서 발급받아 전달

**Request Body**
```json
{
  "billingKey": "BK_abc123xyz789"
}
```

> ⚠️ **v1.1 변경**: `cardCompany`, `last4`, `cardType`은 클라이언트에서 받지 않음  
> 서버가 PG 조회 API로 카드 메타 정보를 직접 확인하여 저장 (조작 방지)

**Response (201 Created)**
```json
{
  "success": true,
  "data": {
    "id": "card_002",
    "cardCompany": "SHINHAN",
    "cardCompanyName": "신한카드",
    "last4": "1234",
    "cardType": "CREDIT",
    "isDefault": true,
    "status": "ACTIVE",
    "createdAt": "2025-01-06T10:30:00+09:00"
  }
}
```

> 💡 `cardCompany`, `last4`, `cardType`은 서버가 PG에서 조회한 값으로 확정

**Error Responses**

| HTTP | 에러 코드 | 설명 |
|------|-----------|------|
| 400 | CARD_INVALID_BILLING_KEY | 유효하지 않은 빌링키 |
| 409 | CARD_ALREADY_REGISTERED | 이미 등록된 카드 |
| 422 | CARD_LIMIT_EXCEEDED | 최대 카드 등록 개수 초과 (5개) |

---

### 4.3 카드 삭제

**DELETE** `/cards/{cardId}`

**Response (204 No Content)**

**Error Responses**

| HTTP | 에러 코드 | 설명 |
|------|-----------|------|
| 404 | CARD_NOT_FOUND | 카드 없음 |
| 409 | CARD_HAS_PENDING_DEALS | 진행 중인 거래에 사용 중 |
| 422 | CARD_IS_ONLY_ONE | 유일한 카드는 삭제 불가 |

---

### 4.4 기본 카드 설정

**POST** `/cards/{cardId}/default`

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "card_001",
    "isDefault": true,
    "updatedAt": "2025-01-06T10:30:00+09:00"
  }
}
```

---

## 5. 수취인 API (/recipients)

### 5.1 수취인 목록 조회

**GET** `/recipients`

**Query Parameters**

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| cursor | string | N | 페이지네이션 커서 |
| limit | integer | N | 조회 개수 (기본: 20, 최대: 50) |
| search | string | N | 별칭/이름 검색 |

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "recipients": [
      {
        "id": "recipient_001",
        "alias": "엄마",
        "bankCode": "004",
        "bankName": "KB국민은행",
        "accountNumber": "***456789",
        "holderName": "김*자",
        "isFavorite": true,
        "lastUsedAt": "2025-01-05T15:00:00+09:00",
        "usageCount": 10,
        "createdAt": "2024-12-01T10:00:00+09:00"
      }
    ],
    "pagination": {
      "hasNext": true,
      "nextCursor": "cursor_xyz789"
    }
  }
}
```

---

### 5.2 계좌 실명조회

**POST** `/recipients/verify`

계좌 등록 전 실명조회를 수행합니다.

**Request Body**
```json
{
  "bankCode": "004",
  "accountNumber": "123456789012"
}
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "verified": true,
    "bankCode": "004",
    "bankName": "KB국민은행",
    "accountNumber": "***456789",
    "holderName": "김영희",
    "verificationToken": "vt_abc123",
    "expiresAt": "2025-01-06T10:35:00+09:00"
  }
}
```

> ⚠️ verificationToken은 5분간 유효, 수취인 등록 시 필요

**Error Responses**

| HTTP | 에러 코드 | 설명 |
|------|-----------|------|
| 422 | RECIPIENT_ACCOUNT_NOT_FOUND | 계좌 없음 |
| 422 | RECIPIENT_ACCOUNT_CLOSED | 해지된 계좌 |
| 503 | RECIPIENT_BANK_MAINTENANCE | 은행 점검 중 |

---

### 5.3 수취인 등록

**POST** `/recipients`

**Request Body**
```json
{
  "verificationToken": "vt_abc123",
  "alias": "엄마",
  "isFavorite": true
}
```

**Response (201 Created)**
```json
{
  "success": true,
  "data": {
    "id": "recipient_002",
    "alias": "엄마",
    "bankCode": "004",
    "bankName": "KB국민은행",
    "accountNumber": "***456789",
    "holderName": "김*희",
    "isFavorite": true,
    "createdAt": "2025-01-06T10:30:00+09:00"
  }
}
```

**Error Responses**

| HTTP | 에러 코드 | 설명 |
|------|-----------|------|
| 400 | RECIPIENT_VERIFICATION_EXPIRED | 실명조회 토큰 만료 |
| 409 | RECIPIENT_ALREADY_REGISTERED | 이미 등록된 계좌 |
| 422 | RECIPIENT_LIMIT_EXCEEDED | 최대 수취인 등록 개수 초과 (50개) |

---

### 5.4 수취인 수정

**PATCH** `/recipients/{recipientId}`

**Request Body**
```json
{
  "alias": "어머니",
  "isFavorite": false
}
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "recipient_001",
    "alias": "어머니",
    "isFavorite": false,
    "updatedAt": "2025-01-06T10:30:00+09:00"
  }
}
```

---

### 5.5 수취인 삭제

**DELETE** `/recipients/{recipientId}`

**Response (204 No Content)**

---

## 6. 거래 API (/deals)

### 6.1 거래 생성 (송금 요청)

**POST** `/deals`

새로운 송금 거래를 생성합니다.

**Request Body**
```json
{
  "recipientId": "recipient_001",
  "amount": 100000,
  "cardId": "card_001",
  "memo": "용돈"
}
```

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| recipientId | string | Y | 수취인 ID |
| amount | integer | Y | 송금액 (원) |
| cardId | string | N | 카드 ID (미지정 시 기본 카드) |
| memo | string | N | 송금 메모 (최대 20자) |

**Response (201 Created)**
```json
{
  "success": true,
  "data": {
    "id": "deal_001",
    "status": "PENDING",
    "recipient": {
      "id": "recipient_001",
      "alias": "엄마",
      "bankName": "KB국민은행",
      "accountNumber": "***456789",
      "holderName": "김*자"
    },
    "amounts": {
      "transfer": 100000,
      "fee": 3000,
      "total": 103000
    },
    "card": {
      "id": "card_001",
      "cardCompanyName": "신한카드",
      "last4": "1234"
    },
    "memo": "용돈",
    "expiresAt": "2025-01-06T10:35:00+09:00",
    "createdAt": "2025-01-06T10:30:00+09:00"
  }
}
```

> ⚠️ 거래 생성 후 5분 이내에 확정(confirm) 필요, 미확정 시 자동 만료

**Error Responses**

| HTTP | 에러 코드 | 설명 |
|------|-----------|------|
| 400 | DEAL_AMOUNT_TOO_LOW | 최소 금액 미달 (1만원) |
| 400 | DEAL_AMOUNT_TOO_HIGH | 최대 금액 초과 (100만원/건) |
| 422 | USER_DAILY_LIMIT_EXCEEDED | 일일 한도 초과 |
| 422 | USER_MONTHLY_LIMIT_EXCEEDED | 월간 한도 초과 |
| 422 | CARD_NOT_AVAILABLE | 사용 불가 카드 |

---

### 6.2 거래 확정 ⚠️ (v1.1 보강)

**POST** `/deals/{dealId}/confirm`

사용자가 거래 내용을 확인하고 최종 승인합니다.

**Required Headers**
```
Idempotency-Key: {uuid}     # 필수
If-Match: {version}         # 필수 (또는 body에 version)
```

**Request Body (Optional)**
```json
{
  "version": 1
}
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "deal_001",
    "status": "PROCESSING",
    "version": 2,
    "confirmedAt": "2025-01-06T10:31:00+09:00",
    "message": "결제 및 송금이 진행 중입니다.",
    "polling": {
      "endpoint": "/deals/deal_001",
      "recommendedInterval": "2s",
      "maxWaitTime": "120s"
    }
  }
}
```

> 확정 후 상태 흐름: PENDING → PROCESSING → (PAID → TRANSFERRING → COMPLETED | FAILED)

**Error Responses**

| HTTP | 에러 코드 | 설명 |
|------|-----------|------|
| 404 | DEAL_NOT_FOUND | 거래 없음 |
| 409 | DEAL_ALREADY_CONFIRMED | 이미 확정됨 |
| 409 | DEAL_VERSION_CONFLICT | 버전 충돌 (다른 요청에 의해 변경됨) |
| 409 | IDEMPOTENCY_KEY_CONFLICT | 동일 키로 다른 요청 존재 |
| 410 | DEAL_EXPIRED | 거래 만료 (5분 초과) |

---

### 6.3 거래 취소 ⚠️ (v1.1 보강)

**POST** `/deals/{dealId}/cancel`

PENDING 또는 PROCESSING 상태의 거래를 취소합니다.

**Required Headers**
```
Idempotency-Key: {uuid}     # 필수
If-Match: {version}         # 필수
```

**Request Body**
```json
{
  "reason": "USER_REQUESTED",
  "version": 1
}
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "deal_001",
    "status": "CANCELLED",
    "version": 2,
    "cancelledAt": "2025-01-06T10:31:00+09:00",
    "refund": {
      "status": "PENDING",
      "amount": 103000,
      "expectedAt": "2025-01-06T10:33:00+09:00"
    }
  }
}
```

**Error Responses**

| HTTP | 에러 코드 | 설명 |
|------|-----------|------|
| 409 | DEAL_CANNOT_CANCEL | 취소 불가 상태 (COMPLETED, ABANDONED 등) |
| 409 | DEAL_VERSION_CONFLICT | 버전 충돌 |

---

### 6.4 거래 목록 조회

**GET** `/deals`

**Query Parameters**

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| cursor | string | N | 페이지네이션 커서 |
| limit | integer | N | 조회 개수 (기본: 20, 최대: 50) |
| status | string | N | 상태 필터 (PENDING, COMPLETED 등) |
| from | string | N | 시작일 (ISO 8601) |
| to | string | N | 종료일 (ISO 8601) |

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "deals": [
      {
        "id": "deal_001",
        "status": "COMPLETED",
        "recipient": {
          "alias": "엄마",
          "bankName": "KB국민은행",
          "holderName": "김*자"
        },
        "amounts": {
          "transfer": 100000,
          "fee": 3000,
          "total": 103000
        },
        "completedAt": "2025-01-06T10:32:00+09:00",
        "createdAt": "2025-01-06T10:30:00+09:00"
      }
    ],
    "pagination": {
      "hasNext": true,
      "nextCursor": "cursor_xyz789"
    }
  }
}
```

---

### 6.5 거래 상세 조회 ⚠️ (v1.1 폴링 규약 추가)

**GET** `/deals/{dealId}`

**Response Headers**
```
ETag: "3"  # 현재 version
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "deal_001",
    "status": "COMPLETED",
    "version": 3,
    "recipient": {
      "id": "recipient_001",
      "alias": "엄마",
      "bankCode": "004",
      "bankName": "KB국민은행",
      "accountNumber": "***456789",
      "holderName": "김*자"
    },
    "amounts": {
      "transfer": 100000,
      "fee": 3000,
      "total": 103000
    },
    "card": {
      "id": "card_001",
      "cardCompanyName": "신한카드",
      "last4": "1234"
    },
    "payment": {
      "id": "payment_001",
      "status": "PAID",
      "approvalNumber": "12345678",
      "paidAt": "2025-01-06T10:31:05+09:00"
    },
    "transfer": {
      "id": "transfer_001",
      "status": "COMPLETED",
      "completedAt": "2025-01-06T10:31:30+09:00"
    },
    "memo": "용돈",
    "timeline": [
      { "status": "PENDING", "at": "2025-01-06T10:30:00+09:00" },
      { "status": "PROCESSING", "at": "2025-01-06T10:31:00+09:00" },
      { "status": "PAID", "at": "2025-01-06T10:31:05+09:00" },
      { "status": "TRANSFERRING", "at": "2025-01-06T10:31:10+09:00" },
      { "status": "COMPLETED", "at": "2025-01-06T10:31:30+09:00" }
    ],
    "createdAt": "2025-01-06T10:30:00+09:00",
    "completedAt": "2025-01-06T10:31:30+09:00"
  }
}
```

### 6.5.1 클라이언트 폴링 규약 ⚠️ (v1.1 추가)

> ⚠️ **PROCESSING 상태**일 때 클라이언트는 아래 규칙에 따라 폴링

**폴링 스케줄 (Exponential Backoff)**

| 시도 | 대기 시간 | 누적 시간 |
|------|----------|----------|
| 1~3회 | 1초 | 3초 |
| 4~6회 | 2초 | 9초 |
| 7~10회 | 5초 | 29초 |
| 11~15회 | 10초 | 79초 |
| 16회~ | 30초 | - |

**타임아웃 처리**

| 조건 | 클라이언트 동작 |
|------|----------------|
| 2분 경과 후에도 PROCESSING | "확인 중입니다" 메시지 + 백그라운드 폴링 계속 |
| 5분 경과 후에도 PROCESSING | 폴링 중단 + "잠시 후 거래내역에서 확인해주세요" |
| 최종 상태 도달 | 즉시 UI 업데이트 |

```javascript
// 클라이언트 폴링 예시
async function pollDealStatus(dealId: string) {
  const backoff = [1000, 1000, 1000, 2000, 2000, 2000, 5000, 5000, 5000, 5000, 10000];
  const maxPolls = 20;
  
  for (let i = 0; i < maxPolls; i++) {
    const deal = await api.getDeal(dealId);
    
    if (['COMPLETED', 'FAILED', 'CANCELLED', 'ABANDONED'].includes(deal.status)) {
      return deal; // 최종 상태
    }
    
    const delay = backoff[Math.min(i, backoff.length - 1)];
    await sleep(delay);
  }
  
  // 최대 폴링 초과
  return { status: 'TIMEOUT', message: '잠시 후 거래내역에서 확인해주세요' };
}
```

---

### 6.6 거래 상태 (status) 값

| 상태 | 설명 | 사용자 노출 |
|------|------|------------|
| PENDING | 거래 생성됨, 확정 대기 | "결제 대기 중" |
| PROCESSING | 확정됨, 결제 진행 중 | "처리 중" |
| PAID | 결제 완료, 송금 대기 | "송금 준비 중" |
| TRANSFERRING | 송금 진행 중 | "송금 중" |
| COMPLETED | 송금 완료 | "송금 완료" |
| CANCELLED | 사용자 취소 | "취소됨" |
| FAILED | 결제 실패 | "결제 실패" |
| ABANDONED | 송금 실패 (복구 불가) | "송금 실패" |

---

## 7. 결제 API (/payments) ⚠️ (v1.1 추가)

> ⚠️ 운영/디버깅을 위한 결제 정보 조회 API

### 7.1 결제 상세 조회

**GET** `/payments/{paymentId}`

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "payment_001",
    "dealId": "deal_001",
    "status": "PAID",
    "version": 2,
    "amounts": {
      "total": 103000,
      "transfer": 100000,
      "fee": 3000
    },
    "pg": {
      "provider": "SOFTPAYMENT",
      "paymentKey": "PK_20250106_abc123",
      "orderId": "PLIC_D20250106_001",
      "approvalNumber": "12345678"
    },
    "card": {
      "id": "card_001",
      "cardCompany": "SHINHAN",
      "last4": "1234"
    },
    "timeline": [
      { "status": "PENDING", "at": "2025-01-06T10:30:00+09:00" },
      { "status": "PROCESSING", "at": "2025-01-06T10:31:00+09:00" },
      { "status": "PAID", "at": "2025-01-06T10:31:05+09:00" }
    ],
    "paidAt": "2025-01-06T10:31:05+09:00",
    "createdAt": "2025-01-06T10:30:00+09:00"
  }
}
```

### 7.2 PG 결제키로 결제 조회 (운영용)

**GET** `/payments?pgPaymentKey={paymentKey}`

> ⚠️ 웹훅/대사 시 PG 결제키로 역추적

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "payment": { /* 7.1과 동일 */ }
  }
}
```

---

## 8. 송금 API (/transfers) ⚠️ (v1.1 추가)

> ⚠️ 운영/디버깅을 위한 송금 정보 조회 API

### 8.1 송금 상세 조회

**GET** `/transfers/{transferId}`

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "transfer_001",
    "dealId": "deal_001",
    "paymentId": "payment_001",
    "status": "COMPLETED",
    "version": 3,
    "failureType": null,
    "amount": 100000,
    "recipient": {
      "bankCode": "004",
      "bankName": "KB국민은행",
      "accountNumber": "***456789",
      "holderName": "김*자"
    },
    "external": {
      "provider": "FIRMBANKING_PROVIDER",
      "externalId": "EXT_TR_abc123",
      "idempotencyKey": "PLIC_T20250106_001"
    },
    "attempts": [
      {
        "attemptNo": 1,
        "status": "COMPLETED",
        "startedAt": "2025-01-06T10:31:10+09:00",
        "completedAt": "2025-01-06T10:31:30+09:00"
      }
    ],
    "timeline": [
      { "status": "PENDING", "at": "2025-01-06T10:31:05+09:00" },
      { "status": "PROCESSING", "at": "2025-01-06T10:31:10+09:00" },
      { "status": "COMPLETED", "at": "2025-01-06T10:31:30+09:00" }
    ],
    "completedAt": "2025-01-06T10:31:30+09:00",
    "createdAt": "2025-01-06T10:31:05+09:00"
  }
}
```

### 8.2 멱등키로 송금 조회 (운영용)

**GET** `/transfers?idempotencyKey={key}`

> ⚠️ 송금사 응답 확인/대사 시 멱등키로 역추적

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "transfer": { /* 8.1과 동일 */ }
  }
}
```

### 8.3 송금 상태 값

| 상태 | 설명 | failure_type |
|------|------|--------------|
| PENDING | 송금 대기 | - |
| PROCESSING | 송금 진행 중 | - |
| COMPLETED | 송금 완료 | - |
| FAILED | 송금 실패 | FATAL / RETRYABLE |
| RETURNED | 사후 반환 | RETURN_* |

---

## 9. 관리자 API (/admin)

> ⚠️ 관리자 전용 API, 별도 인증 필요

### 9.1 거래 검색

**GET** `/admin/deals`

**Query Parameters**

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| userId | string | N | 사용자 ID |
| status | string | N | 상태 |
| from | string | N | 시작일 |
| to | string | N | 종료일 |
| minAmount | integer | N | 최소 금액 |
| maxAmount | integer | N | 최대 금액 |

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "deals": [...],
    "summary": {
      "totalCount": 150,
      "totalAmount": 15000000,
      "statusBreakdown": {
        "COMPLETED": 120,
        "PROCESSING": 5,
        "FAILED": 10,
        "ABANDONED": 15
      }
    },
    "pagination": { ... }
  }
}
```

---

### 9.2 수동 환불 처리

**POST** `/admin/deals/{dealId}/refund`

ABANDONED 상태의 거래를 수동으로 환불 처리합니다.

**Request Body**
```json
{
  "reason": "TRANSFER_FAILED_MANUAL_REVIEW",
  "note": "은행 점검으로 인한 송금 실패, 고객 문의로 수동 처리"
}
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "dealId": "deal_001",
    "refund": {
      "id": "refund_001",
      "status": "PROCESSING",
      "amount": 103000,
      "initiatedAt": "2025-01-06T11:00:00+09:00"
    }
  }
}
```

---

### 9.3 사용자 한도 조정

**PATCH** `/admin/users/{userId}/limits`

**Request Body**
```json
{
  "dailyLimit": 1000000,
  "monthlyLimit": 5000000,
  "reason": "PLATINUM 등급 승급"
}
```

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "userId": "user_001",
    "limits": {
      "daily": 1000000,
      "monthly": 5000000
    },
    "updatedAt": "2025-01-06T11:00:00+09:00"
  }
}
```

---

### 9.4 운영 자금 현황

**GET** `/admin/operational-fund`

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "currentBalance": 50000000,
    "thresholds": {
      "warning": 30000000,
      "critical": 10000000
    },
    "status": "NORMAL",
    "todayOutflow": 5000000,
    "todayInflow": 3000000,
    "pendingTransfers": {
      "count": 5,
      "totalAmount": 500000
    },
    "lastUpdatedAt": "2025-01-06T10:00:00+09:00"
  }
}
```

---

### 9.5 대사 현황

**GET** `/admin/reconciliation/status`

**Query Parameters**

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| date | string | N | 대사 날짜 (YYYY-MM-DD, 기본: 어제) |

**Response (200 OK)**
```json
{
  "success": true,
  "data": {
    "date": "2025-01-05",
    "status": "COMPLETED",
    "summary": {
      "totalDeals": 150,
      "matchedDeals": 148,
      "mismatchedDeals": 2
    },
    "mismatches": [
      {
        "dealId": "deal_100",
        "type": "AMOUNT_MISMATCH",
        "expected": 100000,
        "actual": 99000,
        "status": "PENDING_REVIEW"
      }
    ],
    "completedAt": "2025-01-06T06:00:00+09:00"
  }
}
```

---

## 10. 웹훅 수신 API (/webhooks)

### 10.1 PG 웹훅

**POST** `/webhooks/softpayment`

소프트페이먼트에서 결제 이벤트를 수신합니다.

> 상세 내용은 PLIC_EXTERNAL_INTERFACE.md 참조

---

## 11. Rate Limiting ⚠️ (v1.1 기준 명확화)

### 11.1 기본 정책

| 엔드포인트 | 제한 | 윈도우 | 기준 |
|-----------|------|--------|------|
| 인증 API (미인증) | 10회 | 1분 | **IP** |
| 인증 API (인증 후) | 10회 | 1분 | **userId** |
| 일반 API | 100회 | 1분 | **userId** |
| 거래 생성 | 30회 | 1분 | **userId** |
| 관리자 API | 300회 | 1분 | **adminId** |

### 11.1.1 Rate Limit 기준 상세 ⚠️ (v1.1 추가)

| 기준 | 적용 상황 | 구현 |
|------|----------|------|
| **IP** | 미인증 요청 (로그인, 본인인증) | WAF / API Gateway |
| **userId** | 인증된 요청 | Redis (ElastiCache) |
| **deviceId** | 보조 기준 (미래 확장) | - |

**구현 권장 (Redis)**
```javascript
// Sliding Window Counter 알고리즘
const key = `ratelimit:${userId}:${endpoint}`;
const limit = 100;
const window = 60; // 1분

const current = await redis.incr(key);
if (current === 1) {
  await redis.expire(key, window);
}

if (current > limit) {
  throw new TooManyRequestsError({
    retryAfter: await redis.ttl(key)
  });
}
```

### 11.2 제한 초과 시

**Response (429 Too Many Requests)**

**Response Headers**
```
Retry-After: 30
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1704520200
```

**Response Body**
```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "요청 한도를 초과했습니다. 잠시 후 다시 시도해주세요.",
    "retryAfter": 30
  }
}
```

---

## 부록

### A. 테스트 계정

| 환경 | 용도 | 계정 |
|------|------|------|
| 개발/스테이징 | 테스트 사용자 | phone: 01000000001 |
| 개발/스테이징 | 테스트 카드 | billingKey: TEST_BK_001 |
| 개발/스테이징 | 테스트 수취인 | bank: 004, account: 0000000001 |

### B. 참고 문서

| 문서 | 관계 |
|------|------|
| PLIC_EXTERNAL_INTERFACE.md | 외부 API 연동 상세 |
| PLIC_STATE_MACHINES.md | 상태 전이 규칙 |
| PLIC_FUNDS_FLOW.md | 자금 흐름 |
| PLIC_DB_SCHEMA.md | 데이터베이스 스키마 |
