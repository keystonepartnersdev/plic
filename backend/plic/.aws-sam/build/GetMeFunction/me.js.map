{
  "version": 3,
  "sources": ["../../../GetMeFunction/me.ts"],
  "sourcesContent": ["// backend/plic/GetMeFunction/me.ts\n// GET /users/me - \uD604\uC7AC \uB85C\uADF8\uC778 \uC0AC\uC6A9\uC790 \uC815\uBCF4 \uC870\uD68C\nimport { APIGatewayProxyHandler } from 'aws-lambda';\nimport { CognitoIdentityProviderClient, GetUserCommand } from '@aws-sdk/client-cognito-identity-provider';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, QueryCommand } from '@aws-sdk/lib-dynamodb';\n\nconst cognitoClient = new CognitoIdentityProviderClient({ region: 'ap-northeast-2' });\nconst dynamoClient = new DynamoDBClient({ region: 'ap-northeast-2' });\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\n\nconst USERS_TABLE = 'plic-users';\n\nconst corsHeaders = {\n  'Content-Type': 'application/json',\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Headers': 'Content-Type,Authorization',\n  'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',\n};\n\nfunction success(data: Record<string, unknown>, statusCode = 200) {\n  return {\n    statusCode,\n    headers: corsHeaders,\n    body: JSON.stringify({ success: true, data }),\n  };\n}\n\nfunction error(message: string, statusCode = 400) {\n  return {\n    statusCode,\n    headers: corsHeaders,\n    body: JSON.stringify({ success: false, error: message }),\n  };\n}\n\nfunction extractToken(authHeader: string | undefined): string | null {\n  if (!authHeader) return null;\n  return authHeader.startsWith('Bearer ') ? authHeader.substring(7) : authHeader;\n}\n\nasync function getCognitoUser(accessToken: string) {\n  const result = await cognitoClient.send(new GetUserCommand({ AccessToken: accessToken }));\n  const attrs: Record<string, string> = {};\n  result.UserAttributes?.forEach((attr) => {\n    if (attr.Name && attr.Value) {\n      attrs[attr.Name] = attr.Value;\n    }\n  });\n  return {\n    username: result.Username,\n    email: attrs.email,\n    name: attrs.name,\n    phone: attrs.phone_number,\n    emailVerified: attrs.email_verified === 'true',\n  };\n}\n\nexport const handler: APIGatewayProxyHandler = async (event) => {\n  if (event.httpMethod === 'OPTIONS') {\n    return success({});\n  }\n\n  try {\n    const token = extractToken(event.headers.Authorization || event.headers.authorization);\n    if (!token) {\n      return error('\uC778\uC99D \uD1A0\uD070\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.', 401);\n    }\n\n    const cognitoUser = await getCognitoUser(token);\n    if (!cognitoUser.email) {\n      return error('\uC720\uD6A8\uD558\uC9C0 \uC54A\uC740 \uD1A0\uD070\uC785\uB2C8\uB2E4.', 401);\n    }\n\n    // DynamoDB\uC5D0\uC11C \uC0AC\uC6A9\uC790 \uC870\uD68C\n    const queryResult = await docClient.send(new QueryCommand({\n      TableName: USERS_TABLE,\n      IndexName: 'email-index',\n      KeyConditionExpression: 'email = :email',\n      ExpressionAttributeValues: { ':email': cognitoUser.email },\n    }));\n\n    const users = queryResult.Items || [];\n    if (users.length === 0) {\n      return error('\uC0AC\uC6A9\uC790\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.', 404);\n    }\n\n    const user = users[0];\n\n    return success({\n      uid: user.uid,\n      name: user.name,\n      email: user.email,\n      phone: user.phone,\n      grade: user.grade,\n      status: user.status,\n      feeRate: user.feeRate,\n      monthlyLimit: user.monthlyLimit,\n      usedAmount: user.usedAmount,\n      remainingLimit: user.monthlyLimit - user.usedAmount,\n      isVerified: user.isVerified,\n      agreements: user.agreements,\n      totalPaymentAmount: user.totalPaymentAmount,\n      totalDealCount: user.totalDealCount,\n      createdAt: user.createdAt,\n      lastLoginAt: user.lastLoginAt,\n      // \uC0AC\uC5C5\uC790 \uC778\uC99D \uAD00\uB828 \uD544\uB4DC \uCD94\uAC00\n      userType: user.userType,\n      businessInfo: user.businessInfo,\n      authType: user.authType,\n      socialProvider: user.socialProvider,\n    });\n  } catch (err: any) {\n    console.error('GetMe error:', err);\n    if (err.name === 'NotAuthorizedException') {\n      return error('\uD1A0\uD070\uC774 \uB9CC\uB8CC\uB418\uC5C8\uC2B5\uB2C8\uB2E4. \uB2E4\uC2DC \uB85C\uADF8\uC778\uD574\uC8FC\uC138\uC694.', 401);\n    }\n    return error('\uC11C\uBC84 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.', 500);\n  }\n};\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAGA,IAAAI,EAA8D,qDAC9DC,EAA+B,oCAC/BC,EAAqD,iCAE/CC,EAAgB,IAAI,gCAA8B,CAAE,OAAQ,gBAAiB,CAAC,EAC9EC,EAAe,IAAI,iBAAe,CAAE,OAAQ,gBAAiB,CAAC,EAC9DC,EAAY,yBAAuB,KAAKD,CAAY,EAEpDE,EAAc,aAEdC,EAAc,CAClB,eAAgB,mBAChB,8BAA+B,IAC/B,+BAAgC,6BAChC,+BAAgC,6BAClC,EAEA,SAASC,EAAQC,EAA+BC,EAAa,IAAK,CAChE,MAAO,CACL,WAAAA,EACA,QAASH,EACT,KAAM,KAAK,UAAU,CAAE,QAAS,GAAM,KAAAE,CAAK,CAAC,CAC9C,CACF,CAEA,SAASE,EAAMC,EAAiBF,EAAa,IAAK,CAChD,MAAO,CACL,WAAAA,EACA,QAASH,EACT,KAAM,KAAK,UAAU,CAAE,QAAS,GAAO,MAAOK,CAAQ,CAAC,CACzD,CACF,CAEA,SAASC,EAAaC,EAA+C,CACnE,OAAKA,EACEA,EAAW,WAAW,SAAS,EAAIA,EAAW,UAAU,CAAC,EAAIA,EAD5C,IAE1B,CAEA,eAAeC,EAAeC,EAAqB,CACjD,IAAMC,EAAS,MAAMd,EAAc,KAAK,IAAI,iBAAe,CAAE,YAAaa,CAAY,CAAC,CAAC,EAClFE,EAAgC,CAAC,EACvC,OAAAD,EAAO,gBAAgB,QAASE,GAAS,CACnCA,EAAK,MAAQA,EAAK,QACpBD,EAAMC,EAAK,IAAI,EAAIA,EAAK,MAE5B,CAAC,EACM,CACL,SAAUF,EAAO,SACjB,MAAOC,EAAM,MACb,KAAMA,EAAM,KACZ,MAAOA,EAAM,aACb,cAAeA,EAAM,iBAAmB,MAC1C,CACF,CAEO,IAAMpB,EAAkC,MAAOsB,GAAU,CAC9D,GAAIA,EAAM,aAAe,UACvB,OAAOZ,EAAQ,CAAC,CAAC,EAGnB,GAAI,CACF,IAAMa,EAAQR,EAAaO,EAAM,QAAQ,eAAiBA,EAAM,QAAQ,aAAa,EACrF,GAAI,CAACC,EACH,OAAOV,EAAM,kEAAiB,GAAG,EAGnC,IAAMW,EAAc,MAAMP,EAAeM,CAAK,EAC9C,GAAI,CAACC,EAAY,MACf,OAAOX,EAAM,wEAAkB,GAAG,EAWpC,IAAMY,GAPc,MAAMlB,EAAU,KAAK,IAAI,eAAa,CACxD,UAAWC,EACX,UAAW,cACX,uBAAwB,iBACxB,0BAA2B,CAAE,SAAUgB,EAAY,KAAM,CAC3D,CAAC,CAAC,GAEwB,OAAS,CAAC,EACpC,GAAIC,EAAM,SAAW,EACnB,OAAOZ,EAAM,yEAAmB,GAAG,EAGrC,IAAMa,EAAOD,EAAM,CAAC,EAEpB,OAAOf,EAAQ,CACb,IAAKgB,EAAK,IACV,KAAMA,EAAK,KACX,MAAOA,EAAK,MACZ,MAAOA,EAAK,MACZ,MAAOA,EAAK,MACZ,OAAQA,EAAK,OACb,QAASA,EAAK,QACd,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,eAAgBA,EAAK,aAAeA,EAAK,WACzC,WAAYA,EAAK,WACjB,WAAYA,EAAK,WACjB,mBAAoBA,EAAK,mBACzB,eAAgBA,EAAK,eACrB,UAAWA,EAAK,UAChB,YAAaA,EAAK,YAElB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,SAAUA,EAAK,SACf,eAAgBA,EAAK,cACvB,CAAC,CACH,OAASC,EAAU,CAEjB,OADA,QAAQ,MAAM,eAAgBA,CAAG,EAC7BA,EAAI,OAAS,yBACRd,EAAM,0HAA4B,GAAG,EAEvCA,EAAM,wEAAkB,GAAG,CACpC,CACF",
  "names": ["me_exports", "__export", "handler", "__toCommonJS", "import_client_cognito_identity_provider", "import_client_dynamodb", "import_lib_dynamodb", "cognitoClient", "dynamoClient", "docClient", "USERS_TABLE", "corsHeaders", "success", "data", "statusCode", "error", "message", "extractToken", "authHeader", "getCognitoUser", "accessToken", "result", "attrs", "attr", "event", "token", "cognitoUser", "users", "user", "err"]
}
