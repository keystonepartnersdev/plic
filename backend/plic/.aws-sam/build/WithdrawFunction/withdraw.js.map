{
  "version": 3,
  "sources": ["../functions/users/withdraw.ts"],
  "sourcesContent": ["// backend/plic/functions/users/withdraw.ts\n// DELETE /users/me - \uD68C\uC6D0 \uD0C8\uD1F4 (\uBC95\uC801 \uBCF4\uAD00 + \uC6D0\uBCF8 \uC644\uC804 \uC0AD\uC81C)\nimport { APIGatewayProxyHandler } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport {\n  DynamoDBDocumentClient,\n  PutCommand,\n  DeleteCommand,\n  QueryCommand,\n} from '@aws-sdk/lib-dynamodb';\nimport {\n  CognitoIdentityProviderClient,\n  AdminDeleteUserCommand,\n  GetUserCommand,\n} from '@aws-sdk/client-cognito-identity-provider';\n\nconst dynamoClient = new DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-2' });\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\nconst cognitoClient = new CognitoIdentityProviderClient({ region: process.env.AWS_REGION || 'ap-northeast-2' });\n\nconst USERS_TABLE = 'plic-users';\nconst DEALS_TABLE = 'plic-deals';\nconst WITHDRAWN_USERS_TABLE = 'plic-withdrawn-users';\nconst WITHDRAWN_DEALS_TABLE = 'plic-withdrawn-deals';\nconst COGNITO_USER_POOL_ID = process.env.COGNITO_USER_POOL_ID;\n\n// \uC9C4\uD589 \uC911\uC778 \uAC70\uB798 \uC0C1\uD0DC \uBAA9\uB85D\nconst ACTIVE_DEAL_STATUSES = ['awaiting_payment', 'pending', 'reviewing', 'hold'];\n\n// \uBC95\uC801 \uBCF4\uAD00 \uAE30\uAC04: 5\uB144 (\uC804\uC790\uC0C1\uAC70\uB798\uBC95, \uC804\uC790\uAE08\uC735\uAC70\uB798\uBC95)\nconst RETENTION_YEARS = 5;\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Headers': 'Content-Type,Authorization',\n  'Access-Control-Allow-Methods': 'DELETE,OPTIONS',\n};\n\nconst response = (statusCode: number, body: Record<string, unknown>) => ({\n  statusCode,\n  headers: corsHeaders,\n  body: JSON.stringify(body),\n});\n\n// Access Token\uC73C\uB85C Cognito\uC5D0\uC11C \uC0AC\uC6A9\uC790 \uC774\uBA54\uC77C \uCD94\uCD9C\nconst getUserEmailFromToken = async (authHeader: string | undefined): Promise<string | null> => {\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    return null;\n  }\n\n  const token = authHeader.substring(7);\n\n  try {\n    const command = new GetUserCommand({ AccessToken: token });\n    const result = await cognitoClient.send(command);\n    const email = result.UserAttributes?.find(attr => attr.Name === 'email')?.Value;\n    return email || null;\n  } catch (error) {\n    console.error('Token verification failed:', error);\n    return null;\n  }\n};\n\n// \uB9C8\uC2A4\uD0B9 \uD568\uC218\uB4E4 (\uBD84\uB9AC \uBCF4\uAD00 \uD14C\uC774\uBE14\uC5D0 \uC800\uC7A5\uD560 \uB54C \uC0AC\uC6A9)\nfunction maskName(name: string): string {\n  if (!name) return '***';\n  if (name.length === 1) return '*';\n  if (name.length === 2) return name[0] + '*';\n  return name[0] + '*'.repeat(name.length - 2) + name[name.length - 1];\n}\n\nfunction maskEmail(email: string): string {\n  if (!email) return '***@***';\n  const [local, domain] = email.split('@');\n  if (!domain) return '***';\n  const maskedLocal = local.length <= 2 ? local[0] + '***' : local.substring(0, 2) + '***';\n  return `${maskedLocal}@${domain}`;\n}\n\nfunction maskPhone(phone: string): string {\n  if (!phone) return '***-****-****';\n  const digits = phone.replace(/\\D/g, '');\n  if (digits.length < 4) return '***';\n  const last4 = digits.slice(-4);\n  return `***-****-${last4}`;\n}\n\nexport const handler: APIGatewayProxyHandler = async (event) => {\n  // CORS preflight\n  if (event.httpMethod === 'OPTIONS') {\n    return response(200, {});\n  }\n\n  if (event.httpMethod !== 'DELETE') {\n    return response(405, { success: false, error: '\uD5C8\uC6A9\uB418\uC9C0 \uC54A\uB294 \uBA54\uC11C\uB4DC\uC785\uB2C8\uB2E4.' });\n  }\n\n  // 1. \uC778\uC99D \uD655\uC778 (Cognito GetUser\uB85C \uC774\uBA54\uC77C \uCD94\uCD9C)\n  const email = await getUserEmailFromToken(event.headers.Authorization || event.headers.authorization);\n  if (!email) {\n    return response(401, { success: false, error: '\uC778\uC99D\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.' });\n  }\n\n  try {\n    // 2. \uC0AC\uC6A9\uC790 \uC870\uD68C (email-index GSI\uB85C \uAC80\uC0C9 - uid \uD615\uC2DD \uBD88\uC77C\uCE58 \uBB38\uC81C \uD574\uACB0)\n    const queryResult = await docClient.send(new QueryCommand({\n      TableName: USERS_TABLE,\n      IndexName: 'email-index',\n      KeyConditionExpression: 'email = :email',\n      ExpressionAttributeValues: { ':email': email },\n    }));\n\n    if (!queryResult.Items || queryResult.Items.length === 0) {\n      return response(404, { success: false, error: '\uC0AC\uC6A9\uC790\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.' });\n    }\n\n    const user = queryResult.Items[0];\n    const uid = user.uid; // \uC2E4\uC81C DynamoDB \uD30C\uD2F0\uC158 \uD0A4 \uC0AC\uC6A9\n\n    if (user.status === 'withdrawn') {\n      return response(400, { success: false, error: '\uC774\uBBF8 \uD0C8\uD1F4\uB41C \uACC4\uC815\uC785\uB2C8\uB2E4.' });\n    }\n\n    // 3. \uC9C4\uD589 \uC911 \uAC70\uB798 \uD655\uC778\n    const dealsResult = await docClient.send(new QueryCommand({\n      TableName: DEALS_TABLE,\n      IndexName: 'uid-index',\n      KeyConditionExpression: 'uid = :uid',\n      ExpressionAttributeValues: { ':uid': uid },\n    }));\n\n    const allDeals = dealsResult.Items || [];\n    const activeDeals = allDeals.filter(deal => ACTIVE_DEAL_STATUSES.includes(deal.status));\n\n    if (activeDeals.length > 0) {\n      return response(400, {\n        success: false,\n        error: '\uC9C4\uD589 \uC911\uC778 \uAC70\uB798\uAC00 \uC788\uC5B4 \uD0C8\uD1F4\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.',\n        activeDeals: activeDeals.length,\n      });\n    }\n\n    // 4. \uBC95\uC801 \uBCF4\uAD00 \uB370\uC774\uD130\uB97C \uBD84\uB9AC \uD14C\uC774\uBE14\uC5D0 \uC800\uC7A5 (\uB9C8\uC2A4\uD0B9 \uCC98\uB9AC)\n    const now = new Date();\n    const withdrawnAt = now.toISOString();\n    const retentionUntil = new Date(now.getFullYear() + RETENTION_YEARS, now.getMonth(), now.getDate()).toISOString();\n\n    // 4-1. \uD0C8\uD1F4 \uD68C\uC6D0 \uC815\uBCF4 \uBCF4\uAD00 (\uB9C8\uC2A4\uD0B9 \uC801\uC6A9)\n    await docClient.send(new PutCommand({\n      TableName: WITHDRAWN_USERS_TABLE,\n      Item: {\n        uid,\n        maskedName: maskName(user.name),\n        maskedEmail: maskEmail(user.email),\n        maskedPhone: maskPhone(user.phone),\n        grade: user.grade,\n        kakaoId: user.kakaoId || null,\n        joinedAt: user.createdAt,\n        withdrawnAt,\n        retentionUntil,\n        reason: 'user_request',\n      },\n    }));\n\n    // 4-2. \uC644\uB8CC/\uCDE8\uC18C \uAC70\uB798 \uB0B4\uC5ED \uBCF4\uAD00\n    const completedDeals = allDeals.filter(deal =>\n      ['completed', 'cancelled', 'refunded', 'expired'].includes(deal.status)\n    );\n\n    for (const deal of completedDeals) {\n      await docClient.send(new PutCommand({\n        TableName: WITHDRAWN_DEALS_TABLE,\n        Item: {\n          wdid: `wd_${deal.did}`,\n          uid,\n          originalDid: deal.did,\n          amount: deal.amount,\n          fee: deal.fee,\n          status: deal.status,\n          recipientName: deal.recipientName ? maskName(deal.recipientName) : undefined,\n          recipientBank: deal.recipientBank,\n          createdAt: deal.createdAt,\n          completedAt: deal.completedAt || deal.updatedAt,\n          withdrawnAt,\n          retentionUntil,\n        },\n      }));\n    }\n\n    // 5. \uC6D0\uBCF8 plic-users \uD14C\uC774\uBE14\uC5D0\uC11C \uB808\uCF54\uB4DC \uC644\uC804 \uC0AD\uC81C\n    await docClient.send(new DeleteCommand({\n      TableName: USERS_TABLE,\n      Key: { uid },\n    }));\n\n    // 6. Cognito \uC0AC\uC6A9\uC790 \uC644\uC804 \uC0AD\uC81C\n    // Cognito Username\uC740 email \uAE30\uBC18\uC73C\uB85C \uC0DD\uC131\uB428\n    const cognitoUsername = user.email;\n    if (cognitoUsername) {\n      try {\n        await cognitoClient.send(new AdminDeleteUserCommand({\n          UserPoolId: COGNITO_USER_POOL_ID!,\n          Username: cognitoUsername,\n        }));\n      } catch (cognitoError: any) {\n        // UserNotFoundException\uC740 \uBB34\uC2DC (\uC774\uBBF8 \uC0AD\uC81C\uB41C \uACBD\uC6B0)\n        if (cognitoError.name !== 'UserNotFoundException') {\n          console.error('Cognito user deletion failed:', cognitoError);\n        }\n      }\n    }\n\n    // 7. \uC131\uACF5 \uC751\uB2F5\n    return response(200, {\n      success: true,\n      message: '\uD68C\uC6D0 \uD0C8\uD1F4\uAC00 \uC644\uB8CC\uB418\uC5C8\uC2B5\uB2C8\uB2E4.',\n      data: {\n        withdrawnAt,\n        retentionInfo: {\n          retentionUntil,\n          description: '\uC804\uC790\uC0C1\uAC70\uB798\uBC95 \uB4F1 \uAD00\uB828 \uBC95\uB839\uC5D0 \uB530\uB77C \uAC70\uB798 \uBC0F \uACB0\uC81C \uAE30\uB85D\uC740 5\uB144\uAC04 \uBD84\uB9AC \uBCF4\uAD00\uB429\uB2C8\uB2E4.',\n        },\n      },\n    });\n\n  } catch (error: any) {\n    console.error('Withdraw error:', error);\n    return response(500, {\n      success: false,\n      error: '\uD68C\uC6D0 \uD0C8\uD1F4 \uCC98\uB9AC \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4. \uC7A0\uC2DC \uD6C4 \uB2E4\uC2DC \uC2DC\uB3C4\uD574\uC8FC\uC138\uC694.',\n    });\n  }\n};\n"],
  "mappings": "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",
  "names": []
}
