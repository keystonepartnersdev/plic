{
  "version": 3,
  "sources": ["kakao-login.ts"],
  "sourcesContent": ["// backend/functions/auth/kakao-login.ts\nimport { APIGatewayProxyHandler } from 'aws-lambda';\nimport { CognitoIdentityProviderClient, AdminInitiateAuthCommand, AdminSetUserPasswordCommand, AdminGetUserCommand } from '@aws-sdk/client-cognito-identity-provider';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, QueryCommand, UpdateCommand } from '@aws-sdk/lib-dynamodb';\nimport * as crypto from 'crypto';\n\nconst cognitoClient = new CognitoIdentityProviderClient({ region: process.env.AWS_REGION || 'ap-northeast-2' });\nconst dynamoClient = new DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-2' });\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\n\nconst USER_POOL_ID = process.env.COGNITO_USER_POOL_ID || '';\nconst USER_POOL_CLIENT_ID = process.env.USER_POOL_CLIENT_ID || '';\nconst USERS_TABLE = process.env.USERS_TABLE || 'plic-users';\nconst KAKAO_SECRET = process.env.KAKAO_AUTH_SECRET || 'plic-kakao-secret-key-2024';\n\n// CORS \uD5E4\uB354\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Headers': 'Content-Type,Authorization',\n  'Access-Control-Allow-Methods': 'POST,OPTIONS',\n};\n\n// \uC751\uB2F5 \uD5EC\uD37C\nconst response = (statusCode: number, body: Record<string, unknown>) => ({\n  statusCode,\n  headers: corsHeaders,\n  body: JSON.stringify(body),\n});\n\n// \uCE74\uCE74\uC624 ID\uB85C\uBD80\uD130 \uACB0\uC815\uC801 \uBE44\uBC00\uBC88\uD638 \uC0DD\uC131\nfunction generateKakaoPassword(kakaoId: number | string): string {\n  const hash = crypto.createHmac('sha256', KAKAO_SECRET)\n    .update(String(kakaoId))\n    .digest('hex');\n  // Cognito \uBE44\uBC00\uBC88\uD638 \uC694\uAD6C\uC0AC\uD56D: \uB300\uC18C\uBB38\uC790, \uC22B\uC790, \uD2B9\uC218\uBB38\uC790\n  return `Kk${hash.substring(0, 20)}!1`;\n}\n\nexport const handler: APIGatewayProxyHandler = async (event) => {\n  // OPTIONS \uC694\uCCAD \uCC98\uB9AC (CORS)\n  if (event.httpMethod === 'OPTIONS') {\n    return response(200, {});\n  }\n\n  try {\n    if (!event.body) {\n      return response(400, {\n        success: false,\n        error: '\uC694\uCCAD \uBCF8\uBB38\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.',\n      });\n    }\n\n    const body = JSON.parse(event.body);\n    const { email, kakaoId } = body;\n\n    if (!email || !kakaoId) {\n      return response(400, {\n        success: false,\n        error: '\uC774\uBA54\uC77C\uACFC \uCE74\uCE74\uC624 ID\uAC00 \uD544\uC694\uD569\uB2C8\uB2E4.',\n      });\n    }\n\n    // DynamoDB\uC5D0\uC11C \uC0AC\uC6A9\uC790 \uC870\uD68C\n    const queryResult = await docClient.send(new QueryCommand({\n      TableName: USERS_TABLE,\n      IndexName: 'email-index',\n      KeyConditionExpression: 'email = :email',\n      ExpressionAttributeValues: { ':email': email },\n    }));\n\n    if (!queryResult.Items || queryResult.Items.length === 0) {\n      return response(200, {\n        success: true,\n        exists: false,\n        message: '\uB4F1\uB85D\uB418\uC9C0 \uC54A\uC740 \uC0AC\uC6A9\uC790\uC785\uB2C8\uB2E4.',\n      });\n    }\n\n    const user = queryResult.Items[0];\n\n    // \uC0AC\uC6A9\uC790 \uC0C1\uD0DC \uD655\uC778 - \uC644\uC804\uD788 \uAC00\uC785\uB41C \uC0AC\uC6A9\uC790\uB9CC \uC790\uB3D9 \uB85C\uADF8\uC778\n    // 1. \uC774\uBA54\uC77C \uC778\uC99D \uC644\uB8CC (isVerified)\n    // 2. \uC57D\uAD00 \uB3D9\uC758 \uC644\uB8CC (agreements)\n    // 3. \uD65C\uC131 \uC0C1\uD0DC (status !== 'withdrawn')\n    const isFullyRegistered =\n      user.isVerified === true &&\n      user.agreements?.service === true &&\n      user.agreements?.privacy === true &&\n      user.agreements?.thirdParty === true &&\n      user.status !== 'withdrawn';\n\n    if (!isFullyRegistered) {\n      return response(200, {\n        success: true,\n        exists: false, // \uC644\uC804\uD788 \uAC00\uC785\uB418\uC9C0 \uC54A\uC558\uC73C\uBBC0\uB85C \uC0C8 \uAC00\uC785 \uCDE8\uAE09\n        incomplete: true,\n        message: '\uAC00\uC785\uC774 \uC644\uB8CC\uB418\uC9C0 \uC54A\uC740 \uACC4\uC815\uC785\uB2C8\uB2E4. \uB2E4\uC2DC \uAC00\uC785\uD574\uC8FC\uC138\uC694.',\n      });\n    }\n\n    // \uCE74\uCE74\uC624 ID \uD655\uC778 (\uC800\uC7A5\uB41C kakaoId\uAC00 \uC788\uC73C\uBA74 \uC77C\uCE58 \uC5EC\uBD80 \uD655\uC778)\n    if (user.kakaoId && String(user.kakaoId) !== String(kakaoId)) {\n      return response(401, {\n        success: false,\n        error: '\uCE74\uCE74\uC624 \uACC4\uC815\uC774 \uC77C\uCE58\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.',\n      });\n    }\n\n    // \uCE74\uCE74\uC624 ID\uAC00 \uC5C6\uC73C\uBA74 \uC800\uC7A5 (\uAE30\uC874 \uD68C\uC6D0\uC758 \uCE74\uCE74\uC624 \uC5F0\uB3D9)\n    if (!user.kakaoId) {\n      await docClient.send(new UpdateCommand({\n        TableName: USERS_TABLE,\n        Key: { uid: user.uid },\n        UpdateExpression: 'SET kakaoId = :kakaoId, updatedAt = :updatedAt',\n        ExpressionAttributeValues: {\n          ':kakaoId': kakaoId,\n          ':updatedAt': new Date().toISOString(),\n        },\n      }));\n    }\n\n    // \uACB0\uC815\uC801 \uBE44\uBC00\uBC88\uD638 \uC0DD\uC131\n    const kakaoPassword = generateKakaoPassword(kakaoId);\n\n    // Cognito \uBE44\uBC00\uBC88\uD638 \uC124\uC815 (\uC790\uB3D9 \uB85C\uADF8\uC778\uC744 \uC704\uD574)\n    try {\n      await cognitoClient.send(new AdminSetUserPasswordCommand({\n        UserPoolId: USER_POOL_ID,\n        Username: email,\n        Password: kakaoPassword,\n        Permanent: true,\n      }));\n    } catch (pwError: any) {\n      console.error('\uBE44\uBC00\uBC88\uD638 \uC124\uC815 \uC2E4\uD328:', pwError);\n      // \uBE44\uBC00\uBC88\uD638 \uC124\uC815 \uC2E4\uD328\uD574\uB3C4 \uACC4\uC18D \uC9C4\uD589 (\uC774\uBBF8 \uC124\uC815\uB418\uC5B4 \uC788\uC744 \uC218 \uC788\uC74C)\n    }\n\n    // Cognito \uB85C\uADF8\uC778\n    try {\n      const authResult = await cognitoClient.send(new AdminInitiateAuthCommand({\n        UserPoolId: USER_POOL_ID,\n        ClientId: USER_POOL_CLIENT_ID,\n        AuthFlow: 'ADMIN_USER_PASSWORD_AUTH',\n        AuthParameters: {\n          USERNAME: email,\n          PASSWORD: kakaoPassword,\n        },\n      }));\n\n      if (!authResult.AuthenticationResult) {\n        return response(401, {\n          success: false,\n          error: '\uC778\uC99D\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4.',\n        });\n      }\n\n      return response(200, {\n        success: true,\n        exists: true,\n        autoLogin: true,\n        data: {\n          user: {\n            uid: user.uid,\n            email: user.email,\n            name: user.name,\n            phone: user.phone,\n            userType: user.userType,\n            status: user.status,\n            grade: user.grade,\n            feeRate: user.feeRate,\n            businessInfo: user.businessInfo,\n            agreements: user.agreements,\n          },\n          tokens: {\n            accessToken: authResult.AuthenticationResult.AccessToken,\n            refreshToken: authResult.AuthenticationResult.RefreshToken,\n            idToken: authResult.AuthenticationResult.IdToken,\n            expiresIn: authResult.AuthenticationResult.ExpiresIn,\n          },\n        },\n      });\n    } catch (authError: any) {\n      console.error('Cognito \uC778\uC99D \uC2E4\uD328:', authError);\n\n      // UserNotConfirmedException - \uC774\uBA54\uC77C \uBBF8\uC778\uC99D\n      if (authError.name === 'UserNotConfirmedException') {\n        return response(200, {\n          success: true,\n          exists: false,\n          incomplete: true,\n          message: '\uC774\uBA54\uC77C \uC778\uC99D\uC774 \uC644\uB8CC\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.',\n        });\n      }\n\n      return response(401, {\n        success: false,\n        error: '\uCE74\uCE74\uC624 \uB85C\uADF8\uC778\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4.',\n      });\n    }\n  } catch (error: any) {\n    console.error('\uCE74\uCE74\uC624 \uB85C\uADF8\uC778 \uC624\uB958:', error);\n    return response(500, {\n      success: false,\n      error: error.message || '\uC11C\uBC84 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.',\n    });\n  }\n};\n"],
  "mappings": "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",
  "names": []
}
