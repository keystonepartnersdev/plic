AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: PLIC Backend API
Globals:
  Function:
    Timeout: 30
    Runtime: nodejs20.x
    Architectures:
    - x86_64
    LoggingConfig:
      LogFormat: JSON
  Api:
    Cors:
      AllowMethods: '''GET,POST,PUT,DELETE,OPTIONS'''
      AllowHeaders: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
      AllowOrigin: '''*'''
Resources:
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: plic-users
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: uid
        AttributeType: S
      - AttributeName: email
        AttributeType: S
      - AttributeName: phone
        AttributeType: S
      KeySchema:
      - AttributeName: uid
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: email-index
        KeySchema:
        - AttributeName: email
          KeyType: HASH
        Projection:
          ProjectionType: ALL
      - IndexName: phone-index
        KeySchema:
        - AttributeName: phone
          KeyType: HASH
        Projection:
          ProjectionType: ALL
  DealsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: plic-deals
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: did
        AttributeType: S
      - AttributeName: uid
        AttributeType: S
      - AttributeName: status
        AttributeType: S
      - AttributeName: createdAt
        AttributeType: S
      KeySchema:
      - AttributeName: did
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: uid-index
        KeySchema:
        - AttributeName: uid
          KeyType: HASH
        - AttributeName: createdAt
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: status-index
        KeySchema:
        - AttributeName: status
          KeyType: HASH
        - AttributeName: createdAt
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
  AdminsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: plic-admins
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: adminId
        AttributeType: S
      - AttributeName: email
        AttributeType: S
      KeySchema:
      - AttributeName: adminId
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: email-index
        KeySchema:
        - AttributeName: email
          KeyType: HASH
        Projection:
          ProjectionType: ALL
  ContentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: plic-contents
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
  WithdrawnUsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: plic-withdrawn-users
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: uid
        AttributeType: S
      KeySchema:
      - AttributeName: uid
        KeyType: HASH
  WithdrawnDealsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: plic-withdrawn-deals
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: wdid
        AttributeType: S
      - AttributeName: uid
        AttributeType: S
      KeySchema:
      - AttributeName: wdid
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: uid-index
        KeySchema:
        - AttributeName: uid
          KeyType: HASH
        Projection:
          ProjectionType: ALL
  AttachmentsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: plic-attachments-${AWS::AccountId}
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - PUT
          - POST
          AllowedOrigins:
          - '*'
          MaxAge: 3000
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: plic-users
      AutoVerifiedAttributes:
      - email
      UsernameAttributes:
      - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: plic-web
      UserPoolId:
        Ref: CognitoUserPool
      ExplicitAuthFlows:
      - ALLOW_USER_PASSWORD_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
      GenerateSecret: false
  SignupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SignupFunction
      Handler: signup.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          COGNITO_CLIENT_ID:
            Ref: CognitoUserPoolClient
          USER_POOL_CLIENT_ID:
            Ref: CognitoUserPoolClient
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName: plic-kakao-verifications
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:SignUp
          - cognito-idp:AdminCreateUser
          - cognito-idp:AdminConfirmSignUp
          - cognito-idp:AdminGetUser
          - cognito-idp:AdminDeleteUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /auth/signup
            Method: post
  ConfirmFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ConfirmFunction
      Handler: confirm.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          COGNITO_CLIENT_ID:
            Ref: CognitoUserPoolClient
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:ConfirmSignUp
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /auth/confirm
            Method: post
  LoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LoginFunction
      Handler: login.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          COGNITO_CLIENT_ID:
            Ref: CognitoUserPoolClient
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:InitiateAuth
          - cognito-idp:AdminGetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /auth/login
            Method: post
  KakaoLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: plic-KakaoLoginFunction
      CodeUri: KakaoLoginFunction
      Handler: kakao-login.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          USER_POOL_CLIENT_ID:
            Ref: CognitoUserPoolClient
          USERS_TABLE:
            Ref: UsersTable
          KAKAO_AUTH_SECRET: 'plic-kakao-secret-key-2024'
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:AdminInitiateAuth
          - cognito-idp:AdminSetUserPassword
          - cognito-idp:AdminGetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /auth/kakao-login
            Method: post
  RefreshFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: RefreshFunction
      Handler: refresh.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          COGNITO_CLIENT_ID:
            Ref: CognitoUserPoolClient
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:InitiateAuth
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /auth/refresh
            Method: post
  LogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LogoutFunction
      Handler: logout.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          COGNITO_CLIENT_ID:
            Ref: CognitoUserPoolClient
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GlobalSignOut
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /auth/logout
            Method: post
  GetMeFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetMeFunction
      Handler: me.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /users/me
            Method: get
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - me.ts
        Minify: true
        Sourcemap: true
        Target: es2020
        External:
        - '@aws-sdk/*'
  UpdateMeFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UpdateMeFunction
      Handler: update.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /users/me
            Method: put
  WithdrawFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: WithdrawFunction
      Handler: withdraw.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: WithdrawnUsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: WithdrawnDealsTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          - cognito-idp:AdminDeleteUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /users/me
            Method: delete
  GetGradeFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetGradeFunction
      Handler: grade.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /users/me/grade
            Method: get
  ListDealsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ListDealsFunction
      Handler: list.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /deals
            Method: get
  GetDealFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetDealFunction
      Handler: get.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /deals/{did}
            Method: get
  CreateDealFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CreateDealFunction
      Handler: create.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /deals
            Method: post
  UpdateDealFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UpdateDealFunction
      Handler: update.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /deals/{did}
            Method: put
  CancelDealFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CancelDealFunction
      Handler: cancel.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /deals/{did}
            Method: delete
  ValidateDiscountFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ValidateDiscountFunction
      Handler: validate.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          DISCOUNTS_TABLE: plic-discounts
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName: plic-discounts
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /discounts/validate
            Method: post
  GetCouponsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetCouponsFunction
      Handler: coupons.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          DISCOUNTS_TABLE: plic-discounts
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName: plic-discounts
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /discounts/coupons
            Method: get
  ApplyDiscountFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ApplyDiscountFunction
      Handler: apply.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          DISCOUNTS_TABLE: plic-discounts
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName: plic-discounts
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /deals/{did}/discount
            Method: post
  AdminLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminLoginFunction
      Handler: login.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/auth/login
            Method: post
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  AdminUsersListFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminUsersListFunction
      Handler: users-list.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/users
            Method: get
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  AdminUsersGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminUsersGetFunction
      Handler: users-get.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/users/{uid}
            Method: get
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  AdminUsersStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminUsersStatusFunction
      Handler: users-status.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/users/{uid}/status
            Method: put
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  AdminUsersGradeFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminUsersGradeFunction
      Handler: users-grade.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/users/{uid}/grade
            Method: put
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  AdminUsersSettingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminUsersSettingsFunction
      Handler: users-settings.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/users/{uid}/settings
            Method: put
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - users-settings.ts
        Minify: true
        Sourcemap: true
        Target: es2020
  AdminBusinessVerifyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminBusinessVerifyFunction
      Handler: business-verify.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/users/{uid}/business
            Method: put
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - business-verify.ts
        Minify: true
        Sourcemap: true
        Target: es2020
  AdminDealsListFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminDealsListFunction
      Handler: deals-list.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/deals
            Method: get
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  AdminDealsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminDealsGetFunction
      Handler: deals-get.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/deals/{did}
            Method: get
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  AdminDealsStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminDealsStatusFunction
      Handler: deals-status.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/deals/{did}/status
            Method: put
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - deals-status.ts
        Minify: true
        Sourcemap: true
        Target: es2020
        External:
        - '@aws-sdk/*'
  AdminDealsUpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminDealsUpdateFunction
      Handler: deals-update.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /admin/deals/{did}/update
            Method: put
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - deals-update.ts
        Minify: true
        Sourcemap: true
        Target: es2020
        External:
        - '@aws-sdk/*'
  GetBannersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetBannersFunction
      Handler: banners.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ContentsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /content/banners
            Method: get
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  GetNoticesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetNoticesFunction
      Handler: notices.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ContentsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /content/notices
            Method: get
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  GetNoticeDetailFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetNoticeDetailFunction
      Handler: notice-detail.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ContentsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /content/notices/{id}
            Method: get
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  GetFaqsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetFaqsFunction
      Handler: faqs.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ContentsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /content/faqs
            Method: get
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
  AdminFaqsManageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminFaqsManageFunction
      Handler: faqs-manage.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ContentsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        GetAll:
          Type: Api
          Properties:
            Path: /admin/faqs
            Method: get
        Create:
          Type: Api
          Properties:
            Path: /admin/faqs
            Method: post
        GetOne:
          Type: Api
          Properties:
            Path: /admin/faqs/{id}
            Method: get
        Update:
          Type: Api
          Properties:
            Path: /admin/faqs/{id}
            Method: put
        Delete:
          Type: Api
          Properties:
            Path: /admin/faqs/{id}
            Method: delete
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - faqs-manage.ts
        Minify: true
        Sourcemap: true
        Target: es2020
  AdminFaqsSeedFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminFaqsSeedFunction
      Handler: faqs-seed.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ContentsTable
      Events:
        Seed:
          Type: Api
          Properties:
            Path: /admin/faqs/seed
            Method: post
        SeedOptions:
          Type: Api
          Properties:
            Path: /admin/faqs/seed
            Method: options
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - faqs-seed.ts
        Minify: true
        Sourcemap: true
        Target: es2020
  GetTermsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetTermsFunction
      Handler: terms.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ContentsTable
      Events:
        GetAll:
          Type: Api
          Properties:
            Path: /content/terms
            Method: get
        GetOne:
          Type: Api
          Properties:
            Path: /content/terms/{type}
            Method: get
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - terms.ts
        Minify: true
        Sourcemap: true
        Target: es2020
  AdminTermsManageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminTermsManageFunction
      Handler: terms-manage.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ContentsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        GetAll:
          Type: Api
          Properties:
            Path: /admin/terms
            Method: get
        GetOne:
          Type: Api
          Properties:
            Path: /admin/terms/{type}
            Method: get
        Update:
          Type: Api
          Properties:
            Path: /admin/terms/{type}
            Method: put
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - terms-manage.ts
        Minify: true
        Sourcemap: true
        Target: es2020
  TrackingApiLogFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: TrackingApiLogFunction
      Handler: log-api.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: plic-api-logs
      Events:
        Post:
          Type: Api
          Properties:
            Path: /tracking/api-log
            Method: post
        Options:
          Type: Api
          Properties:
            Path: /tracking/api-log
            Method: options
      Environment:
        Variables:
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - log-api.ts
        Minify: true
        Sourcemap: true
        Target: es2020
  UserBusinessResubmitFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UserBusinessResubmitFunction
      Handler: business-resubmit.handler
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPool
          NODE_OPTIONS: ' --enable-source-maps'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - CognitoUserPool
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /users/me/business
            Method: put
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - business-resubmit.ts
        Minify: true
        Sourcemap: true
        Target: es2020
        External:
        - '@aws-sdk/*'
  AdminBusinessAnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AdminBusinessAnalyticsFunction
      Handler: business-analytics.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DealsTable
      - DynamoDBCrudPolicy:
          TableName: plic-events
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdminsTable
      Events:
        Get:
          Type: Api
          Properties:
            Path: /admin/business-analytics
            Method: get
        Options:
          Type: Api
          Properties:
            Path: /admin/business-analytics
            Method: options
      Environment:
        Variables:
          USERS_TABLE: plic-users
          DEALS_TABLE: plic-deals
          EVENTS_TABLE: plic-events
          NODE_OPTIONS: ' --enable-source-maps'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - business-analytics.ts
        Minify: true
        Sourcemap: true
        Target: es2020
        External:
        - '@aws-sdk/*'
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value:
      Ref: CognitoUserPool
  CognitoClientId:
    Description: Cognito Client ID
    Value:
      Ref: CognitoUserPoolClient
